<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">


<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>




<script>
    (function () {
        if ('') {
            if (prompt('Please input Password:') !== '') {
                alert('Password Error！');
                if (history.length === 1) {
                    location.replace("https://wanderros.github.io/"); // 这里替换成你的首页
                } else {
                    history.back();
                }
            }
        }
    })();
</script>





<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon.ico?v=5.1.4" color="#222">


  <link rel="manifest" href="/images/manifest.json">


  <meta name="msapplication-config" content="/images/browserconfig.xml" />



  <meta name="keywords" content="Hexo, NexT" />




  


  <link rel="alternate" href="/atom.xml" title="WanderROS'S Daily" type="application/atom+xml" />






<meta name="description" content="简介JavaScript、Node和Express 的组合是Web团队的理想选择，可快速部署的技术栈得到了开发社区和大公司的广泛认可，Express 提供了较低的总体拥有成本和较快的上市时间！Node 生态系统提供的框架、库和工具改变了这种状况，它们可以加速开发，鼓励良好的编程习惯！Express是精简的、灵活的 Node.js Web 程序框架，为构建单页、多页及混合的 Web 程序提供了一系列">
<meta property="og:type" content="article">
<meta property="og:title" content="Nodejs-Express">
<meta property="og:url" content="https://wanderros.github.io/2020/04/28/Nodejs-Express/index.html">
<meta property="og:site_name" content="WanderROS&#39;S Daily">
<meta property="og:description" content="简介JavaScript、Node和Express 的组合是Web团队的理想选择，可快速部署的技术栈得到了开发社区和大公司的广泛认可，Express 提供了较低的总体拥有成本和较快的上市时间！Node 生态系统提供的框架、库和工具改变了这种状况，它们可以加速开发，鼓励良好的编程习惯！Express是精简的、灵活的 Node.js Web 程序框架，为构建单页、多页及混合的 Web 程序提供了一系列">
<meta property="article:published_time" content="2020-04-28T01:15:36.000Z">
<meta property="article:modified_time" content="2020-10-01T08:52:15.883Z">
<meta property="article:author" content="WanderROS">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://wanderros.github.io/2020/04/28/Nodejs-Express/"/>





  <title>Nodejs-Express | WanderROS'S Daily</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

<a href="https://github.com/WanderROS" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>


    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WanderROS'S Daily</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-足迹">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            足迹
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wanderros.github.io/2020/04/28/Nodejs-Express/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="WanderROS">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WanderROS'S Daily">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Nodejs-Express</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-28T09:15:36+08:00">
                2020-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">Nodejs</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>JavaScript、Node和Express 的组合是Web团队的理想选择，可快速部署的技术栈得到了开发社区和大公司的广泛认可，Express 提供了较低的总体拥有成本和较快的上市时间！Node 生态系统提供的框架、库和工具改变了这种状况，它们可以加速开发，鼓励良好的编程习惯！Express是精简的、灵活的 Node.js Web 程序框架，为构建单页、多页及混合的 Web 程序提供了一系列健壮的功能特性！<strong><em>推荐书籍：《Node与Express开发》· Ethan Brown著 吴海星 苏文译</em></strong></p>
<hr>
<h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="新技术的衍生"><a href="#新技术的衍生" class="headerlink" title="新技术的衍生"></a>新技术的衍生</h2><ol>
<li>Node 开发的出现带动了一种新式的数据库存储方式，这种方式被称为“NoSQL 数据库”；</li>
<li>构建一个功能性网站要借助很多种技术，因此衍生了一种用来描述网站构建基础“技术栈”的缩略语；</li>
</ol>
<ul>
<li>Linux、Apache、MySQL 和 PHP 被称为 <strong>LAMP</strong> 栈</li>
<li>Mongo、Express、Angular 和Node 被称为 <strong>MEAN</strong> 栈</li>
<li>Node、Express 和 MongoDB 被称为 <strong>JavaScript技术</strong> 栈</li>
</ul>
<h2 id="平台搭建"><a href="#平台搭建" class="headerlink" title="平台搭建"></a>平台搭建</h2><ol>
<li>Mac上：brew install nodejs</li>
<li>npm 是 Node 开发包管理器，主要负责安装开发包和管理依赖项；</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 全局安装grunt编译方式</span></span><br><span class="line">npm install -g grunt-cli</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Node 所提供的范式跟传统的 Web 服务器不同,只是提供了一个构建 Web 服务器的框架;</li>
<li>第一个Hello World程序：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http=<span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	res.writeHead(<span class="number">200</span>,&#123;<span class="string">'Content-Type'</span>:<span class="string">'text/html'</span>&#125;);</span><br><span class="line">	res.write(<span class="string">'&lt;h1&gt;大标题&lt;/h1&gt;'</span>);<span class="comment">//会出现乱码</span></span><br><span class="line">	res.end(<span class="string">'Hello World,NodeJs'</span>);</span><br><span class="line"></span><br><span class="line">&#125;).listen(<span class="number">80</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Server is listening on localhost:80,press ctrl-c to terminate ... ...'</span>);</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>路由是指向客户端提供它所发出的请求内容的机制，客户端在 URL 中指明它想要的内容， 具体来说就是路径和查询字符串；修改案例,用 Node 提供静态资源只适用于初期的小型项目（适合练习）：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http=<span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> path=req.url.replace(<span class="regexp">/\/?(?:\?.*)?$/</span>,<span class="string">''</span>).toLowerCase();</span><br><span class="line">	<span class="keyword">switch</span>(path)&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">''</span>:</span><br><span class="line">			res.writeHead(<span class="number">200</span>,&#123;<span class="string">'Conten-Type'</span>:<span class="string">'text/html'</span>&#125;);</span><br><span class="line">			res.end(<span class="string">'HomePage'</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'/about'</span>:</span><br><span class="line">			res.writeHead(<span class="number">200</span>,&#123;<span class="string">'Conten-Type'</span>:<span class="string">'text/html'</span>&#125;);</span><br><span class="line">			res.end(<span class="string">'About Page'</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			res.writeHead(<span class="number">404</span>,&#123;<span class="string">'Conten-Type'</span>:<span class="string">'text/html'</span>&#125;);</span><br><span class="line">			res.end(<span class="string">'Not found!'</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;).listen(<span class="number">80</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Server is listening on localhost:80,press ctrl-c to terminate ... ...'</span>);</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>Node处理Web的原理：必须打开文件，读取其中的内容，然后将这些内容发送给浏览器；</li>
<li>简单的html网页读取：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http=<span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> fs=<span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="comment">// 异步读取html页面内容</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">serverStaticFile</span>(<span class="params">res,path,contentType,responseCode</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!responseCode) responseCode=<span class="number">200</span>;</span><br><span class="line">	fs.readFile(__dirname+path,<span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(err)</span><br><span class="line">		&#123;</span><br><span class="line">			res.writeHead(<span class="number">500</span>,&#123;<span class="string">'ContentType'</span>:<span class="string">'text/html'</span>&#125;);</span><br><span class="line">			res.end(<span class="string">'&lt;h1&gt;500-Internal Error&lt;/h1&gt;'</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			res.writeHead(responseCode,&#123;<span class="string">'ContentType'</span>:<span class="string">'text/html'</span>&#125;);</span><br><span class="line">			res.end(data);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> path=req.url.replace(<span class="regexp">/\/?(?:\?.*)?$/</span>,<span class="string">''</span>).toLowerCase();</span><br><span class="line">	<span class="keyword">switch</span>(path)&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">''</span>:</span><br><span class="line">			serverStaticFile(res,<span class="string">'/public/home.html'</span>,<span class="string">'text/html'</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'/about'</span>:</span><br><span class="line">			serverStaticFile(res,<span class="string">'/public/about.html'</span>,<span class="string">'text/html'</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			serverStaticFile(res,<span class="string">'/public/notfound.html'</span>,<span class="string">'text/html'</span>,<span class="number">404</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;).listen(<span class="number">80</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Server is listening on localhost:80,press ctrl-c to terminate ... ...'</span>);</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>上述的内容都明白的话，说明已经有了基础的Nodejs开发基础了，那么接下来就是Expres的表现了！</li>
</ol>
<h2 id="Express"><a href="#Express" class="headerlink" title="Express"></a>Express</h2><ol>
<li>创建一个通用的项目骨架，每次开始新项目时，只需复制这个骨架，那么开发就可以减少很多重复性劳动；</li>
<li>创建一个文件夹，用于学习express，使用<strong>npm init</strong>引导，然后下载express包，使用命令<strong>npm install –save express</strong>；</li>
<li>示例代码：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express=<span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app=express();</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'port'</span>,process.env.PORT||<span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定制化404</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	res.type(<span class="string">'text/html'</span>);</span><br><span class="line">	res.status(<span class="number">404</span>);</span><br><span class="line">	res.send(<span class="string">'404-Not Found'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err.stack);</span><br><span class="line">	res.type(<span class="string">'text/html'</span>);</span><br><span class="line">	res.status(<span class="number">500</span>);</span><br><span class="line">	res.send(<span class="string">'500-Internal Error'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(app.get(<span class="string">'port'</span>),<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'express started on http://localhost:'</span>+app.get(<span class="string">'port'</span>)+<span class="string">';press ctrl c to terminate... ... '</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>不幸的事就是访问对应的port却没有任何路由信息，因为没有提供对应的资源给express去管理；</li>
<li>添加路由：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.get 是我们添加路由的方法 </span></span><br><span class="line"><span class="comment">// 在 Express 文档中写的是 app.VERB ; VERB 用来指代 HTTP 动词的</span></span><br><span class="line"><span class="comment">// 参数：一个路径和一个函数</span></span><br><span class="line">app.get(<span class="string">'/'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	res.type(<span class="string">'text/html'</span>);</span><br><span class="line">	res.send(<span class="string">'&lt;h1&gt;Home Page&lt;/h1&gt;'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">'/about'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	res.type(<span class="string">'text/html'</span>);</span><br><span class="line">	res.send(<span class="string">'&lt;h1&gt;About Page&lt;/h1&gt;'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>app.VERB 帮我们做了很多工作：它默认忽略了大小写或反斜杠， 并且在进行匹配时也不考虑查询字符串，因此对于 /about、/About、/about/、/about?foo=bar、/about/?foo=bar 等路径都适用；路由匹配上之后就会调用你提供的函数， 并把请求和响应对象作为参数传给这个函数；</li>
<li>Express 提供了一个 res.type 方法， 可以方便地设置响应头 Content-Type，用res.set 和 res.status 替换了 Node 的 res.writeHead，app.use 是 Express 添加 <strong>中间件</strong> 的一种方法；</li>
<li><strong><em>在 Express 中，路由和中间件的添加顺序至关重要</em></strong>，如果我们把404 处理器放在所有路由上面， 那首页和关于页面就不能用了， 访问这些 URL 得到的都是 404；</li>
<li>在 Express 中,<strong>路由支持通配符，这会导致顺序上的问题,</strong>在使用上要注意点；</li>
<li>熟悉MVC（模型 - 视图 - 控制器）的话，就能更好理解Express中的<strong>视图引擎</strong>，Express 比较偏好的视图引擎是 Jade；Handlebars（基于与语言无关的流行模板语言Mustache）不会试图对 HTML 进行抽象，为了支持 Handlebars， 要用到 Eric Ferraiuolo 的 express-handlebars 包，执行命令：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save express-handlebars</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>创建模板文件：views/layouts/main.handlebars</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span> Learn Nodejs <span class="tag">&lt;/<span class="name">title</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">&#123;&#123;&#123;body&#125;&#125;&#125; </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="12">
<li>创建视图页面：</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--home.handlebars--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">Welcome to Learn Nodejs</span><br><span class="line"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--about.handlebars--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">About Learn Nodejs</span><br><span class="line"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--404.handlebars--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">404 - Not Found </span><br><span class="line"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--500.handlebars--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">500 - Server Error</span><br><span class="line"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="13">
<li>修改路由设置：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express=<span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app=express();</span><br><span class="line"><span class="keyword">var</span> handlebars=<span class="built_in">require</span>(<span class="string">'express-handlebars'</span>).create(&#123;<span class="attr">defaultLayout</span>:<span class="string">'main'</span>&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'port'</span>,process.env.PORT||<span class="number">8080</span>);</span><br><span class="line">app.engine(<span class="string">'handlebars'</span>,handlebars.engine);</span><br><span class="line">app.set(<span class="string">'view engine'</span>,<span class="string">'handlebars'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	res.render(<span class="string">'home'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">'/about*'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	res.render(<span class="string">'about'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">'/about/test'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	res.render(<span class="string">'about'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 定制化404</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	res.status(<span class="number">404</span>);</span><br><span class="line">	res.render(<span class="string">'404'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err.stack);</span><br><span class="line">	res.status(<span class="number">500</span>);</span><br><span class="line">	res.render(<span class="string">'500'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(app.get(<span class="string">'port'</span>),<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'express started on http://localhost:'</span>+app.get(<span class="string">'port'</span>)+<span class="string">';press ctrl c to terminate... ... '</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="14">
<li>Express 靠中间件处理静态文件和视图，<strong>static 中间件可以将一个或多个目录指派为包含静态资源的目录，其中的资源不经过任何特殊处理直接发送到客户端</strong>，可以在其中放图片、CSS 文件、客户端 JavaScript 文件之类的资源；要把 static 中间件加在所有路由之前：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static中间件相当于给你想要发送的所有静态文件创建了一个路由，渲染文件并发送给客户端</span></span><br><span class="line">app.use(express.static(__dirname + <span class="string">'/public'</span>));</span><br></pre></td></tr></table></figure>

<ol start="15">
<li>在 public 下面创建一个子目录 img， 并把 logo.jpg 文件放在其中，然后修改模板文件<strong>main.handlebars</strong>就可以做到在所有页面出现logo：</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span> Learn Nodejs <span class="tag">&lt;/<span class="name">title</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/img/logo.jpg"</span> <span class="attr">alt</span>=<span class="string">"Learn Nodejs Logo"</span> &gt;</span><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">&#123;&#123;&#123;body&#125;&#125;&#125; </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="16">
<li><p>视图真正的强大之处在于它可以包含动态信息，比如下面的示例：</p>
<ol>
<li>在 about.handlebars中修改如下:</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>About Learn Nodejs<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span> Your fortune for the day: <span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">blockquote</span>&gt;</span> &#123;&#123;fortune&#125;&#125; <span class="tag">&lt;/<span class="name">blockquote</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在index.js中添加数组fortunes，以及修改about的处理：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fortunes = [</span><br><span class="line"><span class="string">"Conquer your fears or they will conquer you."</span>, </span><br><span class="line"><span class="string">"Rivers need springs."</span>, </span><br><span class="line"><span class="string">"Do not fear what you don't know."</span>, </span><br><span class="line"><span class="string">"You will have a pleasant surprise."</span>,</span><br><span class="line"><span class="string">"Whenever possible, keep it simple."</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/about'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> randomFortune=fortunes[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*fortunes.length)];</span><br><span class="line">	<span class="comment">//console.log('value: ' + randomFortune);</span></span><br><span class="line">	res.render(<span class="string">'about'</span>,&#123;<span class="attr">fortune</span> : randomFortune&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用curl命令，curl <a href="http://localhost:8080/about，可以看到每次的返回的信息都不太一样：" target="_blank" rel="noopener">http://localhost:8080/about，可以看到每次的返回的信息都不太一样：</a></li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--一种可能的返回 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span> Learn Nodejs <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/img/logo.jpg"</span> <span class="attr">alt</span>=<span class="string">"Learn Nodejs Logo"</span> &gt;</span><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">About Learn Nodejs</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span> Your fortune for the day: <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">blockquote</span>&gt;</span> You will have a pleasant surprise. <span class="tag">&lt;/<span class="name">blockquote</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span>%</span><br></pre></td></tr></table></figure>

<h2 id="Node项目"><a href="#Node项目" class="headerlink" title="Node项目"></a>Node项目</h2><ol>
<li>package.json 文件作用之一是存放项目的元数据,比如项目名称、作者、授权信息等,可以使用npm init来创建package.json文件;</li>
<li>Node 模块和 npm 包是两个相互关联但又彼此不同的概念，Node 模块提供了一个模块化和封装的机制，npm 包则提供了一种存储、版本化和引用项目（不限于模块）的标准范式；</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>*<em>require *</em>是一个用来引入模块的Node 函数，默认会在目录 node_modules中寻找这些模块；</li>
<li>创建一个用来保存模块的目录，一般称为lib，在这个目录下面创建自己的js文件，比如：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/fortune.js</span></span><br><span class="line"><span class="keyword">var</span> fortunes = [</span><br><span class="line"><span class="string">"Conquer your fears or they will conquer you."</span>, </span><br><span class="line"><span class="string">"Rivers need springs."</span>, </span><br><span class="line"><span class="string">"Do not fear what you don't know."</span>, </span><br><span class="line"><span class="string">"You will have a pleasant surprise."</span>,</span><br><span class="line"><span class="string">"Whenever possible, keep it simple."</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">exports.getFortune=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> idx=<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*fortunes.length);</span><br><span class="line">	<span class="keyword">return</span> fortunes[idx];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>如果想让一个东西在模块外可见，必须把它加到exports 上,然后修改index.js</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express=<span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="comment">// 修改的require</span></span><br><span class="line"><span class="keyword">var</span> fortune=<span class="built_in">require</span>(<span class="string">'./lib/fortune.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app=express();</span><br><span class="line"><span class="keyword">var</span> handlebars=<span class="built_in">require</span>(<span class="string">'express-handlebars'</span>).create(&#123;<span class="attr">defaultLayout</span>:<span class="string">'main'</span>&#125;);</span><br><span class="line"></span><br><span class="line">app.use(express.static(__dirname + <span class="string">'/public'</span>));</span><br><span class="line">app.set(<span class="string">'port'</span>,process.env.PORT||<span class="number">8080</span>);</span><br><span class="line">app.engine(<span class="string">'handlebars'</span>,handlebars.engine);</span><br><span class="line">app.set(<span class="string">'view engine'</span>,<span class="string">'handlebars'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	res.render(<span class="string">'home'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//直接使用外部的js函数</span></span><br><span class="line">app.get(<span class="string">'/about*'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> randomFortune=fortune.getFortune();</span><br><span class="line">	res.render(<span class="string">'about'</span>,&#123;<span class="attr">fortune</span> : randomFortune&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">'/about/test'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	res.render(<span class="string">'about'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 定制化404</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	res.status(<span class="number">404</span>);</span><br><span class="line">	res.render(<span class="string">'404'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.error(err.stack);</span><br><span class="line">	res.status(<span class="number">500</span>);</span><br><span class="line">	res.render(<span class="string">'500'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(app.get(<span class="string">'port'</span>),<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'express started on http://localhost:'</span>+app.get(<span class="string">'port'</span>)+<span class="string">';press ctrl c to terminate... ... '</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="质量保证（QA）"><a href="#质量保证（QA）" class="headerlink" title="质量保证（QA）"></a>质量保证（QA）</h2><ol>
<li>页面测试：用来测试页面的表示和前端功能，可以使用Mocha 进行页面测试；</li>
<li>跨页测试：对从一个页面转到另一个页面的功能的测试，测试用的是 Zombie.js、Selenium、PhantomJS；</li>
<li>逻辑测试：测试 JavaScript，跟所有表示功能分开；</li>
<li>去毛：找出潜在的错误，用 JSHint 做去毛；</li>
<li>链接检查：确保你的网站上没有破损的链接，用 LinkChecker 做链接检查</li>
</ol>
<h2 id="页面测试"><a href="#页面测试" class="headerlink" title="页面测试"></a>页面测试</h2><ol>
<li>安装测试框架Mocha：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 用的是 --save-dev 而不是 --save,要把这个包放在开发依赖项中 </span></span><br><span class="line">npm install --save-dev mocha</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将测试资源放在public/vendor目录下：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 把用到的第三方库放在一个特殊的目录中,比较容易分清哪些代码是需要负责测试和修改的， 哪些代码不应该触碰</span></span><br><span class="line">mkdir public/vendor </span><br><span class="line">cp node_modules/mocha/mocha.js public/vendor </span><br><span class="line">cp node_modules/mocha/mocha.css public/vendor</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>测试通常需要一个 assert （或 expect ）函数，浏览器中没有，可以安装Chai断言库：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev chai</span><br><span class="line">cp node_modules/chai/chai.js public/vendor</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在定义的所有路由之前添加中间件检测查询字符串中的test=1：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果test=1 出现在任何页面的查询字符串中（并且不是运行在生产服务器上）， 属性 res.locals.showTests 就会被设为 true</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>)</span>&#123; </span><br><span class="line">	res.locals.showTests = app.get(<span class="string">'env'</span>) !== <span class="string">'production'</span> &amp;&amp; req.query.test === <span class="string">'1'</span>; </span><br><span class="line">	next();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>修改模板文件<strong><em>views/layouts/main.handlebars</em></strong>，引入测试框架：</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span> Learn Nodejs <span class="tag">&lt;/<span class="name">title</span>&gt;</span> </span><br><span class="line">&#123;&#123;#if showTests&#125;&#125; <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/vendor/mocha.css"</span> &gt;</span> &#123;&#123;/if&#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"//code.jquery.com/jquery-2.0.2.min.js"</span> &gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/img/logo.jpg"</span> <span class="attr">alt</span>=<span class="string">"Learn Nodejs Logo"</span> &gt;</span><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">&#123;&#123;&#123;body&#125;&#125;&#125; </span><br><span class="line"></span><br><span class="line">&#123;&#123;#if showTests&#125;&#125; </span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"mocha"</span> &gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/vendor/mocha.js"</span> &gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/vendor/chai.js"</span> &gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="actionscript"> mocha.ui(<span class="string">'tdd'</span>); <span class="keyword">var</span> assert = chai.assert; </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/qa/tests-global.js"</span> &gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> </span><br><span class="line">	&#123;&#123;#if pageTestScript&#125;&#125; </span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123;pageTestScript&#125;&#125;"</span> &gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> </span><br><span class="line">	&#123;&#123;/if&#125;&#125; </span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span>&gt;</span> mocha.run(); <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;&#123;/if&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>添加目录 public/qa， 然后在其中创建文件 tests-global.js，tests-about.js：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tests-global.js</span></span><br><span class="line">suite(<span class="string">'Global Tests'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123; </span><br><span class="line">	test(<span class="string">'page has a valid title'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123; </span><br><span class="line">		assert(<span class="built_in">document</span>.title &amp;&amp; <span class="built_in">document</span>.title.match(<span class="regexp">/\S/</span>) &amp;&amp; <span class="built_in">document</span>.title.toUpperCase() !== <span class="string">'TODO'</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// tests-about.js</span></span><br><span class="line">suite(<span class="string">'"About" Page Tests'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">	test(<span class="string">'page should contain link to contact page'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		assert($(<span class="string">'a[href="/contact"]'</span>).length);</span><br><span class="line"></span><br><span class="line">	&#125;);</span><br><span class="line">	 </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>修改index.js中about路由的测试脚本：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/about*'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> randomFortune=fortune.getFortune();</span><br><span class="line"></span><br><span class="line">	res.render(<span class="string">'about'</span>,&#123;<span class="attr">fortune</span> : randomFortune,<span class="attr">pageTestScript</span>: <span class="string">'/qa/tests-about.js'</span>&#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>访问<a href="http://localhost:8080/about?test=1；" target="_blank" rel="noopener">http://localhost:8080/about?test=1；</a></li>
<li>创建跨页面测试（qa/tests-crosspage.js）:</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Browser = <span class="built_in">require</span>(<span class="string">'zombie'</span>), assert = <span class="built_in">require</span>(<span class="string">'chai'</span>).assert;</span><br><span class="line"><span class="keyword">var</span> browser;</span><br><span class="line"></span><br><span class="line">suite(<span class="string">'Cross-page tests'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	setup(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		browser=<span class="keyword">new</span> Browser();</span><br><span class="line">	&#125;);</span><br><span class="line">	test(<span class="string">'require a group'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> reffer=<span class="string">'http:localhost:8080'</span>;</span><br><span class="line">		browser.visit(reffer,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			done();</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>依赖全局mocha，执行下面的命令：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mocha -u tdd -R spec qa/tests-crosspage.js 2&gt;/dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出：</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  Cross-page tests</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    ✓ require a group (41ms)</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  1 passing (46ms)</span></span><br></pre></td></tr></table></figure>

<ol start="11">
<li><p>Mocha 单元测试：</p>
<ol>
<li>创建qa/tests-unit.js:</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fortune = <span class="built_in">require</span>(<span class="string">'../lib/fortune.js'</span>);</span><br><span class="line"><span class="keyword">var</span> expect = <span class="built_in">require</span>(<span class="string">'chai'</span>).expect;</span><br><span class="line"></span><br><span class="line">suite(<span class="string">'Fortune cookie tests'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	test(<span class="string">'getFortune() should return a fortune'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">		expect(<span class="keyword">typeof</span> fortune.getFortune() === <span class="string">'string'</span>);</span><br><span class="line">		 &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>运行命令：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mocha -u tdd -R spec qa/tests-unit.js</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  Fortune cookie tests</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   ✓ getFortune() should <span class="built_in">return</span> a fortune</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1 passing (5ms)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>grunt实现这些任务的自动化：</strong></p>
<ol>
<li>安装grunt：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install -g grunt-cli</span><br><span class="line">npm install --save-dev grunt</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>插件安装：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev grunt-cafe-mocha </span><br><span class="line">npm install --save-dev grunt-contrib-jshint </span><br><span class="line">npm install --save-dev grunt-exec</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在项目下创建一个Gruntfile.js:</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports=<span class="function"><span class="keyword">function</span>(<span class="params">grunt</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	[</span><br><span class="line">		<span class="string">'grunt-cafe-mocha'</span>,</span><br><span class="line">		<span class="string">'grunt-contrib-jshint'</span>,</span><br><span class="line">		<span class="string">'grunt-exec'</span></span><br><span class="line">	].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">task</span>)</span>&#123;</span><br><span class="line">		grunt.loadNpmTasks(task);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	grunt.initConfig(&#123;<span class="attr">cafemocha</span>:&#123;<span class="attr">all</span>:&#123;<span class="attr">src</span>:<span class="string">'qa/tests-*.js'</span>,<span class="attr">option</span>:&#123;<span class="attr">ui</span>:<span class="string">'tdd'</span>&#125;&#125;&#125;,</span><br><span class="line">		jshint:&#123;</span><br><span class="line">			app: [<span class="string">'index.js'</span>,<span class="string">'public/js/**/*.js'</span>,<span class="string">'lib/**/*.js'</span>],</span><br><span class="line">			qa:[<span class="string">'Gruntfile.js'</span>,<span class="string">'publi/qa/**/*.js'</span>,<span class="string">'qa/**/**.js'</span>],</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">&#125;);</span><br><span class="line">	grunt.registerTask(<span class="string">'default'</span>,[<span class="string">'cafemocha'</span>,<span class="string">'jshint'</span>]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>项目里运行grunt。</li>
</ol>
</li>
</ol>
<h2 id="请求和响应"><a href="#请求和响应" class="headerlink" title="请求和响应"></a>请求和响应</h2><ol>
<li>URL组成部分：<a href="http://localhost:8080/search?test=1#history" target="_blank" rel="noopener">http://localhost:8080/search?test=1#history</a><ol>
<li>协议：确定如何传输请求，比如http</li>
<li>主机名： 标识服务器，比如本地服务器localhost</li>
<li>端口：8080</li>
<li>路径：/search</li>
<li>查询字符串：一种键值对集合，是可选的。它以问号（?）开头，键值对则以与号（&amp;）分隔开</li>
<li>信息片段：信息片段 （或 散列 ）被严格限制在浏览器中使用，不会传递到服务器，如#history</li>
</ol>
</li>
<li>HTTP协议确定了客户端与服务器通信的 <strong>请求方法</strong> 集合（HTTP verbs）；</li>
<li>请求报头：服务器因请求得知优先响应哪种语言的页面，所有能够确保你了解请求对象头文件属性的信息都将会作为请求报头发送；</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/header'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">	res.set(<span class="string">'Content-Type'</span>,<span class="string">'text/plain'</span>);</span><br><span class="line">	<span class="keyword">var</span> s=<span class="string">''</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> name <span class="keyword">in</span> req.headers)&#123;</span><br><span class="line">		s += name + <span class="string">': '</span> + req.headers[name] + <span class="string">'\n'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	res.send(s);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 浏览器访问输出：</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">host: localhost:8080</span></span><br><span class="line"><span class="comment"> connection: keep-alive</span></span><br><span class="line"><span class="comment">upgrade-insecure-requests: 1</span></span><br><span class="line"><span class="comment">user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.122 Safari/537.36</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">**/</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>响应报头：当服务器响应时，会回传一些浏览器没必要渲染和显示的信息，通常是元数据和服务器信息：</p>
<ol>
<li>告诉浏览器正在被传输的内容类型（网页、图片、样式表、客户端脚本等）</li>
<li>根据内容类型报头处理信息</li>
<li>指出响应信息是否被压缩，以及使用的是哪种编码</li>
<li>可以包含关于浏览器对资源缓存时长的提示</li>
<li>包含一些关于服务器的信息</li>
</ol>
</li>
<li><p>查看报头信息：</p>
<ol>
<li>打开开发者工具</li>
<li>选择Network，然后刷新页面</li>
<li>选择header可以看到报头信息</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">host: localhost:8080</span><br><span class="line">connection: keep-alive</span><br><span class="line">cache-control: max-age=0</span><br><span class="line">upgrade-insecure-requests: 1</span><br><span class="line">user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.122 Safari/537.36</span><br><span class="line">accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>请求对象，通常命名为 req：</strong></p>
<ol>
<li>req.params：一个数组，包含命名过的路由参数</li>
<li><del>req.param(name)：返回命名的路由参数，或者 GET 请求或 POST 请求参数</del></li>
<li>req.query：一个对象，包含以键值对存放的查询字符串参数（请求中的?后面带的内容）</li>
<li>req.body：一个对象， 包含 POST 请求参数</li>
<li><strong><em>req.route：关于当前匹配路由的信息，主要用于路由调试</em></strong></li>
<li>req.cookies/req.singnedCookies：一个对象，包含从客户端传递过来的cookies值</li>
<li>req.headers：从客户端接收到的请求报头</li>
<li>req.accepts([types])：一个简便的方法， 用来确定客户端是否接受一个或一组指定的类型</li>
<li>req.ip：客户端的 IP 地址</li>
<li>req.path：请求路径（不包含协议、主机、端口或查询字符串）</li>
<li>req.host：一个简便的方法，用来返回客户端所报告的主机名</li>
<li>req.xhr：一个简便属性，如果请求由 Ajax 发起将会返回true</li>
<li>req.protocol：用于标识请求的协议（ http 或 https）</li>
<li>req.secure：一个简便属性，如果连接是安全的，将返回 true 。等同于 req.protocol===’https’</li>
<li>req.url/req.originalUrl：返回了路径和查询字符串</li>
<li>req.acceptedLanguages：一个简便方法，用来返回客户端首选的一组（人类的）语言</li>
</ol>
</li>
<li><p><strong>响应对象，通常命名为res：</strong></p>
<ol>
<li>res.status(code)：设置HTTP状态码，Express 默认为 200（成功）</li>
<li>res.set(name,value)：设置响应头。这通常不需要手动设置</li>
<li>res.cookie（name,vaue,[options]）,res.clearCookie(name,[options])：设置或清除客户端cookies值，需要中间件支持</li>
<li>res.redirect([status],url)：重定向浏览器。默认重定向代码是 302 （建立），应尽量减少重定向，除非永久移动一个页面，这种情况应当使用代码 301 （永久移动）</li>
<li>res.send(body),res.send(status,body)：向客户端发送响应及可选的状态码</li>
<li>res.json(json),res.json(status,json)：向客户端发送 JSON 以及可选的状态码</li>
<li>res.jsonp(json),req.jsonp(status,json)：向客户端发送 JSONP 及可选的状态码</li>
<li>res.type(type)：用于设置 Content-Type 头信息</li>
<li><strong><em>res.format(object)：允许根据接收请求报头发送不同的内容</em></strong></li>
<li>res.attachment([filename]),res.download(path,[filename],[callback])：将响应报头 Content-Disposition 设为 attachment ， 这样浏览器就会选择下载而不是展现内容</li>
<li>res.sendFile(path,[option],[callback])：根据路径读取指定文件并将内容发送到客户端</li>
<li>res.links(links)：设置链接响应报头，这是一个专用的报头，在大多数应用程序中几乎没有用处</li>
<li>res.locals,res.render(view,[locals],callback)：res.locals 是一个对象， 包含用于渲染视图的 默认上下文，res.render使用配置的模板引擎渲染视图</li>
</ol>
</li>
</ol>
<h2 id="Handlebars模板引擎"><a href="#Handlebars模板引擎" class="headerlink" title="Handlebars模板引擎"></a>Handlebars模板引擎</h2><ol>
<li>模板解决了在目标语言中编写代码的问题， 同时也让插入动态数据成为了可能；</li>
<li>模板引擎的选择标准：<ol>
<li>性能</li>
<li>客户端、服务端或兼而有之？</li>
<li>抽象</li>
</ol>
</li>
<li>Jade 就以抽象 HTML 细节而引人注目，依赖缩进和一些常识性规则， 从而更容易表达出自己想要的；</li>
<li>当渲染一个模板时，便会传递给模板引擎一个对象，叫作 上下文对象 ，它能让替换标识运行。<strong>使用三重大括号关闭 HTML 转义的功能具有一些重要用途；</strong></li>
<li>Handlebars 的注释:</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;! This comment will not be <span class="keyword">in</span> the output &#125;&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li><strong>块级表达式提供了流程控制、条件执行和可扩展性</strong>,需要使用上下文来解释，相对来说比较复杂；</li>
<li>服务器端模板会在 HTML 发送到客户端之前渲染它，除了隐藏实现细节，还支持模板缓存，视图缓存会在开发模式下禁用，在生产模式下启用。如果想显式地启用视图缓存，app.set(‘view cache’, true);</li>
<li><strong><em>扩展名改成同样常见的 .hbs；</em></strong></li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'express-handlebars'</span>).create(&#123; <span class="attr">extname</span>: <span class="string">'.hbs'</span> &#125;)</span><br></pre></td></tr></table></figure>



<ol start="10">
<li><strong>视图</strong> 通常表现为网站上的各个页面，默认情况下， Express 会在 views 子目录中查找视图；</li>
<li>布局** 是一种特殊的视图,是一个用于模板的模板,比如上面使用的views/layouts/main.hadlebars；<strong><em>模板里的 body在哪里放置并没有限制</em></strong></li>
<li>视图首先被渲染， 之后是布局，它允许视图本身进一步自定义布局；***</li>
<li>默认情况下， Express 会在 views 子目录中查找视图，在 views/layouts 下查找布局；当然可以在视图中指定使用的layout，比如不使用：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不使用布局，那么必须在视图中拥有样板文件</span></span><br><span class="line">app.get(<span class="string">'/foo'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">  res.render(<span class="string">'foo'</span>, &#123; <span class="attr">layout</span>: <span class="literal">null</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定布局,会使用布局views/layouts/another.handlebars来渲染视图</span></span><br><span class="line">app.get(<span class="string">'/foo'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">  res.render(<span class="string">'foor'</span>,&#123;<span class="attr">layout</span>:<span class="string">'another'</span>&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="14">
<li>有些组成部分需要在不同的页面重复使用，默认情况下局部文件放在views/partials子目录下，不想让个别的视图干扰指定的上下文，于是将所有的局部文件上下文都放在 partials 对象中；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">语法 &#123;&#123;&gt; partial_name&#125;&#125; 可以让你在视图中包含一个局部文件，express-handlebars 会在 views/partials 中寻找一个叫作 partial_name.handle-bars 的视图，支持子目录，可以将它们放在 views/partials/social目录下面，然后使用 &#123;&#123;&gt; social/partial_name&#125;&#125;；</span><br></pre></td></tr></table></figure>

<ol start="15">
<li><p>实例化 Handlebars 对象时， 会添加一个叫作section 的辅助方法；</p>
</li>
<li><p>模板加主题可以使得网站的一致性以及美观性大大提高，但是注意不是模板越多越好，需要去权衡！</p>
</li>
</ol>
<h2 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h2><ol>
<li><p><strong>HTTPS访问：</strong></p>
<ol>
<li>生成自己的证书：brew install openssl （如果没有安装的话）</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout meadowlark.pem -out meadowlark.crt</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将生成的公钥和私钥移动到目录的ssl目录下；</li>
<li>修改index.js:</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//"use strict";</span></span><br><span class="line"><span class="keyword">var</span> express=<span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> fortune=<span class="built_in">require</span>(<span class="string">'./lib/fortune.js'</span>);</span><br><span class="line"><span class="keyword">var</span> https = <span class="built_in">require</span>(<span class="string">'https'</span>);</span><br><span class="line"><span class="keyword">var</span> fs=<span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">	key: fs.readFileSync(__dirname + <span class="string">'/ssl/meadowlark.pem'</span>),</span><br><span class="line">	cert: fs.readFileSync(__dirname + <span class="string">'/ssl/meadowlark.crt'</span>)</span><br><span class="line">&#125;;</span><br><span class="line">app.set(<span class="string">'port'</span>,process.env.PORT||<span class="number">443</span>);</span><br><span class="line"><span class="comment">// 省略其他部分</span></span><br><span class="line">https.createServer(options, app).listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> <span class="built_in">console</span>.log(<span class="string">'Express started in '</span> + app.get(<span class="string">'env'</span>) + <span class="string">' mode on port '</span> + app.get(<span class="string">'port'</span>) + <span class="string">'.'</span>);</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用Safari浏览器访问：<a href="https://localhost；注意谷歌浏览器是没法让你访问的，可以申请认证机构的证书去访问，但这里只是学习！" target="_blank" rel="noopener">https://localhost；注意谷歌浏览器是没法让你访问的，可以申请认证机构的证书去访问，但这里只是学习！</a></li>
</ol>
</li>
<li><p><strong>跨站请求伪造：</strong></p>
<ol>
<li><p>跨站请求伪造（CSRF）攻击利用了用户一般都会相信浏览器并且在同一个会话中访问多个网站这样的事实；</p>
</li>
<li><p>要防范 CSRF 攻击， 必须想办法确保请求合法地来自自己的网站，可以给浏览器传一个唯一的令牌；</p>
</li>
<li><p>csurf中间件可以产生令牌以及验证令牌：</p>
<ol>
<li>安装：npm install –save csurf</li>
<li>引入：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个必须放在 cookie-parser 和 connect-session 的引入之后 </span></span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'csurf'</span>)()); </span><br><span class="line">app.use( <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">	res.locals._csrfToken = req.csrfToken();</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>csurf 中间件添加了 csurfToken 方法到请求对象上,不一定非要把它赋给 res.locals ，可以将 req.csurfToken() 直接传给需要它的视图，但这个工作量一般更小</li>
<li>如果 body 中的域没有有效的 _csrf 域，它会引发一个错误（确保你的中间件里有错误路由！）</li>
</ol>
</li>
<li><p>Passport 是为 Node/Express 做的认证模块，非常健壮；</p>
<ol>
<li>安装：npm install –save passport</li>
<li>第三方认证：<strong>TODO</strong></li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="Express和MVC"><a href="#Express和MVC" class="headerlink" title="Express和MVC"></a>Express和MVC</h2><ol>
<li>模型 - 视图 - 控制器（MVC）最大的优势之一是它减少了项目的学习时间！在 MVC 中， 模型 是“纯粹”的数据和逻辑，根本不关心自己跟用户之间的交互；视图将模型传递给用户，而控制器则接受用户输入，处理模型，选择要显示哪个（些）视图；</li>
<li>变体：微软的“模型 - 视图 - 视图模型”（MVVM），视图模型的想法是说它是模型的转化，可以“保护”模型；</li>
<li>模型绝对是最最重要的组件，模型是项目的基石；模型中的逻辑严重依赖于持久性，把这两层分开可能得不偿失；</li>
<li><strong>建议在项目中创建一个叫 models 的子目录来存放模型，只要有要实现的逻辑，或要存储的数据，都应该在 models 目录下的文件里完成；</strong></li>
<li>视图模型是保持模型抽象性的办法，同时还能为视图提供有意义的数据;</li>
<li>控制器负责处理用户交互，并根据用户交互选择恰当的视图来显示，控制器和路由器之间唯一的区别是控制器一般会把相关功能归组；</li>
<li>能限制选择的只有想象力了，如果想把控制器从路由中完全剥离出来，肯定可以那么做！</li>
</ol>
<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><ol>
<li>从用户那里收集信息的常用方法就是使用 HTML 表单 ；</li>
<li>向服务器发送客户端数据有两种方式： 查询字符串和请求正文</li>
</ol>
<ul>
<li>使用查询字符串， 就发起了一个 GET 请求  </li>
<li>使用请求正文， 就发起了一个 POST 请求  </li>
</ul>
<ol start="3">
<li>从服务器的角度来看， 最重要的属性是 <input> 域中的 name 属性， 这样服务器才能识别字段；name 属性与 id 属性是截然不同的， 后者只适用于样式和前端功能，id是不会发送到服务端的；    </li>
<li>注意隐藏域： 它不会呈现在浏览器中。 但是， 你不能使用它存放秘密和敏感信息： 用户只要查看页面源文件， 隐藏域就会暴露出来；   </li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/process"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"hush"</span> <span class="attr">val</span>=<span class="string">"hidden, but not secret!"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"fieldColor"</span>&gt;</span>Your favorite color: <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"fieldColor"</span> <span class="attr">name</span>=<span class="string">"color"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>HTML 并不会限制在同一个页面上有多个表单 ,一个表单应该只包含你想要提交的字段；如果一个页面上有两个不同的 action， 请使用两个不同的表单 ；</li>
<li>当表单被提交时， 某种程度上它必须被编码；处理表单时有两件事需要考虑：   </li>
</ol>
<ul>
<li>处理表单是哪个路径（action）  </li>
<li>向浏览器发出怎样的响应  </li>
<li>如果你的表单使用的是 method=”POST”（推荐使用）， 那么展现表单和处理表单通常使用相同的路径，采用这种方法， 就可以省略表单上的 action 属性  ；</li>
<li>使用一个单独的路径处理表单 ，则要使用路径来处理表单；</li>
</ul>
<ol start="7">
<li>响应浏览器：</li>
</ol>
<ul>
<li>直接响应HTML  </li>
<li><del>302重定向</del>  </li>
<li>303重定向  ：<ul>
<li>重定向到专用的成功/失败页面  </li>
<li>运用flash消息重定向到原位置  </li>
<li>运用flash消息重定向到新位置  </li>
</ul>
</li>
</ul>
<h2 id="Express表单处理"><a href="#Express表单处理" class="headerlink" title="Express表单处理"></a>Express表单处理</h2><ol>
<li>如果使用 GET 进行表单处理， 表单域在 req.query 对象中，例如， 如果有一个名称属性为email 的 HTML 输入字段， 它的值会以 req.query.email 的形式传递到处理程序  ； </li>
<li>如果使用 POST（推荐使用的）， 需要引入中间件来解析 URL 编码体，首先， 安装 body-parser中间件（npm install –save body-parser）， 然后引入：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'body-parser'</span>)());</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>一旦引入了 body-parser，  req.body将变为可用， 这样所有的表单字段将可用  </li>
<li>为用户提供真正别出心裁的文件上传， 可拖拽， 可以看到上传文件缩略图， 并查看进度条， 那我向你推荐 Sebastian Tschan 的 jQuery File Upload；</li>
<li>要显示文件缩略图， jquery-file-upload-middleware 使 用 ImageMagick；</li>
<li>安装 jquery-file-upload-middleware 包（npm install  –save jquery-file-upload-middleware），然后在你的应用文件中添加以下代码：  </li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jqupload = <span class="built_in">require</span>(<span class="string">'jquery-file-upload-middleware'</span>);</span><br><span class="line">app.use(<span class="string">'/upload'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line"><span class="keyword">var</span> now = <span class="built_in">Date</span>.now();</span><br><span class="line">jqupload.fileHandler(&#123;</span><br><span class="line">uploadDir: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> __dirname + <span class="string">'/public/uploads/'</span> + now;</span><br><span class="line">&#125;,</span><br><span class="line">uploadUrl: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">'/uploads/'</span> + now;</span><br><span class="line">&#125;,</span><br><span class="line">&#125;)(req, res, next);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="REST"><a href="#REST" class="headerlink" title="REST"></a>REST</h2><ol>
<li>REST 表示“表述性状态传输”（Representational State Transfer），来形容满足 REST 原则的 Web 服务，REST 基本上就是客户端和服务器端的无状态连接；</li>
<li>在实现REST之前， 需要先把 API 规划好，比如景点型网站：</li>
</ol>
<ul>
<li>GET /api/attractions    获取景点 ，以lat、 lng 和 radius 为查询字符串参数， 返回一个景点列表  </li>
<li>GET /api/attraction/:id  根据 ID 返回一处景点  </li>
<li>POST /api/attraction   以 lat、 lng、 name、 description 和 email 为请求体添加新的景点  </li>
<li>PUT /api/attraction/:id   更新一处已有的景点 ， 参数为景点的 ID、 lat、 lng、 name、 description 和 email  </li>
<li>DEL /api/attraction/:id   删除景点，参数为景点 ID、 email 和 reason  </li>
</ul>
<ol start="3">
<li>用 HTTP 方法和路径的组合来区分 API 调用， 并用查询字符串和请求主体参数混合的方式传递数据；</li>
<li>跨域资源共享（CORS）通过 Access-Control-Allow-Origin 响应头实现，在 Express 程序中最容易的实现方式是用 cors 包（npm install –save cors） ：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'cors'</span>)());</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>需要一种实际调用 REST API 的办法 ,要用到 Node 包 restler：  </li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev restler</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>在 qa/tests-api.js 中实现对 API 的测试：  </li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'chai'</span>).assert;</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> rest = <span class="built_in">require</span>(<span class="string">'restler'</span>);</span><br><span class="line">suite(<span class="string">'API tests'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">var</span> attraction = &#123;</span><br><span class="line">lat: <span class="number">45.516011</span>,</span><br><span class="line">lng: <span class="number">-122.682062</span>,</span><br><span class="line">name: <span class="string">'Portland Art Museum'</span>,</span><br><span class="line">description: <span class="string">'Founded in 1892, the Portland Art Museum\'s colleciton '</span> +</span><br><span class="line"><span class="string">'of native art is not to be missed. If modern art is more to your '</span> +</span><br><span class="line"><span class="string">'liking, there are six stories of modern art for your enjoyment.'</span>,</span><br><span class="line">email: <span class="string">'test@meadowlarktravel.com'</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> base = <span class="string">'http://localhost:3000'</span>;</span><br><span class="line">test(<span class="string">'should be able to add an attraction'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line">rest.post(base+<span class="string">'/api/attraction'</span>, &#123;<span class="attr">data</span>:attraction&#125;).on(<span class="string">'success'</span>,</span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">assert.match(data.id, /\w/, <span class="string">'id must be set'</span>);</span><br><span class="line">done();</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">test(<span class="string">'should be able to retrieve an attraction'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line">rest.post(base+<span class="string">'/api/attraction'</span>, &#123;<span class="attr">data</span>:attraction&#125;).on(<span class="string">'success'</span>,</span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">rest.get(base+<span class="string">'/api/attraction/'</span>+data.id).on(<span class="string">'success'</span>,</span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">assert(data.name===attraction.name);</span><br><span class="line">assert(data.description===attraction.description);</span><br><span class="line">done();</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>connect-rest 模块会检查每一个请求， 向请求对象中添加属性， 还会做额外的日志记录（npm install –save connect-rest  ）（var rest = require(‘connect-rest’);  ）；    </li>
</ol>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><ol>
<li><p>中间件是一种功能的封装方式，封装在程序中处理 HTTP 请求的功能 ；</p>
</li>
<li><p>如果不调用 next()， 请求就在那个中间件中终止了；</p>
</li>
<li><p>重点知识：</p>
<ol>
<li>路由处理器（app.get、 app.post 等， 经常被统称为 app.VERB） 可以被看作只处理特定HTTP 谓词（GET、 POST 等） 的中间件；</li>
<li>路由处理器的第一个参数必须是路径，如果你想让某个路由匹配所有路径， 只需用 /*； </li>
<li>路由处理器和中间件的参数中都有回调函数， 这个函数有 2 个、 3 个或 4 个参数；   </li>
<li>如果不调用 next()， 管道就会被终止， 也不会再有处理器或中间件做后续处理；</li>
<li>如果调用了 next()， 一般不宜再发送响应到客户端 ；  </li>
</ol>
</li>
<li><p>Connect通常把它和 Express 一起安装（npm install –save connect）， 并使它在你的程序中可以访问到（var connect = require(connect);）</p>
</li>
</ol>
<ul>
<li>basicAuth （app.use(connect.basicAuth)();）  提供基本的访问授权  </li>
<li>body-parser（npm install –save body-parser, app.use(require(body- parser)());）  只连入 json 和 urlencoded 的便利中间件  </li>
<li>json（参见body-parser）  解析 JSON 编码的请求体  </li>
<li>urlencoded（参见body-parser）  解析互联网媒体类型为 application/x-www-form-urlencoded 的请求体  </li>
<li><del>multipart（已废弃）  解析互联网媒体类型为 multipart/form-data 的请求体</del>  </li>
<li>compress（app.use(connect.compress);）  用 gzip 压缩响应数据  </li>
<li>cookie-parser（npm install –save cookie-parser, app.use(require(cookie-parser)   提供对 cookie 的支持  </li>
<li>cookie-session（npm install –save cookie-session, app.use(require(cookiesession)()); ）  提供 cookie 存储的会话支持   </li>
<li>express-session（npm install –save express-session, app.use(require(expresssession)());）  提供会话 ID（ 存在 cookie 里） 的会话支持  </li>
<li>csurf（npm install –save csurf, app.use(require(csurf)());）   防范跨域请求伪造（CSRF） 攻击  </li>
<li>directory（app.use(connect.directory());）  提供静态文件的目录清单支持  </li>
<li>errorhandler（npm install –save errorhandler, app.use(require(errorhandler)());）   为客户端提供栈追踪和错误消息  </li>
<li>static-favicon（npm install –save static-favicon, app.use(require(staticfavicon)(path_to_favicon));）   提供 favicon（出现在浏览器标题栏上的图标）  </li>
<li>morgan（之前的logger, npm install –save morgan, app.use(require(morgan)());）   提供自动日志记录支持： 所有请求都会被记录  </li>
<li>method-override（npm install –save method-override, app.use(require(methodoverride)());）   提供对 x-http-method-override 请求头的支持， 允许浏览器“假装” 使用除 GET 和 POST之外的 HTTP 方法  </li>
<li>query      解析查询字符串， 并将其变成请求对象上的 query 属性  </li>
<li>response-time（npm install –save response-time, app.use(require(response-time)<br>());）    向响应中添加 X-Response-Time 头， 提供以毫秒为单位的响应时间  </li>
<li>static（app.use(express.static(path_to_static_files)());）  提供对静态（public） 文件的支持  </li>
<li>vhost（npm install –save vhost, var vhost = require(vhost);）    虚拟主机（vhost）， 这个术语是从 Apache 借来的， 它可使子域名在 Express 中更容易管理  </li>
</ul>
<ol start="5">
<li>用Node 模块 loadtest 做压力测试（npm install –save loadtest  ） ：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// qa/tests-stress.js</span></span><br><span class="line"><span class="keyword">var</span> loadtest = <span class="built_in">require</span>(<span class="string">'loadtest'</span>);</span><br><span class="line"><span class="keyword">var</span> expect = <span class="built_in">require</span>(<span class="string">'chai'</span>).expect;</span><br><span class="line">suite(<span class="string">'Stress tests'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">test(<span class="string">'Homepage should handle 100 requests in a second'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">url: <span class="string">'http://localhost:3000'</span>,</span><br><span class="line">concurrency: <span class="number">4</span>,</span><br><span class="line">maxRequests: <span class="number">100</span></span><br><span class="line">&#125;;</span><br><span class="line">loadtest.loadTest(options, <span class="function"><span class="keyword">function</span>(<span class="params">err,result</span>)</span>&#123;</span><br><span class="line">expect(!err);</span><br><span class="line">expect(result.totalTimeSeconds &lt; <span class="number">1</span>);</span><br><span class="line">done();</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>邮箱插件Nodemailer（npm install –save nodemailer  ）</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nodemailer = <span class="built_in">require</span>(<span class="string">'nodemailer'</span>);</span><br><span class="line"><span class="keyword">var</span> mailTransport = nodemailer.createTransport(<span class="string">'SMTP'</span>,&#123;</span><br><span class="line">service: <span class="string">'Gmail'</span>,</span><br><span class="line">auth: &#123;</span><br><span class="line">user: credentials.gmail.user,</span><br><span class="line">pass: credentials.gmail.password,</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// SMTP 服务器</span></span><br><span class="line"><span class="keyword">var</span> mailTransport = nodemailer.createTransport(<span class="string">'SMTP'</span>,&#123;</span><br><span class="line">host: <span class="string">'smtp.meadowlarktravel.com'</span>,</span><br><span class="line">secureConnection: <span class="literal">true</span>, <span class="comment">// 用 SSL 端口 : 465</span></span><br><span class="line">auth: &#123;</span><br><span class="line">user: credentials.meadowlarkSmtp.user,</span><br><span class="line">pass: credentials.meadowlarkSmtp.password,</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送邮件</span></span><br><span class="line">mailTransport.sendMail(&#123;</span><br><span class="line"><span class="keyword">from</span>: <span class="string">'"Meadowlark Travel" &lt;info@meadowlarktravel.com&gt;'</span>,</span><br><span class="line">to: <span class="string">'joecustomer@gmail.com'</span>,</span><br><span class="line">subject: <span class="string">'Your Meadowlark Travel Tour'</span>,</span><br><span class="line">text: <span class="string">'Thank you for booking your trip with Meadowlark Travel.'</span>+</span><br><span class="line"><span class="string">'We look forward to your visit!'</span>,</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(err) <span class="built_in">console</span>.error( <span class="string">'Unable to send email: '</span> + error );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>将邮件作为网站监测工具 ：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(err)&#123;</span><br><span class="line">email.sendError(<span class="string">'the widget broke down!'</span>, __filename);</span><br><span class="line"><span class="comment">// ……给用户显示错误消息</span></span><br><span class="line">&#125; /</span><br><span class="line">/ 或者</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// 在这里做些不确定的事情……</span></span><br><span class="line">&#125; <span class="keyword">catch</span>(ex) &#123;</span><br><span class="line">email.sendError(<span class="string">'the widget broke down!'</span>, __filename, ex);</span><br><span class="line"><span class="comment">// ……给用户显示错误消息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Cookie与会话"><a href="#Cookie与会话" class="headerlink" title="Cookie与会话"></a>Cookie与会话</h2><ol>
<li>Web 工作的方式就是在每个 HTTP 请求中都要包含所有必要的信息， 服务器才能满足这个请求；    </li>
<li>cookie的了解：</li>
</ol>
<ul>
<li>cookie对用户来说不是加密的  </li>
<li>用户可以删除或禁用cookie  </li>
<li>一般的cookie可以被篡改  </li>
<li>cookie可以用于攻击  </li>
<li>如果你滥用cookie， 用户会注意到  </li>
<li>如果可以选择， 会话要优于cookie  </li>
</ul>
<ol start="3">
<li>在程序中开始设置和访问 cookie 之前， 需要先引入中间件 cookie-parser<ol>
<li>首先 npm  install –save cookie-parser：</li>
<li>准备写入文件内容；</li>
<li>cookie：</li>
</ol>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件credentials.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">	cookieSecret: <span class="string">' 把你的 cookie 秘钥放在这里 '</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> credentials = <span class="built_in">require</span>(<span class="string">'./credentials.js'</span>);</span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'cookie-parser'</span>)(credentials.cookieSecret));	</span><br><span class="line"></span><br><span class="line"><span class="comment">//cookie</span></span><br><span class="line">res.cookie(<span class="string">'monster'</span>, <span class="string">'nom nom'</span>);</span><br><span class="line">res.cookie(<span class="string">'signed_monster'</span>, <span class="string">'nom nom'</span>, &#123; <span class="attr">signed</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除 cookie</span></span><br><span class="line">res.clearCookie(<span class="string">'monster'</span>);</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>cookie选项：</li>
</ol>
<ul>
<li>domain：控制跟 cookie 关联的域名，可以将 cookie 分配给特定的子域名  ；</li>
<li>path：控制应用这个 cookie 的路径；</li>
<li>maxAge：指定客户端应该保存 cookie 多长时间， 单位是毫秒 ； </li>
<li>secure：指定该 cookie 只通过安全（HTTPS） 连接发送 ；  </li>
<li>httpOnly ：将这个选项设为 true 表明这个 cookie 只能由服务器修改 ；</li>
<li>signed ：设为 true 会对这个 cookie 签名， 这样就需要用 res.signedCookies 而不是 res.cookies访问它  </li>
</ul>
<ol start="5">
<li>会话实际上只是更方便的状态维护方法，要实现会话， 必须在客户端存些东西 ，通常的做法是用一个包含唯一标识的 cookie， 然后服务器用这个标识获取相应的会话信息；</li>
</ol>
<ul>
<li>安 装 express-session（npm install –save express-session）；</li>
<li>在 链 入cookie-parser 之后链入 express-session  ：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'cookie-parser'</span>)(credentials.cookieSecret));</span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'express-session'</span>)());</span><br></pre></td></tr></table></figure>

<ul>
<li>中间件 express-session 接受带有如下选项的配置对象 :<ul>
<li>key     存放唯一会话标识的 cookie 名称  </li>
<li>store     会话存储的实例  </li>
<li>cookie     会话 cookie 的 cookie 设置（path、 domain、 secure 等）  </li>
</ul>
</li>
</ul>
<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><ol>
<li>路由是将请求（由 URL 和 HTTP 方法指定） 路由到处理它们的代码去的一种机制；</li>
<li>建议：</li>
</ol>
<ul>
<li>绝不在 URL 中暴露技术细节  </li>
<li>避免在 URL 中出现无意义的信息  </li>
<li>避免无谓的长 URL  </li>
<li>单词分隔符要保持一致  </li>
<li>绝不要用空格或不可录入的字符  </li>
<li>在 URL 中用小写字母  </li>
</ul>
<ol start="3">
<li>路由中指定的路径（比如 /foo） 最终会被 Express 转换成一个正则表达式， 某些正则表达式中的元字符可以用在路由路径中： +、 ?、 *、 ( 和 )  </li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> staff = &#123;</span><br><span class="line">portland: &#123;</span><br><span class="line">mitch: &#123; <span class="attr">bio</span>: <span class="string">'Mitch is the man to have at your back.'</span> &#125;,</span><br><span class="line">madeline: &#123; <span class="attr">bio</span>: <span class="string">'Madeline is our Oregon expert.'</span> &#125;,</span><br><span class="line">&#125;,</span><br><span class="line">bend: &#123;</span><br><span class="line">walt: &#123; <span class="attr">bio</span>: <span class="string">'Walt is our Oregon Coast expert.'</span> &#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br><span class="line">app.get(<span class="string">'/staff/:city/:name'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line"><span class="keyword">var</span> info = staff[req.params.city][req.params.name];</span><br><span class="line"><span class="keyword">if</span>(!info) <span class="keyword">return</span> next(); <span class="comment">// 最终将会落入 404</span></span><br><span class="line">res.render(<span class="string">'staffer'</span>, info);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>路由的指导原则 :  </li>
</ol>
<ul>
<li>给路由处理器用命名函数  </li>
<li>路由不应该神秘  </li>
<li>路由组织应该是可扩展的  </li>
<li>不要忽视自动化的基于视图的路由处理器  </li>
</ul>
<ol start="5">
<li>最流行的两种路由组织方式是命名空间路由（namespaced routing） 和随机应变路由（resourceful routing）;</li>
</ol>
<ul>
<li>随机应变路由基于一个对象中的方法自动添加路由，express-resource 包是如何实现这种路由组织风格的范例      </li>
</ul>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><ol>
<li>Node 有个内置的调试器，允许你逐步执行程序，只需要在启动程序时加上 debug 参数就可以开始调试了，会开启调试端口；</li>
<li>node探查器：npm install -g node-inspector</li>
<li>只需要用 –debug-brk 代替 –debug，调试器会在程序的第一行停住，然后你就可以单步执行，或者设置合适的断点；</li>
<li>调试是一个逐渐积累的过程，也是评估你是不是个优秀的程序员的重点之一，不是那种人肉执行机器，那你还是好好的调试你的代码！</li>
</ol>
<h2 id="管理自己的npm库（私库）"><a href="#管理自己的npm库（私库）" class="headerlink" title="管理自己的npm库（私库）"></a>管理自己的npm库（私库）</h2><ol>
<li>对公共包的请求转发到公众库，而私有包从它自己的数据库中提供：</li>
</ol>
<ol start="2">
<li><p>Sinopia 的安装极其容易，除了支持私有包，它还为你的组织提供了一个方便的缓存；</p>
</li>
<li><p>npm 的配置只能支持一个存储库，一旦“切换到”Sinopia（用 npm set registry 和npm adduser），切换回npm公库使用npm set registry <a href="https://registry.npmjs.org/" target="_blank" rel="noopener">https://registry.npmjs.org/</a> ，或者直接删掉 ~/.npmjs；</p>
</li>
</ol>
<h2 id="创建中间件"><a href="#创建中间件" class="headerlink" title="创建中间件"></a>创建中间件</h2><ol>
<li><p>编写中间件不是什么巨大的、可怕的、复杂的事情；</p>
</li>
<li><p>构造模块的方式可以创建私有功能， 让调用者无法访问；</p>
</li>
<li><p>模块直接输出中间件函数：</p>
<ol>
<li>如果中间件不需要配置对象，用这个方法：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>)</span>&#123; </span><br><span class="line">  <span class="comment">// 中间件在这里……记得调用 next() 或 next('route') </span></span><br><span class="line">  <span class="comment">// 除非这个中间件是终点 </span></span><br><span class="line">  next(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用这个中间件：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stuff = <span class="built_in">require</span>(<span class="string">'meadowlark-stuff'</span>);</span><br><span class="line">app.use(stuff);</span><br></pre></td></tr></table></figure>
</li>
<li><p>模块输出返回中间件的函数:</p>
<ol>
<li>如果中间件需要配置对象或者其他信息，用这个方法：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">config</span>)</span>&#123; </span><br><span class="line">  <span class="comment">// 如果没有传入配置对象 </span></span><br><span class="line">  <span class="comment">// 一般会创建一个： </span></span><br><span class="line">  <span class="keyword">if</span> (!config) config = &#123;&#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>)</span>&#123; </span><br><span class="line">    <span class="comment">// 中间件在这里……记得调用 next() 或 next('route')</span></span><br><span class="line">    <span class="comment">// 除非这个中间件是终点 </span></span><br><span class="line">    next();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用这个中间件：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stuff = <span class="built_in">require</span>(<span class="string">'meadowlark-stuff'</span>)(&#123; <span class="attr">option</span>: <span class="string">'my choice'</span> &#125;);</span><br><span class="line">app.use(stuff);</span><br></pre></td></tr></table></figure>
</li>
<li><p>模块输出包含中间件的对象:</p>
<ol>
<li>如果要输出多个相互关联的中间件，用这个办法：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">config</span>)</span>&#123; </span><br><span class="line">  <span class="comment">// 如果没有传入配置对象 </span></span><br><span class="line">  <span class="comment">// 一般会创建一个： </span></span><br><span class="line">  <span class="keyword">if</span> (!config) config = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  m1: <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>)</span>&#123; </span><br><span class="line">    <span class="comment">// 中间件在这里……记得调用 next() 或 next('route')</span></span><br><span class="line">    <span class="comment">// 除非这个中间件是终点</span></span><br><span class="line">    next(); &#125;, </span><br><span class="line">  m2: <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">		next(); &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用这个中间件：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stuff = <span class="built_in">require</span>(<span class="string">'meadowlark-stuff'</span>)(&#123; <span class="attr">option</span>: <span class="string">'my choice'</span> &#125;);</span><br><span class="line">app.use(stuff.m1); </span><br><span class="line">app.use(stuff.m2);</span><br></pre></td></tr></table></figure>
</li>
<li><p>模块输出对象构造器:</p>
<ol>
<li>如果中间件非常适合用面向对象的方式实现，这个方法就比较好用:</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Stuff</span>(<span class="params">config</span>)</span>&#123; <span class="keyword">this</span> .config = config || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Stuff.prototype.m1 = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 注意：'this' 不是你想要的实例；不要用它</span></span><br><span class="line">  next();</span><br><span class="line"></span><br><span class="line">&#125;; Stuff.prototype.m2 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们用 Function.prototype.bind 将这个实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 关联到 'this' 属性上</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (<span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 现在 'this' 是 Stuff 实例了 </span></span><br><span class="line">  next();</span><br><span class="line">&#125;).bind( <span class="keyword">this</span> ); );</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Stuff;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用这个中间件：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Stuff = <span class="built_in">require</span>(<span class="string">'meadowlark-stuff'</span>); </span><br><span class="line"><span class="keyword">var</span> stuff = <span class="keyword">new</span> Stuff(&#123; <span class="attr">option</span>: <span class="string">'my choice'</span> &#125;);</span><br><span class="line">app.use(stuff.m1); </span><br><span class="line">app.use(stuff.m2());</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可以直接在中间件 m1 中链接，但我们必须调用 m2;</li>
</ol>
</li>
</ol>
<h2 id="XaaS"><a href="#XaaS" class="headerlink" title="XaaS"></a>XaaS</h2><ol>
<li>软件即服务（ SaaS ）：用来描述提供给你的软件（网站、应用）;</li>
<li>平台即服务（ PaaS ）：提供了所有的基础设施（操作系统、网络，所有都弄好了）,只需要编写应用程序；</li>
<li>架构即服务（ IaaS ）：只是提供虚拟机和基本的网络连接，需要安装和维护操作系统、数据库和网络策略；</li>
</ol>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><strong>业界有一种将 QA（质量保证） 和开发岗位融合的趋势，让开发人员负责 QA。 在这种范式下，由擅长 QA 的软件工程师担任开发人员的顾问，帮他们将 QA 植入到开发流程中！</strong></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat_pay.jpg" alt="WanderROS 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="WanderROS 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

<div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2020/04/28/Nodejs-Express/">Nodejs-Express</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 WanderROS 的个人博客">WanderROS</a></p>
  <p><span>发布时间:</span>2020年04月28日 - 09:15</p>
  <p><span>最后更新:</span>2020年10月01日 - 16:52</p>
  <p><span>原始链接:</span><a href="/2020/04/28/Nodejs-Express/" title="Nodejs-Express">https://wanderros.github.io/2020/04/28/Nodejs-Express/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://wanderros.github.io/2020/04/28/Nodejs-Express/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
      $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
        });
    });  
</script>


      
</div>

<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

  
</div>

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/04/27/Nodejs-Web/" rel="next" title="Nodejs Web">
                <i class="fa fa-chevron-left"></i> Nodejs Web
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/29/Web-Dev-Base/" rel="prev" title="Web Dev Base">
                Web Dev Base <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>
<div>
		
    	<!-- Link Gitalk 的支持文件  -->
	<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
	<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> 
	<div id="gitalk-container"></div>     <script type="text/javascript">
		var gitalk = new Gitalk({
			clientID: 'bd073c3374c2b1a924b0',
			clientSecret: 'e3818342fe0fa0f03ab0997cfe81ae9c450ec954',
			repo: 'wanderros.github.io',
			owner: 'WanderROS',
			admin: ['WanderROS'],
			id: location.pathname,
			distractionFreeMode: 'true'
		});
		gitalk.render('gitalk-container');
	</script> 
	<!-- Gitalk end -->

		
	</div>


    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
 <div id="gitalk-container"></div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="WanderROS" />
            
              <p class="site-author-name" itemprop="name">WanderROS</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives%7C%7C%20archive">
              
                  <span class="site-state-item-count">164</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">34</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wanderROS" target="_blank" title="GitHub">
                      GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:1194409532@qq.com.com" target="_blank" title="E-Mail">
                      E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#开始"><span class="nav-number">2.</span> <span class="nav-text">开始</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#新技术的衍生"><span class="nav-number">2.1.</span> <span class="nav-text">新技术的衍生</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#平台搭建"><span class="nav-number">2.2.</span> <span class="nav-text">平台搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Express"><span class="nav-number">2.3.</span> <span class="nav-text">Express</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Node项目"><span class="nav-number">2.4.</span> <span class="nav-text">Node项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#质量保证（QA）"><span class="nav-number">2.5.</span> <span class="nav-text">质量保证（QA）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面测试"><span class="nav-number">2.6.</span> <span class="nav-text">页面测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#请求和响应"><span class="nav-number">2.7.</span> <span class="nav-text">请求和响应</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Handlebars模板引擎"><span class="nav-number">2.8.</span> <span class="nav-text">Handlebars模板引擎</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安全"><span class="nav-number">2.9.</span> <span class="nav-text">安全</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Express和MVC"><span class="nav-number">2.10.</span> <span class="nav-text">Express和MVC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#信息收集"><span class="nav-number">2.11.</span> <span class="nav-text">信息收集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Express表单处理"><span class="nav-number">2.12.</span> <span class="nav-text">Express表单处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#REST"><span class="nav-number">2.13.</span> <span class="nav-text">REST</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#中间件"><span class="nav-number">2.14.</span> <span class="nav-text">中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cookie与会话"><span class="nav-number">2.15.</span> <span class="nav-text">Cookie与会话</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由"><span class="nav-number">2.16.</span> <span class="nav-text">路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调试"><span class="nav-number">2.17.</span> <span class="nav-text">调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#管理自己的npm库（私库）"><span class="nav-number">2.18.</span> <span class="nav-text">管理自己的npm库（私库）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建中间件"><span class="nav-number">2.19.</span> <span class="nav-text">创建中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XaaS"><span class="nav-number">2.20.</span> <span class="nav-text">XaaS</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WanderROS</span>

  
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>
<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>


-->
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共415.4k字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  













  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!--崩溃欺骗-->
<script type="text/javascript" src="/js/src/crash_cheat.js"></script>
