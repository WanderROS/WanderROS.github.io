<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">


<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>




<script>
    (function () {
        if ('') {
            if (prompt('Please input Password:') !== '') {
                alert('Password Error！');
                if (history.length === 1) {
                    location.replace("https://wanderros.github.io/"); // 这里替换成你的首页
                } else {
                    history.back();
                }
            }
        }
    })();
</script>





<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon.ico?v=5.1.4" color="#222">


  <link rel="manifest" href="/images/manifest.json">


  <meta name="msapplication-config" content="/images/browserconfig.xml" />



  <meta name="keywords" content="Hexo, NexT" />




  


  <link rel="alternate" href="/atom.xml" title="WanderROS'S Daily" type="application/atom+xml" />






<meta name="description" content="简介服务发现是基于微服务体系结构的关键原则之一。尝试手工配置每个客户端或某种形式的约定可能很困难，而且很脆弱。Eureka是Netflix的服务发现服务器和客户端，可以将服务器配置和部署为高可用性，每个服务器将注册服务的状态复制到其他服务器。本文主要记录SpringCloud Eureka相关技术的操作，真实的使用还需要进行实战才能强化！  开始基础知识 服务发现的两种方式：  客户端发现  Eu">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud Eureka Quick Start">
<meta property="og:url" content="https://wanderros.github.io/2020/08/05/SpringCloud-Eureka-Quick-Start/index.html">
<meta property="og:site_name" content="WanderROS&#39;S Daily">
<meta property="og:description" content="简介服务发现是基于微服务体系结构的关键原则之一。尝试手工配置每个客户端或某种形式的约定可能很困难，而且很脆弱。Eureka是Netflix的服务发现服务器和客户端，可以将服务器配置和部署为高可用性，每个服务器将注册服务的状态复制到其他服务器。本文主要记录SpringCloud Eureka相关技术的操作，真实的使用还需要进行实战才能强化！  开始基础知识 服务发现的两种方式：  客户端发现  Eu">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/06b983e45d45493ba85a05ad9a34476b-109561">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/c1ecae7ac44b251fbda1c7d696fe5da5-38780">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/a4de5d67c6fdab86808d2cd3ba8ce204-26808">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/2822219a5796fa99ab43b0ff472d5dc7-121093">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/79d1fd2acf5008e79aaa18086e7bf20d-122728">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/1968f2b0984809bf464876564eef9f14-116933">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/732ec4bbbf754ffaedb2cdc4f9bc93cf-137465">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/a12149d58adf941cebceaca9406b2bf0-140073">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/67ff71ae722b14068bf54ec71013db35-35448">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/d3cd3bf9c1169c1c7a60a3a7c6d06cc9-21040">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/90d1ce032ea695483d0bc7ae1a41c05e-120477">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/771cc7a70145406b92427b148d684592-18014">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/5393c5d00ad35c6d857235785be3cc7c-42683">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/f519dacdf40981351c0a16f9e3a7b881-110812">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/dca44713c7e8eba2be6f80be99ea50a6-20091">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/ff198fc22593c8807723ca380df04410-21126">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/ff0e8a419bf054dbc4b6c5a06ef84d94-15952">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/bbb3d2ee423a1060a64b7cb96428814c-112832">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/3d4b9eb96de8e029a50c38f583ccb396-23085">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/99d9a830b1de9837c1e1b15756ffbd43-25199">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/9c0f83fb94488c19d9ee0594b84272d4-195280">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/ad92ee11c226e8ca816f947e2182660a-28278">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/273facdf1cf67f2e34655f7fe6c24ed7-16109">
<meta property="og:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/fa9f6138ca8d8607fb92a57f44d4596c-26046">
<meta property="article:published_time" content="2020-08-05T01:29:36.000Z">
<meta property="article:modified_time" content="2020-10-01T08:52:15.920Z">
<meta property="article:author" content="WanderROS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://app.yinxiang.com/FileSharing.action?hash=1/06b983e45d45493ba85a05ad9a34476b-109561">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://wanderros.github.io/2020/08/05/SpringCloud-Eureka-Quick-Start/"/>





  <title>SpringCloud Eureka Quick Start | WanderROS'S Daily</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

<a href="https://github.com/WanderROS" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>


    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WanderROS'S Daily</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-足迹">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            足迹
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wanderros.github.io/2020/08/05/SpringCloud-Eureka-Quick-Start/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="WanderROS">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WanderROS'S Daily">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">SpringCloud Eureka Quick Start</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-05T09:29:36+08:00">
                2020-08-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SpringCloud/" itemprop="url" rel="index">
                    <span itemprop="name">SpringCloud</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>服务发现是基于微服务体系结构的关键原则之一。尝试手工配置每个客户端或某种形式的约定可能很困难，而且很脆弱。Eureka是Netflix的服务发现服务器和客户端，可以将服务器配置和部署为高可用性，每个服务器将注册服务的状态复制到其他服务器。本文主要记录SpringCloud Eureka相关技术的操作，真实的使用还需要进行实战才能强化！</p>
<hr>
<h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol>
<li><p>服务发现的两种方式：</p>
<ul>
<li><p>客户端发现</p>
<ul>
<li>Eureka</li>
</ul>
</li>
<li><p>服务端发现</p>
<ul>
<li>Nginx</li>
<li>Zookeeper</li>
<li>Kubernetes</li>
</ul>
</li>
</ul>
</li>
<li><p>康威定律：任何组织在设计一套系统时，所交付的设计方案在结构上都与该组织的沟通结构保持一致！——沟通的问题会影响架构结构。</p>
</li>
<li><p>微服务特点之一是异构，主要表现在：</p>
<ul>
<li>不同语言</li>
<li>不同类型的数据库</li>
</ul>
</li>
<li><p>应用间通信方式有HTTP和RPC，典型代表有：</p>
<ul>
<li>HTTP——SpringCloud</li>
<li>RPC——Dubbo</li>
</ul>
</li>
<li><p>SpringCloud中服务间有两种RESTful调用方式：</p>
<ul>
<li>RestTemplate</li>
<li>Feign</li>
</ul>
</li>
<li><p>SpringCloud中各种组件的功能描述：</p>
<ul>
<li>Eureka Client——负责将服务的信息注册到Eureka Server中</li>
<li>Eureka Server——注册中心，里面有一个注册表，保存了各个服务所在的机器和端口号</li>
<li>Feign——使用动态代理技术，来动态构造出请求的服务的地址</li>
<li>Ribbon——和Feign以及Eureka紧密协作完成负载均衡的功能</li>
<li>Hystrix——隔离、熔断以及降级的一个框架</li>
<li>Zuul——（微服务网关组件）负责网络路由，一般微服务架构中都必然会设计一个网关在里面</li>
</ul>
</li>
</ol>
<h2 id="网关Zuul"><a href="#网关Zuul" class="headerlink" title="网关Zuul"></a>网关Zuul</h2><ol>
<li><p>Zuul是Netflix开源的微服务网关，可以和Eureka、Ribbon、Hystrix等组件配合使用，Spring Cloud对Zuul进行了整合与增强，Zuul默认使用的HTTP客户端是Apache HTTPClient，也可以使用RestClient或okhttp3.OkHttpClient；</p>
</li>
<li><p>主要功能：路由转发和过滤器</p>
</li>
<li><p>工作原理：在把请求路由到网关之后的服务过程中，通过一系列的过滤器进行处理，达到预期的效果，和Servlet框架的Filter以及AOP类似；</p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/06b983e45d45493ba85a05ad9a34476b-109561" alt="Zuul原理"></p>
</li>
<li><p>过滤器的主要应用：</p>
<ul>
<li>身份验证和安全性 - 确定每个资源的身份验证要求并拒绝不满足这些要求的请求</li>
<li>洞察和监控 - 在边缘跟踪有意义的数据和统计数据，以便为我们提供准确的生产视图</li>
<li>动态路由 - 根据需要动态地将请求路由到不同的后端集群</li>
<li>压力测试 - 逐渐增加集群的流量以衡量性能</li>
<li>Load Shedding - 为每种类型的请求分配容量并删除超过限制的请求</li>
<li>静态响应处理 - 直接在边缘构建一些响应，而不是将它们转发到内部集群</li>
</ul>
</li>
<li><p>过滤器的生命周期：</p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/c1ecae7ac44b251fbda1c7d696fe5da5-38780" alt="过滤器的生命周期"></p>
</li>
<li><p>Zuul的组件：</p>
<ul>
<li>zuul-core——zuul核心库，包含编译和执行过滤器的核心功能</li>
<li>zuul-simple-webapp——zuul Web应用程序示例，展示了如何使用zuul-core构建应用程序</li>
<li>zuul-netflix——lib包，将其他NetflixOSS组件添加到Zuul中，例如使用功能区进去路由请求处理</li>
<li>zuul-netflix-webapp——webapp，它将zuul-core和zuul-netflix封装成一个简易的webapp工程包</li>
</ul>
</li>
<li><p>在zuul中，路由匹配的路径表达式采用ant风格定义</p>
<table>
<thead>
<tr>
<th>通配符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>？</td>
<td>匹配任意单个字符</td>
</tr>
<tr>
<td>*</td>
<td>匹配任意数量的字符</td>
</tr>
<tr>
<td>**</td>
<td>匹配任意数量的字符，支持多级目录</td>
</tr>
</tbody></table>
<ul>
<li><p>默认情况下，Zuul在请求路由时，会过滤掉http请求头信息中一些敏感信息，防止它们被传递到下游的外部服务器，通过zuul.sensitive-headers来进行配置，不过滤掉直接填空值即可</p>
</li>
<li><p>参考配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建路由地址</span></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="comment"># 这里可以自定义</span></span><br><span class="line">    <span class="attr">demo2:</span></span><br><span class="line">      <span class="comment"># 匹配的路由规则</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/demo/**</span></span><br><span class="line">      <span class="comment"># 路由的目标服务名</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">demo</span></span><br><span class="line"><span class="comment"># 关闭使用eureka负载路由</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eureka:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 如果不使用eureka的话，需要自己定义路由的那个服务的其他负载服务</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ol>
<h2 id="限流、熔断和降级Hystrix-hɪst’rɪks"><a href="#限流、熔断和降级Hystrix-hɪst’rɪks" class="headerlink" title="限流、熔断和降级Hystrix [hɪst’rɪks]"></a>限流、熔断和降级Hystrix [hɪst’rɪks]</h2><ol>
<li><p>Hystrix是由Netflix开源的一个延迟和容错库，用于隔离访问远程系统、服务或者第三方库，防止级联失败，从而提升系统的可用性、容错性与局部应用的弹性，是一个实现了超时机制和断路器模式的工具类库！</p>
</li>
<li><p>在理想状态下，一个应用依赖的服务都是健康可用的，可以正常的处理所有的请求。但是当某一个服务出现延迟时，所有的请求都阻塞在依赖的服务上，会导致服务阻塞，可能引起服务雪崩；</p>
</li>
<li><p>使用了Hystrix时，Hystrix将所有的外部调用都封装成一个HystrixCommand或者HystrixObservableCommand对象，这些外部调用将会在一个独立的线程中运行。可以将出现问题的服务通过熔断、降级等手段隔离开来，这样不影响整个系统的主业务；</p>
</li>
<li><p>Hystrix工作原理：</p>
<ul>
<li>使用命令模式将所有对外部服务（或依赖关系）的调用包装在HystrixCommand或HystrixObservableCommand对象中，并将该对象放在单独的线程中执行</li>
<li>每个依赖都维护着一个线程池（或信号量），线程池被耗尽则拒绝请求（而不是让请求排队）</li>
<li>记录请求成功，失败，超时和线程拒绝</li>
<li>服务错误百分比超过了阈值，熔断器开关自动打开，一段时间内停止对该服务的所有请求</li>
<li>请求失败，被拒绝，超时或熔断时执行降级逻辑</li>
<li>近实时地监控指标和配置的修改</li>
</ul>
</li>
<li><p>Hystrix配置示例：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 线程池大小</span></span><br><span class="line"><span class="meta">hystrix.threadpool.default.coreSize</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"># 缓冲区大小， 如果为-1，则不缓冲，直接进行降级 fallback</span></span><br><span class="line"><span class="meta">hystrix.threadpool.default.maxQueueSize</span>=<span class="string">200</span></span><br><span class="line"><span class="comment"># 缓冲区大小超限的阈值，超限就直接降级</span></span><br><span class="line"><span class="meta">hystrix.threadpool.default.queueSizeRejectionThreshold</span>=<span class="string">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行策略</span></span><br><span class="line"><span class="comment"># 资源隔离模式，默认thread。 还有一种叫信号量</span></span><br><span class="line"><span class="meta">hystrix.command.default.execution.isolation.strategy</span>=<span class="string">THREAD</span></span><br><span class="line"><span class="comment"># 是否打开超时</span></span><br><span class="line"><span class="meta">hystrix.command.default.execution.timeout.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 超时时间，默认1000毫秒</span></span><br><span class="line"><span class="meta">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</span>=<span class="string">15000</span></span><br><span class="line"><span class="comment"># 超时时中断线程</span></span><br><span class="line"><span class="meta">hystrix.command.default.execution.isolation.thread.interruptOnTimeout</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 取消时候中断线程</span></span><br><span class="line"><span class="meta">hystrix.command.default.execution.isolation.thread.interruptOnFutureCancel</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 信号量模式下，最大并发量</span></span><br><span class="line"><span class="meta">hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests</span>=<span class="string">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 降级策略</span></span><br><span class="line"><span class="comment"># 是否开启服务降级</span></span><br><span class="line"><span class="meta">hystrix.command.default.fallback.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># fallback执行并发量</span></span><br><span class="line"><span class="meta">hystrix.command.default.fallback.isolation.semaphore.maxConcurrentRequests</span>=<span class="string">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 熔断策略</span></span><br><span class="line"><span class="comment"># 启用/禁用熔断机制</span></span><br><span class="line"><span class="meta">hystrix.command.default.circuitBreaker.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 强制开启熔断</span></span><br><span class="line"><span class="meta">hystrix.command.default.circuitBreaker.forceOpen</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 强制关闭熔断</span></span><br><span class="line"><span class="meta">hystrix.command.default.circuitBreaker.forceClosed</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 前提条件，一定时间内发起一定数量的请求。  也就是5秒钟内(这个5秒对应下面的滚动窗口长度)至少请求4次，熔断器才发挥起作用。  默认20</span></span><br><span class="line"><span class="meta">hystrix.command.default.circuitBreaker.requestVolumeThreshold</span>=<span class="string">4</span></span><br><span class="line"><span class="comment"># 错误百分比。达到或超过这个百分比，熔断器打开。  比如：5秒内有4个请求，2个请求超时或者失败，就会自动开启熔断</span></span><br><span class="line"><span class="meta">hystrix.command.default.circuitBreaker.errorThresholdPercentage</span>=<span class="string">50</span></span><br><span class="line"><span class="comment"># 10秒后，进入半打开状态（熔断开启，间隔一段时间后，会让一部分的命令去请求服务提供者，如果结果依旧是失败，则又会进入熔断状态，如果成功，就关闭熔断）。 默认5秒</span></span><br><span class="line"><span class="meta">hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds</span>=<span class="string">10000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 度量策略</span></span><br><span class="line"><span class="comment"># 5秒为一次统计周期，术语描述：滚动窗口的长度为5秒</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.rollingStats.timeInMilliseconds</span>=<span class="string">5000</span></span><br><span class="line"><span class="comment"># 统计周期内 度量桶的数量，必须被timeInMilliseconds整除。作用：</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.rollingStats.numBuckets</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># 是否收集执行时间，并计算各个时间段的百分比</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.rollingPercentile.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 设置执行时间统计周期为多久，用来计算百分比</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.rollingPercentile.timeInMilliseconds</span>=<span class="string">60000</span></span><br><span class="line"><span class="comment"># 执行时间统计周期内，度量桶的数量</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.rollingPercentile.numBuckets</span>=<span class="string">6</span></span><br><span class="line"><span class="comment"># 执行时间统计周期内，每个度量桶最多统计多少条记录。设置为50，有100次请求，则只会统计最近的10次</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.rollingPercentile.bucketSize</span>=<span class="string">100</span></span><br><span class="line"><span class="comment"># 数据取样时间间隔</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.healthSnapshot.intervalInMilliseconds</span>=<span class="string">500</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置是否缓存请求，request-scope内缓存</span></span><br><span class="line"><span class="meta">hystrix.command.default.requestCache.enabled</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 设置HystrixCommand执行和事件是否打印到HystrixRequestLog中</span></span><br><span class="line"><span class="meta">hystrix.command.default.requestLog.enabled</span>=<span class="string">false</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 限流策略</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果没有定义HystrixThreadPoolKey，HystrixThreadPoolKey会默认定义为HystrixCommandGroupKey的值</span></span><br><span class="line"><span class="meta">hystrix.threadpool.userGroup.coreSize</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">hystrix.threadpool.userGroup.maxQueueSize</span>=<span class="string">-1</span></span><br><span class="line"><span class="meta">hystrix.threadpool.userGroup.queueSizeRejectionThreshold</span>=<span class="string">800</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">hystrix.threadpool.userThreadPool.coreSize</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">hystrix.threadpool.userThreadPool.maxQueueSize</span>=<span class="string">-1</span></span><br><span class="line"><span class="meta">hystrix.threadpool.userThreadPool.queueSizeRejectionThreshold</span>=<span class="string">800</span></span><br><span class="line"><span class="meta">hystrix.command.userCommandKey.execution.isolation.thread.timeoutInMilliseconds</span>=<span class="string">5000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Hystrix支持以注解的形式配置，通过@HystrixCommand注解的fallbackMethod属性指定降级方法；通过@HystrixProperty的name value键值对进行配置commandProperties<code>和</code>threadPoolProperties；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"timeoutFallback"</span>, threadPoolProperties = &#123;</span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"coreSize"</span>, value = <span class="string">"20"</span>),</span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"queueSizeRejectionThreshold"</span>, value = <span class="string">"20"</span>)</span><br><span class="line">    &#125;, commandProperties = &#123;</span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"execution.isolation.thread.timeoutInMilliseconds"</span>, value = <span class="string">"8000"</span>)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在客户端需要使用@EnableCircuitBreaker启用熔断机制；</p>
</li>
<li><p>Hystrix配置属性说明：<a href="https://github.com/Netflix/Hystrix/wiki/Configuration" target="_blank" rel="noopener">https://github.com/Netflix/Hystrix/wiki/Configuration</a></p>
</li>
</ol>
<h2 id="配置ConfigServer"><a href="#配置ConfigServer" class="headerlink" title="配置ConfigServer"></a>配置ConfigServer</h2><ol>
<li><p>在分布式系统中，Spring Cloud提供一个Config子项目，该项目核心就是配置中心，通过一个服务端和多个客户端实现配置服务！</p>
</li>
<li><p>功能：使用配置服务器集中的管理所有服务的各种环境配置文件；</p>
</li>
<li><p>需要使用@EnableConfigServer来启动配置服务；配合Eureke可实现服务发现，配合Cloud Bus可实现配置推送更新；</p>
</li>
<li><p>需要添加bootstrap.yml配置文件，文件内容类似下面的：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/hellxz/SpringCloudlearn</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">config-repo</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">username</span> </span><br><span class="line">          <span class="attr">password:</span> <span class="string">password</span></span><br></pre></td></tr></table></figure>

<ul>
<li>search-paths指定的是匹配查询的路径名</li>
<li>username和password是访问仓库的用户名和密码</li>
</ul>
</li>
<li><p>Config支持使用的请求的参数规则有：</p>
<ul>
<li>/ { 应用名 } / { 环境名 } [ / { 分支名 } ]</li>
<li>/ { 应用名 } - { 环境名 }.yml</li>
<li>/ { 应用名 } - { 环境名 }.properties</li>
<li>/ { 分支名 } / { 应用名 } - { 环境名 }.yml</li>
<li>/ { 分支名 } / { 应用名 } - { 环境名 }.properties</li>
</ul>
</li>
<li><p>Config Server工作原理：</p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/a4de5d67c6fdab86808d2cd3ba8ce204-26808" alt="Config Server工作原理"></p>
<ul>
<li>远程git仓库——用来存储配置文件的地方</li>
<li>Config Server——分布式配置中心</li>
<li>微服务应用——配置了ConfigClient的微服务</li>
</ul>
</li>
<li><p>Config Server启动流程：</p>
<ol>
<li>微服务应用启动，根据bootstrap.yml（properties）中配置的应用名（application）、环境名（profile）、分支名（label），向Config Server请求配置信息</li>
<li>Config Server 根据自己bootstrap.yml（properties）中的Git（或SVN）仓库信息加上客户端传来的配置定位信息去查配置信息的路径</li>
<li>Config Server 执行git clone命令，将配置信息下载到本地Git仓库中，将配置信息加载到Spring的ApplicationContext读取内容返回给客户端（微服务应用）</li>
<li>客户端将内容加载到ApplicationContext，配置内容的优先级大于客户端内部的配置内容，进行忽略</li>
</ol>
<ul>
<li>当Config Server因为网络原因无法连接到Git或SVN时，客户端的请求过来后，会先连接Git或SVN，如果没连上，就使用本地仓库的配置文件内容进行返回给客户端</li>
</ul>
</li>
<li><p>Config Server可以配置多个仓库，配置示例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/spring-cloud-samples/config-repo</span>   <span class="comment">#默认的仓库</span></span><br><span class="line">          <span class="attr">repos:</span></span><br><span class="line">            <span class="attr">simple:</span> <span class="string">https://github.com/simple/config-repo</span></span><br><span class="line">            <span class="attr">special:</span></span><br><span class="line">              <span class="attr">pattern:</span> <span class="string">special*/dev*,*special*/dev*</span></span><br><span class="line">              <span class="attr">uri:</span> <span class="string">https://github.com/special/config-repo</span></span><br><span class="line">            <span class="attr">local:</span></span><br><span class="line">              <span class="attr">pattern:</span> <span class="string">local*</span></span><br><span class="line">              <span class="attr">uri:</span> <span class="string">file:/home/configsvc/config-repo</span></span><br><span class="line">            <span class="attr">test:</span> </span><br><span class="line">              <span class="attr">pattern:</span> </span><br><span class="line">                <span class="bullet">-</span> <span class="string">'*/development'</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">'*/staging'</span></span><br><span class="line">              <span class="attr">uri:</span> <span class="string">https://github.com/development/config-repo</span></span><br></pre></td></tr></table></figure>

<ul>
<li>simple 仓库自动匹配到 simple/*</li>
<li>special 仓库的pattern，第一个是应用名以special开头，环境名以dev开头；第二个是应用名包含special，环境名以dev开头；多个匹配到同一uri的pattern用逗号分割</li>
<li>local 仓库的的pattern也会自动补全为local<em>/</em></li>
<li>test仓库中的 pattern 是以通配符开始的，需要使用单引号</li>
<li><strong>配置多个仓库时，Config Server 在启动时会直接克隆第一个仓库的配置库，其他配置库只有请求时才会clone到本地</strong></li>
</ul>
</li>
</ol>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><ol>
<li><p><strong>SpringCloud Config的手动刷新：</strong>在Config Server以及Config Client都在运行的情况下，修改GitHub中的配置文件中的内容，然后再手动刷新Config Client就可以不重启任何服务的情况达到效果，但是需要注意以下点：</p>
<ul>
<li><p>Config Client需要添加actuator依赖，并且暴露refresh端点的配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">	<span class="attr">endpoint:</span></span><br><span class="line">		<span class="attr">web:</span></span><br><span class="line">			<span class="attr">exposure:</span></span><br><span class="line">				<span class="attr">include:</span> <span class="string">refresh</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>对于引用了GitHub配置文件的类上加上注解@RefreshScope</p>
</li>
<li><p>手动POST Config Client的/actuator/refresh接口</p>
</li>
</ul>
</li>
<li><p>在配置使用Feign时，添加了之前可以使用的一些依赖但是导致在项目中一直出现如下错误：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nested exception is java.lang.NoClassDefFoundError</span><br></pre></td></tr></table></figure>

<ul>
<li>只添加spring-cloud-starter-openfeign即可，其他的依赖项添加不对的话，会导致依赖出现问题</li>
</ul>
</li>
<li><p>Ribbon的负载均衡策略主要有以下几种：</p>
<ul>
<li>com.netflix.loadbalancer.RandomRule #配置规则 随机</li>
<li>com.netflix.loadbalancer.RoundRobinRule #配置规则 轮询</li>
<li>com.netflix.loadbalancer.RetryRule #配置规则 重试</li>
<li>com.netflix.loadbalancer.WeightedResponseTimeRule #配置规则 响应时间权重</li>
<li>com.netflix.loadbalancer.BestAvailableRule #配置规则 最空闲连接策略</li>
</ul>
</li>
<li><p>@FeignClient注解参数说明：</p>
<ul>
<li>name——指定FeignClient的名称，如果项目使用了Ribbon，name属性会作为微服务的名称，用于服务发现</li>
<li>fallback——定义容错的处理类，当调用远程接口失败或超时时，会调用对应接口的容错逻辑，fallback指定的类必须实现@FeignClient标记的接口</li>
<li>fallbackFactory——工厂类，用于生成fallback类示例，通过这个属性我们可以实现每个接口通用的容错逻辑，减少重复的代码</li>
<li>path——定义当前FeignClient的统一前缀，类似于注解到类上的@RequestMapping的功能</li>
<li><strong>注意：</strong>出现fallback method wasn’t found异常时，是因为指定的备用方法和原方法的参数个数或类型不同造成的，需要统一参数的类型和个数</li>
</ul>
</li>
<li><p>在注册完服务之后，服务提供者会维护一个心跳用来持续告诉 Eureka Server“我还活着”，以防止 Eureka Server 的“剔除任务”将该服务实例从服务列表中排除出去，我们称该操作为服务续约（Renew），关于服务续约有如下两个重要属性，可以根据需求来调整：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义服务续约任务的调用时间间隔（即发送心跳给server端的频率），默认为30秒</span></span><br><span class="line"><span class="meta">eureka.instance.lease-renewal-interval-in-seconds</span>=<span class="string">30</span></span><br><span class="line"><span class="comment"># 定于服务失效的时间（即server端多长时间没收到心跳后就将此实例剔除)，默认为90秒</span></span><br><span class="line"><span class="meta">eureka.instance.lease-expiration-duration-in-seconds</span>=<span class="string">90</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="动手实操"><a href="#动手实操" class="headerlink" title="动手实操"></a>动手实操</h1><h2 id="Eureka服务端"><a href="#Eureka服务端" class="headerlink" title="Eureka服务端"></a>Eureka服务端</h2><ol>
<li><p>创建一个SpringCloud Eureka的注册中心服务端项目，选中Spring Cloud Discovery下的Eureka Server即可；</p>
</li>
<li><p>开启注解@EnableEurekaServer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>直接启动能够打开<a href="http://localhost:8080，但是终端会报错误，效果如下：">http://localhost:8080，但是终端会报错误，效果如下：</a></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/2822219a5796fa99ab43b0ff472d5dc7-121093" alt="Eureka网页"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">com.netflix.discovery.shared.transport.TransportException: Cannot execute request on any known server</span><br><span class="line">	at com.netflix.discovery.shared.transport.decorator.RetryableEurekaHttpClient.execute(RetryableEurekaHttpClient.java:<span class="number">112</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">	at com.netflix.discovery.shared.transport.decorator.EurekaHttpClientDecorator.register(EurekaHttpClientDecorator.java:<span class="number">56</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">	at com.netflix.discovery.shared.transport.decorator.EurekaHttpClientDecorator$<span class="number">1</span>.execute(EurekaHttpClientDecorator.java:<span class="number">59</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">	at com.netflix.discovery.shared.transport.decorator.SessionedEurekaHttpClient.execute(SessionedEurekaHttpClient.java:<span class="number">77</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">	at com.netflix.discovery.shared.transport.decorator.EurekaHttpClientDecorator.register(EurekaHttpClientDecorator.java:<span class="number">56</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">	at com.netflix.discovery.DiscoveryClient.register(DiscoveryClient.java:<span class="number">857</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">	at com.netflix.discovery.InstanceInfoReplicator.run(InstanceInfoReplicator.java:<span class="number">121</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">	at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:<span class="number">515</span>) ~[na:na]</span><br><span class="line">	at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">264</span>) ~[na:na]</span><br><span class="line">	at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:<span class="number">304</span>) ~[na:na]</span><br><span class="line">	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1128</span>) ~[na:na]</span><br><span class="line">	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">628</span>) ~[na:na]</span><br><span class="line">	at java.base/java.lang.Thread.run(Thread.java:<span class="number">834</span>) ~[na:na]</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加配置如下（application.yml）：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span> <span class="comment"># 本身也是客户端，注册到自己的服务中心</span></span><br><span class="line">   <span class="comment"># register-with-eureka: false # 关闭在注册中心的显示</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka</span> <span class="comment"># 修改应用名</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span> <span class="comment"># 修改端口号</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EurekaClientConfigBean.class    </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">EurekaClientConfigBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serviceUrl.put(<span class="string">"defaultZone"</span>, <span class="string">"http://localhost:8761/eureka/"</span>);</span><br><span class="line">        <span class="keyword">this</span>.gZipContent = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.useDnsForFetchingServiceUrls = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerWithEureka = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.preferSameZoneEureka = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.availabilityZones = <span class="keyword">new</span> HashMap();</span><br><span class="line">        <span class="keyword">this</span>.filterOnlyUpInstances = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.fetchRegistry = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.dollarReplacement = <span class="string">"_-"</span>;</span><br><span class="line">        <span class="keyword">this</span>.escapeCharReplacement = <span class="string">"__"</span>;</span><br><span class="line">        <span class="keyword">this</span>.allowRedirects = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.onDemandUpdateStatusChange = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.clientDataAccept = EurekaAccept.full.name();</span><br><span class="line">        <span class="keyword">this</span>.shouldUnregisterOnShutdown = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.shouldEnforceRegistrationAtInit = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.order = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新启动服务之后，等待一段时间就可以查看<a href="http://localhost:8761，效果如下：">http://localhost:8761，效果如下：</a></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/79d1fd2acf5008e79aaa18086e7bf20d-122728" alt="Eureka自注册"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">08</span>-<span class="number">05</span> <span class="number">09</span>:<span class="number">44</span>:<span class="number">00.893</span>  INFO <span class="number">25750</span> --- [freshExecutor-<span class="number">0</span>] com.netflix.discovery.DiscoveryClient    : Getting all instance registry info from the eureka server</span><br><span class="line"><span class="number">2020</span>-<span class="number">08</span>-<span class="number">05</span> <span class="number">09</span>:<span class="number">44</span>:<span class="number">00.897</span>  INFO <span class="number">25750</span> --- [freshExecutor-<span class="number">0</span>] com.netflix.discovery.DiscoveryClient    : The response status is <span class="number">200</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">08</span>-<span class="number">05</span> <span class="number">09</span>:<span class="number">44</span>:<span class="number">01.041</span>  INFO <span class="number">25750</span> --- [      Thread-<span class="number">16</span>] c.n.e.registry.AbstractInstanceRegistry  : Registered instance EUREKA/<span class="number">192.168</span><span class="number">.3</span><span class="number">.108</span>:eureka:<span class="number">8761</span> <span class="function">with status <span class="title">UP</span> <span class="params">(replication=<span class="keyword">true</span>)</span></span></span><br><span class="line"><span class="function">2020-08-05 09:44:01.041  INFO 25750 --- [      Thread-16] c.n.e.r.PeerAwareInstanceRegistryImpl    : Got 1 instances from neighboring DS node</span></span><br><span class="line"><span class="function">2020-08-05 09:44:01.041  INFO 25750 --- [      Thread-16] c.n.e.r.PeerAwareInstanceRegistryImpl    : Renew threshold is: 1</span></span><br><span class="line"><span class="function">2020-08-05 09:44:01.041  INFO 25750 --- [      Thread-16] c.n.e.r.PeerAwareInstanceRegistryImpl    : Changing status to UP</span></span><br><span class="line"><span class="function">2020-08-05 09:44:01.047  INFO 25750 --- [      Thread-16] e.s.EurekaServerInitializerConfiguration : Started Eureka Server</span></span><br><span class="line"><span class="function">2020-08-05 09:45:01.044  INFO 25750 --- [a-EvictionTimer] c.n.e.registry.AbstractInstanceRegistry  : Running the evict task with compensationTime 0ms</span></span><br></pre></td></tr></table></figure>

<ul>
<li>通过终端可以看到自己注册到了服务中</li>
<li>使用register-with-eureka: false 可以关闭自注册，取消配置文件中的注释就看不到自注册了</li>
</ul>
</li>
<li><p><strong>修改配置，支持密码保护：</strong></p>
<ul>
<li><p>添加安全依赖（pom.xml）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件（application.yml）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@127.0.0.1:8761/eureka/</span> <span class="comment"># 本身也是客户端，注册到自己的服务中心 username : password@</span></span><br><span class="line">    <span class="comment"># register-with-eureka: false # 关闭在注册中心的显示</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka</span> <span class="comment"># 修改应用名</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">basic:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span> <span class="comment"># 修改端口号</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安全配置（跨域问题，账户登录问题）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.csrf().disable();</span><br><span class="line">        <span class="keyword">super</span>.configure(http);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果不将csrf检验关闭，会出现其他服务无法注册进 eureka注册中心的情况</li>
<li>如果不添加父类的配置，则无法进行安全认证的情况</li>
</ul>
</li>
<li><p>客户端的注册地址要修改成<a href="http://admin:admin@127.0.0.1:8761/eureka/类似的地址" target="_blank" rel="noopener">http://admin:admin@127.0.0.1:8761/eureka/类似的地址</a></p>
</li>
</ul>
</li>
</ol>
<h2 id="Eureka客户端"><a href="#Eureka客户端" class="headerlink" title="Eureka客户端"></a>Eureka客户端</h2><ol>
<li><p>创建一个SpringCloud项目，选择Web下的Spring Web以及Spring Cloud Discovery下的Eureka Discovery Client；</p>
</li>
<li><p>开启注解@EnableDiscoveryClient：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaclientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaclientApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加配置文件（application.yml）:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line"><span class="comment">#  instance:</span></span><br><span class="line"><span class="comment">#    hostname: test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eurekaclient</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务，查看Eureka服务端网址<a href="http://localhost:8761" target="_blank" rel="noopener">http://localhost:8761</a></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/1968f2b0984809bf464876564eef9f14-116933" alt="Eureka客户端注册"></p>
</li>
<li><p>开发过程中可以关闭Eureka服务的自我保护模式，在注册中心配置application.yml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span> <span class="comment"># 本身也是客户端，注册到自己的服务中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment"># 关闭在注册中心的显示</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span> <span class="comment"># 关闭自我保护</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka</span> <span class="comment"># 修改应用名</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span> <span class="comment"># 修改端口号</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Eureka高可用注册"><a href="#Eureka高可用注册" class="headerlink" title="Eureka高可用注册"></a>Eureka高可用注册</h2><ol>
<li><p>多个注册中心相互注册自己的客户端，修改application.yml即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 两个注册中心,注册中心配置文件</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端注册的时候要注册到<strong>每个注册中心</strong>，防止其中任何一个注册中心宕机都还是可用的</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端配置文件</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br><span class="line"><span class="comment">#  instance:</span></span><br><span class="line"><span class="comment">#    hostname: test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eurekaclient</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>效果：</p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/732ec4bbbf754ffaedb2cdc4f9bc93cf-137465" alt="Eureka1号注册中心"></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/a12149d58adf941cebceaca9406b2bf0-140073" alt="Eureka2号注册中心"></p>
</li>
<li><p>在开发的项目的正式发布环境中一般至少保证有两个注册中心。</p>
</li>
</ol>
<h2 id="ConfigServer服务"><a href="#ConfigServer服务" class="headerlink" title="ConfigServer服务"></a>ConfigServer服务</h2><ol>
<li><p>创建一个SpringCloud ConfigServer服务的项目，主要依赖如下（pom.xml）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringCloud 整合 config-server --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- SpringCloud 整合 eureka客户端 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在启动类上添加Eureka客户端以及ConfigServer注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigserverApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigserverApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在GitHub上创建一个github配置文件项目，可以公开或者私有，私有的话，SpringCloud的ConfigServer项目配置文件中就要输入密码；</p>
</li>
<li><p>修改应用配置文件（application.yml）:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># 使用ip</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span>  <span class="comment"># 修改了安全，这个会单独说明</span></span><br><span class="line">    <span class="attr">instance:</span></span><br><span class="line">      <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># 使用ip</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">configserver</span>  <span class="comment"># 项目名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/WanderROS/cloudconfig</span> <span class="comment"># 配置git仓库的地址（最后不需要带/，否则会出现：No custom http config found for URL: XXX）</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">/</span> <span class="comment"># git仓库地址下的相对搜索地址（可用使用通配符），可以配置多个，用,分割。可以&#123;application&#125;实现按应用查配置</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">wanderros</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">******</span></span><br><span class="line">          <span class="attr">default-label:</span> <span class="string">master</span> <span class="comment">#选择分支</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置好了就可以直接启动配置服务器了，然后访问配置服务器的地址：<a href="http://localhost:8080/service-dev.json，注意这个是要在github配置中有，不然是访问不到的：" target="_blank" rel="noopener">http://localhost:8080/service-dev.json，注意这个是要在github配置中有，不然是访问不到的：</a></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/67ff71ae722b14068bf54ec71013db35-35448" alt="github内容"></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/d3cd3bf9c1169c1c7a60a3a7c6d06cc9-21040" alt="config网址内容"></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/90d1ce032ea695483d0bc7ae1a41c05e-120477" alt="config添加到注册中心"></p>
</li>
</ol>
<h2 id="ConfigClient"><a href="#ConfigClient" class="headerlink" title="ConfigClient"></a>ConfigClient</h2><ol>
<li><p>创建一个服务，使用ConfigServer的配置，项目主要依赖如下（pom.xml）:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在启动类上添加Eureka客户端注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientserviceApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ClientserviceApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建配置文件bootstrap.yml，并添加内容：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service</span>   <span class="comment">#指定了配置文件的应用名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8080/</span>  <span class="comment">#Config server的uri </span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span>     <span class="comment">#指定的环境</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span>                      <span class="comment">#指定分支</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span></span><br><span class="line">    <span class="attr">instance:</span></span><br><span class="line">      <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个RESTful控制器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RestController</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;hello&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">serviceHello</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; ret = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        ret.put(<span class="string">"test"</span>, <span class="string">"hello"</span>);</span><br><span class="line">        ret.put(<span class="string">"age"</span>, <span class="number">18</span>);</span><br><span class="line">        ret.put(<span class="string">"status"</span>, <span class="string">"success"</span>);</span><br><span class="line">        ret.put(<span class="string">"hello"</span>, name);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注意注入了配置服务器中的hello字段的内容，如果配置服务器没启动会报错的</li>
<li>还添加了@RefreshScope注解，这个是github配置文件修改后进行手动刷新之后必须要配置的（坑点之一），有用到配置服务器的内容的类都要添加</li>
<li>将所有的actuator接口都暴露出来，是为了POST actuator/refresh接口，这样就能够手动刷新服务，而无需重新启动服务就更新配置了</li>
</ul>
</li>
<li><p>启动服务，需要注意的是前面的EurekaServer服务以及ConfigServer服务都要是启动的，然后访问<a href="http://localhost:8081：">http://localhost:8081：</a></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/771cc7a70145406b92427b148d684592-18014" alt="访问Service服务"></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/5393c5d00ad35c6d857235785be3cc7c-42683" alt="修改github配置文件"></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/f519dacdf40981351c0a16f9e3a7b881-110812" alt="POST刷新配置"></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/dca44713c7e8eba2be6f80be99ea50a6-20091" alt="刷新后访问Service服务"></p>
</li>
</ol>
<h2 id="Feign服务"><a href="#Feign服务" class="headerlink" title="Feign服务"></a>Feign服务</h2><ol>
<li><p>创建这个项目主要为了使用Feign进行服务的访问，主要依赖配置如下（pom.xml）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>需要注意的是要添加的是spring-cloud-starter-openfeign，其他的会默认添加上，不要乱添加，否则会出现问题</li>
</ul>
</li>
<li><p>在启动类上添加注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加配置（使用配置服务，因此文件要为bootstrap.yml）：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consumer</span>   <span class="comment">#指定了配置文件的应用名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8080/</span>  <span class="comment">#Config server的uri</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span>     <span class="comment">#指定的环境</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span>                      <span class="comment">#指定分支</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="comment"># feign熔断器开关</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">1000</span>  <span class="comment">#1秒</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment">#配置规则 随机</span></span><br><span class="line">    <span class="comment">#NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RoundRobinRule #配置规则 轮询</span></span><br><span class="line">    <span class="comment"># NFLoadBalancerRuleClassName: com.netflix.loadbalancer.BestAvailableRule #配置规则 最空闲连接策略</span></span><br><span class="line">    <span class="attr">ConnectTimeout:</span> <span class="number">500</span> <span class="comment">#请求连接超时时间</span></span><br><span class="line">    <span class="attr">ReadTimeout:</span> <span class="number">1000</span> <span class="comment">#请求处理的超时时间</span></span><br><span class="line">    <span class="attr">OkToRetryOnAllOperations:</span> <span class="literal">true</span> <span class="comment">#对所有请求都进行重试</span></span><br><span class="line">    <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">2</span> <span class="comment">#切换实例的重试次数</span></span><br><span class="line">    <span class="attr">MaxAutoRetries:</span> <span class="number">1</span> <span class="comment">#对当前实例的重试次数</span></span><br></pre></td></tr></table></figure>

<ul>
<li>注意fegin和hystrix结合的比较好，要配置服务降级的话，添加feign.hystrix.enabled=true即可</li>
<li>默认负载均衡是轮询，也是可以修改的</li>
</ul>
</li>
<li><p>配置Feign接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(value = <span class="string">"myFeignClient"</span>)</span><br><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"service"</span>,fallback=ServiceFallback<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">MyFeignClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/"</span>)</span><br><span class="line">    <span class="function">Map&lt;String,Object&gt; <span class="title">hello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加降级类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceFallback</span> <span class="keyword">implements</span> <span class="title">MyFeignClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"err"</span>,<span class="string">"服务崩溃"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置RESTful控制器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyFeignClient myFeignClient;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// @HystrixCommand(fallbackMethod = "getHello")</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; ret=myFeignClient.hello();</span><br><span class="line">        Map&lt;String,Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"res"</span>,ret);</span><br><span class="line">        res.put(<span class="string">"msg"</span>,<span class="string">"success"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">getHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"msg"</span>,<span class="string">"启动熔断"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动项目，前面的EurekaServer服务、Service服务以及ConfigServer服务都要是启动的，访问<a href="http://localhost:9000即可：">http://localhost:9000即可：</a></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/ff198fc22593c8807723ca380df04410-21126" alt="Feign服务"></p>
<ul>
<li><p>关闭Service服务，访问服务：</p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/ff0e8a419bf054dbc4b6c5a06ef84d94-15952" alt="Feign服务降级"></p>
</li>
<li><p>EurekaServer展示页面：</p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/bbb3d2ee423a1060a64b7cb96428814c-112832" alt="EurekaServer展示页面"></p>
</li>
</ul>
</li>
</ol>
<h2 id="RestTemplate服务"><a href="#RestTemplate服务" class="headerlink" title="RestTemplate服务"></a>RestTemplate服务</h2><ol>
<li><p>创建这个项目主要为了使用RestTemplate进行服务的访问，主要依赖配置如下（pom.xml）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在启动类上注解并添加RestTemplate的Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableHystrix</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestconsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RestconsumerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function">RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>@LoadBalanced是Ribbon的注解，用于负载均衡</li>
<li>@EnableHystrix是开启Hystrix的注解，用于服务熔断</li>
</ul>
</li>
<li><p>添加配置（application.yml）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9500</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">restconsumer</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建控制器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod=<span class="string">"consumerServiceRibbonFallback"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String ret=restTemplate.getForObject(<span class="string">"http://service/"</span>,String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Map&lt;String,Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"res"</span>,ret);</span><br><span class="line">        res.put(<span class="string">"msg"</span>,<span class="string">"success"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">consumerServiceRibbonFallback</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"res"</span>,<span class="string">"error"</span>);</span><br><span class="line">        res.put(<span class="string">"msg"</span>,<span class="string">"err"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动项目，前面的EurekaServer服务、Service服务以及ConfigServer服务都要是启动的，访问<a href="http://localhost:9500即可：">http://localhost:9500即可：</a></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/3d4b9eb96de8e029a50c38f583ccb396-23085" alt="restTemplate客户端"></p>
</li>
</ol>
<h2 id="zuul网关"><a href="#zuul网关" class="headerlink" title="zuul网关"></a>zuul网关</h2><ol>
<li><p>创建项目，添加主要依赖如下(不添加配置客户端)：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在启动类上开启zuul服务以及Eureka客户端注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulgatewayApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ZuulgatewayApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件(application.yml)：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">zuul</span>   <span class="comment">#指定了配置文件的应用名</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">host:</span></span><br><span class="line">    <span class="attr">connect-timeout-millis:</span> <span class="number">15000</span> <span class="comment">#HTTP连接超时要比Hystrix的大</span></span><br><span class="line">    <span class="attr">socket-timeout-millis:</span> <span class="number">60000</span>   <span class="comment">#socket超时</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">120000</span>  <span class="comment">#请求处理的超时时间</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">30000</span>  <span class="comment">#请求连接的超时时间</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动zuul服务，然后就可以通过Eureka中注册的服务名称添加接口地址访问服务了，比如：<a href="http://localhost:9001/consumer/" target="_blank" rel="noopener">http://localhost:9001/consumer/</a></p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/99d9a830b1de9837c1e1b15756ffbd43-25199" alt="zuul访问服务"></p>
<ul>
<li><p>访问超时的服务时会崩溃，比如：<a href="http://localhost:9001/configserver/service-dev.json，因此添加了配置" target="_blank" rel="noopener">http://localhost:9001/configserver/service-dev.json，因此添加了配置</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">host:</span></span><br><span class="line">    <span class="attr">connect-timeout-millis:</span> <span class="number">15000</span> <span class="comment">#HTTP连接超时要比Hystrix的大</span></span><br><span class="line">    <span class="attr">socket-timeout-millis:</span> <span class="number">60000</span>   <span class="comment">#socket超时</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">120000</span>  <span class="comment">#请求处理的超时时间</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">30000</span>  <span class="comment">#请求连接的超时时间</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>超时错误：</p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/9c0f83fb94488c19d9ee0594b84272d4-195280" alt="未配置超时效果"></p>
</li>
<li><p>修改配置后：</p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/ad92ee11c226e8ca816f947e2182660a-28278" alt="配置之后"></p>
</li>
<li><p>网关默认的等待时间为1秒，时间到了还没有响应就会报错</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>创建一个服务过滤器serviceFilter继承自ZuulFilter：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">serviceFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"pre"</span>;<span class="comment">// 定义filter的类型，有pre、route、post、error四种</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">// 定义filter的顺序，数字越小表示顺序越高，越先执行</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// 表示是否需要执行该filter，true表示执行，false表示不执行</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123; <span class="comment">// filter需要执行的具体操作</span></span><br><span class="line">        <span class="comment">// filter需要执行的具体操作</span></span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletRequest request = ctx.getRequest();</span><br><span class="line">        String token = request.getParameter(<span class="string">"token"</span>);</span><br><span class="line">        System.out.println(token);</span><br><span class="line">        <span class="keyword">if</span>(token==<span class="keyword">null</span>)&#123;</span><br><span class="line">            log.warn(<span class="string">"there is no request token"</span>);</span><br><span class="line">            ctx.setSendZuulResponse(<span class="keyword">false</span>);</span><br><span class="line">            ctx.setResponseStatusCode(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ctx.getResponse().getWriter().write(<span class="string">"there is no request token"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"ok"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加玩上述过滤器之后，重启网关服务</li>
<li>现在所有经过网关的服务中必须添加参数token，否则不允许访问任何服务</li>
</ul>
</li>
<li><p>测试过滤器：</p>
<ul>
<li><p>不带token参数：</p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/273facdf1cf67f2e34655f7fe6c24ed7-16109" alt="不带token参数"></p>
</li>
<li><p>带token参数：</p>
<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/fa9f6138ca8d8607fb92a57f44d4596c-26046" alt="带token参数"></p>
</li>
</ul>
</li>
</ol>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>SpringCloud相关的技术真的很繁琐，内容比较多，这里还有和SpringCloud相关的组件没有使用过，而且这些使用都是非常简单的实现，复杂的配置选项以及源码都没有阅读理解。在后续的学习过程中还需要不断扩充这部分的内容，感觉理解还是不够深入，无法比较好地去叙述这部分内容！</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat_pay.jpg" alt="WanderROS 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="WanderROS 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

<div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2020/08/05/SpringCloud-Eureka-Quick-Start/">SpringCloud Eureka Quick Start</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 WanderROS 的个人博客">WanderROS</a></p>
  <p><span>发布时间:</span>2020年08月05日 - 09:29</p>
  <p><span>最后更新:</span>2020年10月01日 - 16:52</p>
  <p><span>原始链接:</span><a href="/2020/08/05/SpringCloud-Eureka-Quick-Start/" title="SpringCloud Eureka Quick Start">https://wanderros.github.io/2020/08/05/SpringCloud-Eureka-Quick-Start/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://wanderros.github.io/2020/08/05/SpringCloud-Eureka-Quick-Start/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
      $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
        });
    });  
</script>


      
</div>

<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

  
</div>

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/07/29/Vue%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E6%A8%A1%E5%BC%8F%E7%BB%84%E4%BB%B6Vuex/" rel="next" title="Vue状态管理模式组件Vuex">
                <i class="fa fa-chevron-left"></i> Vue状态管理模式组件Vuex
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/08/07/SpringBoot%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AEhttp%E6%9C%8D%E5%8A%A1%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB/" rel="prev" title="SpringBoot远程访问http服务方法汇总">
                SpringBoot远程访问http服务方法汇总 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>
<div>
		
    	<!-- Link Gitalk 的支持文件  -->
	<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
	<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script> 
	<div id="gitalk-container"></div>     <script type="text/javascript">
		var gitalk = new Gitalk({
			clientID: 'bd073c3374c2b1a924b0',
			clientSecret: 'e3818342fe0fa0f03ab0997cfe81ae9c450ec954',
			repo: 'wanderros.github.io',
			owner: 'WanderROS',
			admin: ['WanderROS'],
			id: location.pathname,
			distractionFreeMode: 'true'
		});
		gitalk.render('gitalk-container');
	</script> 
	<!-- Gitalk end -->

		
	</div>


    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
 <div id="gitalk-container"></div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="WanderROS" />
            
              <p class="site-author-name" itemprop="name">WanderROS</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives%7C%7C%20archive">
              
                  <span class="site-state-item-count">148</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wanderROS" target="_blank" title="GitHub">
                      GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:1194409532@qq.com.com" target="_blank" title="E-Mail">
                      E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#开始"><span class="nav-number">2.</span> <span class="nav-text">开始</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础知识"><span class="nav-number">2.1.</span> <span class="nav-text">基础知识</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网关Zuul"><span class="nav-number">2.2.</span> <span class="nav-text">网关Zuul</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#限流、熔断和降级Hystrix-hɪst’rɪks"><span class="nav-number">2.3.</span> <span class="nav-text">限流、熔断和降级Hystrix [hɪst’rɪks]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置ConfigServer"><span class="nav-number">2.4.</span> <span class="nav-text">配置ConfigServer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注意点"><span class="nav-number">2.5.</span> <span class="nav-text">注意点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#动手实操"><span class="nav-number">3.</span> <span class="nav-text">动手实操</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Eureka服务端"><span class="nav-number">3.1.</span> <span class="nav-text">Eureka服务端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Eureka客户端"><span class="nav-number">3.2.</span> <span class="nav-text">Eureka客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Eureka高可用注册"><span class="nav-number">3.3.</span> <span class="nav-text">Eureka高可用注册</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ConfigServer服务"><span class="nav-number">3.4.</span> <span class="nav-text">ConfigServer服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ConfigClient"><span class="nav-number">3.5.</span> <span class="nav-text">ConfigClient</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Feign服务"><span class="nav-number">3.6.</span> <span class="nav-text">Feign服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RestTemplate服务"><span class="nav-number">3.7.</span> <span class="nav-text">RestTemplate服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#zuul网关"><span class="nav-number">3.8.</span> <span class="nav-text">zuul网关</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WanderROS</span>

  
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>
<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>


-->
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共386k字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  













  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
<!--崩溃欺骗-->
<script type="text/javascript" src="/js/src/crash_cheat.js"></script>
