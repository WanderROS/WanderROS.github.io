<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>WanderROS&#39;S Daily</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://wanderros.github.io/"/>
  <updated>2020-10-06T10:03:35.574Z</updated>
  <id>https://wanderros.github.io/</id>
  
  <author>
    <name>WanderROS</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>SpringBoot Serializer&amp;Deserializer Quick Start</title>
    <link href="https://wanderros.github.io/2020/10/06/SpringBoot-Serializer-Deserializer-Quick-Start/"/>
    <id>https://wanderros.github.io/2020/10/06/SpringBoot-Serializer-Deserializer-Quick-Start/</id>
    <published>2020-10-06T08:16:18.000Z</published>
    <updated>2020-10-06T10:03:35.574Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>序列化和反序列化是编程语言中的一个概念，在Java里是一个较为基础的知识点，但是什么是序列化和反序列化，有什么作用，底层实现原理是什么，一连问之后可能整个人会蒙。这里主要记录Java序列化、反序列化的概念以及如何进行序列化和反序列化，包括在这当中用到的工具包等。</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li><code>Java (Serializer)序列化</code>是指把Java对象转换为字节序列的过程，而<code>Java (Deserializer )反序列化</code>是指把字节序列恢复为Java对象的过程。</li><li>主要功能：对象序列化最主要的用处就是在传递和保存对象的时候，保证对象的完整性和可传递性；对象反序列化则用于重建对象。</li><li>本质：序列化就是把实体对象状态按照一定的格式写入到有序字节流，反序列化就是从有序字节流重建对象，恢复对象状态。</li><li>用处：<ul><li>实现了数据持久化</li><li>利用序列化实现远程通信</li><li>利用序列化在进程间传递对象</li></ul></li><li>序列化以及反序列化必须保证字节流中所保存的对象状态及描述信息完整！</li><li>Java中提供了对象的序列化与反序列化，但是目前常用的数据传输格式主要有<code>xml</code>、<code>json</code>，在后端开发中一般使用<code>json</code>进行接口数据传输，因此在本文中主要涉及到序列化之后的内容呈现为<code>json</code>格式。</li><li>对于采用实现原生Java API的序列化接口<code>Serializable</code>的方式：<strong>为了提高serialVersionUID的独立性和确定性，强烈建议在一个可序列化类中显示的定义serialVersionUID，为它赋予明确的值。</strong></li><li><code>json</code>格式规范：<ul><li>英文版：<a href="https://google.github.io/styleguide/jsoncstyleguide.xml" target="_blank" rel="noopener">https://google.github.io/styleguide/jsoncstyleguide.xml</a></li><li>中文版：<a href="https://github.com/darcyliu/google-styleguide/blob/master/JSONStyleGuide.md" target="_blank" rel="noopener">https://github.com/darcyliu/google-styleguide/blob/master/JSONStyleGuide.md</a></li><li><code>json API</code>格式规范：<a href="http://jsonapi.org.cn/format/" target="_blank" rel="noopener">http://jsonapi.org.cn/format/</a></li></ul></li><li>几个常用的json类库：<ul><li>Gson: 谷歌开发的<code>json</code>库，功能十分全面</li><li>FastJson: 阿里巴巴开发的 <code>json</code>库，性能十分优秀</li><li>Jackson: 社区十分活跃且更新速度很快</li></ul></li><li><code>Gson</code>、<code>FastJson</code>、<code>Jackson</code>要求序列化/反序列化的是标准的类，否则无法解析，因为都用到了反射！</li></ol><h2 id="JSON的一些经验"><a href="#JSON的一些经验" class="headerlink" title="JSON的一些经验"></a>JSON的一些经验</h2><ol><li>遵循Java Beans规范与JSON规范，能减少大部分的问题。</li><li>使用正常的key，尽量不要使用数字等字符开头的key，尽量使用符合Java的class或property命名规范的key，这样会减少不必要的冲突。</li><li>关于日期处理尽量使用标准的日期格式，或者序列化和反序列化里都是用同样的datePattern格式。</li><li>如果JSONObject与正常的POJO混用，出现问题的概率较高。</li><li>尽量不要在使用过多的层次嵌套的同时使用泛型（List、Map等），可能导致类型丢失，而且问题比较难查。</li><li>尽量不要在同一个Bean的层次结构里使用多个子类型对象，可能导致类型丢失，而且问题比较难查。</li><li>尽量避免循环引用，这个虽然可以通过序列化特性禁掉，但是如果能避免则避免。</li><li>注意编码和不可见字符！</li></ol><h2 id="Fastjson基础"><a href="#Fastjson基础" class="headerlink" title="Fastjson基础"></a>Fastjson基础</h2><ol><li><p><code>fastjson</code>是一个阿里开源的基于<code>Java</code>语言编写的高性能功能完善的json库，非常适合用于<code>Java</code>的序列化以及反序列化。如果项目中使用maven管理依赖的话，只需在<code>pom</code>中添加如下内容：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.73<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><code>fastjson</code>源码地址：<a href="https://github.com/alibaba/fastjson" target="_blank" rel="noopener">https://github.com/alibaba/fastjson</a></p></li><li><p><code>fastjson</code>快速使用以及<a href="https://github.com/alibaba/fastjson/wiki/FastJson-文档链接" target="_blank" rel="noopener">文档链接</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String text = JSON.toJSONString(obj); <span class="comment">//序列化</span></span><br><span class="line">VO vo = JSON.parseObject(<span class="string">"&#123;...&#125;"</span>, VO<span class="class">.<span class="keyword">class</span>)</span>; <span class="comment">//反序列化</span></span><br></pre></td></tr></table></figure></li><li><p><code>fastjson</code>序列化API：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 将Java对象序列化为JSON字符串，支持各种各种Java基本类型和JavaBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toJSONString</span><span class="params">(Object object, SerializerFeature... features)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将Java对象序列化为JSON字符串，返回JSON字符串的utf-8 bytes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] toJSONBytes(Object object, SerializerFeature... features);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将Java对象序列化为JSON字符串，写入到Writer中</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeJSONString</span><span class="params">(Writer writer, </span></span></span><br><span class="line"><span class="function"><span class="params">                                       Object object, </span></span></span><br><span class="line"><span class="function"><span class="params">                                       SerializerFeature... features)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将Java对象序列化为JSON字符串，按UTF-8编码写入到OutputStream中</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">writeJSONString</span><span class="params">(OutputStream os, // </span></span></span><br><span class="line"><span class="function"><span class="params">                                            Object object, // </span></span></span><br><span class="line"><span class="function"><span class="params">                                            SerializerFeature... features)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>fastjson</code>反序列化API：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 将JSON字符串反序列化为JavaBean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">parseObject</span><span class="params">(String jsonStr, </span></span></span><br><span class="line"><span class="function"><span class="params">                                    Class&lt;T&gt; clazz, </span></span></span><br><span class="line"><span class="function"><span class="params">                                    Feature... features)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将JSON字符串反序列化为JavaBean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">parseObject</span><span class="params">(<span class="keyword">byte</span>[] jsonBytes,  // UTF<span class="number">-8</span>格式的JSON字符串</span></span></span><br><span class="line"><span class="function"><span class="params">                                    Class&lt;T&gt; clazz, </span></span></span><br><span class="line"><span class="function"><span class="params">                                    Feature... features)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将JSON字符串反序列化为泛型类型的JavaBean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">parseObject</span><span class="params">(String text, </span></span></span><br><span class="line"><span class="function"><span class="params">                                    TypeReference&lt;T&gt; type, </span></span></span><br><span class="line"><span class="function"><span class="params">                                    Feature... features)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将JSON字符串反序列为JSONObject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title">parseObject</span><span class="params">(String text)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>fastjson</code>支持的时间格式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String            defaultPatttern    = <span class="string">"yyyy-MM-dd HH:mm:ss"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter defaultFormatter   = DateTimeFormatter.ofPattern(defaultPatttern);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_dt19_tw  = DateTimeFormatter.ofPattern(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_dt19_cn  = DateTimeFormatter.ofPattern(<span class="string">"yyyy年M月d日 HH:mm:ss"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_dt19_cn_1  = DateTimeFormatter.ofPattern(<span class="string">"yyyy年M月d日 H时m分s秒"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_dt19_kr  = DateTimeFormatter.ofPattern(<span class="string">"yyyy년M월d일 HH:mm:ss"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_dt19_us  = DateTimeFormatter.ofPattern(<span class="string">"MM/dd/yyyy HH:mm:ss"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_dt19_eur = DateTimeFormatter.ofPattern(<span class="string">"dd/MM/yyyy HH:mm:ss"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_dt19_de  = DateTimeFormatter.ofPattern(<span class="string">"dd.MM.yyyy HH:mm:ss"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_dt19_in  = DateTimeFormatter.ofPattern(<span class="string">"dd-MM-yyyy HH:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_d8       = DateTimeFormatter.ofPattern(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_d10_tw   = DateTimeFormatter.ofPattern(<span class="string">"yyyy/MM/dd"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_d10_cn   = DateTimeFormatter.ofPattern(<span class="string">"yyyy年M月d日"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_d10_kr   = DateTimeFormatter.ofPattern(<span class="string">"yyyy년M월d일"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_d10_us   = DateTimeFormatter.ofPattern(<span class="string">"MM/dd/yyyy"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_d10_eur  = DateTimeFormatter.ofPattern(<span class="string">"dd/MM/yyyy"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_d10_de   = DateTimeFormatter.ofPattern(<span class="string">"dd.MM.yyyy"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_d10_in   = DateTimeFormatter.ofPattern(<span class="string">"dd-MM-yyyy"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter ISO_FIXED_FORMAT =</span><br><span class="line">        DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).withZone(ZoneId.systemDefault());</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String formatter_iso8601_pattern     = <span class="string">"yyyy-MM-dd'T'HH:mm:ss"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter formatter_iso8601  = DateTimeFormatter.ofPattern(formatter_iso8601_pattern);</span><br></pre></td></tr></table></figure></li><li><p><code>fastjson</code>目前没有废弃的SerializerFeature介绍：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">QuoteFieldNames <span class="comment">// key使用引号</span></span><br><span class="line">UseSingleQuotes <span class="comment">// 使用单引号</span></span><br><span class="line">WriteMapNullValue <span class="comment">// 输出Map的null值</span></span><br><span class="line">WriteEnumUsingToString <span class="comment">// 枚举属性输出toString的结果</span></span><br><span class="line">WriteEnumUsingName <span class="comment">// 枚举数据输出name</span></span><br><span class="line">UseISO8601DateFormat <span class="comment">// 使用日期格式</span></span><br><span class="line">WriteNullListAsEmpty <span class="comment">// List为空则输出[]</span></span><br><span class="line">WriteNullStringAsEmpty <span class="comment">// String为空则输出""</span></span><br><span class="line">WriteNullNumberAsZero <span class="comment">// Number类型为空则输出0</span></span><br><span class="line">WriteNullBooleanAsFalse <span class="comment">// Boolean类型为空则输出false</span></span><br><span class="line">SkipTransientField <span class="comment">// 忽略使用了transient关键字的内容</span></span><br><span class="line">SortField <span class="comment">// 排序字段</span></span><br></pre></td></tr></table></figure><ul><li>支持多个SerializerFeature同时作用</li></ul></li></ol><h2 id="Gson基础"><a href="#Gson基础" class="headerlink" title="Gson基础"></a>Gson基础</h2><ol><li><p>源码地址：<a href="https://github.com/google/gson" target="_blank" rel="noopener">https://github.com/google/gson</a></p></li><li><p>如果项目中使用maven管理依赖的话，只需在<code>pom</code>中添加如下内容：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><code>Gson</code>序列化、反序列化：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">String jsonStr = gson.toJson(beanObject); <span class="comment">// 序列化</span></span><br><span class="line">BeanType bean = gson.fromJson(jsonData, BeanType<span class="class">.<span class="keyword">class</span>)</span>; <span class="comment">// 反序列化</span></span><br></pre></td></tr></table></figure></li><li><p><code>Gson</code>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GSONTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">//解析</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 对象嵌套数组嵌套对象</span></span><br><span class="line">        String json1 = <span class="string">"&#123;'id':1,'name':'JAVAEE-1703','stus':[&#123;'id':101,'name':'刘一','age':16&#125;]&#125;"</span>;</span><br><span class="line">        <span class="comment">// 数组</span></span><br><span class="line">        String json2 = <span class="string">"['北京','天津','杭州']"</span>;</span><br><span class="line"></span><br><span class="line">        Gson gson=<span class="keyword">new</span> Gson();</span><br><span class="line">        <span class="comment">//1、</span></span><br><span class="line">        <span class="comment">//解析对象：第一个参数：待解析的字符串 第二个参数结果数据类型的Class对象</span></span><br><span class="line">        Grade grade=gson.fromJson(json1, Grade<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(grade);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、</span></span><br><span class="line">        <span class="comment">//解析数组要求使用Type</span></span><br><span class="line">        ArrayList&lt;String&gt; list=gson.fromJson(json2, </span><br><span class="line">                <span class="keyword">new</span> TypeToken&lt;ArrayList&lt;String&gt;&gt;()&#123;&#125;.getType());</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//生成</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ArrayList&lt;Student&gt; list=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;<span class="number">3</span>;i++)&#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> Student(<span class="number">101</span>+i, <span class="string">"码子"</span>, <span class="number">20</span>+i));</span><br><span class="line">        &#125;</span><br><span class="line">        Grade grade=<span class="keyword">new</span> Grade(<span class="number">100001</span>,<span class="string">"张三"</span>, list);</span><br><span class="line">        Gson gson=<span class="keyword">new</span> Gson();</span><br><span class="line">        <span class="comment">//将对象转换为诶JSON格式字符串</span></span><br><span class="line">        String json=gson.toJson(grade);</span><br><span class="line">        System.out.println(json);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="Jackson基础"><a href="#Jackson基础" class="headerlink" title="Jackson基础"></a>Jackson基础</h2><ol><li><p>源码地址：<a href="https://github.com/FasterXML/jackson-databind" target="_blank" rel="noopener">https://github.com/FasterXML/jackson-databind</a></p></li><li><p>如果项目中使用maven管理依赖的话，只需在<code>pom</code>中添加如下内容：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><code>Jackson</code>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JackSonTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// 对象嵌套数组嵌套对象</span></span><br><span class="line">        String json1 = <span class="string">"&#123;\"id\":1,\"name\":\"JAVAEE-1703\",\"stus\":[&#123;\"id\":101,\"name\":\"刘一\",\"age\":16&#125;]&#125;"</span>;</span><br><span class="line">        <span class="comment">// 数组</span></span><br><span class="line">        String json2 = <span class="string">"[\"北京\",\"天津\",\"杭州\"]"</span>;</span><br><span class="line">        <span class="comment">//1、</span></span><br><span class="line">        ObjectMapper mapper=<span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        Grade grade=mapper.readValue(json1, Grade<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(grade);</span><br><span class="line">        <span class="comment">//2、</span></span><br><span class="line">        ArrayList&lt;String&gt; list=mapper.readValue(json2, </span><br><span class="line">                <span class="keyword">new</span> TypeReference&lt;ArrayList&lt;String&gt;&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(list);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//生成</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException</span>&#123;</span><br><span class="line">        ArrayList&lt;Student&gt; list=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;<span class="number">3</span>;i++)&#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> Student(<span class="number">101</span>+i, <span class="string">"码子"</span>, <span class="number">20</span>+i));</span><br><span class="line">        &#125;</span><br><span class="line">        Grade grade=<span class="keyword">new</span> Grade(<span class="number">100001</span>,<span class="string">"张三"</span>, list);</span><br><span class="line">        ObjectMapper mapper=<span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        <span class="comment">//将对象转换为JSON格式字符串</span></span><br><span class="line">        String json=mapper.writeValueAsString(grade);</span><br><span class="line">        System.out.println(json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>序列化这部分主要是看官方文档以及一些比较有价值的博客，示例代码都不太想写了，写规范的<code>json</code>是要遵守规则的，否则会出现问题！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;序列化和反序列化是编程语言中的一个概念，在Java里是一个较为基础的知识点，但是什么是序列化和反序列化，有什么作用，底层实现原理是什么，一连
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="https://wanderros.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBoot ELK Quick Start</title>
    <link href="https://wanderros.github.io/2020/10/02/SpringBoot-ELK-Quick-Start/"/>
    <id>https://wanderros.github.io/2020/10/02/SpringBoot-ELK-Quick-Start/</id>
    <published>2020-10-02T12:36:20.000Z</published>
    <updated>2020-10-02T15:29:20.475Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>随着互联网的快速发展，系统越来越庞大，依赖肉眼分析日志文件来排查问题的方式渐渐凸显出一些问题：</p><ul><li>分布式集群环境下，服务器数量可能达到成百上千，如何准确定位？</li><li>微服务架构中，如何根据异常信息，定位其他各服务的上下文信息？</li><li>随着日志文件的不断增大，可能面临在服务器上不能直接打开的尴尬。</li><li>文本搜索太慢、无法多维度查询等… …</li></ul><p>面临这些问题，就需要集中化的日志管理，将所有服务器节点上的日志统一收集，管理，访问。ELK（Elasticsearch Logstash Kibana）的强大在之前的文章中有介绍过，这里主要记录如何在SpringBoot中使用ELK记录日志。后续可能还会将ELK引入项目中作为搜索引擎提供搜索功能，这里先记录下日志记录功能。</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li><p><code>Elasticsearch</code>基于 Lucene 开发，目前使用最广的开源搜索引擎之一，是一个分布式的搜索和分析引擎，可以用于全文检索、结构化检索和分析，并能将这三者结合起来。</p></li><li><p><code>Logstash</code>简单来说就是一根具备实时数据传输能力的管道，负责将数据信息从管道的输入端传输到管道的输出端，与此同时这根管道还可以根据需求在中间加上滤网，提供了很多功能强大的滤网以满足各种应用场景。</p></li><li><p><code>Kibana</code>是一个开源的分析与可视化平台，可以用<code>Kibana</code>搜索、查看、交互存放在<code>Elasticsearch</code>索引里的数据，使用各种不同的图标、表格、地图等，<code>Kibana</code>能够很轻易的展示高级数据分析与可视化。</p></li><li><p><code>Logstash</code>可以从本地磁盘，网络服务（自己监听端口，接受用户日志），消息队列中收集各种各样的日志，然后进行过滤分析，并将日志输出到<code>Elasticsearch</code>中。</p></li><li><p>轻量级数据采集器Beats官网：<a href="https://www.elastic.co/cn/beats/" target="_blank" rel="noopener">https://www.elastic.co/cn/beats/</a></p></li><li><p>ELKB架构图：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/4c796fcaa7eea35a4d48bb6a1efee623-206417" alt="ELK架构图"></p></li><li><p>ELKR架构图：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/57d725d8092bef5760dac89f00892ced-246693" alt="ELKR架构图"></p></li><li><p>程序写入日志时序图：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/f852ca8e0dd5fbbcdd2377edddc11d0d-70104" alt="程序写入日志时序图"></p></li><li><p>ELK收集日志及Kibina查询日志时序图：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/56d44272ab155a82b18aacf1a22f5a7f-123940" alt="ELK收集日志及Kibina查询日志时序图"></p></li></ol><h2 id="ELK环境构建（Docker单机）"><a href="#ELK环境构建（Docker单机）" class="headerlink" title="ELK环境构建（Docker单机）"></a>ELK环境构建（Docker单机）</h2><ol><li><p><strong>注意版本保持一致，这里都使用7.6.2版本！</strong></p></li><li><p>Docker镜像拉取：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull logstash:7.6.2</span><br><span class="line">docker pull elasticsearch:7.6.2</span><br><span class="line">docker pull kibana:7.6.2</span><br></pre></td></tr></table></figure></li><li><p>在要启动的镜像的命令处创建一个<code>elk</code>目录，主要用于放置ELK的数据和配置，在<code>elk</code>目录中添加<code>esdata</code>目录，给予777权限，然后运行下面的docker命令，用于启动<code>elasticsearch</code>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --name elasticsearch \</span><br><span class="line">-v "$PWD/esdata":/usr/share/elasticsearch/data \</span><br><span class="line">-e "discovery.type=single-node" \</span><br><span class="line">-p 9200:9200 -p 9300:9300 \</span><br><span class="line">-d elasticsearch:7.6.2</span><br></pre></td></tr></table></figure></li><li><p>然后访问启动<code>elasticsearch</code>服务的主机的9200端口，看到如下类似内容就表示启动成功：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"name"</span>: <span class="string">"46f533f30381"</span>,</span><br><span class="line"><span class="attr">"cluster_name"</span>: <span class="string">"docker-cluster"</span>,</span><br><span class="line"><span class="attr">"cluster_uuid"</span>: <span class="string">"4HvY1D4PSqWzRNANscHFEw"</span>,</span><br><span class="line"><span class="attr">"version"</span>: &#123;</span><br><span class="line"><span class="attr">"number"</span>: <span class="string">"7.6.2"</span>,</span><br><span class="line"><span class="attr">"build_flavor"</span>: <span class="string">"default"</span>,</span><br><span class="line"><span class="attr">"build_type"</span>: <span class="string">"docker"</span>,</span><br><span class="line"><span class="attr">"build_hash"</span>: <span class="string">"ef48eb35cf30adf4db14086e8aabd07ef6fb113f"</span>,</span><br><span class="line"><span class="attr">"build_date"</span>: <span class="string">"2020-03-26T06:34:37.794943Z"</span>,</span><br><span class="line"><span class="attr">"build_snapshot"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="attr">"lucene_version"</span>: <span class="string">"8.4.0"</span>,</span><br><span class="line"><span class="attr">"minimum_wire_compatibility_version"</span>: <span class="string">"6.8.0"</span>,</span><br><span class="line"><span class="attr">"minimum_index_compatibility_version"</span>: <span class="string">"6.0.0-beta1"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">"tagline"</span>: <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>使用如下命令启动<code>Kibana</code>服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --name kibana \</span><br><span class="line">--link elasticsearch:elasticsearch \</span><br><span class="line">-p 5601:5601 \</span><br><span class="line">-d kibana:7.6.2</span><br></pre></td></tr></table></figure></li><li><p>等待启动成功之后就可以访问启动<code>Kibana</code>服务的主机的5601端口，可以看到<code>Kibana</code>的主页。</p></li><li><p>在<code>elk</code>目录下创建<code>logstash</code>、<code>logstash/conf</code>、<code>logstash/pipeline</code>、<code>logstash/data</code>目录，在<code>logstash/conf</code>目录下创建<code>jvm.options</code>、<code>log4j2.properties</code>、<code>logstash.yml</code>、<code>pipelines.yml</code>、<code>startup.options</code>文件，文件内容分别如下：</p><ul><li><p><code>jvm.options</code>：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## JVM configuration</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Xms represents the initial size of total heap space</span></span><br><span class="line"><span class="comment"># Xmx represents the maximum size of total heap space</span></span><br><span class="line"></span><br><span class="line"><span class="attr">-Xms1g</span></span><br><span class="line"><span class="attr">-Xmx1g</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment">## Expert settings</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## All settings below this section are considered</span></span><br><span class="line"><span class="comment">## expert settings. Don't tamper with them unless</span></span><br><span class="line"><span class="comment">## you understand what you are doing</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## GC configuration</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseConcMarkSweepGC</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">CMSInitiatingOccupancyFraction=75</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseCMSInitiatingOccupancyOnly</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Locale</span></span><br><span class="line"><span class="comment"># Set the locale language</span></span><br><span class="line"><span class="comment">#-Duser.language=en</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the locale country</span></span><br><span class="line"><span class="comment">#-Duser.country=US</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the locale variant, if any</span></span><br><span class="line"><span class="comment">#-Duser.variant=</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## basic</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set the I/O temp directory</span></span><br><span class="line"><span class="comment">#-Djava.io.tmpdir=$HOME</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set to headless, just in case</span></span><br><span class="line"><span class="meta">-Djava.awt.headless</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ensure UTF-8 encoding by default (e.g. filenames)</span></span><br><span class="line"><span class="meta">-Dfile.encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># use our provided JNA always versus the system one</span></span><br><span class="line"><span class="comment">#-Djna.nosys=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Turn on JRuby invokedynamic</span></span><br><span class="line"><span class="meta">-Djruby.compile.invokedynamic</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># Force Compilation</span></span><br><span class="line"><span class="meta">-Djruby.jit.threshold</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># Make sure joni regexp interruptability is enabled</span></span><br><span class="line"><span class="meta">-Djruby.regexp.interruptible</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## heap dumps</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># generate a heap dump when an allocation from the Java heap fails</span></span><br><span class="line"><span class="comment"># heap dumps are created in the working directory of the JVM</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+HeapDumpOnOutOfMemoryError</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># specify an alternative path for heap dumps</span></span><br><span class="line"><span class="comment"># ensure the directory exists and has sufficient space</span></span><br><span class="line"><span class="comment">#-XX:HeapDumpPath=$&#123;LOGSTASH_HOME&#125;/heapdump.hprof</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## GC logging</span></span><br><span class="line"><span class="comment">#-XX:+PrintGCDetails</span></span><br><span class="line"><span class="comment">#-XX:+PrintGCTimeStamps</span></span><br><span class="line"><span class="comment">#-XX:+PrintGCDateStamps</span></span><br><span class="line"><span class="comment">#-XX:+PrintClassHistogram</span></span><br><span class="line"><span class="comment">#-XX:+PrintTenuringDistribution</span></span><br><span class="line"><span class="comment">#-XX:+PrintGCApplicationStoppedTime</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># log GC status to a file with time stamps</span></span><br><span class="line"><span class="comment"># ensure the directory exists</span></span><br><span class="line"><span class="comment">#-Xloggc:$&#123;LS_GC_LOG_FILE&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Entropy source for randomness</span></span><br><span class="line"><span class="meta">-Djava.security.egd</span>=<span class="string">file:/dev/urandom</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy the logging context from parent threads to children</span></span><br><span class="line"><span class="meta">-Dlog4j2.isThreadContextMapInheritable</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure></li><li><p><code>log4j2.properties</code>:</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status</span> = <span class="string">error</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">LogstashPropertiesConfig</span></span><br><span class="line"></span><br><span class="line"><span class="meta">appender.console.type</span> = <span class="string">Console</span></span><br><span class="line"><span class="meta">appender.console.name</span> = <span class="string">plain_console</span></span><br><span class="line"><span class="meta">appender.console.layout.type</span> = <span class="string">PatternLayout</span></span><br><span class="line"><span class="meta">appender.console.layout.pattern</span> = <span class="string">[%d&#123;ISO8601&#125;][%-5p][%-25c]%notEmpty&#123;[%X&#123;pipeline.id&#125;]&#125; %m%n</span></span><br><span class="line"></span><br><span class="line"><span class="meta">appender.json_console.type</span> = <span class="string">Console</span></span><br><span class="line"><span class="meta">appender.json_console.name</span> = <span class="string">json_console</span></span><br><span class="line"><span class="meta">appender.json_console.layout.type</span> = <span class="string">JSONLayout</span></span><br><span class="line"><span class="meta">appender.json_console.layout.compact</span> = <span class="string">true</span></span><br><span class="line"><span class="meta">appender.json_console.layout.eventEol</span> = <span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="meta">rootLogger.level</span> = <span class="string">$&#123;sys:ls.log.level&#125;</span></span><br><span class="line"><span class="meta">rootLogger.appenderRef.console.ref</span> = <span class="string">$&#123;sys:ls.log.format&#125;_console</span></span><br></pre></td></tr></table></figure></li><li><p><code>logstash.yml</code>:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">node.name:</span> <span class="string">logstash-203</span></span><br><span class="line"><span class="comment"># 日志文件目录配置</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/usr/share/logstash/logs</span></span><br><span class="line"><span class="comment"># # 验证配置文件及存在性</span></span><br><span class="line"><span class="attr">config.test_and_exit:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># # 配置文件改变时是否自动加载</span></span><br><span class="line"><span class="attr">config.reload.automatic:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># # 重新加载配置文件间隔</span></span><br><span class="line"><span class="attr">config.reload.interval:</span> <span class="string">60s</span></span><br><span class="line"><span class="comment"># # debug模式 开启后会打印解析后的配置文件 包括密码等信息 慎用</span></span><br><span class="line"><span class="comment"># # 需要同时配置日志等级为debug</span></span><br><span class="line"><span class="attr">config.debug:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">log.level:</span> <span class="string">debug</span></span><br><span class="line"><span class="comment"># # The bind address for the metrics REST endpoint.</span></span><br><span class="line"><span class="attr">http.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="comment"># # 日志格式 json/plain</span></span><br><span class="line"><span class="attr">log.format:</span> <span class="string">json</span></span><br></pre></td></tr></table></figure></li><li><p><code>pipelines.yml</code>:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This file is where you define your pipelines. You can define multiple.</span></span><br><span class="line"><span class="comment"># For more information on multiple pipelines, see the documentation:</span></span><br><span class="line"><span class="comment">#   https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">pipeline.id:</span> <span class="string">es</span></span><br><span class="line">  <span class="attr">path.config:</span> <span class="string">/usr/share/logstash/pipeline/logstash.conf</span></span><br></pre></td></tr></table></figure></li><li><p><code>startup.options</code>:</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment"># These settings are ONLY used by $LS_HOME/bin/system-install to create a custom</span></span><br><span class="line"><span class="comment"># startup script for Logstash and is not used by Logstash itself. It should</span></span><br><span class="line"><span class="comment"># automagically use the init system (systemd, upstart, sysv, etc.) that your</span></span><br><span class="line"><span class="comment"># Linux distribution uses.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># After changing anything here, you need to re-run $LS_HOME/bin/system-install</span></span><br><span class="line"><span class="comment"># as root to push the changes to the init script.</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Override Java location</span></span><br><span class="line"><span class="comment">#JAVACMD=/usr/bin/java</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set a home directory</span></span><br><span class="line"><span class="attr">LS_HOME</span>=<span class="string">/usr/share/logstash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># logstash settings directory, the path which contains logstash.yml</span></span><br><span class="line"><span class="attr">LS_SETTINGS_DIR</span>=<span class="string">/etc/logstash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arguments to pass to logstash</span></span><br><span class="line"><span class="attr">LS_OPTS</span>=<span class="string">"--path.settings $&#123;LS_SETTINGS_DIR&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arguments to pass to java</span></span><br><span class="line"><span class="attr">LS_JAVA_OPTS</span>=<span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pidfiles aren't used the same way for upstart and systemd; this is for sysv users.</span></span><br><span class="line"><span class="attr">LS_PIDFILE</span>=<span class="string">/var/run/logstash.pid</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># user and group id to be invoked as</span></span><br><span class="line"><span class="attr">LS_USER</span>=<span class="string">logstash</span></span><br><span class="line"><span class="attr">LS_GROUP</span>=<span class="string">logstash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable GC logging by uncommenting the appropriate lines in the GC logging</span></span><br><span class="line"><span class="comment"># section in jvm.options</span></span><br><span class="line"><span class="attr">LS_GC_LOG_FILE</span>=<span class="string">/var/log/logstash/gc.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Open file limit</span></span><br><span class="line"><span class="attr">LS_OPEN_FILES</span>=<span class="string">16384</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Nice level</span></span><br><span class="line"><span class="attr">LS_NICE</span>=<span class="string">19</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Change these to have the init script named and described differently</span></span><br><span class="line"><span class="comment"># This is useful when running multiple instances of Logstash on the same</span></span><br><span class="line"><span class="comment"># physical box or vm</span></span><br><span class="line"><span class="attr">SERVICE_NAME</span>=<span class="string">"logstash"</span></span><br><span class="line"><span class="attr">SERVICE_DESCRIPTION</span>=<span class="string">"logstash"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If you need to run a command or script before launching Logstash, put it</span></span><br><span class="line"><span class="comment"># between the lines beginning with `read` and `EOM`, and uncomment those lines.</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment">## read -r -d '' PRESTART &lt;&lt; EOM</span></span><br><span class="line"><span class="comment">## EOM</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>在<code>logstash/pipeline</code>目录下创建<code>logstash.conf</code>文件，文件内容如下：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">input</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="attr">tcp&#123;</span></span><br><span class="line">     <span class="attr">host</span> =<span class="string">&gt; "0.0.0.0"</span></span><br><span class="line">     <span class="attr">port</span> =<span class="string">&gt; 5600</span></span><br><span class="line">     <span class="attr">mode</span> =<span class="string">&gt; "server"</span></span><br><span class="line">     <span class="attr">type</span> =<span class="string">&gt; "tcplog"</span></span><br><span class="line">     <span class="attr">codec</span> =<span class="string">&gt; json_lines</span></span><br><span class="line">   <span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output&#123;</span></span><br><span class="line"> <span class="attr">stdout&#123;</span></span><br><span class="line">   <span class="attr">codec</span> =<span class="string">&gt; rubydebug</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">elasticsearch</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">hosts</span> =<span class="string">&gt; "192.168.37.128:9200"</span></span><br><span class="line">    <span class="attr">index</span> =<span class="string">&gt; "logstash-file-test-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    <span class="attr">action</span> =<span class="string">&gt; "index"</span></span><br><span class="line">    <span class="attr">codec</span> =<span class="string">&gt; "json"</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li><p>对于多个输出（多端口）：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">input</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment"> # 我们创建了两个微服务demo 所以建立两个不同的输入，将两个服务的日志分别输入到不同的索引中</span></span><br><span class="line">  <span class="attr">tcp</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">mode</span> =<span class="string">&gt; "server"</span></span><br><span class="line">    <span class="attr">host</span> =<span class="string">&gt; "0.0.0.0"  # 允许任意主机发送日志</span></span><br><span class="line">    <span class="attr">type</span> =<span class="string">&gt; "elk1"      # 设定type以区分每个输入源</span></span><br><span class="line">    <span class="attr">port</span> =<span class="string">&gt; 4567      </span></span><br><span class="line">    <span class="attr">codec</span> =<span class="string">&gt; json_lines    # 数据格式</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">tcp</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">mode</span> =<span class="string">&gt; "server"</span></span><br><span class="line">    <span class="attr">host</span> =<span class="string">&gt; "0.0.0.0"</span></span><br><span class="line">    <span class="attr">type</span> =<span class="string">&gt; "elk2"</span></span><br><span class="line">    <span class="attr">port</span> =<span class="string">&gt; 4667</span></span><br><span class="line">    <span class="attr">codec</span> =<span class="string">&gt; json_lines</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">filter</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">  #Only matched data are send to output.</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">output</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">  # For detail config for elasticsearch as output,</span></span><br><span class="line"><span class="comment">  # See: https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">if</span> <span class="string">[type] == "elk1" &#123;</span></span><br><span class="line">    <span class="attr">elasticsearch</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="attr">action</span> =<span class="string">&gt; "index"          # 输出时创建映射</span></span><br><span class="line">      <span class="attr">hosts</span>  =<span class="string">&gt; "192.168.87.136:9200"   # ElasticSearch 的地址和端口</span></span><br><span class="line">      <span class="attr">index</span>  =<span class="string">&gt; "elk1"         # 指定索引名</span></span><br><span class="line">      <span class="attr">codec</span>  =<span class="string">&gt; "json"</span></span><br><span class="line">     <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">if</span> <span class="string">[type] == "elk2" &#123;</span></span><br><span class="line">    <span class="attr">elasticsearch</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="attr">action</span> =<span class="string">&gt; "index"          #The operation on ES</span></span><br><span class="line">      <span class="attr">hosts</span>  =<span class="string">&gt; "192.168.87.136:9200"   #ElasticSearch host, can be array.</span></span><br><span class="line">      <span class="attr">index</span>  =<span class="string">&gt; "elk2"         #The index to write data to.</span></span><br><span class="line">      <span class="attr">codec</span>  =<span class="string">&gt; "json"</span></span><br><span class="line">     <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>对于同一个端口区分应用日志：</p><ul><li><code>logstash.conf</code>：</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">input</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="attr">tcp&#123;</span></span><br><span class="line">     <span class="attr">host</span> =<span class="string">&gt; "0.0.0.0"</span></span><br><span class="line">     <span class="attr">port</span> =<span class="string">&gt; 5600</span></span><br><span class="line">     <span class="attr">mode</span> =<span class="string">&gt; "server"</span></span><br><span class="line">     <span class="attr">type</span> =<span class="string">&gt; "tcplog"</span></span><br><span class="line">     <span class="attr">codec</span> =<span class="string">&gt; json_lines</span></span><br><span class="line">   <span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output&#123;</span></span><br><span class="line"> <span class="attr">stdout&#123;</span></span><br><span class="line">   <span class="attr">codec</span> =<span class="string">&gt; rubydebug</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">elasticsearch</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">hosts</span> =<span class="string">&gt; "192.168.37.128:9200"</span></span><br><span class="line">    <span class="attr">index</span> =<span class="string">&gt; "logstash-file-%&#123;[appname]&#125;-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    <span class="attr">action</span> =<span class="string">&gt; "index"</span></span><br><span class="line">    <span class="attr">codec</span> =<span class="string">&gt; "json"</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>SpringBoot项目日志配置文件<code>logback-spring.xml</code>：</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">"org/springframework/boot/logging/logback/base.xml"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"LOGSTASH_HOST"</span> <span class="attr">value</span>=<span class="string">"$&#123;LOGSTASH_HOST:-$&#123;DOCKER_HOST:-192.168.37.128&#125;&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"LOGSTASH_PORT"</span> <span class="attr">value</span>=<span class="string">"$&#123;LOGSTASH_PORT:-5600&#125;"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"LOGSTASH"</span> <span class="attr">class</span>=<span class="string">"net.logstash.logback.appender.LogstashTcpSocketAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">destination</span>&gt;</span>$&#123;LOGSTASH_HOST&#125;:$&#123;LOGSTASH_PORT&#125;<span class="tag">&lt;/<span class="name">destination</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> <span class="attr">class</span>=<span class="string">"net.logstash.logback.encoder.LogstashEncoder"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">customFields</span>&gt;</span>&#123;"appname":"hello"&#125;<span class="tag">&lt;/<span class="name">customFields</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"INFO"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"LOGSTASH"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li></ol><ol start="9"><li><p>在<code>elk</code>目录下运行下面的docker命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name logstash -p 5600:5600 \</span><br><span class="line">-v "$PWD/logstash/conf":/usr/share/logstash/config \</span><br><span class="line">-v "$PWD/logstash/data":/usr/share/logstash/data \</span><br><span class="line">-v "$PWD/logstash/logs":/usr/share/logstash/logs \</span><br><span class="line">-v "$PWD/logstash/pipeline":/usr/share/logstash/pipeline \</span><br><span class="line">--link elasticsearch:elasticsearch -d logstash:7.6.2</span><br></pre></td></tr></table></figure></li><li><p>至此<code>ELK</code>的环境已经搭建完成，只要在项目中访问提供<code>ELK</code>服务主机的5600端口即可，如果没什么问题，应该在<code>ELK</code>主机上使用<code>docker ps</code>命令即可看到三个docker容器已经启动了：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[root@localhost</span> <span class="string">~]# docker ps </span></span><br><span class="line"><span class="attr">CONTAINER</span> <span class="string">ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                                            NAMES</span></span><br><span class="line"><span class="attr">0b955f2b892a</span>        <span class="string">logstash:7.6.2        "/usr/local/bin/do..."   52 minutes ago      Up 40 minutes       5044/tcp, 9600/tcp, 0.0.0.0:5600-&gt;5600/tcp       logstash</span></span><br><span class="line"><span class="attr">c13e9a66500a</span>        <span class="string">kibana:7.6.2          "/usr/local/bin/du..."   About an hour ago   Up About an hour    0.0.0.0:5601-&gt;5601/tcp                           kibana</span></span><br><span class="line"><span class="attr">46f533f30381</span>        <span class="string">elasticsearch:7.6.2   "/usr/local/bin/do..."   About an hour ago   Up About an hour    0.0.0.0:9200-&gt;9200/tcp, 0.0.0.0:9300-&gt;9300/tcp   elasticsearch</span></span><br></pre></td></tr></table></figure></li><li><p><code>docker-composer.yml</code>（待验证）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">elasticsearch:7.6.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">        <span class="comment"># 设置集群名称为elasticsearch</span></span><br><span class="line">        <span class="attr">cluster:</span></span><br><span class="line">            <span class="string">name=elasticsearch</span></span><br><span class="line">        <span class="comment"># # 以单一节点模式启动</span></span><br><span class="line">        <span class="attr">discovery:</span></span><br><span class="line">            <span class="string">type=single-node</span></span><br><span class="line">        <span class="comment"># 设置使用jvm内存大小</span></span><br><span class="line">        <span class="attr">ES_JAVA_OPTS:</span> <span class="string">-Xms512m</span> <span class="string">-Xmx512m</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">        <span class="comment"># 插件文件挂载</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/d/usr/local/opt/elasticsearch/plugins:/usr/share/elasticsearch/plugins</span></span><br><span class="line">        <span class="comment"># 数据文件挂载</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/d/usr/local/var/elasticsearch/data:/usr/share/elasticsearch/data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/d/usr/local/etc/elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9200</span><span class="string">:9200</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9300</span><span class="string">:9300</span></span><br><span class="line">  <span class="attr">logstash:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">logstash:7.6.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">logstash</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># 挂载logstash的配置文件</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/d/usr/local/etc/logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/d/usr/local/etc/logstash/pipeline/logstash.conf:/usr/share/logstash/pipeline/logstash.conf</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">        <span class="comment"># logstash在elasticsearch启动之后再启动</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">        <span class="comment"># 可以用es这个域名访问elasticsearch服务</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">elasticsearch:es</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">9600</span><span class="string">:9600</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">5044</span><span class="string">:5044</span></span><br><span class="line">  <span class="attr">kibana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kibana:7.6.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kibana</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">elasticsearch:es</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"elasticsearch.hosts=http://es:9200"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">5601</span><span class="string">:5601</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.yml</span></span><br><span class="line"><span class="comment"># 使外网可连接</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="comment"># 节点名称</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">"ZSX"</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> <span class="string">["ZSX"]</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="SpringBoot日志项目"><a href="#SpringBoot日志项目" class="headerlink" title="SpringBoot日志项目"></a>SpringBoot日志项目</h2><ol><li><p>创建一个SpringBoot项目，然后在依赖中添加<code>logstash</code>依赖（pom.xml）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.logstash.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logstash-logback-encoder<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在<code>resources</code>目录下添加<code>logback-spring.xml</code>文件，内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">"org/springframework/boot/logging/logback/base.xml"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"LOGSTASH_HOST"</span> <span class="attr">value</span>=<span class="string">"$&#123;LOGSTASH_HOST:-$&#123;DOCKER_HOST:-192.168.37.128&#125;&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"LOGSTASH_PORT"</span> <span class="attr">value</span>=<span class="string">"$&#123;LOGSTASH_PORT:-5600&#125;"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"LOGSTASH"</span> <span class="attr">class</span>=<span class="string">"net.logstash.logback.appender.LogstashTcpSocketAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">destination</span>&gt;</span>$&#123;LOGSTASH_HOST&#125;:$&#123;LOGSTASH_PORT&#125;<span class="tag">&lt;/<span class="name">destination</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> <span class="attr">class</span>=<span class="string">"net.logstash.logback.encoder.LogstashEncoder"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"INFO"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"LOGSTASH"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>注意<code>LOGSTASH_HOST</code>、<code>LOGSTASH_PORT</code>要和提供ELK的IP和端口一致</li></ul></li><li><p>配置文件中添加：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">logging.config</span>=<span class="string">classpath:logback-spring.xml</span></span><br></pre></td></tr></table></figure></li></ol><ol start="4"><li><p>创建一个控制器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">controller</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"hello"</span>,<span class="string">"world"</span>);</span><br><span class="line">        log.info(<span class="string">"hello"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动项目，然后在<code>Kibana</code>中就会有相应的<code>index</code>，然后添加<code>index</code>的检索就可以了，至此SpringBoot日志使用ELK检索以完成！<code>Kibana</code>中一条日志的<code>JSON</code>格式如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_index"</span>: <span class="string">"logstash-file-test-2020.10.02"</span>,</span><br><span class="line">  <span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"JfAF63QBTKzFrbF7CZbO"</span>,</span><br><span class="line">  <span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"_score"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"_source"</span>: &#123;</span><br><span class="line">    <span class="attr">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="attr">"level_value"</span>: <span class="number">20000</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"hello"</span>,</span><br><span class="line">    <span class="attr">"logger_name"</span>: <span class="string">"com.example.demo.controller"</span>,</span><br><span class="line">    <span class="attr">"thread_name"</span>: <span class="string">"http-nio-8080-exec-5"</span>,</span><br><span class="line">    <span class="attr">"@version"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"tcplog"</span>,</span><br><span class="line">    <span class="attr">"host"</span>: <span class="string">"192.168.37.1"</span>,</span><br><span class="line">    <span class="attr">"@timestamp"</span>: <span class="string">"2020-10-02T12:35:17.081Z"</span>,</span><br><span class="line">    <span class="attr">"port"</span>: <span class="number">1618</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"fields"</span>: &#123;</span><br><span class="line">    <span class="attr">"@timestamp"</span>: [</span><br><span class="line">      <span class="string">"2020-10-02T12:35:17.081Z"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"sort"</span>: [</span><br><span class="line">    <span class="number">1601642117081</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>ELK的功能远不止于此，这里先学习在SpringBoot项目中引用ELK进行日志记录，在生产环境出现问题的话就可以快速定位问题所在，在工作中可以作为快速接入指南进行使用。后续还可以使用ELK进行搜索引擎为项目提供搜索服务！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;随着互联网的快速发展，系统越来越庞大，依赖肉眼分析日志文件来排查问题的方式渐渐凸显出一些问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;分布式集群环境下，
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="https://wanderros.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBoot WebSocket Quick Start</title>
    <link href="https://wanderros.github.io/2020/09/30/SpringBoot-WebSocket-Quick-Start/"/>
    <id>https://wanderros.github.io/2020/09/30/SpringBoot-WebSocket-Quick-Start/</id>
    <published>2020-09-30T08:55:45.000Z</published>
    <updated>2020-10-01T08:52:15.908Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议,使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。有了WebSocket技术之后，后端就可以像客户端推送消息，比如向商家客户端推送订单消息等。这里记录在SpringBoot中使用WebSocket的过程。</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li><p>在 WebSocket API 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。</p></li><li><p>HTML5 定义的 WebSocket 协议，能更好的节省服务器资源和带宽，并且能够更实时地进行通讯。</p></li><li><p>WebSocket 协议本质上是一个基于 TCP 的协议。</p></li><li><p>WebSocket 使用 ws 或 wss 的统一资源标志符，类似于 HTTPS，其中 wss 表示在 TLS 之上的 Websocket,如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ws:<span class="comment">//example.com/wsapi</span></span><br><span class="line">wss:<span class="comment">//secure.example.com/wsapi</span></span><br></pre></td></tr></table></figure></li><li><p>从分层的角度来讲，Socket 是传输控制层协议，WebSocket 是应用层协议。</p></li><li><p>WebSocket的调试可以安装一个谷歌浏览器插件<code>Browser WebSocket Client</code>（印象笔记中文档服务笔记本有保存），或者访问在线调试网址：<a href="http://www.websocket-test.com/。" target="_blank" rel="noopener">http://www.websocket-test.com/。</a></p></li><li><p>SpringFramework官方中文介绍WebSocket网址：<a href="https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/web.html#websocket" target="_blank" rel="noopener">https://www.docs4dev.com/docs/zh/spring-framework/5.1.3.RELEASE/reference/web.html#websocket</a></p></li><li><p>尽管 WebSocket 设计为与 HTTP 兼容并以 HTTP 请求开头，但重要的是要了解这两个协议导致了截然不同的体系结构和应用程序编程模型。</p></li><li><p>应用场景：</p><ul><li>可以使网页具有动态性和交互性</li><li>新闻，邮件和社交订阅源</li><li>协作，游戏和金融应用程序</li></ul></li><li><p>服务器与Web客户端之间的双向通行策略：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/47bfa9136df7ac80c4ef082f95d28ebe-35615" alt="Web服务客户端互通策略"></p></li></ol><h2 id="创建一个WebSocket-Server端"><a href="#创建一个WebSocket-Server端" class="headerlink" title="创建一个WebSocket Server端"></a>创建一个<code>WebSocket Server</code>端</h2><ol><li><p>在创建的项目中引入maven依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>WebSocket处理器用来处理客户端发送的消息,常用有<code>TextWebSocketHandler</code>和<code>BinaryWebSocketHandler</code>，这里创建一个<code>TextWebSocketHandler</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.socket.CloseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.TextMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.WebSocketSession;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.handler.TextWebSocketHandler;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatWebSocketHandler</span> <span class="keyword">extends</span> <span class="title">TextWebSocketHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleTransportError</span><span class="params">(WebSocketSession session, Throwable exception)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"建立连接： "</span>+session.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handleTextMessage</span><span class="params">(WebSocketSession session, TextMessage message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String msg = message.getPayload();</span><br><span class="line">        System.out.println(<span class="string">"收到消息： "</span>+msg);</span><br><span class="line">        session.sendMessage(<span class="keyword">new</span> TextMessage(<span class="string">"Hello"</span>+msg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus status)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"关闭连接： "</span>+session.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>afterConnectionEstablished</code> 成功创建连接后调用</li><li><code>handleTextMessage</code> 收到客户端消息后调用</li><li><code>handleTransportError</code> 连接异常时调用</li><li><code>afterConnectionClosed</code> 连接关闭后调用</li><li><code>sendMessage</code>用于向客户端发送消息</li><li><code>WebSocketSession</code>是客户端与服务端建立的回话，可以通过<code>close()</code>方法主动关闭连接</li><li><code>TextMessage</code>为收到的消息，可以通过<code>getPayload()</code>方法获取消息内容</li></ul></li><li><p>配置WebSocket，将处理器映射到指定的path上，还可以添加一些额外的配置，通过实现<code>WebSocketConfigurer</code>以及添加注解<code>@EnableWebSocket</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocket;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.standard.ServletServerContainerFactoryBean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title">WebSocketConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry webSocketHandlerRegistry)</span> </span>&#123;</span><br><span class="line">        webSocketHandlerRegistry.addHandler(chatWebSocketHandler(), <span class="string">"chat"</span>,<span class="string">"chat1"</span>) <span class="comment">// 添加消息处理器,可以添加多个path</span></span><br><span class="line">                <span class="comment">//.addInterceptors(chatHandshakeInterceptor()) // 添加握手拦截器</span></span><br><span class="line">                .setAllowedOrigins(<span class="string">"*"</span>); <span class="comment">// 设置跨域</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ChatWebSocketHandler <span class="title">chatWebSocketHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChatWebSocketHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ChatHandshakeInterceptor <span class="title">chatHandshakeInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChatHandshakeInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletServerContainerFactoryBean <span class="title">createWebSocketContainer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ServletServerContainerFactoryBean container = <span class="keyword">new</span> ServletServerContainerFactoryBean();</span><br><span class="line">        container.setMaxTextMessageBufferSize(<span class="number">8192</span>);</span><br><span class="line">        container.setMaxSessionIdleTimeout(<span class="number">10</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>addHandler()</code>用于添加消息处理器，并指定映射<code>path</code>，服务端WebSocket地址为 <code>ws://host:port/path</code></li><li><code>setAllowedOrigins</code>用于设置跨域</li><li><code>addInterceptors</code>用于添加拦截器</li></ul></li><li><p>创建一个握手拦截器（可选），只要实现<code>HandshakeInterceptor</code>即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.WebSocketHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.HandshakeInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatHandshakeInterceptor</span> <span class="keyword">implements</span> <span class="title">HandshakeInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">beforeHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"--------------握手前拦截"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Exception exception)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"--------------完成握手"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>beforeHandshake</code>握手前，该方法返回<code>true</code>表示继续建立连接，返回<code>false</code>则终止</li><li><code>afterHandshake</code>握手后动作</li></ul></li><li><p>Session空闲失效时间配置，可以增加一些配置来约束超时时间；还可以设置消息缓冲区大小等(<code>WebSocketConfigurer</code>实现的配置中注入Bean)：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ServletServerContainerFactoryBean <span class="title">createWebSocketContainer</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> ServletServerContainerFactoryBean container = <span class="keyword">new</span> ServletServerContainerFactoryBean();</span><br><span class="line"> container.setMaxTextMessageBufferSize(<span class="number">8192</span>);</span><br><span class="line"> container.setMaxSessionIdleTimeout(<span class="number">10</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line"> <span class="keyword">return</span> container;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>目前还没有在真实业务中使用WebSocket，但是查看调试信息可以看到公司邮箱系统是有用到WebSocket的，在后续需要的时候再继续深入吧！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议,使得客户端和服务器之间的数据交换变得更加简单，
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="https://wanderros.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBoot Filter QuickStart</title>
    <link href="https://wanderros.github.io/2020/09/29/SpringBoot-Filter-QuickStart/"/>
    <id>https://wanderros.github.io/2020/09/29/SpringBoot-Filter-QuickStart/</id>
    <published>2020-09-29T15:02:10.000Z</published>
    <updated>2020-10-01T08:52:15.903Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>过滤器、拦截器、AOP能从不同的程度满足拦截请求的过程，想要了解每种方式的差异性必须要深入了解区别，这部分主要记录过滤器的实操。</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li>过滤器是对数据进行过滤，预处理过程，SpringBoot的过滤器在实现上基于函数回调，可以对几乎所有请求进行过滤。</li><li>过滤器（<code>javax.servlet.Filter</code>）依赖于<code>Servlet</code>容器，属于<code>Servlet</code>规范的一部分。<code>Filter</code>的执行由<code>Servlet</code>容器回调完成，生命周期由<code>Servlet</code>容器管理。</li><li>Filter过滤器是servlet包下面的东西，因此不需要再额外引包。</li><li>官方文档：<a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-embedded-container-servlets-filters-listeners-scanning" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-embedded-container-servlets-filters-listeners-scanning</a></li><li>过滤器可以实现URL级别的权限控制、压缩响应信息、编码格式等等。</li><li>过滤器里面的三个方法：<ul><li><code>init</code>： filter对象只会创建一次，init方法也只会执行一次</li><li><code>doFilter</code> ： 主要的业务代码编写方法，可以多次重复调用</li><li><code>destroy</code>： 在销毁Filter时自动调用（程序关闭或者主动销毁Filter）</li></ul></li><li>在过滤器中，对于满足条件的请求，使用<code>filterChain.doFilter(request, response);</code>将连接转发到目的地，不满足，则直接通过response写入错误信息。</li><li><strong>过滤器可以包装Request和Response，而拦截器、AOP是不能的，<code>HttpServletRequest</code>并未开放接口提供修改头信息，但是利用过滤器+装饰模式可以修改HttpServletRequest的请求头信息。</strong></li></ol><h2 id="过滤器配置"><a href="#过滤器配置" class="headerlink" title="过滤器配置"></a>过滤器配置</h2><h3 id="Component注解"><a href="#Component注解" class="headerlink" title="Component注解"></a><strong>Component</strong>注解</h3><ol><li><p>直接实现<strong>Filter</strong>接口，并使用<strong>@Component</strong>注解标注为组件自动注入Bean:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogCostFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"初始化成功LogCostFilter"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">        System.out.println(<span class="string">"LogCostFilter Execute cost="</span>+(System.currentTimeMillis()-start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>当有多个过滤器的时候，使用<code>@Order(num)</code>进行优先级设定，数字越小，优先级越高：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogCostFilter2</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"初始化成功LogCostFilter2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        System.out.println(<span class="string">"LogCostFilter2 Execute cost="</span> + (System.currentTimeMillis() - start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="FilterRegistrationBean配置"><a href="#FilterRegistrationBean配置" class="headerlink" title="FilterRegistrationBean配置"></a><code>FilterRegistrationBean</code>配置</h3><ol><li><p>首先实现一个过滤器接口的类，比如记录时间的过滤器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogCostFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">        System.out.println(<span class="string">"Execute cost="</span>+(System.currentTimeMillis()-start));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>使用<code>FilterRegistrationBean</code>配置该过滤器的规则：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FiltersConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">registFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean registration = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        registration.setFilter(<span class="keyword">new</span> LogCostFilter());</span><br><span class="line">        registration.addUrlPatterns(<span class="string">"/*"</span>);</span><br><span class="line">        registration.setName(<span class="string">"LogCostFilter"</span>);</span><br><span class="line">        registration.setOrder(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>addUrlPatterns</code>可以添加多个过滤URI</li></ul></li><li><p>对于多个过滤器：</p><ol><li><p>再实现一个过滤器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogCostFilter2</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        System.out.println(<span class="string">"LogCostFilter2 Execute cost="</span> + (System.currentTimeMillis() - start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>修改配置类<code>FiltersConfig</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FiltersConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">registFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean registration = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        registration.setFilter(<span class="keyword">new</span> LogCostFilter());</span><br><span class="line">        registration.addUrlPatterns(<span class="string">"/body"</span>);</span><br><span class="line">        registration.setName(<span class="string">"LogCostFilter"</span>);</span><br><span class="line">        registration.setOrder(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">registFilter2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean registration = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        registration.setFilter(<span class="keyword">new</span> LogCostFilter2());</span><br><span class="line">        registration.addUrlPatterns(<span class="string">"/"</span>);</span><br><span class="line">        registration.setName(<span class="string">"LogCostFilter2"</span>);</span><br><span class="line">        registration.setOrder(<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>这个里面可以配置过滤器的优先级，有些时候是需要考虑优先级的</p></li><li><p>优先级数字越小，优先级越高</p></li><li><p>调试过滤器输出：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mapping filters: LogCostFilter urls=[<span class="comment">/*] order=2, LogCostFilter2 urls=[/*] order=5, characterEncodingFilter urls=[/*] order=-2147483648, formContentFilter urls=[/*] order=-9900, requestContextFilter urls=[/*] order=-105</span></span><br></pre></td></tr></table></figure></li></ul></li></ol></li><li><p><strong>Component</strong>可以和<code>FilterRegistrationBean</code>配合使用，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FiltersConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> cLogCostFilter clog;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> bLogCostFilter2 blog;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">registFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean registration = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        registration.setFilter(blog);</span><br><span class="line">        registration.addUrlPatterns(<span class="string">"/*"</span>);</span><br><span class="line">        registration.setName(<span class="string">"LogCostFilter2"</span>);</span><br><span class="line">        registration.setOrder(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">registFilter2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean registration = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        registration.setFilter(clog);</span><br><span class="line">        registration.addUrlPatterns(<span class="string">"/*"</span>);</span><br><span class="line">        registration.setName(<span class="string">"LogCostFilter"</span>);</span><br><span class="line">        registration.setOrder(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="WebFilter配置"><a href="#WebFilter配置" class="headerlink" title="WebFilter配置"></a><code>WebFilter</code>配置</h3><ol><li><p><code>@WebFilter</code> 用于将一个类声明为过滤器，该注解将会在部署时被容器处理，容器将根据具体的属性配置将相应的类部署为过滤器。该注解具有下表给出的一些常用属性 ( 以下所有属性均为可选属性，但是 value、urlPatterns、servletNames 三者必需至少包含一个，且 value 和 urlPatterns 不能共存，如果同时指定，通常忽略 value 的取值 )</p></li><li><p><code>@WebFilter</code>常用属性:</p><table><thead><tr><th align="left"><strong>属性名</strong></th><th align="left"><strong>类型</strong></th><th align="left"><strong>描述</strong></th></tr></thead><tbody><tr><td align="left">filterName</td><td align="left">String</td><td align="left">指定过滤器的 name 属性，等价于</td></tr><tr><td align="left">value</td><td align="left">String[]</td><td align="left">该属性等价于 urlPatterns 属性。但是两者不应该同时使用。</td></tr><tr><td align="left">urlPatterns</td><td align="left">String[]</td><td align="left">指定一组过滤器的 URL 匹配模式。等价于 标签。</td></tr><tr><td align="left">servletNames</td><td align="left">String[]</td><td align="left">指定过滤器将应用于哪些 Servlet。取值是 @WebServlet 中的 name 属性的取值，或者是 web.xml 中 的取值。</td></tr><tr><td align="left">dispatcherTypes</td><td align="left">DispatcherType</td><td align="left">指定过滤器的转发模式。具体取值包括： ASYNC、ERROR、FORWARD、INCLUDE、REQUEST。</td></tr><tr><td align="left">initParams</td><td align="left">WebInitParam[]</td><td align="left">指定一组过滤器初始化参数，等价于 标签。</td></tr><tr><td align="left">asyncSupported</td><td align="left">boolean</td><td align="left">声明过滤器是否支持异步操作模式，等价于 标签。</td></tr><tr><td align="left">description</td><td align="left">String</td><td align="left">该过滤器的描述信息，等价于 标签。</td></tr><tr><td align="left">displayName</td><td align="left">String</td><td align="left">该过滤器的显示名，通常配合工具使用，等价于 标签。</td></tr></tbody></table></li><li><p>使用的时候先要在过滤器类上添加<code>@WebFilter</code>注解，然后在启动类上加上<code>@ServletComponentScan</code>注解来扫描：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebFilter</span>(filterName = <span class="string">"LogCostFilter2"</span>,urlPatterns = &#123;<span class="string">"/1"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">bLogCostFilter2</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"LogCostFilter2 inited!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        System.out.println(<span class="string">"LogCostFilter2 Execute cost="</span> + (System.currentTimeMillis() - start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>扫描多个包时，格式如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ServletComponentScan</span>(basePackages = &#123;<span class="string">"com.example.springboot.servlet"</span>,<span class="string">"com.example.springboot.filter"</span>&#125;)</span><br></pre></td></tr></table></figure></li><li><p>添加多个过滤地址的方式类下面：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebFilter</span>(urlPatterns = &#123;<span class="string">"/config/*"</span>,<span class="string">"/driver/*"</span>,<span class="string">"/order/*"</span>,<span class="string">"/im/*"</span>,<span class="string">"/privacy/*"</span>,<span class="string">"/config/*"</span>&#125;, filterName = <span class="string">"apiFilter"</span>)</span><br></pre></td></tr></table></figure></li></ul></li></ol><ol start="4"><li><p>对于在同一个包下的filter，采用这种方式的时候，过滤器的执行顺序按照过滤器名来决定，比如aLogCostFilter2&gt;bLogCostFilter2,在不同包下更复杂（有博客去说，但是没有验证）</p></li><li><p>使用了该方式就不要使用<code>@Component</code>注解的方式了，两个选其一，过滤器会被多次初始化以及执行。如果有<code>FilterRegistrationBean</code>则该方式的过滤器不生效。</p></li><li><p>有多个Filter的时候，<code>filterName</code>属性不能相同，否则会出错。可以配置配置文件修改覆盖，但是不推荐：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启用覆盖同名bean</span></span><br><span class="line"><span class="meta">spring.main.allow-bean-definition-overriding</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>过滤器想对来说还是很容易理解的，记录了几种不同的过滤器设置规则，但是觉得还是<code>FilterRegistrationBean</code>比较好用，非常友好，其他的都有一些缺陷，<code>FilterRegistrationBean</code>能够设置过滤的规则，过滤器的优先顺序，相比<code>WebFilter</code>这种优先级的设置要觉得清楚很多，个人优先考虑<code>FilterRegistrationBean</code>。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;过滤器、拦截器、AOP能从不同的程度满足拦截请求的过程，想要了解每种方式的差异性必须要深入了解区别，这部分主要记录过滤器的实操。&lt;/p&gt;
&lt;
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="https://wanderros.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBoot AOP Quick Start</title>
    <link href="https://wanderros.github.io/2020/09/28/SpringBoot-AOP-Quick-Start/"/>
    <id>https://wanderros.github.io/2020/09/28/SpringBoot-AOP-Quick-Start/</id>
    <published>2020-09-28T11:30:21.000Z</published>
    <updated>2020-10-01T08:52:15.901Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Spring AOP在SpringBoot实战学习的时候有接触过，但是对于其并没有深入，在实际开发中才渐渐发现它的强大，这里花点时间深入了解一下AOP，使得后续项目开发中能更好地使用AOP写出优质代码！</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><ol><li><p>官方说明文档：<a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/core.html#aop" target="_blank" rel="noopener">https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/core.html#aop</a></p></li><li><p>AOP （Aspect Oriented Programming，面向切面编程）是一种编程思想，是面向对象编程（OOP）的一种补充。（OOP从纵向上区分出一个个的类来，而AOP则从横向上向对象中加入特定的代码。）面向对象编程将程序抽象成各个层次的对象，而面向切面编程是将程序抽象成各个切面！</p></li><li><p>AOP的存在是为了保证开发者不修改源代码的前提下，为系统中的业务组件添加某种通用功能，AOP能够使得代码解耦，并且可以让一组类共享相同的行为。</p></li><li><p>各种AOP实现的比较：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/7f6d70a666b70e2cf99d93a04c34eb58-59526" alt="AOP比较"></p></li><li><p>AOP 领域术语：</p><ol><li>通知（Advice）: AOP 框架中的增强处理。通知描述了切面何时执行以及如何执行增强处理</li><li>连接点（Join Point）: 连接点表示应用执行过程中能够插入切面的一个点，这个点可以是方法的调用、异常的抛出。在 Spring AOP 中，连接点总是方法的调用，通过声明一个<code>org.aspectj.lang.JoinPoint</code>类型参数我们可以在通知(Advice)中获得连接点的信息</li><li>切点（PointCut）: 可以插入增强处理的连接点集，切入点表达式如何跟连接点匹配是AOP的核心，Spring默认使用AspectJ作为切入点语法</li><li>切面（Aspect）: 切面是通知和切点的结合，可能会横切多个对象</li><li>引入（Introduction）：引入允许我们向现有的类添加新的方法或者属性，AOP允许在运行时动态的向代理对象实现新的接口来完成一些额外的功能并且不影响现有对象的功能</li><li>织入（Weaving）: 将增强处理添加到目标对象中，并创建一个被增强的对象，这个过程就是织入。Spring和其他纯AOP框架一样，在运行时完成织入</li></ol></li><li><p>Spring 中的 AOP 是通过动态代理实现的，不能拦截对对象字段的修改，也不支持构造器连接点,无法在 Bean 创建时应用通知！</p></li><li><p>Spring AOP 中有 5 中通知类型：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/7c1d36d77b3d405328d28bb915250fc7-28909" alt="通知类型"></p><ul><li>环绕通知类型<code>@Around</code>将整个目标方法封装了起来，在使用时，传入<code>ProceedingJoinPoint</code>类型的参数，调用<code>proceed()</code>方法是会进入目标方法中返回，否则原目标方法被阻塞调用</li><li>后置通知是当某个连接点退出的时候执行的通知，而不管是正常返回还是发生异常后的退出，说白了就是会在返回后通知和抛出异常后通知执行</li></ul></li><li><p>Spring AOP是Spring的一个重要组件，但是Spring IOC并不依赖于Spring AOP，这意味着可以自由选择是否使用AOP，AOP提供了强大的中间件解决方案，这使得Spring IOC更加完善。</p></li><li><p><strong>AOP能用来实现日志监听、事务管理、效率检查、权限控制等。</strong>AOP能够减少系统的重复代码，降低模块间的耦合度，并有利于未来的可拓展性和可维护性。</p></li><li><p>被定义为切面的类需要 <code>@Component</code> 注解标注。</p></li><li><p>Spring提供了3种类型的AOP支持：</p><ol><li>基于代理的经典SpringAOP（需要实现接口，手动创建代理）</li><li>纯POJO切面（使用XML配置，aop命名空间）</li><li><code>@AspectJ</code>注解驱动的切面（使用注解的方式）</li></ol></li><li><p>AOP实现日志监听的比较好的样例效果：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/af330349070ce3c0d890c6089e4053da-184252" alt="日志管理"></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/bb2526c43285284bfd389f5189cff547-84900" alt="日志管理详情"></p></li></ol><h2 id="声明一个PointCut（切点）"><a href="#声明一个PointCut（切点）" class="headerlink" title="声明一个PointCut（切点）"></a>声明一个PointCut（切点）</h2><ol><li><p>Spring AOP仅支持Spring Bean可执行方法连接点，因此在 Spring AOP 中，连接点总是方法的调用。</p></li><li><p>切点可以通过注解<code>@Pointcut</code>来声明，作为Pointcut 标识的方法返回类型必须是<code>void</code>。示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut</span>(<span class="string">"execution(* transfer(..))"</span>) <span class="comment">// the pointcut expression</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">anyOldTransfer</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// the pointcut signature</span></span><br></pre></td></tr></table></figure></li></ol><ol start="3"><li><p>Spring AOP借助了AspectJ的语法，但底层技术用的还是Spring自己的。因此AspectJ的切点语法可以参考<a href="https://www.eclipse.org/aspectj/doc/released/progguide/index.html" target="_blank" rel="noopener">AspectJ语法指导</a>，Spring AOP支持的AspectJ 切点标识符：</p><ul><li><code>execution</code>：用于匹配方法执行连接点（基础切点标识符）</li><li><code>within</code>：限制性匹配指定类型的连接点（范围型）</li><li><code>this</code>：限制性匹配指定类型的实例及其子类的连接点（精确型）</li><li><code>target</code>：限制性匹配目标Object是给定类型实例（不包含子类）的连接点（精确型）</li><li><code>args</code>：限制性匹配使用指定参数类型（如<code>String</code>）的连接点（范围型）</li><li><code>@target</code>：<strong>类上</strong>带有指定类型注解的连接点（精确型）</li><li><code>@args</code>：<strong>参数类型</strong>带有指定类型的注解（范围型）</li><li><code>@within</code>：目标类型上有指定类型的注解（范围性）</li><li><code>@annotation</code>：限制性匹配有指定的注解可执行方法的连接点（精确型）</li></ul></li><li><p>可以通过<code>&amp;&amp;</code>，<code>||</code>以及<code>!</code>来组合表示切点表达式，示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut</span>(<span class="string">"execution(public * *(..))"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">anyPublicOperation</span><span class="params">()</span> </span>&#123;&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">@Pointcut</span>(<span class="string">"within(com.xyz.myapp.trading..*)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inTrading</span><span class="params">()</span> </span>&#123;&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">@Pointcut</span>(<span class="string">"anyPublicOperation() &amp;&amp; inTrading()"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tradingOperation</span><span class="params">()</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><ul><li><code>anyPublicOperation()</code>指示任何public类型的可执行方法</li><li><code>inTrading()</code>指示在模块<code>trading</code>中的可执行方法</li><li><code>tradingOperation()</code>指示在模块<code>trading</code>中的public类型的可执行方法</li></ul></li><li><p>Spring AOP的大多数使用者喜欢使用<code>execution</code>来指示连接点，格式如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(modifiers-pattern? ret-type-pattern declaring-type-pattern?name-pattern(param-pattern) <span class="keyword">throws</span>-pattern?)</span><br></pre></td></tr></table></figure><ul><li><code>ret-type-pattern</code>、<code>name-pattern</code>、<code>param-pattern</code>是必须有的，其他的都是可选的</li><li><code>*</code>是使用最多的返回类型，用于匹配任意返回类型</li><li>参数类型使用<code>()</code>表示没有参数，<code>(..)</code>表示可以有任意个参数，<code>(*)</code>表示只有一个任意类型的参数，<code>(*,String)</code>匹配第一个是任意类型的参数，第二个是String类型的可执行方法</li></ul></li><li><p>示例：</p><ul><li>任意public的可执行方法：<code>execution(public * *(..))</code></li><li>任意名称以set开头的可执行方法：<code>execution(* set*(..))</code></li><li>指定到<code>com.xyz.service.AccountService</code>下任意可执行方法：<code>execution(* com.xyz.service.AccountService.*(..))</code></li><li>指定到包<code>com.xyz.service</code>下的任意可执行方法：<code>execution(* com.xyz.service.*.*(..))</code></li><li>指定到包<code>com.xyz.service</code>或者任意一个子包下的任意可执行方法：<code>execution(* com.xyz.service..*.*(..))</code></li><li>在包<code>com.xyz.service</code>下（不包含子包）的任意连接点：<code>within(com.xyz.service.*)</code></li><li>使用了<code>@Transactional</code>注解的可执行方法的任意连接点：<code>@annotation(org.springframework.transaction.annotation.Transactional)</code></li><li>只有一个参数，而且运行时传递了<code>@Classified</code>注解的任意连接点：<code>@args(com.xyz.security.Classified)</code></li><li>… …</li></ul></li><li><p>推荐博客：<a href="https://www.cnblogs.com/zhangxufeng/p/9160869.html，实在不太清楚可以对照官方文档进行试验，以实际效果为准！" target="_blank" rel="noopener">https://www.cnblogs.com/zhangxufeng/p/9160869.html，实在不太清楚可以对照官方文档进行试验，以实际效果为准！</a></p></li></ol><h2 id="通知（Advice）"><a href="#通知（Advice）" class="headerlink" title="通知（Advice）"></a>通知（Advice）</h2><ol><li><p>5种类型的通知：</p><ul><li><code>@Before</code> ：在切入点开始处切入内容</li><li><code>@AfterReturning</code> ：在切入点 return 内容之后切入内容（可以用来对处理返回值做一些加工处理）</li><li><code>@AfterThrowing</code> ：用来处理当切入内容部分抛出异常之后的处理逻辑</li><li><code>@After</code> ：在切入点结尾处切入内容</li><li><code>@Around</code> ：在切入点前后切入内容，并自己控制何时执行切入点自身的内容</li></ul></li><li><p>在实际情况下，对同一个接口做多个切面时会面临一个优先级的问题，这就需要使用 <code>@Order(i)</code> 注解来标识切面的优先级, <code>i</code> 的值越小，优先级越高。<strong>在切入点前的操作，按order的值由小到大执行，在切入点后的操作，按order的值由大到小执行！</strong></p></li><li><p>在进行通知处理的时候，5中类型通知的处理是有先后顺序的，默认顺序如下，如果有特殊处理除外：</p><ul><li><code>@Around</code> &gt; <code>@Before</code> &gt; <code>@AfterThrowing</code>&gt;<code>@AfterReturning</code> &gt; <code>@After</code> </li><li>如果<code>@Around</code>不执行<code>proceed()</code>方法，则其他通知是无法执行的</li></ul></li><li><p>除了环绕通知可以添加<code>ProceedingJoinPoint</code>类型的参数外，其他的通知都可以添加<code>JoinPoint</code>类型的参数。</p></li><li><p><code>@Before</code>通知可以接受切点的方法参数，示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(value = <span class="string">"execution(public * com.example.aop.controller..*(..))&amp;&amp;args(result)"</span>,argNames = <span class="string">"joinPoint,result"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">beforeAdvice</span><span class="params">(JoinPoint joinPoint,Result result)</span></span>&#123;</span><br><span class="line">        log.info(joinPoint.toString());</span><br><span class="line">        System.out.println(result);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li><p>@Before注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Before &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">argNames</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>该注解只能用在方法上</p></li><li><p><code>value</code>用于传递切点</p></li><li><p><code>argNames</code>可以接受方法的参数名</p></li></ul></li><li><p><code>@AfterReturning</code>通知可以通过参数接受切点方法的返回值也可以获取参数值，示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例1   </span></span><br><span class="line"><span class="meta">@AfterReturning</span>(value = <span class="string">"annotationPointCut()"</span>,returning = <span class="string">"res"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterReturnAdvice</span><span class="params">(JoinPoint joinPoint,Object res)</span></span>&#123;</span><br><span class="line">        log.info(joinPoint.toString());</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//示例2</span></span><br><span class="line">    <span class="meta">@AfterReturning</span>(value = <span class="string">"execution(public * com.example.aop.controller..*(..))&amp;&amp;args(result)"</span>,returning = <span class="string">"res"</span>,argNames = <span class="string">"joinPoint,res,result"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterReturnAdvice2</span><span class="params">(JoinPoint joinPoint,Object res,Result result)</span></span>&#123;</span><br><span class="line">        log.info(joinPoint.toString());</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>@AfterReturning</code>注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AfterReturning &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">pointcut</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">returning</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">argNames</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>value</code>用于传递切点,<code>pointcut</code>也是 </p></li><li><p><code>argNames</code>可以接受方法的参数名</p></li><li><p><code>returning</code>可以接受方法的返回值，然后传递到通知的参数中</p></li></ul></li><li><p><code>@AfterThrowing</code>通知可以通过参数接受切点方法的异常：</p><ul><li><p><code>@AfterThrowing</code>注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AfterThrowing &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">pointcut</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">throwing</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">argNames</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>throwing</code>用于接受异常，然后传递到通知的参数中</p></li></ul></li><li><p><code>@After</code>注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> After &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">argNames</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>@Around</code>注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Around &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">argNames</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>可以通过自定义注解来表示切点，格式类似下面：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Target 的注解类型    适用场景</span></span><br><span class="line"><span class="comment"> *    TYPE              类(包括Enum)接口</span></span><br><span class="line"><span class="comment"> *    PACKAGE           包</span></span><br><span class="line"><span class="comment"> *    METHOD            方法</span></span><br><span class="line"><span class="comment"> *    FIELD             成员域(包括Enum常量)</span></span><br><span class="line"><span class="comment"> *    CONSTRUCTOR       构造器</span></span><br><span class="line"><span class="comment"> *    PARAMETER         方法或构造器参数</span></span><br><span class="line"><span class="comment"> *    LOCAL_VARIABLE    本地变量</span></span><br><span class="line"><span class="comment"> *    ANNOTATION_TYPE   注解类型声明</span></span><br><span class="line"><span class="comment"> *    java 8 新加</span></span><br><span class="line"><span class="comment"> *    TYPE_PARAMETER    类型参数声明</span></span><br><span class="line"><span class="comment"> *    TYPE_USE          类型的使用</span></span><br><span class="line"><span class="comment"> * Retention的保留策略</span></span><br><span class="line"><span class="comment"> *    保留规则           描述</span></span><br><span class="line"><span class="comment"> *    SOURCE             注释将被编译器丢弃,不包括在类文件中</span></span><br><span class="line"><span class="comment"> *    CLASS              注释由编译器记录在类文件中,但是不需要在运行时被虚拟机(VM)保留。默认策略</span></span><br><span class="line"><span class="comment"> *    RUNTIME            注释由编译器记录在类文件中，并在运行时由VM保存，因此可以反射可读取它们</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD) <span class="comment">//注解放置的目标位置,METHOD是可注解在方法级别上</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME) <span class="comment">//注解在哪个阶段执行</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OperLog &#123;</span><br><span class="line">    <span class="function">String <span class="title">operModul</span><span class="params">()</span> <span class="keyword">default</span> ""</span>; <span class="comment">// 操作模块</span></span><br><span class="line">    <span class="function">String <span class="title">operType</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;  <span class="comment">// 操作类型</span></span><br><span class="line">    <span class="function">String <span class="title">operDesc</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;  <span class="comment">// 操作说明</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>注解方式的参数传递：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Log &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Pointcut</span>(value = <span class="string">"@annotation(log)"</span>, argNames = <span class="string">"log"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointcut</span><span class="params">(Log log)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around</span>(value = <span class="string">"pointcut(log)"</span>, argNames = <span class="string">"joinPoint,log"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint, Log log)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(log.value());</span><br><span class="line">            System.out.println(<span class="string">"around"</span>);</span><br><span class="line">            <span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"around"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>环绕通知非常强大，可以决定目标方法是否执行，什么时候执行，执行时是否需要替换方法参数，执行完毕是否需要替换返回值。 </p></li><li><p>环绕通知第一个参数必须是org.aspectj.lang.ProceedingJoinPoint类型 。</p></li></ol><h2 id="数据提取"><a href="#数据提取" class="headerlink" title="数据提取"></a>数据提取</h2><ol><li><p><code>HttpServletRequest</code>以及<code>HttpServletResponse</code>：</p><ol><li><p>实例获取：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取RequestAttributes</span></span><br><span class="line">RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class="line"><span class="comment">// RequestAttributes requestAttributes = RequestContextHolder.currentRequestAttributes(); // 这个方法也可以</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从获取的RequestAttributes中获取HttpServletRequest的信息</span></span><br><span class="line">HttpServletRequest request = (HttpServletRequest) requestAttributes</span><br><span class="line">  .resolveReference(RequestAttributes.REFERENCE_REQUEST);</span><br><span class="line">HttpServletRequest request = ((ServletRequestAttributes)requestAttributes).getRequest();</span><br><span class="line">HttpServletResponse response = ((ServletRequestAttributes)requestAttributes).getResponse();</span><br></pre></td></tr></table></figure></li><li><p><code>HttpServletRequest</code>方法说明(常用)：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">request.getMethod() <span class="comment">//动词 GET POST等</span></span><br><span class="line">  request.getHeader(<span class="string">"Connection"</span>) <span class="comment">//请求头的获取</span></span><br><span class="line">  request.getServletPath() <span class="comment">// 获取URI 比如：/api/test</span></span><br><span class="line">  request.getCookies() <span class="comment">// 获取所有的Cookie</span></span><br><span class="line">  request.getRequestedSessionId() <span class="comment">// 获取SessionID</span></span><br><span class="line">  request.getRequestURL() <span class="comment">// 获取除参数外的完整URL</span></span><br><span class="line">  request.getProtocol() <span class="comment">// 获取http协议标准 比如：HTTP/1.1</span></span><br><span class="line">  request.getQueryString() <span class="comment">// 该方法返回请求中的参数部分（参数名+值）</span></span><br><span class="line">  request.getRemoteAddr() <span class="comment">// 该方法返回请求的客户机的IP地址</span></span><br><span class="line">  request.getRemoteHost() <span class="comment">// 该方法返回请求的客户机的完整主机名</span></span><br><span class="line">  request.getRemotePort() <span class="comment">// 该方法返回客户机所使用的网络端口号</span></span><br><span class="line">  request.getLocalPort() <span class="comment">// 该方法返回web服务器所使用的网络端口号</span></span><br><span class="line">  request.getLocalAddr() <span class="comment">// 该方法返回WEB服务器的IP地址</span></span><br><span class="line">  request.getLocalName() <span class="comment">// 该方法返回WEB服务器的主机名</span></span><br><span class="line">  request.getAuthType() <span class="comment">// 该返回包含用来保护servlet身份验证方案的名称，如BASIC和SSL，如果是null表示未不受保护</span></span><br><span class="line">  request.getScheme() <span class="comment">// 返回请求的方案名，如http,ftp,https等</span></span><br><span class="line">  request.getInputStream() <span class="comment">// 获取body中的内容</span></span><br><span class="line">  request.getParameter(<span class="string">"result"</span>) <span class="comment">// 获取Params中的参数值</span></span><br><span class="line">  request.getParameterMap() <span class="comment">//获取Params中的所有参数值，Map形式</span></span><br><span class="line">  request.getParameterNames() <span class="comment">// 获取Params中的所有参数名称</span></span><br><span class="line">  request.getHeaderNames() <span class="comment">//获取Headers中所有的Header名称</span></span><br></pre></td></tr></table></figure></li><li><p>获取所有Params：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">        Enumeration&lt;?&gt; temp = request.getParameterNames();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != temp) &#123;</span><br><span class="line">            <span class="keyword">while</span> (temp.hasMoreElements()) &#123;</span><br><span class="line">                String en = (String) temp.nextElement(); <span class="comment">// key</span></span><br><span class="line">                String value = request.getParameter(en); <span class="comment">// value</span></span><br><span class="line">                System.out.println(en);</span><br><span class="line">                System.out.println(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">        Map&lt;String, String[]&gt; map= request.getParameterMap();</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry&lt;String, String[]&gt; entry : map.entrySet())&#123;</span><br><span class="line">            String mapKey = entry.getKey();</span><br><span class="line">            String[] mapValue = entry.getValue();</span><br><span class="line">            System.out.println(mapKey+<span class="string">":"</span>+mapValue[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li><li><p>获取所有的Header：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Enumeration&lt;?&gt; temp = request.getHeaderNames();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">null</span> != temp) &#123;</span><br><span class="line">    <span class="keyword">while</span> (temp.hasMoreElements()) &#123;</span><br><span class="line">        String en = (String) temp.nextElement();</span><br><span class="line">        String value = request.getHeader(en);</span><br><span class="line">        System.out.println(en);</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>HttpServletResponse</code>相比而言多了<code>send</code>方法，而少了一些其他的get方法，需要时可以了解</p></li><li><p>IP提取：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getRealIp</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 这个一般是Nginx反向代理设置的参数</span></span><br><span class="line">       String ip = request.getHeader(<span class="string">"X-Real-IP"</span>);</span><br><span class="line">       <span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">"unknown"</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">           ip = request.getHeader(<span class="string">"X-Forwarded-For"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">"unknown"</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">           ip = request.getHeader(<span class="string">"Proxy-Client-IP"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">"unknown"</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">           ip = request.getHeader(<span class="string">"WL-Proxy-Client-IP"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">"unknown"</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">           ip = request.getRemoteAddr();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 处理多IP的情况（只取第一个IP）</span></span><br><span class="line">       <span class="keyword">if</span> (ip != <span class="keyword">null</span> &amp;&amp; ip.contains(<span class="string">","</span>)) &#123;</span><br><span class="line">           String[] ipArray = ip.split(<span class="string">","</span>);</span><br><span class="line">           ip = ipArray[<span class="number">0</span>];</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> ip;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><p><code>JoinPoint</code>以及<code>ProceedingJoinPoint</code>：</p><ol><li><p>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Object[] getArgs(); <span class="comment">// 获取传入目标方法的参数对象</span></span><br><span class="line"><span class="function">Signature <span class="title">getSignature</span><span class="params">()</span></span>; <span class="comment">// 获取封装了署名信息的对象,在该对象中可以获取到目标方法名,所属类的Class等信息</span></span><br><span class="line"><span class="function">Object <span class="title">getTarget</span><span class="params">()</span></span>; <span class="comment">// 获取被代理的对象</span></span><br><span class="line"><span class="function">Object <span class="title">getThis</span><span class="params">()</span></span>; <span class="comment">//获取代理对象</span></span><br></pre></td></tr></table></figure></li><li><p><code>Signature getSignature()</code>:<strong>（用的非常多）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function">String <span class="title">toString</span><span class="params">()</span></span>;<span class="comment">// 方法名称参数，如 Map com.example.aop.controller.helloPara(Integer,String,String)</span></span><br><span class="line">  <span class="function">String <span class="title">toShortString</span><span class="params">()</span></span>; <span class="comment">//非常简单的方法名称参数，如 controller.helloPara(..)</span></span><br><span class="line">  <span class="function">String <span class="title">toLongString</span><span class="params">()</span></span>; <span class="comment">// 超级详细的方法名称参数，如public java.util.Map com.example.aop.controller.helloPara(java.lang.Integer,java.lang.String,java.lang.String)</span></span><br><span class="line">  <span class="function">String <span class="title">getName</span><span class="params">()</span></span>; <span class="comment">// 方法名称 ，如helloPara</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getModifiers</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function">Class <span class="title">getDeclaringType</span><span class="params">()</span></span>; <span class="comment">// 目标方法的类 如 class com.example.aop.controller</span></span><br><span class="line">  <span class="function">String <span class="title">getDeclaringTypeName</span><span class="params">()</span></span>;<span class="comment">// 类名 如com.example.aop.controller</span></span><br><span class="line">      </span><br><span class="line">Signature signature = joinPoint.getSignature();</span><br><span class="line">MethodSignature methodSignature = (MethodSignature) signature;</span><br><span class="line">String[] parameterNames = methodSignature.getParameterNames(); <span class="comment">//获取方法参数名称</span></span><br><span class="line">methodSignature.getParameterTypes() <span class="comment">// 获取方法参数类</span></span><br></pre></td></tr></table></figure></li><li><p><code>Object getTarget()</code>以及<code>Object getThis()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Object target=pjp.getTarget();</span><br><span class="line">Object proxy=pjp.getThis();</span><br><span class="line">System.out.println(target.getClass().getName()); <span class="comment">// 方法名称</span></span><br><span class="line">System.out.println(proxy.getClass().getName()); <span class="comment">// 增强后的方法名称</span></span><br></pre></td></tr></table></figure></li><li><p><code>MethodSignature</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Class[] getParameterTypes();</span><br><span class="line">String[] getParameterNames();</span><br><span class="line">Class[] getExceptionTypes();</span><br><span class="line"><span class="function">String <span class="title">toString</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">String <span class="title">toShortString</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">String <span class="title">toLongString</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getModifiers</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">Class <span class="title">getDeclaringType</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">String <span class="title">getDeclaringTypeName</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">Class <span class="title">getReturnType</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">Method <span class="title">getMethod</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure></li><li><p>目标方法获取后的处理模板：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理请求参数</span></span><br><span class="line">String[] paramNames = ((MethodSignature) signature).getParameterNames();</span><br><span class="line">Object[] paramValues = joinPoint.getArgs();</span><br><span class="line"><span class="keyword">int</span> paramLength = <span class="keyword">null</span> == paramNames ? <span class="number">0</span> : paramNames.length;</span><br><span class="line"><span class="keyword">if</span> (paramLength == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paramLength; i++) &#123;</span><br><span class="line">        paramNames[i] <span class="comment">// 参数名称</span></span><br><span class="line">        JSONObject.toJSONString(paramValues[i])<span class="comment">// 参数内容</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li></ol><h2 id="引入-目标类增加方法"><a href="#引入-目标类增加方法" class="headerlink" title="引入(目标类增加方法)"></a>引入(目标类增加方法)</h2><ol><li>概念：在不改变一个现有类代码的情况下，为该类添加属性和方法,可以在无需修改现有类的前提下，让它们具有新的行为和状态。</li><li>主要是使用<code>@DeclareParents</code>注解来实现。</li></ol><h2 id="重复获取RestController请求中body内容"><a href="#重复获取RestController请求中body内容" class="headerlink" title="重复获取RestController请求中body内容"></a>重复获取RestController请求中body内容</h2><ol><li><p>AOP可以对RestController中的方法进行切面，而涉及到这些Web请求的增强时通常会使用<code>HttpServletRequest</code>来获取请求的body等的内容，获取body内容时可能会出现问题，这里主要介绍如何解决这些问题。</p></li><li><p><code>HttpServletRequest</code>的获取使用如下方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取RequestAttributes</span></span><br><span class="line">RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class="line"><span class="comment">// RequestAttributes requestAttributes = RequestContextHolder.currentRequestAttributes(); // 这个方法也可以</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从获取的RequestAttributes中获取HttpServletRequest的信息</span></span><br><span class="line">HttpServletRequest request = (HttpServletRequest) requestAttributes</span><br><span class="line">  .resolveReference(RequestAttributes.REFERENCE_REQUEST);</span><br></pre></td></tr></table></figure></li><li><p>body内容的获取通过上面的方法的request来得到：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  System.out.println(<span class="keyword">new</span> String(request.getInputStream().readAllBytes()));</span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">   System.out.println(e.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>需要注意的是body的获取方法是<code>getInputStream</code>，这个只能读取一次，再次读取会抛出异常，因此，想要获取body中的内容，需要实现一个继承<code>HttpServletRequestWrapper</code>的类<code>RequestMapper</code>，并重写里面的<code>getInputStream</code>方法</li></ul></li><li><p>重写继承自<code>HttpServletRequestWrapper</code>的类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ReadListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletInputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Vector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChangeRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String[]&gt; parameterMap; <span class="comment">// 所有参数的Map集合</span></span><br><span class="line">    <span class="keyword">private</span> String body;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChangeRequestWrapper</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(request);</span><br><span class="line">        parameterMap = request.getParameterMap();</span><br><span class="line">        body= <span class="keyword">new</span> String(request.getInputStream().readAllBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重写的getInputStream方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ByteArrayInputStream is=<span class="keyword">new</span> ByteArrayInputStream(body.getBytes());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServletInputStream() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadListener</span><span class="params">(ReadListener readListener)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> is.read();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重写几个HttpServletRequestWrapper中的方法</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所有参数名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回所有参数名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title">getParameterNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Vector&lt;String&gt; vector = <span class="keyword">new</span> Vector&lt;String&gt;(parameterMap.keySet());</span><br><span class="line">        <span class="keyword">return</span> vector.elements();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定参数名的值，如果有重复的参数名，则返回第一个的值 接收一般变量 ，如text类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 指定参数名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 指定参数名的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getParameter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        String[] results = parameterMap.get(name);</span><br><span class="line">        <span class="keyword">return</span> results[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定参数名的所有值的数组，如：checkbox的所有数据</span></span><br><span class="line"><span class="comment">     * 接收数组变量 ，如checkobx类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getParameterValues(String name) &#123;</span><br><span class="line">        <span class="keyword">return</span> parameterMap.get(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String[]&gt; getParameterMap() &#123;</span><br><span class="line">        <span class="keyword">return</span> parameterMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameterMap</span><span class="params">(Map&lt;String, String[]&gt; parameterMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.parameterMap = parameterMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>实现一个过滤器类来使用重写的继承类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LangFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"使用requestWrapper过滤器"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        ChangeRequestWrapper changeRequestWrapper = <span class="keyword">new</span> ChangeRequestWrapper((HttpServletRequest) servletRequest);</span><br><span class="line">        Map&lt;String, String[]&gt; parameterMap = <span class="keyword">new</span> HashMap&lt;&gt;(changeRequestWrapper.getParameterMap());</span><br><span class="line">        String[] strings = parameterMap.get(<span class="string">"lang"</span>);           <span class="comment">//逻辑代码给定默认的参数值,如果参数不为中文,则直接返回异常</span></span><br><span class="line">        <span class="keyword">if</span> (strings == <span class="keyword">null</span> || strings.length == <span class="number">0</span>) &#123;</span><br><span class="line">            strings = <span class="keyword">new</span> String[<span class="number">1</span>];</span><br><span class="line">            strings[<span class="number">0</span>] = <span class="string">"zh"</span>;</span><br><span class="line">            parameterMap.put(<span class="string">"lang"</span>, strings);</span><br><span class="line">            changeRequestWrapper.setParameterMap(parameterMap);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            String language = strings[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (!language.equals(<span class="string">"zh"</span>)) &#123;</span><br><span class="line">                Map&lt;String,String&gt; error = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                error.put(<span class="string">"code"</span>,<span class="string">"500"</span>);</span><br><span class="line"></span><br><span class="line">                ServletOutputStream outputStream = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    outputStream = servletResponse.getOutputStream();</span><br><span class="line">                    outputStream.write(<span class="number">112</span>);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (outputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        outputStream.flush();</span><br><span class="line">                        outputStream.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//使用复写后的wrapper</span></span><br><span class="line">        filterChain.doFilter(changeRequestWrapper, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在项目中实现了这两个类之后，就可以在AOP中获取RestController的body中的内容！</p></li></ol><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol><li>在使用AOP切入方法的时候，方法的访问控制修饰符不可以是<code>private</code>（由于CGLib采用动态创建子类的方式代理对象，不能对目标类中的final或private方法进行代理），可以是<code>public</code>、<code>protected</code>以及不加任何访问修饰符！</li><li>AOP的默认配置属性中，<code>spring.aop.auto</code>属性默认是开启的，也就是说只要引入了AOP依赖后，默认已经增加了<code>@EnableAspectJAutoProxy</code>，不需要在程序主类中增加<code>@EnableAspectJAutoProxy</code>来启用！</li><li><strong>不宜把重要的业务逻辑放置到AOP中！</strong></li><li>AOP无法拦截<code>static</code>、<code>final</code>修饰的方法，也无法拦截内部方法调用，因为内部方法调用直接被调用，无法进行增强。</li><li>需要合理利用面向切面编程提升代码质量。</li><li>课程学习：<a href="https://www.imooc.com/learn/869" target="_blank" rel="noopener">https://www.imooc.com/learn/869</a></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>SpringBoot项目中目前能想到的内容都基本上有去查询与记录，后续使用到一些更为麻烦的场景的时候再继续记录下来，不断扩充自己的AOP知识，这部分没有完整看官方的文档，目前的策略还是用到多少看多少，不然进度太慢了！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;Spring AOP在SpringBoot实战学习的时候有接触过，但是对于其并没有深入，在实际开发中才渐渐发现它的强大，这里花点时间深入了解
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="https://wanderros.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBoot MybatisPlus 多租户插件学习</title>
    <link href="https://wanderros.github.io/2020/09/28/SpringBoot-MybatisPlus-%E5%A4%9A%E7%A7%9F%E6%88%B7%E6%8F%92%E4%BB%B6%E5%AD%A6%E4%B9%A0/"/>
    <id>https://wanderros.github.io/2020/09/28/SpringBoot-MybatisPlus-%E5%A4%9A%E7%A7%9F%E6%88%B7%E6%8F%92%E4%BB%B6%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-09-27T23:21:52.000Z</published>
    <updated>2020-10-01T08:52:15.906Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>多租户是一种软件架构技术，在多用户的环境下，共有同一套系统，并且要注意数据之间的隔离性。在学习MybatiPlus（以下简称MP）的使用过程中，看到自3.4.0之后添加内置插件，内置插件里有多租户插件，就很好奇，然后就尝试了下使用，虽然有文档啥的，但还是花了很长时间去跑一个Demo。记录下来，如果以后有需要也能快速开发！</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li>多租户是指软件架构支持一个实例服务多个用户（Customer），每一个用户被称之为租户（tenant），软件给予租户可以对系统进行部分定制的能力，如用户界面颜色或业务规则，但是他们不能定制修改软件的代码。</li><li>场景：开发系统时，如果该系统提供给多个商家使用时，考虑到各个商家的数据隔离的时候，就需要在传输数据时带上商家的ID（租户ID），从而进行数据的隔离。其实就是不同租户使用同一套系统，需要考虑数据隔离的问题！</li><li>数据隔离有三种方案：<ol><li><strong>独立数据库</strong>：简单来说就是一个租户使用一个数据库，这种数据隔离级别最高，安全性最好，但是成本就相对很高</li><li><strong>共享数据库、隔离数据架构</strong>：多租户使用同一个数据裤，但是每个租户对应一个Schema</li><li><strong>共享数据库、共享数据架构</strong>：使用同一个数据库，同一个Schema，但是在表中增加了租户ID的字段，这种共享数据程度最高，隔离级别最低</li></ol></li><li>MP通过内置的多租户插件（TenantLineInnerInterceptor）提供了一种多租户解决方案。</li></ol><h2 id="MP多租户简单实现"><a href="#MP多租户简单实现" class="headerlink" title="MP多租户简单实现"></a>MP多租户简单实现</h2><ol><li><p>创建一个SpringBoot项目，添加MP的依赖(3.4版本)：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>创建数据库脚本：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- schema.sql</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> tb_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_user</span><br><span class="line">(</span><br><span class="line">id_real <span class="built_in">varchar</span> (<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'主键ID'</span>,</span><br><span class="line">name_real <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'姓名'</span>,</span><br><span class="line">age_real <span class="built_in">INT</span>(<span class="number">11</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'年龄'</span>,</span><br><span class="line">email_real <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'邮箱'</span>,</span><br><span class="line"><span class="keyword">version</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">null</span>,</span><br><span class="line">sex <span class="built_in">int</span>(<span class="number">2</span>) <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">null</span>,</span><br><span class="line">update_time DATETIME <span class="literal">null</span> <span class="keyword">default</span>  <span class="literal">null</span>,</span><br><span class="line">insert_time DATETIME <span class="literal">null</span> <span class="keyword">default</span>  <span class="literal">null</span>,</span><br><span class="line">author <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="literal">null</span> <span class="keyword">default</span>  <span class="literal">null</span>,</span><br><span class="line">deleted <span class="built_in">boolean</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span>  <span class="literal">false</span>,</span><br><span class="line">tenant_id <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">null</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (id_real)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- data.sql</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> tb_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb_user (id_real, name_real, age_real, email_real,<span class="keyword">version</span>,sex,tenant_id) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">'Jone'</span>, <span class="number">18</span>, <span class="string">'test1@baomidou.com'</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">'Jack'</span>, <span class="number">20</span>, <span class="string">'test2@baomidou.com'</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">'Tom'</span>, <span class="number">28</span>, <span class="string">'test3@baomidou.com'</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">'Sandy'</span>, <span class="number">21</span>, <span class="string">'test4@baomidou.com'</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">'Billie'</span>, <span class="number">24</span>, <span class="string">'test5@baomidou.com'</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure></li><li><p>创建实体对象User：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(value=<span class="string">"tb_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@TableId</span>(value=<span class="string">"id_real"</span>,type= IdType.ASSIGN_UUID)</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"name_real"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"age_real"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"email_real"</span>)</span><br><span class="line">    <span class="keyword">private</span>  String email;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"version"</span>)</span><br><span class="line">    <span class="meta">@Version</span></span><br><span class="line">    <span class="keyword">private</span> Integer version;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Boolean sex;</span><br><span class="line">    <span class="meta">@TableField</span>(fill = FieldFill.UPDATE)</span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">    <span class="meta">@TableField</span>(fill=FieldFill.INSERT)</span><br><span class="line">    <span class="keyword">private</span> Date insertTime;</span><br><span class="line">    <span class="meta">@TableField</span>(fill=FieldFill.INSERT_UPDATE)</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableLogic</span></span><br><span class="line">    <span class="keyword">private</span> Boolean deleted;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField</span>(value = <span class="string">"tenant_id"</span>)</span><br><span class="line">    <span class="keyword">private</span> Long tenantId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建Mapper：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在启动类上添加Mapper扫描注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.example.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Test2Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置MP的内置插件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MPConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新的分页插件,一缓和二缓遵循mybatis的规则,需要设置 MybatisConfiguration#useDeprecatedExecutor = false 避免缓存出现问题(该属性会在旧插件移除后一同移除)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MybatisPlusInterceptor <span class="title">mybatisPlusInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MybatisPlusInterceptor interceptor = <span class="keyword">new</span> MybatisPlusInterceptor();</span><br><span class="line">        TenantLineInnerInterceptor tenantLineInnerInterceptor=<span class="keyword">new</span> TenantLineInnerInterceptor(<span class="keyword">new</span> TenantLineHandler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Expression <span class="title">getTenantId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> LongValue(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">getTenantIdColumn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"tenant_id"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">ignoreTable</span><span class="params">(String tableName)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        interceptor.addInnerInterceptor(tenantLineInnerInterceptor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分页插件</span></span><br><span class="line"><span class="comment">//        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));</span></span><br><span class="line">        <span class="comment">// 乐观锁插件</span></span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> OptimisticLockerInnerInterceptor());</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>主要实现TenantLineHandler的<code>getTenantId</code>、<code>getTenantIdColumn</code>、<code>ignoreTable</code>方法，分别表示租户ID、租户ID对应的数据库列、忽略哪些表（因为有些可能是公用的表或者其他用处）</li><li>这里是所有的表都不忽略，然后租户ID以及租户ID对应的数据库列都是固定的，方便测试</li></ol></li><li><p>添加配置文件（application.yml）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mybatis?characterEncoding=utf8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">schema:</span> <span class="string">classpath:sql/schema.sql</span></span><br><span class="line">    <span class="attr">data:</span> <span class="string">classpath:sql/data.sql</span></span><br><span class="line">    <span class="attr">initialization-mode:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment"># sql输出到控制台  方便查看</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure></li><li><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2ApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        userMapper.deleteById(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">输出：</span></span><br><span class="line"><span class="comment">Creating a new SqlSession</span></span><br><span class="line"><span class="comment">SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@604c7e9b] was not registered for synchronization because synchronization is not active</span></span><br><span class="line"><span class="comment">JDBC Connection [HikariProxyConnection@1560391896 wrapping com.mysql.cj.jdbc.ConnectionImpl@271e851e] will not be managed by Spring</span></span><br><span class="line"><span class="comment">==&gt;  Preparing: UPDATE tb_user SET deleted = 1 WHERE tenant_id = 1 AND id_real = ? AND deleted = 0</span></span><br><span class="line"><span class="comment">==&gt; Parameters: 5(Integer)</span></span><br><span class="line"><span class="comment">&lt;==    Updates: 1</span></span><br><span class="line"><span class="comment">Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@604c7e9b]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><ul><li>可以看到虽然没有在条件中加入tenant_id，但是输出的sql语句中自动加入了该字段，非常方便</li><li>配置好之后，不管是查询、新增、修改删除方法，MP都会自动加上租户ID的标识</li><li>实现出现问题可以先看SpringBoot MybatisPlus Quick Start中的记录</li></ul></li></ol><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ol><li><code>MateCloud</code>有用MP的多租户插件，可以阅读下源码，代码地址：<a href="https://github.com/matevip/matecloud" target="_blank" rel="noopener">https://github.com/matevip/matecloud</a></li><li><strong>多租户 != 权限过滤,不要乱用,租户之间是完全隔离的!!!</strong></li><li>在开发的过程中我忘记ComponentScan，导致MP的配置没有生效，一直不出现效果，浪费了很多时间，非常要注意这些弱智问题！</li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>多租户概念上理解起来还是很简单的，但是涉及到的内容很多，这里只是用MP的内置插件写了一个Demo，根据效果大致了解了MP的多租户的实现原理，后续如果业务上有需求，也不失为一种快速方案！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;多租户是一种软件架构技术，在多用户的环境下，共有同一套系统，并且要注意数据之间的隔离性。在学习MybatiPlus（以下简称MP）的使用过程
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="https://wanderros.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBoot MybatisPlus Quick Start</title>
    <link href="https://wanderros.github.io/2020/09/26/SpringBoot-MybatisPlus-Quick-Start/"/>
    <id>https://wanderros.github.io/2020/09/26/SpringBoot-MybatisPlus-Quick-Start/</id>
    <published>2020-09-26T06:21:18.000Z</published>
    <updated>2020-10-01T08:52:15.906Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>真的是好久没有写学习日志了，一方面和最近这一个月的状态有关，另一方面也可能上上班太累了吧，每天都有很多杂七杂八的活，然后又重构项目，在这种状态下人真的很颓废，然后收拾一下自己的房间，也收拾一下自己的心情，不能放弃学习记录的习惯，更不能让坏心情影响了自己，之前有去接触了下MybatisPlus（以下简称MP），本以为自己会很快建立新项目引入MP，实际上却出现了不少的问题，记录下这些东西很有意义的内容，快速成长吧！</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="自动化SQL"><a href="#自动化SQL" class="headerlink" title="自动化SQL"></a>自动化SQL</h2><p>在开发过程中建立好了表，如果迁移到测试环境或者其他环境中，可能需要手动执行SQL语句来执行表的建立以及数据的导入，非常不方便，但是Spring中提供了在项目启动时执行sql语句的配置，只要配置好了就可以自动建表以及插入数据。自动建表的配置如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mybatis?characterEncoding=utf8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">schema:</span> <span class="string">classpath:sql/schema.sql</span></span><br><span class="line">    <span class="attr">data:</span> <span class="string">classpath:sql/data.sql</span></span><br><span class="line">    <span class="attr">initialization-mode:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure><ul><li><code>spring.datasource.schema</code>用于建立表，<code>classpath:sql/schema.sql</code>代表的是会从resources下的sql文件夹中搜索schema.sql文件然后执行</li><li><code>spring.datasource.data</code>用于导入数据，<code>classpath:sql/data.sql</code>代表的是会从resources下的sql文件夹中搜索data.sql文件然后执行</li><li><code>spring.datasource.initialization-mode</code>用于设置sql文件是否执行，内建数据库的文件执行不需要设置，但是其他的需要设置该配置</li></ul><h2 id="去除IDEA中的自动注入Mapper的警告"><a href="#去除IDEA中的自动注入Mapper的警告" class="headerlink" title="去除IDEA中的自动注入Mapper的警告"></a>去除IDEA中的自动注入Mapper的警告</h2><p>不管是直接使用Mybatis还是使用MP，在IDE工程中自动注入Mapper的时候就会出现警告，虽然没什么问题，但是就让人觉得代码好像是有问题似的，对于开发人员而言，有点强迫症的是很难忍受红色波浪线的警告，这里经过测试记录下可以使用的解决方案。</p><ol><li><p>在Mapper的注入时，为<code>@Autowired</code>注解设置<code>required=false</code>，样例如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">private</span> UserMapper userMapper;</span><br></pre></td></tr></table></figure><ul><li>IDEA认为userMapper是个null，给了警告；加上了required = false后，使用 <code>@Autowired</code> 注解不再去校验userMapper是否存在了，因而也就没有警告了</li></ul></li><li><p>在Mapper的注入时，用<code>@Resource</code>替换<code>@Autowired</code>，样例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> UserMapper userMapper;</span><br></pre></td></tr></table></figure><ul><li>可以在自动注入Mapper的时候使用<code>@Resource</code>注解</li><li><code>@Autowired</code>与<code>@Resource</code>都可以用来装配Bean</li><li><code>@Autowired</code>默认按类型装配（该注解属于Spring），而@Resource（该注解属于J2EE）有name和type两个重要的属性，Spring将@Resource注解的name属性解析为bean的名字，而type属性则解析为bean的类型</li></ul></li><li><p>在需要使用Mapper的类上添加注解<code>@RequiredArgsConstructor(onConstructor = @__(@Autowired))</code>，并且设置mapper为<code>final</code>，样例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span>(onConstructor = @__(<span class="meta">@Autowired</span>))</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MPTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这个方法有点不推荐使用，感觉不太爽，而且在类的依赖关系比较复杂的时候可能启动不起来</li></ul></li><li><p>关闭IDEA的警告（不推荐）</p><ul><li>进入 Settings，找到 Inspection，并选择其中的 Spring Core -&gt; Code -&gt; Autowiring for Bean Class,将 Error 改为 Warning</li><li>关闭了IDEA的警告，没有提示反而不能帮助我们写出高质量代码，当然代码的质量还在于开发人员</li><li>关于IDEA的Mapper警告还可以安装插件，但是具体哪个插件没有去尝试</li></ul></li></ol><h2 id="MP的使用"><a href="#MP的使用" class="headerlink" title="MP的使用"></a>MP的使用</h2><h3 id="基础介绍及使用"><a href="#基础介绍及使用" class="headerlink" title="基础介绍及使用"></a>基础介绍及使用</h3><ol><li><p>官方指导文档：<a href="https://mybatis.plus/guide/" target="_blank" rel="noopener">https://mybatis.plus/guide/</a></p></li><li><p>代码托管地址：<a href="https://github.com/baomidou" target="_blank" rel="noopener">https://github.com/baomidou</a></p></li><li><p>MP官方示例：<a href="https://github.com/baomidou/mybatis-plus-samples" target="_blank" rel="noopener">https://github.com/baomidou/mybatis-plus-samples</a></p></li><li><p>MP只是一个Mybatis的增强工具，在Mybatis的基础上只做增强不做改变，为简化开发、提高效率而生！原理上就是已经封装好了一些crud方法，从官方的介绍也知道MP的使用是依赖于Mybatis的，在项目中没有添加Mybatis的依赖的话会出现错误。</p></li><li><p>首先需要启动好自己的MySQL数据库，然后确保能够连接数据库，不然SpringBoot项目是没法启动的，可以使用Docker启动一个MySQL：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --name mysql-test -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql</span><br></pre></td></tr></table></figure><ul><li>还需要建立数据库，比如我创建的是mybatis</li></ul></li><li><p>添加Maven依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;dependency&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;version&gt;2.1.3&lt;/version&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;/dependency&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><strong>引入MP就不需要再引入Mybatis依赖了，以免冲突</strong></li></ul></li><li><p>在项目中添加配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mybatis?characterEncoding=utf8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">schema:</span> <span class="string">classpath:sql/schema.sql</span></span><br><span class="line">    <span class="attr">data:</span> <span class="string">classpath:sql/data.sql</span></span><br><span class="line">    <span class="attr">initialization-mode:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure></li><li><p>按照自动化SQL的说明来建立schema.sql以及data.sql，添加SQL语句如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- schema.sql</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> tb_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_user</span><br><span class="line">(</span><br><span class="line">id_real <span class="built_in">varchar</span> (<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'主键ID'</span>,</span><br><span class="line">name_real <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'姓名'</span>,</span><br><span class="line">age_real <span class="built_in">INT</span>(<span class="number">11</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'年龄'</span>,</span><br><span class="line">email_real <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'邮箱'</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (id_real)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- data.sql</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> tb_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb_user (id_real, name_real, age_real, email_real) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">'Jone'</span>, <span class="number">18</span>, <span class="string">'test1@baomidou.com'</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">'Jack'</span>, <span class="number">20</span>, <span class="string">'test2@baomidou.com'</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">'Tom'</span>, <span class="number">28</span>, <span class="string">'test3@baomidou.com'</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">'Sandy'</span>, <span class="number">21</span>, <span class="string">'test4@baomidou.com'</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">'Billie'</span>, <span class="number">24</span>, <span class="string">'test5@baomidou.com'</span>);</span><br></pre></td></tr></table></figure></li><li><p>创建表<code>tb_user</code>对应的Persistent Object（PO）User：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(value=<span class="string">"tb_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@TableId</span>(value=<span class="string">"id_real"</span>,type= IdType.ASSIGN_UUID)</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"name_real"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"age_real"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"email_real"</span>)</span><br><span class="line">    <span class="keyword">private</span>  String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>@TableName</code>用于映射表名</li><li><code>@TableId</code>用于声明主键，属性type可以用于在PO中的主键没设置时自动生成（依据策略），<code>IdType.ASSIGN_UUID</code>和<code>IdType.ASSIGN_ID</code>推荐使用</li><li><code>@TableField</code>用在非主键对应的属性上，可以指定属性对应的数据库字段名，同时也可以设置字段是否为空等属性</li><li><code>@TableLogic</code> : 用在标记逻辑删除的字段属性上，使用该注解后，Myabtis Plus 所有针对该表的删除都将执行逻辑删除(即更新操作)，而不使用该注解，Mybatis Plus 执行的删除操作为物理删除</li></ul></li><li><p>创建Mapper：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>继承自<code>BaseMapper</code>则可以少写很多SQL语句</li></ul></li><li><p>在启动类上添加扫描Mapper注解，如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.example.mapper"</span>)</span><br></pre></td></tr></table></figure></li><li><p>可以测试是否引入成功：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MPTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span>  UserMapper userMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testMapper</span><span class="params">()</span></span>&#123;</span><br><span class="line">        User user=<span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="string">"123"</span>);</span><br><span class="line">        user.setName(<span class="string">"lll1"</span>);</span><br><span class="line">        user.setEmail(<span class="string">"hello@qq.com"</span>);</span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">        List&lt;User&gt; userList = userMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line">        userList.forEach((d)-&gt; System.out.println(d));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="引入分页插件（第三方）"><a href="#引入分页插件（第三方）" class="headerlink" title="引入分页插件（第三方）"></a>引入分页插件（第三方）</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mybatis分页插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>添加分页测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testPage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    User user=<span class="keyword">new</span> User();</span><br><span class="line">    user.setId(<span class="string">"123"</span>);</span><br><span class="line">    user.setName(<span class="string">"lll1"</span>);</span><br><span class="line">    user.setEmail(<span class="string">"hello@qq.com"</span>);</span><br><span class="line">    userMapper.insert(user);</span><br><span class="line">    PageHelper.startPage(<span class="number">2</span>,<span class="number">5</span>);</span><br><span class="line">    List&lt;User&gt; userList = userMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line">    userList.forEach((d)-&gt; System.out.println(d));</span><br><span class="line">    PageHelper.startPage(<span class="number">1</span>,<span class="number">5</span>);</span><br><span class="line">    userList = userMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line">    userList.forEach((d)-&gt; System.out.println(d));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用MP的分页-版本3-4"><a href="#使用MP的分页-版本3-4" class="headerlink" title="使用MP的分页(版本3.4)"></a>使用MP的分页(版本3.4)</h3><ol><li><p><strong>3.4版本之后</strong>和之前的版本分页插件是不同的，记录时就是喜欢用新的，新版本的成了内置插件，主体插件<code>MybatisPlusInterceptor</code>，包含了多个内部插件：</p><ul><li>分页插件: <code>PaginationInnerInterceptor</code></li><li>多租户插件: <code>TenantLineInnerInterceptor</code></li><li>动态表名插件: <code>DynamicTableNameInnerInterceptor</code></li><li>乐观锁插件: <code>OptimisticLockerInnerInterceptor</code></li><li>sql性能规范插件: <code>IllegalSQLInnerInterceptor</code></li><li>防止全表更新与删除插件: <code>BlockAttackInnerInterceptor</code></li></ul></li><li><p><strong>新提供的插件不得和同功能的旧插件一同使用，之前的插件在新版本里是属于废弃状态的！</strong></p></li><li><p>分页查询分为物理分页和逻辑分页：</p><ul><li>物理分页：相当于执行了limit分页语句，返回部分数据，占用内存小，能够获取数据库最新的状态，实施性比较强，一般适用于数据量比较大，数据更新比较频繁的场景</li><li>逻辑分页：一次性把全部的数据取出来，通过程序进行筛选数据，数据量大的情况下会消耗大量的内存，由于逻辑分页只需要读取数据库一次，不能获取数据库最新状态，实施性比较差，适用于数据量小，数据稳定的场合</li></ul></li><li><p>如果内部插件都是使用,需要注意顺序关系,建议使用如下顺序：</p><ol><li>多租户插件,动态表名插件</li><li>分页插件,乐观锁插件</li><li>sql性能规范插件,防止全表更新与删除插件</li></ol><ul><li><strong>对sql进行单次改造的优先放入,不对sql进行改造的最后放入</strong></li></ul></li><li><p>添加配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新的分页插件,一缓和二缓遵循mybatis的规则,需要设置 MybatisConfiguration#useDeprecatedExecutor = false 避免缓存出现问题(该属性会在旧插件移除后一同移除)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MybatisPlusInterceptor <span class="title">mybatisPlusInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MybatisPlusInterceptor interceptor = <span class="keyword">new</span> MybatisPlusInterceptor();</span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> PaginationInnerInterceptor(DbType.MYSQL));</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testselectPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Page&lt;User&gt; page = <span class="keyword">new</span> Page&lt;&gt;(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    IPage&lt;User&gt; userIPage = userMapper.selectPage(page, <span class="keyword">null</span>);</span><br><span class="line">    System.out.println(<span class="string">"总条数 ------&gt; "</span> + userIPage.getTotal());</span><br><span class="line">    System.out.println(<span class="string">"总页数 ------&gt; "</span> +  userIPage.getPages());</span><br><span class="line">    System.out.println(<span class="string">"当前页数 ------&gt; "</span> + userIPage.getCurrent());</span><br><span class="line">    System.out.println(<span class="string">"当前每页显示数 ------&gt; "</span> + userIPage.getSize());</span><br><span class="line">    System.out.println(userIPage.getCurrent()); <span class="comment">// 获取当前页</span></span><br><span class="line">    System.out.println(userIPage.getTotal()); <span class="comment">// 获取总记录数</span></span><br><span class="line">    System.out.println(userIPage.getSize()); <span class="comment">// 获取每页的条数</span></span><br><span class="line">    System.out.println(userIPage.getRecords()); <span class="comment">// 获取每页数据的集合</span></span><br><span class="line">    System.out.println(userIPage.getPages()); <span class="comment">// 获取总页数</span></span><br><span class="line">    System.out.println(userIPage.hasNext()); <span class="comment">// 是否存在下一页</span></span><br><span class="line">    System.out.println(userIPage.hasPrevious()); <span class="comment">// 是否存在上一页</span></span><br><span class="line">    List&lt;User&gt; records = userIPage.getRecords();</span><br><span class="line">    <span class="keyword">for</span> (User user : records) &#123;</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>自定义查询分页（上面的基础下）：</p><ol><li><p>添加Mapper语句：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT id_real as id,name_real as name,age_real as age,email_real as email FROM tb_user WHERE email_real LIKE #&#123;state&#125;"</span>)</span><br><span class="line">    <span class="function">IPage&lt;User&gt; <span class="title">selectPageUserDefined</span><span class="params">(IPage&lt;?&gt; page, String state)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">userDefinedPageSelect</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Page&lt;User&gt; page = <span class="keyword">new</span> Page&lt;&gt;(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    IPage&lt;User&gt; userIPage =userMapper.selectPageUserDefined(page,<span class="string">"%baomidou%"</span>);</span><br><span class="line">    System.out.println(<span class="string">"总条数 ------&gt; "</span> + userIPage.getTotal());</span><br><span class="line">    System.out.println(<span class="string">"总页数 ------&gt; "</span> +  userIPage.getPages());</span><br><span class="line">    System.out.println(<span class="string">"当前页数 ------&gt; "</span> + userIPage.getCurrent());</span><br><span class="line">    System.out.println(<span class="string">"当前每页显示数 ------&gt; "</span> + userIPage.getSize());</span><br><span class="line">    List&lt;User&gt; records = userIPage.getRecords();</span><br><span class="line">    <span class="keyword">for</span> (User user : records) &#123;</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>映射关系：</p><ul><li><p>Java中的字段和MySQL字段不一致时，在Mapper中可以使用as字段，但是每个都这样就很繁琐</p></li><li><p>使用注解的方式就可以简化：<code>@Results</code>、<code>@Result</code>以及<code>@ResultMap</code>可以简化SQL语句，示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Select("SELECT id_real as id,name_real as name,age_real as age,email_real as email FROM tb_user WHERE email_real LIKE #&#123;state&#125;")</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Results</span>(id = <span class="string">"resultMap"</span> , value = &#123;</span><br><span class="line">            <span class="meta">@Result</span>(property = <span class="string">"id"</span>,column = <span class="string">"id_real"</span>),</span><br><span class="line">            <span class="meta">@Result</span>(property = <span class="string">"name"</span>,column = <span class="string">"name_real"</span>),</span><br><span class="line">            <span class="meta">@Result</span>(property = <span class="string">"age"</span>,column = <span class="string">"age_real"</span>),</span><br><span class="line">            <span class="meta">@Result</span>(property = <span class="string">"email"</span>,column = <span class="string">"email_real"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT * FROM tb_user WHERE email_real LIKE #&#123;state&#125;"</span>)</span><br><span class="line">    <span class="function">IPage&lt;User&gt; <span class="title">selectPageUserDefined</span><span class="params">(IPage&lt;?&gt; page, String state)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResultMap</span>(<span class="string">"resultMap"</span>)</span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT * FROM tb_user WHERE name_real like #&#123;name&#125;"</span>)</span><br><span class="line">    <span class="function">IPage&lt;User&gt; <span class="title">selectPageUserDefined2</span><span class="params">(IPage&lt;?&gt; page, String name)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>@Results</code>建立多个映射关系，<code>@Result</code>建立单个映射关系，其中<code>property</code>属性对应java代码中定义的名称，<code>column</code>属性对应MySQL字段</li><li><code>@ResultMap</code>可以使用带有id属性的<code>@Results</code></li></ul></li></ul></li></ol></li></ol><h3 id="多表一对一查询以及一对多查询"><a href="#多表一对一查询以及一对多查询" class="headerlink" title="多表一对一查询以及一对多查询"></a>多表一对一查询以及一对多查询</h3><ol><li><p>场景描述：一个员工可以在一家公司任职（员工和公司在该情况下属于一对一），一家公司里有很多的员工（公司和员工在该情况下属于一对多）</p></li><li><p>创建数据库表以及数据（工程的schema.sql以及data.sql中添加即可）：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- schema.sql</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> company;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> employee;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">table</span> company</span><br><span class="line">(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span>,</span><br><span class="line">    companyName <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> employee</span><br><span class="line">(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span>,</span><br><span class="line">    userName <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'姓名'</span>,</span><br><span class="line">    email <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'邮箱'</span>,</span><br><span class="line">    companyId <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- data.sql</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employee;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> company;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> employee (<span class="keyword">id</span>, userName, companyId, email) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">'Jone'</span>, <span class="number">1</span>, <span class="string">'test1@baomidou.com'</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">'Jack'</span>, <span class="number">2</span>, <span class="string">'test2@baomidou.com'</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">'Tom'</span>, <span class="number">1</span>, <span class="string">'test3@baomidou.com'</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">'Sandy'</span>, <span class="number">1</span>, <span class="string">'test4@baomidou.com'</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">'Billie'</span>, <span class="number">2</span>, <span class="string">'test5@baomidou.com'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> company (<span class="keyword">id</span>, companyName) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">'Apple'</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">'Midea'</span>);</span><br></pre></td></tr></table></figure></li><li><p>创建PO：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line">    Integer id;</span><br><span class="line">    String userName;</span><br><span class="line">    String email;</span><br><span class="line">    Company company;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Company</span> </span>&#123;</span><br><span class="line">    Integer id;</span><br><span class="line">    String companyName;</span><br><span class="line">    List&lt;Employee&gt; list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建Mapper：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">com.example.mapper.EmployeeMapper是项目中保存Mapper的路径</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmployeeMapper</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"Select * from employee"</span>)</span><br><span class="line">    <span class="meta">@Result</span>(property = <span class="string">"company"</span>,column = <span class="string">"companyId"</span>,one=<span class="meta">@One</span>(select = <span class="string">"com.example.mapper.CompanyMapper.selectById"</span>))</span><br><span class="line">    <span class="function">List&lt;Employee&gt; <span class="title">selectAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"Select * from employee where companyId=#&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">List&lt;Employee&gt; <span class="title">selectByCompanyId</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CompanyMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from company where id=#&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">Company <span class="title">selectById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"Select * from company where id=#&#123;id&#125;"</span>)</span><br><span class="line">    <span class="meta">@Result</span>(property = <span class="string">"list"</span>,column = <span class="string">"id"</span>,many = <span class="meta">@Many</span>(select = <span class="string">"com.example.mapper.EmployeeMapper.selectByCompanyId"</span>))</span><br><span class="line">    <span class="meta">@Result</span>(property = <span class="string">"id"</span>,column = <span class="string">"id"</span>)</span><br><span class="line">    <span class="function">Company <span class="title">showCompanyEmployee</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>@One联查（一对一）</li><li>@Many联查（一对多）</li><li><strong>不管是一对多还是多对一，还是多对多，只需要知道数据是需要一对一关联还是多个结果映射到1个list，就可以很好的在实体的POJO，Mapper文件中写出来</strong></li><li>要实现多对多，在程序中则是拆分成2个一对多</li></ul></li><li><p>测试一对一：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmployeeMapperTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    EmployeeMapper employeeMapper;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OneTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Employee&gt; list=employeeMapper.selectAll();</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">[Employee(id=1, userName=Jone, email=test1@baomidou.com, company=Company(id=1, companyName=Apple, list=null)), Employee(id=2, userName=Jack, email=test2@baomidou.com, company=Company(id=2, companyName=Midea, list=null)), Employee(id=3, userName=Tom, email=test3@baomidou.com, company=Company(id=1, companyName=Apple, list=null)), Employee(id=4, userName=Sandy, email=test4@baomidou.com, company=Company(id=1, companyName=Apple, list=null)), Employee(id=5, userName=Billie, email=test5@baomidou.com, company=Company(id=2, companyName=Midea, list=null))]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li><li><p>测试一对多：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompanyMapperTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    CompanyMapper companyMapper;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">one2Many</span><span class="params">()</span></span>&#123;</span><br><span class="line">       Company company= companyMapper.showCompanyEmployee(<span class="number">1</span>);</span><br><span class="line">        System.out.println(company);</span><br><span class="line">        List&lt;Employee&gt; list=company.getList();</span><br><span class="line">        <span class="keyword">for</span>(Employee e:list)&#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">Company(id=1, companyName=Apple, list=[Employee(id=1, userName=Jone, email=test1@baomidou.com, company=null), Employee(id=3, userName=Tom, email=test3@baomidou.com, company=null), Employee(id=4, userName=Sandy, email=test4@baomidou.com, company=null)])</span></span><br><span class="line"><span class="comment">Employee(id=1, userName=Jone, email=test1@baomidou.com, company=null)</span></span><br><span class="line"><span class="comment">Employee(id=3, userName=Tom, email=test3@baomidou.com, company=null)</span></span><br><span class="line"><span class="comment">Employee(id=4, userName=Sandy, email=test4@baomidou.com, company=null)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="Wrapper条件构造器"><a href="#Wrapper条件构造器" class="headerlink" title="Wrapper条件构造器"></a>Wrapper条件构造器</h3><ol><li><p>首先看样例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 名字包含雨并且年龄小于40</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * WHERE name LIKE '%雨%' AND age &lt; 40</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByWrapperOne</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> QueryWrapper();</span><br><span class="line">        wrapper.like(<span class="string">"name"</span>, <span class="string">"雨"</span>).lt(<span class="string">"age"</span>, <span class="number">40</span>);</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectList(wrapper);</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 名字包含雨</span></span><br><span class="line"><span class="comment">     * 年龄大于20小于40</span></span><br><span class="line"><span class="comment">     * 邮箱不能为空</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * WHERE name LIKE '%雨%' AND age BETWEEN 20 AND 40 AND email IS NOT NULL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByWrapperTwo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = Wrappers.query();</span><br><span class="line">        wrapper.like(<span class="string">"name"</span>, <span class="string">"雨"</span>).between(<span class="string">"age"</span>, <span class="number">20</span>, <span class="number">40</span>).isNotNull(<span class="string">"email"</span>);</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectList(wrapper);</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 名字为王性</span></span><br><span class="line"><span class="comment">     * 或者年龄大于等于25</span></span><br><span class="line"><span class="comment">     * 按照年龄降序排序，年龄相同按照id升序排序</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * WHERE name LIKE '王%' OR age &gt;= 25 ORDER BY age DESC , id ASC</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByWrapperThree</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = Wrappers.query();</span><br><span class="line">        wrapper.likeRight(<span class="string">"name"</span>, <span class="string">"王"</span>).or()</span><br><span class="line">                .ge(<span class="string">"age"</span>, <span class="number">25</span>).orderByDesc(<span class="string">"age"</span>).orderByAsc(<span class="string">"id"</span>);</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectList(wrapper);</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询创建时间为2019年2月14</span></span><br><span class="line"><span class="comment">     * 并且上级领导姓王</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * WHERE date_format(create_time,'%Y-%m-%d') = '2019-02-14' AND manager_id IN (select id from user where name like '王%')</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByWrapperFour</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = Wrappers.query();</span><br><span class="line">        wrapper.apply(<span class="string">"date_format(create_time,'%Y-%m-%d') = &#123;0&#125;"</span>, <span class="string">"2019-02-14"</span>)</span><br><span class="line">                .inSql(<span class="string">"manager_id"</span>, <span class="string">"select id from user where name like '王%'"</span>);</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectList(wrapper);</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询王姓</span></span><br><span class="line"><span class="comment">     * 并且年龄小于40或者邮箱不为空</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * WHERE name LIKE '王%' AND ( age &lt; 40 OR email IS NOT NULL )</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByWrapperFive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = Wrappers.query();</span><br><span class="line">        wrapper.likeRight(<span class="string">"name"</span>, <span class="string">"王"</span>).and(qw -&gt; qw.lt(<span class="string">"age"</span>, <span class="number">40</span>).or().isNotNull(<span class="string">"email"</span>));</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectList(wrapper);</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询王姓</span></span><br><span class="line"><span class="comment">     * 并且年龄大于20 、年龄小于40、邮箱不能为空</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * WHERE name LIKE ? OR ( age BETWEEN ? AND ? AND email IS NOT NULL )</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByWrapperSix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = Wrappers.query();</span><br><span class="line">        wrapper.likeRight(<span class="string">"name"</span>, <span class="string">"王"</span>).or(</span><br><span class="line">                qw -&gt; qw.between(<span class="string">"age"</span>, <span class="number">20</span>, <span class="number">40</span>).isNotNull(<span class="string">"email"</span>)</span><br><span class="line">        );</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectList(wrapper);</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * (年龄小于40或者邮箱不为空) 并且名字姓王</span></span><br><span class="line"><span class="comment">     * WHERE ( age &lt; 40 OR email IS NOT NULL ) AND name LIKE '王%'</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByWrapperSeven</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = Wrappers.query();</span><br><span class="line">        wrapper.nested(qw -&gt; qw.lt(<span class="string">"age"</span>, <span class="number">40</span>).or().isNotNull(<span class="string">"email"</span>))</span><br><span class="line">                .likeRight(<span class="string">"name"</span>, <span class="string">"王"</span>);</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectList(wrapper);</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询年龄为30、31、32</span></span><br><span class="line"><span class="comment">     * WHERE age IN (?,?,?)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByWrapperEight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = Wrappers.query();</span><br><span class="line">        wrapper.in(<span class="string">"age"</span>, Arrays.asList(<span class="number">30</span>, <span class="number">31</span>, <span class="number">32</span>));</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectList(wrapper);</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询一条数据</span></span><br><span class="line"><span class="comment">     * limit 1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByWrapperNine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = Wrappers.query();</span><br><span class="line">        wrapper.in(<span class="string">"age"</span>, Arrays.asList(<span class="number">30</span>, <span class="number">31</span>, <span class="number">32</span>)).last(<span class="string">"limit 1"</span>);</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectList(wrapper);</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>常用条件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">【通用条件：】</span><br><span class="line">【比较大小： ( =, &lt;&gt;, &gt;, &gt;=, &lt;, &lt;= )】</span><br><span class="line">    eq(R column, Object val); <span class="comment">// 等价于 =，例: eq("name", "老王") ---&gt; name = '老王'</span></span><br><span class="line">    ne(R column, Object val); <span class="comment">// 等价于 &lt;&gt;，例: ne("name", "老王") ---&gt; name &lt;&gt; '老王'</span></span><br><span class="line">    gt(R column, Object val); <span class="comment">// 等价于 &gt;，例: gt("name", "老王") ---&gt; name &gt; '老王'</span></span><br><span class="line">    ge(R column, Object val); <span class="comment">// 等价于 &gt;=，例: ge("name", "老王") ---&gt; name &gt;= '老王'</span></span><br><span class="line">    lt(R column, Object val); <span class="comment">// 等价于 &lt;，例: lt("name", "老王") ---&gt; name &lt; '老王'</span></span><br><span class="line">    le(R column, Object val); <span class="comment">// 等价于 &lt;=，例: le("name", "老王") ---&gt; name &lt;= '老王'</span></span><br><span class="line">    </span><br><span class="line">【范围：（between、not between、in、not in）】</span><br><span class="line">   between(R column, Object val1, Object val2); <span class="comment">// 等价于 between a and b, 例： between("age", 18, 30) ---&gt; age between 18 and 30</span></span><br><span class="line">   notBetween(R column, Object val1, Object val2); <span class="comment">// 等价于 not between a and b, 例： notBetween("age", 18, 30) ---&gt; age not between 18 and 30</span></span><br><span class="line">   in(R column, Object... values); <span class="comment">// 等价于 字段 IN (v0, v1, ...),例: in("age",&#123;1,2,3&#125;) ---&gt; age in (1,2,3)</span></span><br><span class="line">   notIn(R column, Object... values); <span class="comment">// 等价于 字段 NOT IN (v0, v1, ...), 例: notIn("age",&#123;1,2,3&#125;) ---&gt; age not in (1,2,3)</span></span><br><span class="line">   inSql(R column, Object... values); <span class="comment">// 等价于 字段 IN (sql 语句), 例: inSql("id", "select id from table where id &lt; 3") ---&gt; id in (select id from table where id &lt; 3)</span></span><br><span class="line">   notInSql(R column, Object... values); <span class="comment">// 等价于 字段 NOT IN (sql 语句)</span></span><br><span class="line">   </span><br><span class="line">【模糊匹配：（like）】</span><br><span class="line">    like(R column, Object val); <span class="comment">// 等价于 LIKE '%值%'，例: like("name", "王") ---&gt; name like '%王%'</span></span><br><span class="line">    notLike(R column, Object val); <span class="comment">// 等价于 NOT LIKE '%值%'，例: notLike("name", "王") ---&gt; name not like '%王%'</span></span><br><span class="line">    likeLeft(R column, Object val); <span class="comment">// 等价于 LIKE '%值'，例: likeLeft("name", "王") ---&gt; name like '%王'</span></span><br><span class="line">    likeRight(R column, Object val); <span class="comment">// 等价于 LIKE '值%'，例: likeRight("name", "王") ---&gt; name like '王%'</span></span><br><span class="line">    </span><br><span class="line">【空值比较：（isNull、isNotNull）】</span><br><span class="line">    isNull(R column); <span class="comment">// 等价于 IS NULL，例: isNull("name") ---&gt; name is null</span></span><br><span class="line">    isNotNull(R column); <span class="comment">// 等价于 IS NOT NULL，例: isNotNull("name") ---&gt; name is not null</span></span><br><span class="line"></span><br><span class="line">【分组、排序：（group、having、order）】</span><br><span class="line">    groupBy(R... columns); <span class="comment">// 等价于 GROUP BY 字段, ...， 例: groupBy("id", "name") ---&gt; group by id,name</span></span><br><span class="line">    orderByAsc(R... columns); <span class="comment">// 等价于 ORDER BY 字段, ... ASC， 例: orderByAsc("id", "name") ---&gt; order by id ASC,name ASC</span></span><br><span class="line">    orderByDesc(R... columns); <span class="comment">// 等价于 ORDER BY 字段, ... DESC， 例: orderByDesc("id", "name") ---&gt; order by id DESC,name DESC</span></span><br><span class="line">    having(String sqlHaving, Object... params); <span class="comment">// 等价于 HAVING ( sql语句 )， 例: having("sum(age) &gt; &#123;0&#125;", 11) ---&gt; having sum(age) &gt; 11</span></span><br><span class="line"></span><br><span class="line">【拼接、嵌套 sql：（or、and、nested、apply）】</span><br><span class="line">   or(); <span class="comment">// 等价于 a or b， 例：eq("id",1).or().eq("name","老王") ---&gt; id = 1 or name = '老王'</span></span><br><span class="line">   or(Consumer&lt;Param&gt; consumer); <span class="comment">// 等价于 or(a or/and b)，or 嵌套。例: or(i -&gt; i.eq("name", "李白").ne("status", "活着")) ---&gt; or (name = '李白' and status &lt;&gt; '活着')</span></span><br><span class="line">   and(Consumer&lt;Param&gt; consumer); <span class="comment">// 等价于 and(a or/and b)，and 嵌套。例: and(i -&gt; i.eq("name", "李白").ne("status", "活着")) ---&gt; and (name = '李白' and status &lt;&gt; '活着')</span></span><br><span class="line">   nested(Consumer&lt;Param&gt; consumer); <span class="comment">// 等价于 (a or/and b)，普通嵌套。例: nested(i -&gt; i.eq("name", "李白").ne("status", "活着")) ---&gt; (name = '李白' and status &lt;&gt; '活着')</span></span><br><span class="line">   apply(String applySql, Object... params); <span class="comment">// 拼接sql（若不使用 params 参数，可能存在 sql 注入），例: apply("date_format(dateColumn,'%Y-%m-%d') = &#123;0&#125;", "2008-08-08") ---&gt; date_format(dateColumn,'%Y-%m-%d') = '2008-08-08'")</span></span><br><span class="line">   last(String lastSql); <span class="comment">// 无视优化规则直接拼接到 sql 的最后，可能存若在 sql 注入。</span></span><br><span class="line">   exists(String existsSql); <span class="comment">// 拼接 exists 语句。例: exists("select id from table where age = 1") ---&gt; exists (select id from table where age = 1)</span></span><br><span class="line">   </span><br><span class="line">【QueryWrapper 条件：】</span><br><span class="line">    select(String... sqlSelect); <span class="comment">// 用于定义需要返回的字段。例： select("id", "name", "age") ---&gt; select id, name, age</span></span><br><span class="line">    select(Predicate&lt;TableFieldInfo&gt; predicate); <span class="comment">// Lambda 表达式，过滤需要的字段。</span></span><br><span class="line">    lambda(); <span class="comment">// 返回一个 LambdaQueryWrapper</span></span><br><span class="line">    </span><br><span class="line">【UpdateWrapper 条件：】</span><br><span class="line">    set(String column, Object val); <span class="comment">// 用于设置 set 字段值。例: set("name", null) ---&gt; set name = null</span></span><br><span class="line">    etSql(String sql); <span class="comment">// 用于设置 set 字段值。例: setSql("name = '老李头'") ---&gt; set name = '老李头'</span></span><br><span class="line">    lambda(); <span class="comment">// 返回一个 LambdaUpdateWrapper</span></span><br></pre></td></tr></table></figure></li></ol><ol start="3"><li><p>wapper介绍 ：</p><ol><li>Wrapper ： 条件构造抽象类，最顶端父类，抽象类中提供4个方法西面贴源码展示</li><li>AbstractWrapper ： 用于查询条件封装，生成 sql 的 where 条件</li><li>AbstractLambdaWrapper ： Lambda 语法使用 Wrapper统一处理解析 lambda 获取 column。</li><li>LambdaQueryWrapper ：看名称也能明白就是用于Lambda语法使用的查询Wrapper</li><li>LambdaUpdateWrapper ： Lambda 更新封装Wrapper</li><li>QueryWrapper ： Entity 对象封装操作类，不是用lambda语法</li><li>UpdateWrapper ： Update 条件封装，用于Entity对象更新操作</li></ol></li></ol><h3 id="Service-CRUD"><a href="#Service-CRUD" class="headerlink" title="Service CRUD"></a>Service CRUD</h3><ol><li><p>通用 Service CRUD 封装IService接口，更进一步封装 CRUD 采用 <code>get 查询单行</code>、 <code>remove 删除</code>、 <code>list 查询集合</code>、 <code>page 分页</code> 前缀命名方式来避免混淆 <code>Mapper</code> 层</p></li><li><p>Service的好处是可以省略大量的代码编写，避免重复劳动</p></li><li><p>首先建立一个借口继承<code>IService</code>接口，注意该接口不能放在Mapper的扫描包内，否则会出错：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">User</span>&gt;</span>&#123;&#125;</span><br></pre></td></tr></table></figure></li><li><p>定义一个实现类，实现自定义的接口<code>UserService</code>之前要继承<code>IService</code>的实现类<code>ServiceImpl</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *IService:mp提供的接口。ServiceImpl:mp提供的接口实现类。</span></span><br><span class="line"><span class="comment"> *ServiceImpl&lt;BaseMapper&lt;T&gt;, T&gt;是IService 的实现类。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">UserMapper</span>,<span class="title">User</span>&gt; <span class="keyword">implements</span> <span class="title">UserService</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure></li><li><p>然后就是在需要的地方注入自定义UserService接口即可，比如测试类中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceCRUDTest</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserService userService;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 插入（批量）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> entityList 实体对象集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> batchSize  插入批次数量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveBatch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">Collection&lt;User&gt; entityList=<span class="keyword">new</span> ArrayList&lt;User&gt;();</span><br><span class="line">entityList.add(<span class="keyword">new</span> User().setName(<span class="string">"zsf"</span>).setAge(<span class="number">1</span>).setEmail(<span class="string">"zsf@hot.com"</span>));</span><br><span class="line">entityList.add(<span class="keyword">new</span> User().setName(<span class="string">"whh"</span>).setAge(<span class="number">21</span>).setEmail(<span class="string">"whh@tt.com"</span>));</span><br><span class="line">userService.saveBatch(entityList);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>各种操作方法可以看官方文档</p></li></ol><h3 id="自定义主键ID生成"><a href="#自定义主键ID生成" class="headerlink" title="自定义主键ID生成"></a>自定义主键ID生成</h3><ol><li><p>自3.3.0开始,默认使用雪花算法+UUID(不含中划线)</p></li><li><p>自定义主键生成主要是重写对应的<code>nextId</code>（对应ASSIGN_ID策略）、<code>nextUUID</code>（对应ASSIGN_UUID策略）方法</p></li><li><p>SpringBOOT注入代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomIdGenerator</span> <span class="keyword">implements</span> <span class="title">IdentifierGenerator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">nextId</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//可以将当前传入的class全类名来作为bizKey,或者提取参数来生成bizKey进行分布式Id调用生成.</span></span><br><span class="line">      String bizKey = entity.getClass().getName();</span><br><span class="line">        <span class="comment">//根据bizKey调用分布式ID生成</span></span><br><span class="line">        <span class="keyword">long</span> id = ....;</span><br><span class="line">      <span class="comment">//返回生成的id值即可.</span></span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="乐观锁插件OptimisticLockerInnerInterceptor"><a href="#乐观锁插件OptimisticLockerInnerInterceptor" class="headerlink" title="乐观锁插件OptimisticLockerInnerInterceptor"></a>乐观锁插件OptimisticLockerInnerInterceptor</h3><ol><li><p>当要更新一条记录的时候，希望这条记录没有被别人更新，如果记录被更新了，则不会更新记录</p></li><li><p>实现方式：</p><ol><li>取出记录时，获取当前version</li><li>更新时，带上这个version</li><li>执行更新时， set version = newVersion where version = oldVersion</li><li>如果version不对，就更新失败</li></ol></li><li><p>注解@Version：</p><ol><li><strong>支持的数据类型只有:int,Integer,long,Long,Date,Timestamp,LocalDateTime</strong></li><li>整数类型下 <code>newVersion = oldVersion + 1</code></li><li>仅支持 <code>updateById(id)</code> 与 <code>update(entity, wrapper)</code> 方法，在 <code>update(entity, wrapper)</code> 方法下,<code>wrapper</code> 不能复用!!!</li><li><strong>对于自定义的方法或者其他的方法，乐观锁会失效</strong></li></ol></li><li><p>乐观锁插件的使用：</p><ol><li><p>修改数据表，数据库增加字段version 设为为int类型，给它一个默认值1</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- schema.sql</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> tb_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_user</span><br><span class="line">(</span><br><span class="line">id_real <span class="built_in">varchar</span> (<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'主键ID'</span>,</span><br><span class="line">name_real <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'姓名'</span>,</span><br><span class="line">age_real <span class="built_in">INT</span>(<span class="number">11</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'年龄'</span>,</span><br><span class="line">email_real <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'邮箱'</span>,</span><br><span class="line"><span class="keyword">version</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">null</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (id_real)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- data.sql</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> tb_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb_user (id_real, name_real, age_real, email_real,<span class="keyword">version</span>) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">'Jone'</span>, <span class="number">18</span>, <span class="string">'test1@baomidou.com'</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">'Jack'</span>, <span class="number">20</span>, <span class="string">'test2@baomidou.com'</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">'Tom'</span>, <span class="number">28</span>, <span class="string">'test3@baomidou.com'</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">'Sandy'</span>, <span class="number">21</span>, <span class="string">'test4@baomidou.com'</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">'Billie'</span>, <span class="number">24</span>, <span class="string">'test5@baomidou.com'</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure></li><li><p>User实体增加相应属性并用@Version注解标识,UserMapper可以同之前的一致:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(value=<span class="string">"tb_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@TableId</span>(value=<span class="string">"id_real"</span>,type= IdType.ASSIGN_UUID)</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"name_real"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"age_real"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"email_real"</span>)</span><br><span class="line">    <span class="keyword">private</span>  String email;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"version"</span>)</span><br><span class="line">    <span class="meta">@Version</span></span><br><span class="line">    <span class="keyword">private</span> Integer version;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>添加乐观锁插件配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新的分页插件,一缓和二缓遵循mybatis的规则,需要设置 MybatisConfiguration#useDeprecatedExecutor = false 避免缓存出现问题(该属性会在旧插件移除后一同移除)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MybatisPlusInterceptor <span class="title">mybatisPlusInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MybatisPlusInterceptor interceptor = <span class="keyword">new</span> MybatisPlusInterceptor();</span><br><span class="line">        <span class="comment">// 分页插件</span></span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> PaginationInnerInterceptor(DbType.MYSQL));</span><br><span class="line">        <span class="comment">// 乐观锁插件</span></span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> OptimisticLockerInnerInterceptor());</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>然后就可以测试了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OptimisticLockerTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOptimistic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user1 = userMapper.selectById(<span class="number">5</span>);</span><br><span class="line">        user1.setName(<span class="string">"test01"</span>);</span><br><span class="line"></span><br><span class="line">        User user2 = userMapper.selectById(<span class="number">5</span>);</span><br><span class="line">        user2.setName(<span class="string">"test02"</span>);</span><br><span class="line">      </span><br><span class="line">        userMapper.updateById(user2);</span><br><span class="line">        userMapper.updateById(user1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">1.先进行了两次查询 假设获取到的version都为1</span></span><br><span class="line"><span class="comment">2.但是先执行的更新user2对象 此时更新后version变为2</span></span><br><span class="line"><span class="comment">3.当执行更新user1时 where条件where version = oldVersion 没有匹配到  因为这时数据库中的version已经为2 那么就更新失败了</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li></ol></li></ol><h3 id="通用枚举"><a href="#通用枚举" class="headerlink" title="通用枚举"></a>通用枚举</h3><ol><li><p>解决了繁琐的配置，让 mybatis 优雅的使用枚举属性</p></li><li><p>使用方式：</p><ol><li><p>使用 @EnumValue 注解枚举属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> GradeEnum &#123;</span><br><span class="line">    PRIMARY(<span class="number">1</span>, <span class="string">"小学"</span>),  SECONDORY(<span class="number">2</span>, <span class="string">"中学"</span>),  HIGH(<span class="number">3</span>, <span class="string">"高中"</span>);</span><br><span class="line">    GradeEnum(<span class="keyword">int</span> code, String descp) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.descp = descp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@EnumValue</span><span class="comment">//标记数据库存的值是code</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="comment">//。。。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>枚举属性，实现 IEnum 接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> AgeEnum implements IEnum&lt;Integer&gt; &#123;</span><br><span class="line">    ONE(<span class="number">1</span>, <span class="string">"一岁"</span>),</span><br><span class="line">    TWO(<span class="number">2</span>, <span class="string">"二岁"</span>),</span><br><span class="line">    THREE(<span class="number">3</span>, <span class="string">"三岁"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>需要在配置文件中添加配置<code>mybatis-plus.type-enums-package</code>来扫描枚举类</p></li><li><p>示例：</p><ol><li><p>在原来的表基础上添加sex字段：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> tb_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_user</span><br><span class="line">(</span><br><span class="line">id_real <span class="built_in">varchar</span> (<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'主键ID'</span>,</span><br><span class="line">name_real <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'姓名'</span>,</span><br><span class="line">age_real <span class="built_in">INT</span>(<span class="number">11</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'年龄'</span>,</span><br><span class="line">email_real <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'邮箱'</span>,</span><br><span class="line"><span class="keyword">version</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">null</span>,</span><br><span class="line">sex <span class="built_in">int</span>(<span class="number">2</span>) <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">null</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (id_real)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- data.sql</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> tb_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb_user (id_real, name_real, age_real, email_real,<span class="keyword">version</span>,sex) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">'Jone'</span>, <span class="number">18</span>, <span class="string">'test1@baomidou.com'</span>,<span class="number">1</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">'Jack'</span>, <span class="number">20</span>, <span class="string">'test2@baomidou.com'</span>,<span class="number">1</span>,<span class="number">2</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">'Tom'</span>, <span class="number">28</span>, <span class="string">'test3@baomidou.com'</span>,<span class="number">1</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">'Sandy'</span>, <span class="number">21</span>, <span class="string">'test4@baomidou.com'</span>,<span class="number">1</span>,<span class="number">2</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">'Billie'</span>, <span class="number">24</span>, <span class="string">'test5@baomidou.com'</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure></li><li><p>添加枚举类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> SexEnum &#123;</span><br><span class="line"></span><br><span class="line">    MAN(<span class="number">1</span>,<span class="string">"男"</span>),</span><br><span class="line">    WOMAN(<span class="number">2</span>,<span class="string">"女"</span>);</span><br><span class="line"><span class="comment">// 注解方式</span></span><br><span class="line">    <span class="meta">@EnumValue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">    SexEnum(Integer code, String value)&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>修改User实体类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(value=<span class="string">"tb_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@TableId</span>(value=<span class="string">"id_real"</span>,type= IdType.ASSIGN_UUID)</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"name_real"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"age_real"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"email_real"</span>)</span><br><span class="line">    <span class="keyword">private</span>  String email;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"version"</span>)</span><br><span class="line">    <span class="meta">@Version</span></span><br><span class="line">    <span class="keyword">private</span> Integer version;</span><br><span class="line"><span class="comment">// 增加的枚举类</span></span><br><span class="line">    <span class="keyword">private</span> SexEnum sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>添加配置（application.yml）:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mybatis?characterEncoding=utf8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">schema:</span> <span class="string">classpath:sql/schema.sql</span></span><br><span class="line">    <span class="attr">data:</span> <span class="string">classpath:sql/data.sql</span></span><br><span class="line">    <span class="attr">initialization-mode:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment"># sql输出到控制台  方便查看</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line">  <span class="attr">type-enums-package:</span> <span class="string">com.midea.mpoptimistic</span></span><br></pre></td></tr></table></figure></li><li><p>测试枚举：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OptimisticLockerTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOptimistic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user1 = userMapper.selectById(<span class="number">5</span>);</span><br><span class="line">        user1.setName(<span class="string">"test01"</span>);</span><br><span class="line"></span><br><span class="line">        User user2 = userMapper.selectById(<span class="number">5</span>);</span><br><span class="line">        user2.setName(<span class="string">"test02"</span>);</span><br><span class="line">        System.out.println(user1);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//   userMapper.updateById(user2);</span></span><br><span class="line">        user1.setSex(SexEnum.WOMAN);</span><br><span class="line">        userMapper.updateById(user1);</span><br><span class="line">        user1 = userMapper.selectById(<span class="number">5</span>);</span><br><span class="line">        System.out.println(user1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li></ol><h3 id="自动填充"><a href="#自动填充" class="headerlink" title="自动填充"></a>自动填充</h3><ol><li><p>像创建时间、更新时间、创建人、更新人这些都可以自动填充，而无需自己设置</p></li><li><p>原理：</p><ol><li><p>实现元对象处理器接口：com.baomidou.mybatisplus.core.handlers.MetaObjectHandler</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMetaObjectHandler</span> <span class="keyword">implements</span> <span class="title">MetaObjectHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"start insert fill ...."</span>);</span><br><span class="line">        <span class="keyword">this</span>.strictInsertFill(metaObject, <span class="string">"createTime"</span>, LocalDateTime<span class="class">.<span class="keyword">class</span>, <span class="title">LocalDateTime</span>.<span class="title">now</span>())</span>; <span class="comment">// 起始版本 3.3.0(推荐使用)</span></span><br><span class="line">        <span class="comment">// 或者</span></span><br><span class="line">        <span class="keyword">this</span>.strictUpdateFill(metaObject, <span class="string">"createTime"</span>, () -&gt; LocalDateTime.now(), LocalDateTime<span class="class">.<span class="keyword">class</span>)</span>; <span class="comment">// 起始版本 3.3.3(推荐)</span></span><br><span class="line">        <span class="comment">// 或者</span></span><br><span class="line">        <span class="keyword">this</span>.fillStrategy(metaObject, <span class="string">"createTime"</span>, LocalDateTime.now()); <span class="comment">// 也可以使用(3.3.0 该方法有bug)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"start update fill ...."</span>);</span><br><span class="line">        <span class="keyword">this</span>.strictUpdateFill(metaObject, <span class="string">"updateTime"</span>, LocalDateTime<span class="class">.<span class="keyword">class</span>, <span class="title">LocalDateTime</span>.<span class="title">now</span>())</span>; <span class="comment">// 起始版本 3.3.0(推荐)</span></span><br><span class="line">        <span class="comment">// 或者</span></span><br><span class="line">        <span class="keyword">this</span>.strictUpdateFill(metaObject, <span class="string">"updateTime"</span>, () -&gt; LocalDateTime.now(), LocalDateTime<span class="class">.<span class="keyword">class</span>)</span>; <span class="comment">// 起始版本 3.3.3(推荐)</span></span><br><span class="line">        <span class="comment">// 或者</span></span><br><span class="line">        <span class="keyword">this</span>.fillStrategy(metaObject, <span class="string">"updateTime"</span>, LocalDateTime.now()); <span class="comment">// 也可以使用(3.3.0 该方法有bug)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>注解填充字段 <code>@TableField(.. fill = FieldFill.INSERT)</code> 生成器策略部分也可以配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意！这里需要标记为填充字段</span></span><br><span class="line">    <span class="meta">@TableField</span>(.. fill = FieldFill.INSERT)</span><br><span class="line">    <span class="keyword">private</span> String fillField;</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>FieldFill有四种策略：</p><ol><li><code>DEFAULT</code>：默认不处理</li><li><code>INSERT</code>：插入时填充</li><li><code>UPDATE</code>：更新时填充</li><li><code>INSERT_UPDATE</code>：插入或者更新时填充</li></ol></li><li><p>示例：</p><ol><li><p>在原来的表基础上添加update_time、insert_time、author字段：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> tb_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_user</span><br><span class="line">(</span><br><span class="line">id_real <span class="built_in">varchar</span> (<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'主键ID'</span>,</span><br><span class="line">name_real <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'姓名'</span>,</span><br><span class="line">age_real <span class="built_in">INT</span>(<span class="number">11</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'年龄'</span>,</span><br><span class="line">email_real <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'邮箱'</span>,</span><br><span class="line"><span class="keyword">version</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">null</span>,</span><br><span class="line">sex <span class="built_in">int</span>(<span class="number">2</span>) <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">null</span>,</span><br><span class="line">update_time DATETIME <span class="literal">null</span> <span class="keyword">default</span>  <span class="literal">null</span>,</span><br><span class="line">insert_time DATETIME <span class="literal">null</span> <span class="keyword">default</span>  <span class="literal">null</span>,</span><br><span class="line">author <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="literal">null</span> <span class="keyword">default</span>  <span class="literal">null</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (id_real)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li><li><p>修改User实体类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(value=<span class="string">"tb_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@TableId</span>(value=<span class="string">"id_real"</span>,type= IdType.ASSIGN_UUID)</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"name_real"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"age_real"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"email_real"</span>)</span><br><span class="line">    <span class="keyword">private</span>  String email;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"version"</span>)</span><br><span class="line">    <span class="meta">@Version</span></span><br><span class="line">    <span class="keyword">private</span> Integer version;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SexEnum sex;</span><br><span class="line">    <span class="meta">@TableField</span>(fill = FieldFill.UPDATE)</span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">    <span class="meta">@TableField</span>(fill=FieldFill.INSERT)</span><br><span class="line">    <span class="keyword">private</span> Date insertTime;</span><br><span class="line">    <span class="meta">@TableField</span>(fill=FieldFill.INSERT_UPDATE)</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>添加填充配置：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMetaObjectHandler</span> <span class="keyword">implements</span> <span class="title">MetaObjectHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"start insert fill ...."</span>);</span><br><span class="line">        <span class="keyword">this</span>.fillStrategy(metaObject, <span class="string">"insertTime"</span>, <span class="keyword">new</span> Date());</span><br><span class="line">        <span class="keyword">this</span>.strictInsertFill(metaObject, <span class="string">"updateTime"</span>, LocalDateTime<span class="class">.<span class="keyword">class</span>, <span class="title">LocalDateTime</span>.<span class="title">now</span>())</span>; <span class="comment">// 起始版本 3.3.0(推荐使用)</span></span><br><span class="line">        <span class="keyword">this</span>.setFieldValByName(<span class="string">"author"</span>,<span class="string">"admin"</span>,metaObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"start update fill ...."</span>);</span><br><span class="line">        <span class="keyword">this</span>.fillStrategy(metaObject, <span class="string">"updateTime"</span>,<span class="keyword">new</span> Date());</span><br><span class="line">        <span class="keyword">this</span>.setFieldValByName(<span class="string">"author"</span>,<span class="string">"admin"</span>,metaObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>然后测试即可</p></li></ol></li></ol><h3 id="逻辑删除"><a href="#逻辑删除" class="headerlink" title="逻辑删除"></a>逻辑删除</h3><ol><li><p>并非真的删除了，而是在数据库的表中有一个字段来区分是否不可见</p></li><li><p>添加方式：</p><ol><li>通过配置：</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">logic-delete-field:</span> <span class="string">deleted</span>  <span class="comment"># 全局逻辑删除的实体字段名</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span> <span class="comment"># 逻辑已删除值(默认为 1)</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span> <span class="comment"># 逻辑未删除值(默认为 0)</span></span><br></pre></td></tr></table></figure><ol start="2"><li>可单独配置某个实体类的软删除字段，在字段上加上<code>@TableLogic</code>注解即可</li></ol></li></ol><p>3.测试：</p><ol><li><p>在sql原来的基础上添加删除字段：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> tb_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_user</span><br><span class="line">(</span><br><span class="line">id_real <span class="built_in">varchar</span> (<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'主键ID'</span>,</span><br><span class="line">name_real <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'姓名'</span>,</span><br><span class="line">age_real <span class="built_in">INT</span>(<span class="number">11</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'年龄'</span>,</span><br><span class="line">email_real <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'邮箱'</span>,</span><br><span class="line"><span class="keyword">version</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">null</span>,</span><br><span class="line">sex <span class="built_in">int</span>(<span class="number">2</span>) <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">null</span>,</span><br><span class="line">update_time DATETIME <span class="literal">null</span> <span class="keyword">default</span>  <span class="literal">null</span>,</span><br><span class="line">insert_time DATETIME <span class="literal">null</span> <span class="keyword">default</span>  <span class="literal">null</span>,</span><br><span class="line">author <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="literal">null</span> <span class="keyword">default</span>  <span class="literal">null</span>,</span><br><span class="line">deleted <span class="built_in">boolean</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span>  <span class="literal">false</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (id_real)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li><li><p>修改User实体类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(value=<span class="string">"tb_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@TableId</span>(value=<span class="string">"id_real"</span>,type= IdType.ASSIGN_UUID)</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"name_real"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"age_real"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"email_real"</span>)</span><br><span class="line">    <span class="keyword">private</span>  String email;</span><br><span class="line">    <span class="meta">@TableField</span>(<span class="string">"version"</span>)</span><br><span class="line">    <span class="meta">@Version</span></span><br><span class="line">    <span class="keyword">private</span> Integer version;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SexEnum sex;</span><br><span class="line">    <span class="meta">@TableField</span>(fill = FieldFill.UPDATE)</span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">    <span class="meta">@TableField</span>(fill=FieldFill.INSERT)</span><br><span class="line">    <span class="keyword">private</span> Date insertTime;</span><br><span class="line">    <span class="meta">@TableField</span>(fill=FieldFill.INSERT_UPDATE)</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableLogic</span></span><br><span class="line">    <span class="keyword">private</span> Boolean deleted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>然后就可以测试了</p></li></ol><h3 id="配置文件安全"><a href="#配置文件安全" class="headerlink" title="配置文件安全"></a>配置文件安全</h3><ol><li><p>为了保护数据库配置及数据安全，在一定的程度上控制开发人员流动导致敏感信息泄露</p></li><li><p>配置文件（YML）中加密配置使用<code>mpw:加密内容</code>，不是只有数据库配置才能加密，其他内容也是可以加密的</p></li><li><p>配置了加密内容之后，没法进行测试，可以在正式环境使用该方式</p></li><li><p>配置文件示例：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">加密配置</span> <span class="attr">mpw:</span> <span class="string">开头紧接加密内容（</span> <span class="string">非数据库配置专用</span> <span class="string">YML</span> <span class="string">中其它配置也是可以使用的</span> <span class="string">）</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">mpw:qRhvCwF4GOqjessEB3G+a5okP+uXXr96wcucn2Pev6Bf1oEMZ1gVpPPhdDmjQqoM</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">mpw:Hzy5iliJbwDHhjLs1L0j6w==</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">mpw:Xb+EgsyuYRXw7U7sBJjBpA==</span></span><br></pre></td></tr></table></figure></li><li><p>启动项目时可以在项目的idea 设置 Program arguments，服务器可以设置为启动环境变量：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--mpw.key=d1104d7c3b616f0b</span><br><span class="line">//比如 java -jar test.jar --mpw.key=d1104d7c3b616f0b</span><br></pre></td></tr></table></figure></li><li><p>AES加密类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.codec.binary.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.IvParameterSpec;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AES</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 密钥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String key = <span class="string">"littleswan123456"</span>; <span class="comment">//长度为16</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String charset = <span class="string">"utf-8"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String transformation = <span class="string">"AES/CBC/PKCS5Padding"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String algorithm = <span class="string">"AES"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encrypt</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> encrypt(content, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decrypt</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> decrypt(content, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 需要加密的内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key     加密密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encrypt</span><span class="params">(String content, String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SecretKeySpec skey = <span class="keyword">new</span> SecretKeySpec(key.getBytes(), algorithm);</span><br><span class="line">            IvParameterSpec iv = <span class="keyword">new</span> IvParameterSpec(key.getBytes());</span><br><span class="line">            Cipher cipher = Cipher.getInstance(transformation);</span><br><span class="line">            <span class="keyword">byte</span>[] byteContent = content.getBytes(charset);</span><br><span class="line">            cipher.init(Cipher.ENCRYPT_MODE, skey, iv);<span class="comment">// 初始化</span></span><br><span class="line">            <span class="keyword">byte</span>[] result = cipher.doFinal(byteContent);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Base64().encodeToString(result); <span class="comment">// 加密</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// LogUtil.exception(e);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AES（256）解密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 待解密内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key     解密密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解密之后</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decrypt</span><span class="params">(String content, String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            SecretKeySpec skey = <span class="keyword">new</span> SecretKeySpec(key.getBytes(), algorithm);</span><br><span class="line">            IvParameterSpec iv = <span class="keyword">new</span> IvParameterSpec(key.getBytes());</span><br><span class="line">            Cipher cipher = Cipher.getInstance(transformation);</span><br><span class="line">            cipher.init(Cipher.DECRYPT_MODE, skey, iv);<span class="comment">// 初始化</span></span><br><span class="line">            <span class="keyword">byte</span>[] result = cipher.doFinal(<span class="keyword">new</span> Base64().decode(content));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(result); <span class="comment">// 解密</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//LogUtil.exception(e);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String s = <span class="string">"hello world"</span>;</span><br><span class="line">        <span class="comment">// 加密</span></span><br><span class="line">        System.out.println(<span class="string">"加密前："</span> + s);</span><br><span class="line">        String encryptResultStr = encrypt(s);</span><br><span class="line">        System.out.println(<span class="string">"加密后："</span> + encryptResultStr);</span><br><span class="line">        <span class="comment">// 解密</span></span><br><span class="line">        System.out.println(<span class="string">"解密后："</span> + decrypt(encryptResultStr));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>注意：加密的key字符串长度一定要是16否则会出问题！</strong></p></li></ol><h3 id="动态表名"><a href="#动态表名" class="headerlink" title="动态表名"></a>动态表名</h3><ol><li><p>在之前的项目开发中使用Mybatis的<code>${}</code>来实现动态表名，非常的不友好：</p><ol><li>在动态sql解析过程，<code>#{}</code>与<code>${}</code>的效果是不一样的， <code>#{ }</code>解析为一个 JDBC 预编译语句（prepared statement）的参数标记符, <code>${ }</code> 仅仅为一个纯碎的 String 替换，在动态 SQL 解析阶段将会进行变量替换</li><li><code>${ }</code>的变量的替换阶段是在动态 SQL 解析阶段，而 <code>#{ }</code>的变量的替换是在 DBMS 中</li><li><code>#{}</code>能够很大程度上防止sql注入，<code>${}</code>无法防止sql注入</li><li><code>${}</code>一般用于传输数据库的表名、字段名等</li></ol></li><li><p>在UserMapper上编写一个创建新表的接口方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.metadata.IPage;</span><br><span class="line"><span class="keyword">import</span> com.example.po.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Select("SELECT id_real as id,name_real as name,age_real as age,email_real as email FROM tb_user WHERE email_real LIKE #&#123;state&#125;")</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Results</span>(id = <span class="string">"resultMap"</span> , value = &#123;</span><br><span class="line">            <span class="meta">@Result</span>(property = <span class="string">"id"</span>,column = <span class="string">"id_real"</span>),</span><br><span class="line">            <span class="meta">@Result</span>(property = <span class="string">"name"</span>,column = <span class="string">"name_real"</span>),</span><br><span class="line">            <span class="meta">@Result</span>(property = <span class="string">"age"</span>,column = <span class="string">"age_real"</span>),</span><br><span class="line">            <span class="meta">@Result</span>(property = <span class="string">"email"</span>,column = <span class="string">"email_real"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT * FROM tb_user WHERE email_real LIKE #&#123;state&#125;"</span>)</span><br><span class="line">    <span class="function">IPage&lt;User&gt; <span class="title">selectPageUserDefined</span><span class="params">(IPage&lt;?&gt; page, String state)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResultMap</span>(<span class="string">"resultMap"</span>)</span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT * FROM tb_user WHERE name_real like #&#123;name&#125;"</span>)</span><br><span class="line">    <span class="function">IPage&lt;User&gt; <span class="title">selectPageUserDefined2</span><span class="params">(IPage&lt;?&gt; page, String name)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据名称创建一个新的表</span></span><br><span class="line">    <span class="meta">@Update</span>(<span class="string">"CREATE TABLE $&#123;tableName&#125;\n"</span> +</span><br><span class="line">            <span class="string">"(\n"</span> +</span><br><span class="line">            <span class="string">"\tid_real varchar (50) NOT NULL COMMENT '主键ID',\n"</span> +</span><br><span class="line">            <span class="string">"\tname_real VARCHAR(30) NULL DEFAULT NULL COMMENT '姓名',\n"</span> +</span><br><span class="line">            <span class="string">"\tage_real INT(11) NULL DEFAULT NULL COMMENT '年龄',\n"</span> +</span><br><span class="line">            <span class="string">"\temail_real VARCHAR(50) NULL DEFAULT NULL COMMENT '邮箱',\n"</span> +</span><br><span class="line">            <span class="string">"\tPRIMARY KEY (id_real)\n"</span> +</span><br><span class="line">            <span class="string">");"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createTable</span><span class="params">(@Param(<span class="string">"tableName"</span>)</span> String tableName)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>修改MP的配置类，引入动态表名插件以及规则：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; TABLE_NAME = <span class="keyword">new</span> ThreadLocal&lt;String&gt;();<span class="comment">// 线程内部存储类</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新的分页插件,一缓和二缓遵循mybatis的规则,需要设置 MybatisConfiguration#useDeprecatedExecutor = false 避免缓存出现问题(该属性会在旧插件移除后一同移除)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MybatisPlusInterceptor <span class="title">mybatisPlusInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MybatisPlusInterceptor interceptor = <span class="keyword">new</span> MybatisPlusInterceptor();</span><br><span class="line">        PaginationInnerInterceptor paginationInnerInterceptor=<span class="keyword">new</span> PaginationInnerInterceptor(DbType.MYSQL);</span><br><span class="line"></span><br><span class="line">        paginationInnerInterceptor.setOverflow(<span class="keyword">true</span>);</span><br><span class="line">        interceptor.addInnerInterceptor(paginationInnerInterceptor);</span><br><span class="line"></span><br><span class="line">        DynamicTableNameInnerInterceptor dynamicTableNameInnerInterceptor=<span class="keyword">new</span> DynamicTableNameInnerInterceptor();</span><br><span class="line">        Map&lt;String, TableNameHandler&gt; tableNameHandlerMap = <span class="keyword">new</span> HashMap&lt;String, TableNameHandler&gt;();</span><br><span class="line">        tableNameHandlerMap.put(<span class="string">"tb_user"</span>, <span class="keyword">new</span> TableNameHandler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">dynamicTableName</span><span class="params">(String sql, String tableName)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> TABLE_NAME.get();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);<span class="comment">// tb_user和User类上的@TableName(value="tb_user")保持一致</span></span><br><span class="line">        dynamicTableNameInnerInterceptor.setTableNameHandlerMap(tableNameHandlerMap);</span><br><span class="line">        interceptor.addInnerInterceptor(dynamicTableNameInnerInterceptor);</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>编写测试类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MPTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span>  UserMapper userMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testCreateTableAndInsert</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="comment">// userMapper.createTable("user_01"); // 创建表user_01</span></span><br><span class="line">        MybatisPlusConfig.TABLE_NAME.set(<span class="string">"user_01"</span>); <span class="comment">// 配置输出到user_01</span></span><br><span class="line">        User user=<span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="string">"46"</span>);</span><br><span class="line">        user.setName(<span class="string">"lll1"</span>);</span><br><span class="line">        user.setEmail(<span class="string">"hello@qq.com"</span>);</span><br><span class="line">        userMapper.updateById(user);</span><br><span class="line">        MybatisPlusConfig.TABLE_NAME.set(<span class="string">"tb_user"</span>);<span class="comment">// 配置输出到tb_user</span></span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ul><li><strong>在PO中最好不要使用基础类型，要使用的话也是其对应的封装类型！</strong></li><li><code>MateCloud</code>代码地址：<a href="https://github.com/matevip/matecloud" target="_blank" rel="noopener">https://github.com/matevip/matecloud</a></li></ul><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>MP的引入使Mybatis的开发变得简单，而且简化了代码的编写，避免了重复劳动问题。当然这部分只涉及了MP的功能的一部分，在后续需要新功能的时候可以考虑再继续深入学习！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;真的是好久没有写学习日志了，一方面和最近这一个月的状态有关，另一方面也可能上上班太累了吧，每天都有很多杂七杂八的活，然后又重构项目，在这种状
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="https://wanderros.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringCloud Consul Quick Start</title>
    <link href="https://wanderros.github.io/2020/08/28/SpringCloud-Consul-Quick-Start/"/>
    <id>https://wanderros.github.io/2020/08/28/SpringCloud-Consul-Quick-Start/</id>
    <published>2020-08-28T01:31:22.000Z</published>
    <updated>2020-10-01T08:52:15.919Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>在微服务架构体系中，服务发现是非常重要的组件。Euerka、Consul、zookeeper、etcd、Nacos等都是注册中心，本主要记录Consul作为注册中心，如何进行服务注册以及进行配置中心配置。</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li><p>服务网格（Service Mesh）是用于控制和监控微服务应用程序中的内部服务到服务流量的软件基础结构层。在此模型中，服务网格对于开发人员 (服务所有者) 是透明的， 而运维人员 (平台工程师) 则被授予一套新的工具，以确保可靠性、安全性和可见性；</p></li><li><p>服务网格的由来：对许多公司来说，Docker 和 Kubernetes 这样的工具已经 “解决了部署问题”（Docker 和 Kubernetes 所提供了强大的抽象，并且将服务打包和部署模式过程标准化了），但是还没有解决运行时问题，服务网格为了解决该问题而产生；</p></li><li><p>服务网格的核心：提供统一的全局方法来控制和测量应用或服务之间的所有请求流量（东西流量，East-West Traffic）。在微服务架构中，东西流量在系统运行中发挥着至关重要的作用，该流量是决定应用程序在运行时行为的关键因素。因此标准化此流量的管理将成为标准化应用程序运行时操作的切入口；</p><ul><li>客户端和服务器之间的流量被称为南北流量（South-North Traffic）</li><li>不同服务器之间的流量与数据中心或不同数据中心之间的网络流被称为东西流量（East-West Traffic）</li><li>东西流量和南北流量的命名源于典型Network Diagrams的习惯，在图表中，通常核心网络组件绘制在顶部（North），客户端绘制在底部（South），而数据中心内的不同服务器水平（East-West）绘制</li></ul></li><li><p>Consul是一个服务网格解决方案，提供了一个功能齐全的控制平面，主要特点是：服务发现、健康检查、键值存储、安全服务通信、多数据中心；</p></li><li><p>Consul工作原理如下：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/b37089065f72f6cfc8cddf0bdf8aa006-45510" alt="Consul工作原理"></p></li><li><p>Consul的使用场景包括服务发现、服务隔离、服务配置：</p><ul><li>服务发现场景中consul作为注册中心，服务地址被注册到consul中以后，可以使用consul提供的dns、http接口查询，consul支持health check</li><li>服务隔离场景中consul支持以服务为单位设置访问策略，能同时支持经典的平台和新兴的平台，支持tls证书分发，service-to-service加密</li><li>服务配置场景中consul提供key-value数据存储功能，并且能将变动迅速地通知出去，借助consul可以实现配置共享，需要读取配置的服务可以从consul中读取到准确的配置信息</li><li>consul可以帮助系统管理者更清晰的了解复杂系统内部的系统架构，运维人员可以将consul看成一种监控软件，也可以看成一种资产（资源）管理系统</li></ul></li><li><p>Consul 和其他注册中心的对比：</p><table><thead><tr><th align="left">Feature</th><th align="left">euerka</th><th align="left">Consul</th><th align="left">zookeeper</th><th align="left">etcd</th></tr></thead><tbody><tr><td align="left">服务健康检查</td><td align="left">可配支持</td><td align="left">服务状态，内存，硬盘等</td><td align="left">(弱)长连接，keepalive</td><td align="left">连接心跳</td></tr><tr><td align="left">多数据中心</td><td align="left">—</td><td align="left">支持</td><td align="left">—</td><td align="left">—</td></tr><tr><td align="left">kv 存储服务</td><td align="left">—</td><td align="left">支持</td><td align="left">支持</td><td align="left">支持</td></tr><tr><td align="left">一致性</td><td align="left">—</td><td align="left">raft</td><td align="left">paxos</td><td align="left">raft</td></tr><tr><td align="left">cap</td><td align="left">ap</td><td align="left">ca</td><td align="left">cp</td><td align="left">cp</td></tr><tr><td align="left">使用接口(多语言能力)</td><td align="left">http（sidecar）</td><td align="left">支持 http 和 dns</td><td align="left">客户端</td><td align="left">http/grpc</td></tr><tr><td align="left">watch 支持</td><td align="left">支持 long polling/大部分增量</td><td align="left">全量/支持long polling</td><td align="left">支持</td><td align="left">支持 long polling</td></tr><tr><td align="left">自身监控</td><td align="left">metrics</td><td align="left">metrics</td><td align="left">—</td><td align="left">metrics</td></tr><tr><td align="left">安全</td><td align="left">—</td><td align="left">acl /https</td><td align="left">acl</td><td align="left">https 支持（弱）</td></tr><tr><td align="left">spring cloud 集成</td><td align="left">已支持</td><td align="left">已支持</td><td align="left">已支持</td><td align="left">已支持</td></tr></tbody></table></li><li><p>Consul的优势：</p><ul><li>使用 Raft 算法来保证一致性, 比复杂的 Paxos 算法更直接</li><li>支持多数据中心，内外网的服务采用不同的端口进行监听</li><li>支持健康检查</li><li>支持 http 和 dns 协议接口</li><li>官方提供 web 管理界面</li></ul></li><li><p>SpringCloud官网说明文档：<a href="https://cloud.spring.io/spring-cloud-consul/reference/html/" target="_blank" rel="noopener">https://cloud.spring.io/spring-cloud-consul/reference/html/</a></p></li><li><p>Eureka闭源了：<a href="https://github.com/Netflix/eureka/wiki" target="_blank" rel="noopener">https://github.com/Netflix/eureka/wiki</a></p></li></ol><h1 id="动手实操"><a href="#动手实操" class="headerlink" title="动手实操"></a>动手实操</h1><h2 id="注册服务"><a href="#注册服务" class="headerlink" title="注册服务"></a>注册服务</h2><ol><li><p>下载consul的Docker镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull consul</span><br></pre></td></tr></table></figure></li><li><p>创建consul镜像实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name consul -d -p 8500:8500 consul</span><br></pre></td></tr></table></figure></li><li><p>创建一个consul服务端应用程序，包含consul注册依赖（pom.xml）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>添加配置（application.yml）:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8501</span></span><br></pre></td></tr></table></figure></li><li><p>启动类添加注解@EnableDiscoveryClient：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsulServiceApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConsulServiceApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建控制器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"helle consul"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/hello2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"helle consul2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动服务即可在<a href="http://localhost:8500/ui观察注册情况了，可以修改配置再启动一个服务，效果如下：" target="_blank" rel="noopener">http://localhost:8500/ui观察注册情况了，可以修改配置再启动一个服务，效果如下：</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/467b4ded29d20ea4a7bfd30cbac9c5a3-68256" alt="consul中注册服务"></p><ul><li></li></ul></li></ol><h2 id="服务消费者"><a href="#服务消费者" class="headerlink" title="服务消费者"></a>服务消费者</h2><ol><li><p>创建一个Consul服务消费者，依赖和服务一致；</p></li><li><p>配置文件如下（application.properties）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">spring.application.name=customer</span></span><br><span class="line"><span class="string">server.port=8504</span></span><br><span class="line"><span class="string">spring.cloud.consul.host=127.0.0.1</span></span><br><span class="line"><span class="string">spring.cloud.consul.port=8500</span></span><br><span class="line"><span class="comment">#设置不需要注册到 consul 中</span></span><br><span class="line"><span class="string">spring.cloud.consul.discovery.register=true</span></span><br></pre></td></tr></table></figure></li><li><p>启动类添加注解@EnableDiscoveryClient：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsulCustomerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConsulCustomerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建ServiceController：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.DiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalancerClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancer;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所有服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/services"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">services</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> discoveryClient.getInstances(<span class="string">"service"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从所有服务中选择一个服务（轮询）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/discover"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">discover</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> loadBalancer.choose(<span class="string">"service"</span>).getUri().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建服务消费CallHelloController：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalancerClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallHelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/call"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ServiceInstance serviceInstance = loadBalancer.choose(<span class="string">"service"</span>);</span><br><span class="line">        System.out.println(<span class="string">"服务地址："</span> + serviceInstance.getUri());</span><br><span class="line">        System.out.println(<span class="string">"服务名称："</span> + serviceInstance.getServiceId());</span><br><span class="line"></span><br><span class="line">        String callServiceResult = <span class="keyword">new</span> RestTemplate().getForObject(serviceInstance.getUri().toString() + <span class="string">"/hello2"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(callServiceResult);</span><br><span class="line">        <span class="keyword">return</span> callServiceResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动服务即可！然后就可以访问<a href="http://localhost:8504/call" target="_blank" rel="noopener">http://localhost:8504/call</a></p></li></ol><h2 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h2><ol><li><p>创建一个使用consul的配置项目，添加相关依赖（pom.xml）:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>配置文件如下（application.yml）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span>    <span class="comment"># 启用配置中心</span></span><br><span class="line">        <span class="attr">format:</span> <span class="string">yaml</span>     <span class="comment"># 指定配置格式为 yaml</span></span><br><span class="line">        <span class="attr">data-key:</span> <span class="string">config_get</span> <span class="comment"># 也就是 consul 中 key/value 中的 key</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">config</span>         <span class="comment"># 可以理解为配置文件所在的最外层目录</span></span><br><span class="line">        <span class="attr">defaultContext:</span> <span class="string">consul-config</span>  <span class="comment"># 可以理解为 mysql_config 的上级目录</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">register:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-get</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">root:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure></li><li><p>启动类添加注解@EnableDiscoveryClient：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsulConfigApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConsulConfigApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Consul配置中心添加配置，配置如图所示：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/430a649526c7053038b83598cfd17e71-121736" alt="Consul配置"></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">root:</span> <span class="string">warn</span></span><br></pre></td></tr></table></figure></li><li><p>启动项目即可，然后实时修改Consul配置的Key/Vaule中的配置，会实时配置应用程序，这个和Eureka还不是太一样。</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;在微服务架构体系中，服务发现是非常重要的组件。Euerka、Consul、zookeeper、etcd、Nacos等都是注册中心，本主要记录
      
    
    </summary>
    
    
      <category term="SpringCloud" scheme="https://wanderros.github.io/categories/SpringCloud/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBoot Mybatis Quick Start</title>
    <link href="https://wanderros.github.io/2020/08/27/SpringBoot-Mybatis-Quick-Start/"/>
    <id>https://wanderros.github.io/2020/08/27/SpringBoot-Mybatis-Quick-Start/</id>
    <published>2020-08-27T07:05:11.000Z</published>
    <updated>2020-10-01T08:52:15.905Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>MyBatis 是一款优秀的持久层框架，它支持自定义 SQL、存储过程以及高级映射。MyBatis 免除了几乎所有的 JDBC 代码以及设置参数和获取结果集的工作。MyBatis 可以通过简单的 XML 或注解来配置和映射原始类型、接口和 Java POJO（Plain Old Java Objects，普通老式 Java 对象）为数据库中的记录!Mybatis属于半自动化配置，在项目开发中直接使用了Mybatis，真的是有很长时间去写Mapper中的SQL语句了，真心体会了MybatisPlus的妙处！</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><ol><li>MyBatis 主要提供了以下CRUD注解：（增删改查占据了绝大部分的业务操作）<ul><li>@Select</li><li>@Insert</li><li>@Update</li><li>@Delete</li></ul></li><li>Mybatis主要提供这些映射注解：<ul><li>@Results 用于填写结果集的多个字段的映射关系，property表示实体对象的属性名，column表示对应的数据库字段名</li><li>@Result 用于填写结果集的单个字段的映射关系</li><li>@ResultMap 根据ID关联XML里面&lt;resultMap&gt;</li></ul></li><li>MyBatis-3 主要提供了以下CRUD的高级注解：（主要用于动态SQL）<ul><li>@SelectProvider</li><li>@InsertProvider</li><li>@UpdateProvider</li><li>@DeleteProvider</li></ul></li><li>官方中文文档：<a href="https://mybatis.org/mybatis-3/zh/index.html" target="_blank" rel="noopener">https://mybatis.org/mybatis-3/zh/index.html</a></li><li>mybatis-spring-boot-autoconfigure：<a href="http://mybatis.org/spring-boot-starter/mybatis-spring-boot-autoconfigure/" target="_blank" rel="noopener">http://mybatis.org/spring-boot-starter/mybatis-spring-boot-autoconfigure/</a></li><li>mybatis-PageHelper参考代码：<a href="https://github.com/abel533/MyBatis-Spring-Boot" target="_blank" rel="noopener">https://github.com/abel533/MyBatis-Spring-Boot</a></li><li>Mybatis中文网：<a href="http://www.mybatis.cn/" target="_blank" rel="noopener">http://www.mybatis.cn/</a></li></ol><h2 id="分页插件参数说明"><a href="#分页插件参数说明" class="headerlink" title="分页插件参数说明"></a>分页插件参数说明</h2><ol><li><strong>helperDialect</strong>：分页插件会自动检测当前的数据库链接，自动选择合适的分页方式。可以指定分页插件使用哪种方言，比如oracle，mysql，mariadb，sqlite，hsqldb，postgresql，db2，sqlserver，informix，h2，sqlserver2012，derby；</li><li><strong>offsetAsPageNum</strong>：该参数对使用 RowBounds 作为分页参数时有效，默认false，当该参数设置为 true 时，会将 RowBounds 中的 offset 参数当成 pageNum 使用，可以用页码和页面大小两个参数进行分页；</li><li><strong>rowBoundsWithCount</strong>：该参数对使用 RowBounds 作为分页参数时有效，默认false，当该参数设置为 true 时，使用 RowBounds 分页会进行 count 查询；</li><li><strong>pageSizeZero</strong>：该参数设置为 true 时，如果 pageSize=0 或者 RowBounds.limit = 0 就会查询出全部的结果，默认false；</li><li><strong>reasonable</strong>：分页合理化参数，默认值为false。当该参数设置为 true 时，pageNum&lt;=0 时会查询第一页， pageNum&gt;pages（超过总数时），会查询最后一页；</li><li><strong>params</strong>：为了支持startPage(Object params)方法，增加了该参数来配置参数映射，用于从对象中根据属性名取值， 可以配置pageNum,pageSize,count,pageSizeZero,reasonable，不配置映射的用默认值， 默认值为pageNum=pageNum;pageSize=pageSize;count=countSql;reasonable=reasonable;pageSizeZero=pageSizeZero；</li><li>其他参数可以看官方文档：<a href="https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/zh/HowToUse.md" target="_blank" rel="noopener">https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/zh/HowToUse.md</a></li></ol><h1 id="动手实操"><a href="#动手实操" class="headerlink" title="动手实操"></a>动手实操</h1><ol><li><p>创建一个SpringBoot项目，添加Mybatis相关依赖，包含分页插件（pom.xml）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mybatis分页插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>添加配置文件（application.yml）:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mybatis?characterEncoding=utf8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">root:</span> <span class="string">debug</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置pagehelper参数</span></span><br><span class="line"><span class="attr">pagehelper:</span></span><br><span class="line">  <span class="attr">helperDialect:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">reasonable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">supportMethodsArguments:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">params:</span> <span class="string">count=countSql</span></span><br></pre></td></tr></table></figure></li><li><p>在启动类上添加扫描Mapper的注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.wander.mybatis"</span>)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MybatisApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建一个数据类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span>  String email;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建数据类的Mapper：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**  <span class="doctag">@Results</span>(&#123; //2</span></span><br><span class="line"><span class="comment">            <span class="doctag">@Result</span>(property = "id", column = "id"), //2</span></span><br><span class="line"><span class="comment">            <span class="doctag">@Result</span>(property = "name", column = "name"),</span></span><br><span class="line"><span class="comment">            <span class="doctag">@Result</span>(property = "email", column = "email")</span></span><br><span class="line"><span class="comment">    &#125;)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT * FROM user"</span>)</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">getAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT name FROM user"</span>)</span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">getAllName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from user where id =#&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">User <span class="title">findById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT * FROM user WHERE name = #&#123;name&#125;"</span>) <span class="comment">//3</span></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">getFromName</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"INSERT INTO user(id,name, email) VALUES (#&#123;id&#125;, #&#123;name&#125;,#&#123;email&#125;)"</span>) <span class="comment">//3</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"INSERT INTO user(id,name, email) VALUES (#&#123;id&#125;, #&#123;name&#125;,#&#123;email&#125;)"</span>) <span class="comment">//3</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertUserByMap</span><span class="params">(Map&lt;String,Object&gt; map)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="meta">@Insert</span>(<span class="string">"insert into user(id,name,email)"</span></span><br><span class="line">          + <span class="string">"values                   "</span></span><br><span class="line">          + <span class="string">"(#&#123;id&#125;, #&#123;name&#125;, #&#123;email&#125;) "</span>)</span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">insertUserByParam</span><span class="params">(@Param(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id,</span></span><br><span class="line"><span class="function">                        @<span class="title">Param</span><span class="params">(<span class="string">"name"</span>)</span> String name,</span></span><br><span class="line"><span class="function">                        @<span class="title">Param</span><span class="params">(<span class="string">"email"</span>)</span> String email)</span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 修改</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Update</span>(<span class="string">"update user set  "</span></span><br><span class="line">          + <span class="string">"name = #&#123;name&#125;,  "</span></span><br><span class="line">          + <span class="string">"email  = #&#123;email&#125;    "</span></span><br><span class="line">          + <span class="string">"where id = #&#123;id&#125; "</span>)</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">updateUser</span><span class="params">(User bean)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 删除</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Delete</span>(<span class="string">"delete from user  "</span></span><br><span class="line">          + <span class="string">"where id = #&#123;id&#125;  "</span>)</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">deleteUserById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 删除</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Delete</span>(<span class="string">"delete from user "</span>)</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">deleteUserAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * truncate 返回值为0</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Delete</span>(<span class="string">"truncate table user "</span>)</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">truncateUser</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Select</span>(<span class="string">"select count(*) from user "</span>)</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">selectCountUser</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建测试的控制器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello World!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;User&gt; users= userDao.getAll();</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/pages/&#123;page&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getpage</span><span class="params">(@PathVariable <span class="keyword">int</span> page)</span></span>&#123;</span><br><span class="line">        PageHelper.startPage(page,<span class="number">5</span>);</span><br><span class="line">        List&lt;User&gt; users= userDao.getAll();</span><br><span class="line">        PageInfo&lt;User&gt; pageInfo=<span class="keyword">new</span> PageInfo(users,<span class="number">3</span>);</span><br><span class="line">        System.out.println(pageInfo);</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/pages2/&#123;page&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;User&gt; <span class="title">getpage2</span><span class="params">(@PathVariable <span class="keyword">int</span> page)</span></span>&#123;</span><br><span class="line">        Page&lt;User&gt; pager =PageHelper.startPage(page,<span class="number">5</span>);</span><br><span class="line">        List&lt;User&gt; users= userDao.getFromName(<span class="string">"lisi"</span>);</span><br><span class="line">        System.out.println(pager.getTotal());</span><br><span class="line">        System.out.println(pager.size());</span><br><span class="line">        System.out.println(pager.get(<span class="number">2</span>));</span><br><span class="line">        <span class="comment">// 第一个User对象，参考list，序号0是第一个元素，依此类推</span></span><br><span class="line">        <span class="comment">//pager.get(0);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/get/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> <span class="keyword">int</span> id)</span>&#123;</span><br><span class="line">        User user=userDao.findById(id);</span><br><span class="line">        log.info(<span class="string">"username:&#123;&#125;,useremail:&#123;&#125;"</span>,user.getName(),user.getEmail());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/insert/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">insertUser</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> <span class="keyword">int</span> id,String name,String email)</span>&#123;</span><br><span class="line">        User user=<span class="keyword">new</span> User();</span><br><span class="line">        user.setId(id);</span><br><span class="line">        user.setName(name);</span><br><span class="line">        user.setEmail(email);</span><br><span class="line">        userDao.insertUser(user);</span><br><span class="line">        log.info(<span class="string">"username:&#123;&#125;,useremail:&#123;&#125;"</span>,user.getName(),user.getEmail());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/trans"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">transactionalTest</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        User user=<span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="number">15</span>);</span><br><span class="line">        user.setName(<span class="string">"lisi15"</span>);</span><br><span class="line">        user.setEmail(<span class="string">"lisi14@email.com"</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            userDao.insertUser(user);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (DataAccessException e)&#123;</span><br><span class="line">            System.out.println(<span class="string">"!!!!!"</span>+e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"!!!!---成功----username:&#123;&#125;,useremail:&#123;&#125;"</span>,user.getName(),user.getEmail());</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    user.setId(<span class="number">1</span>);</span><br><span class="line">    user.setName(<span class="string">"lisi"</span>);</span><br><span class="line">    user.setEmail(<span class="string">"lisi@email.com"</span>);</span><br><span class="line">    userDao.insertUser(user);</span><br><span class="line">&#125;<span class="keyword">catch</span> (DataAccessException e)&#123;</span><br><span class="line">    System.out.println(<span class="string">"!!!!!"</span>+e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"!!!!---失败----username:&#123;&#125;,useremail:&#123;&#125;"</span>,user.getName(),user.getEmail());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/map"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertMapUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map= <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"id"</span>,<span class="number">5</span>);</span><br><span class="line">        map.put(<span class="string">"name"</span>,<span class="string">"lier"</span>);</span><br><span class="line">        map.put(<span class="string">"email"</span>,<span class="string">"email@email.com"</span>);</span><br><span class="line">        userDao.insertUserByMap(map);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/param"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertParamUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        userDao.insertUserByParam(<span class="number">6</span>,<span class="string">"you"</span>,<span class="string">"you@email.com"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/name/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> String id)</span>&#123;</span><br><span class="line">        List&lt;User&gt; users=userDao.getFromName(id);</span><br><span class="line">        users.forEach(user-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">"userid: &#123;&#125; ,useremail: &#123;&#125;"</span>,user.getId(),user.getEmail());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/count"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">countUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count=userDao.selectCountUser();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"一共有 "</span>+Integer.toString(count)+<span class="string">" 名成员！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/delete/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deletebyId</span><span class="params">(@PathVariable <span class="keyword">int</span> id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i= userDao.deleteUserById(id);</span><br><span class="line">        log.error(<span class="string">"delete user id :&#123;&#125;,return &#123;&#125;"</span>,id,i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/update"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        User user=<span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="number">4</span>);</span><br><span class="line">        user.setName(<span class="string">"Fuck"</span>);</span><br><span class="line">        user.setEmail(<span class="string">"fuck@email.com"</span>);</span><br><span class="line">        <span class="keyword">int</span> i= userDao.updateUser(user);</span><br><span class="line">        log.error(<span class="string">"update user return &#123;&#125;"</span>,i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/deleteall"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deletebyId</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i= userDao.deleteUserAll();</span><br><span class="line">        log.error(<span class="string">"delete user return &#123;&#125;"</span>,i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>注意：分页的函数与要执行的查询SQL语句的函数不能隔离，最好上下行，否则有可能出错</li><li><strong>只有紧跟在PageHelper.startPage方法后的第一个Mybatis的查询（Select）方法会被分页</strong></li><li>对于带有for update的sql，会抛出运行时异常，对于这样的sql建议手动分页，毕竟这样的sql需要重视</li><li><strong>分页插件不支持嵌套结果映射</strong></li></ul></li><li><p>启动项目，然后就可以测试了。</p></li><li><p>建议开发过程中还是引入MP！</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;MyBatis 是一款优秀的持久层框架，它支持自定义 SQL、存储过程以及高级映射。MyBatis 免除了几乎所有的 JDBC 代码以及设置
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="https://wanderros.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringCloud Stream Quick Start</title>
    <link href="https://wanderros.github.io/2020/08/27/SpringCloud-Stream-Quick-Start/"/>
    <id>https://wanderros.github.io/2020/08/27/SpringCloud-Stream-Quick-Start/</id>
    <published>2020-08-27T01:29:34.000Z</published>
    <updated>2020-10-01T08:52:15.921Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>SpringCloud Stream是⼀款用于构建消息驱动的微服务应用程序的轻量级框架。目前常见的消息中间件的配置都不太相同，使用也各异，而SpringCloud Stream类似于VFS（虚拟文件系统）一样屏蔽底层差异，提供统一的使用方式来发布订阅消息。本文主要介绍以及使用SpringCloud Stream进行消息的发布与订阅。</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li><p>消息中间件主要解决应用解耦、异步消息、流量削锋等问题，实现高性能，高可用，可伸缩和最终一致性架构。不同的中间件其实现方式，内部结构是不一样的，这就导致了SpringCloud Stream的出现。可以使用SpringCloud Stream来整合消息中间件，来降低系统和中间件的耦合性；</p></li><li><p>SpringCloud Stream 为一些开发商的消息中间件产品提供了个性化的自动化配置实现，并引入了发布-订阅、消费组、分区这三个核心概念。通过使用 SpringCloud Stream可以有效简化开发人员对消息中间件的使用复杂度，让系统开发人员可以有更多的精力关注于核心业务逻辑的处理！</p></li><li><p>SpringCloud Stream应用模型如下所示：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/7589631dca02dc399a94401b1ba974d3-16266" alt="SpringCloud Stream应用模型"></p><ul><li>可以看到SpringCloud Stream在应用和中间件之间通过Binder进行通信，从而避免了不同中间件的差异化</li></ul></li><li><p>SpringCloud Stream提供很多的消息中间件的集成，截止2020年8月支持的消息中间件有：</p><ul><li>RabbitMQ</li><li>Apache Kafka</li><li>Kafka Streams</li><li>Amazon Kinesis</li><li>Google PubSub（合作伙伴维护）</li><li>Solace PubSub+（合作伙伴维护）</li><li>Azure Event Hubs（合作伙伴维护）</li><li>Apache RocketMQ（合作伙伴维护）</li></ul></li><li><p>SpringCloud Stream特性：</p><ul><li>声明式编程模型</li><li>引入多种概念抽象</li><li>支持多种消息中间件</li></ul></li><li><p>在 SpringCloud Stream中，不同的消息中间件统一封装成binder的类型。有了这些binder之后，应用程序只需要跟binder打交道，并不需要去关注底层的细节。如果需要使用到消息中间件独有的特性，SpringCloud Stream 提供了一些配置，可以去做一个定制；</p></li><li><p>注解 @EnableBinding：应用中生产者、消费者与消息系统之间的桥梁，通过注解的方式去定义一个接口；</p></li><li><p>注解 @Input：注解要订阅的消息的方法，返回值类型是SubscribableChannel；</p></li><li><p>注解 @Output：注解要发送消息的方法，返回值类型是MessageChannel。使用MessageChannel 中的 send() 可以发送消息；</p></li><li><p>注解 @SendTo：注解在方法上，会将这个方法的返回值发送到特定的消息队列中去；</p></li><li><p>注解 @StreamListener：注解在方法上，会去消费指定的消息队列；</p></li><li><p>在现实的业务场景中，每一个微服务应用为了实现高可用和负载均衡，都会集群部署，消息可能会被重复消费。为了解决这个问题，SpringCloud Stream提供了消费组，通过配置即可指定组名；</p></li><li><p>SpringCloud Stream官方网址：<a href="https://spring.io/projects/spring-cloud-stream" target="_blank" rel="noopener">https://spring.io/projects/spring-cloud-stream</a></p></li></ol><h2 id="重点概念"><a href="#重点概念" class="headerlink" title="重点概念"></a>重点概念</h2><ol><li><strong>group</strong>：组内只有1个实例会消费消息，组内的每个实例都会有机会消费消息（轮询负载均衡）。如果不设置group，则stream会自动为每个实例创建匿名且独立的group，则每个实例都会消费消息；</li><li><strong>destination binder</strong>：与外部消息系统通信的组件，为构造 Binding提供了 2 个方法，分别是 bindConsumer 和 bindProducer ，用于构造生产者和消费者。Binder使SpringCloud Stream应用程序可以灵活地连接到中间件；</li><li><strong>destination binding</strong>：Binding 是连接应用程序跟消息中间件的桥梁，用于消息的消费和生产，由binder创建；</li><li><strong>partition</strong>：一个或多个生产者将数据发送到多个消费者，并确保有共同特征标识的数据由同一个消费者处理。默认是对消息进行hashCode，然后根据分区个数取余，所以对于相同的消息，总会落到同一个消费者上；</li></ol><h1 id="动手实操"><a href="#动手实操" class="headerlink" title="动手实操"></a>动手实操</h1><h2 id="SCS整合RabbitMQ"><a href="#SCS整合RabbitMQ" class="headerlink" title="SCS整合RabbitMQ"></a>SCS整合RabbitMQ</h2><ol><li><p>启动RabbitMQ的Docker镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5672:5672 -p 15672:15672 -e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=admin --name rabbit rabbitmq:management</span><br></pre></td></tr></table></figure><ul><li>账户名：admin</li><li>密码：admin</li><li>Web管理页面端口15672</li></ul></li><li><p>创建一个SCS项目，添加主要依赖如下（pom.xml）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream-binder-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>添加配置（application.yml）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">addresses:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span>  <span class="comment"># 注意，这里是5672，不是访问界面用的15672，这个是默认值</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="comment"># 增加该配置，对队列进行分组。保证一个服务只有一台实例接受到消息。</span></span><br><span class="line">      <span class="attr">bindings:</span></span><br><span class="line">        <span class="comment"># 监听的消息队列的名称。</span></span><br><span class="line">        <span class="attr">testMessage:</span></span><br><span class="line">          <span class="comment"># 服务的名称</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">order</span></span><br><span class="line">          <span class="comment"># 将发送的对象消息转化为json，方便调试</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span></span><br></pre></td></tr></table></figure></li><li><p>创建消息接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StreamClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Input</span>(<span class="string">"testMessage"</span>)</span><br><span class="line">    <span class="function">SubscribableChannel <span class="title">input</span><span class="params">()</span></span>;  <span class="comment">//用于接受消息</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Output</span>(<span class="string">"testMessage"</span>)</span><br><span class="line">    <span class="function">MessageChannel <span class="title">output</span><span class="params">()</span></span>;  <span class="comment">//用于发送消息</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Input</span>(<span class="string">"responseMessage"</span>)</span><br><span class="line">    <span class="function">SubscribableChannel <span class="title">responseinput</span><span class="params">()</span></span>;  <span class="comment">//用于接受消息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建消息监听类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableBinding</span>(StreamClient<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">StreamReceiver</span> </span>&#123;  <span class="comment">//消息接受类</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener</span>(<span class="string">"testMessage"</span>)  <span class="comment">//监听testMessage这个消息队列, StreamClient类中必须定义相应的Input。</span></span><br><span class="line">    <span class="meta">@SendTo</span>(<span class="string">"responseMessage"</span>)  <span class="comment">//该注解会在消息处理完成后，向responseMessage这个队列发送消息。消息内容就是该方法的返回值。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">receiver</span><span class="params">(Object message)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"接收到消息："</span> + message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"完成消息处理"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@StreamListener</span>(<span class="string">"responseMessage"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiverResponse</span><span class="params">(Object message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"接收到转发消息："</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建测试控制器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StreamClient streamClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/sendMessage"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//org.springframework.messaging.support.MessageBuilder;</span></span><br><span class="line">        streamClient.output().send(MessageBuilder.withPayload(<span class="string">"it is test message."</span>).build()); <span class="comment">//构建消息并且发送</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动项目，访问<a href="http://localhost:8080/sendMessage可以看到控制台输出消息，效果如下：" target="_blank" rel="noopener">http://localhost:8080/sendMessage可以看到控制台输出消息，效果如下：</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/1d8e27d9264c0209c663258e51935f26-171738" alt="消息输出"></p></li><li><p>因为设置了组，因此，该项目的多个实例每次只会有一个消费消息！</p></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>SCS的使用远不止如此，还有许多高级的特性没有使用，后续有用到再详细学习！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;SpringCloud Stream是⼀款用于构建消息驱动的微服务应用程序的轻量级框架。目前常见的消息中间件的配置都不太相同，使用也各异，而
      
    
    </summary>
    
    
      <category term="SpringCloud" scheme="https://wanderros.github.io/categories/SpringCloud/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBoot管理Docker快速入门</title>
    <link href="https://wanderros.github.io/2020/08/26/SpringBoot%E7%AE%A1%E7%90%86Docker%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <id>https://wanderros.github.io/2020/08/26/SpringBoot%E7%AE%A1%E7%90%86Docker%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/</id>
    <published>2020-08-26T09:19:22.000Z</published>
    <updated>2020-10-01T08:52:15.915Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Docker提供了Remote API，可以通过REST接口进行Docker服务的控制，包括pull/push等所有操作，结果与本机的操作完全一样。使用Docker Remote API可以通过脚本进行Docker集群的自动化控制。在SpringBoot项目中可以通过引入Docker-Java相关的依赖然后就可以进行Docker的管理，本文主要记录如何在Mac上开启Docker Remote API以及使用Docker-Java进行Docker的管理。</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><ol><li><p>连接服务器、获取信息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 连接docker服务器</span></span><br><span class="line">DockerClient dockerClient = DockerClientBuilder</span><br><span class="line">  .getInstance(<span class="string">"tcp://localhost:2375"</span>).build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取服务器信息</span></span><br><span class="line">Info info = dockerClient.infoCmd().exec();</span><br></pre></td></tr></table></figure></li><li><p>获取服务器上所有的镜像：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取服务器上的镜像</span></span><br><span class="line">List&lt;Image&gt; images = dockerClient.listImagesCmd().exec();</span><br><span class="line"><span class="keyword">for</span>(Image image : images) &#123;</span><br><span class="line">    System.out.println(image.getRepoTags()[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>判断服务器上是否存在某个镜像：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 筛选服务器上的镜像</span></span><br><span class="line">List&lt;Image&gt; images = dockerClient.listImagesCmd().withImageNameFilter(<span class="string">"busybox"</span>).exec();</span><br><span class="line"><span class="keyword">if</span> (images.isEmpty()) &#123;</span><br><span class="line">    System.out.println(<span class="string">"不存在 busybox 镜像。"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">"存在 busybox 镜像。"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>搜索镜像：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 搜索镜像</span></span><br><span class="line">List&lt;SearchItem&gt; dockerSearch = dockerClient.searchImagesCmd(<span class="string">"busybox"</span>).exec();</span><br><span class="line"><span class="keyword">for</span>(SearchItem item : dockerSearch) &#123;</span><br><span class="line">    System.out.println(item.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>下载镜像：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">dockerClient.pullImageCmd(<span class="string">"busybox:latest"</span>).exec(<span class="keyword">new</span> ResultCallback&lt;PullResponseItem&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Closeable closeable)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始下载!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(PullResponseItem object)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 实时显示出下载信息</span></span><br><span class="line">        System.out.println(object.getStatus());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">        throwable.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"下载完毕!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>删除镜像：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除镜像</span></span><br><span class="line">dockerClient.removeImageCmd(<span class="string">"busybox"</span>).exec();</span><br><span class="line">System.out.println(<span class="string">"删除完毕"</span>);</span><br></pre></td></tr></table></figure></li><li><p>创建、运行容器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建容器</span></span><br><span class="line">CreateContainerResponse container1 = dockerClient.createContainerCmd(<span class="string">"httpd:latest"</span>)</span><br><span class="line">        .withName(<span class="string">"hangge_http_server"</span>) <span class="comment">//给容器命名</span></span><br><span class="line">        .withPortBindings(PortBinding.parse(<span class="string">"8080:80"</span>)) <span class="comment">//Apache端口是80，映射到主机的8080端口</span></span><br><span class="line">        .withBinds(Bind.parse(<span class="string">"/home/user/htdocs:/usr/local/apache2/htdocs"</span>)) <span class="comment">//目录挂载</span></span><br><span class="line">        .exec();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//运行容器</span></span><br><span class="line">dockerClient.startContainerCmd(container1.getId()).exec();</span><br></pre></td></tr></table></figure></li><li><p>进入容器执行命令：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建命令</span></span><br><span class="line">ExecCreateCmdResponse execCreateCmdResponse = dockerClient.execCreateCmd(container1.getId())</span><br><span class="line">        .withAttachStdout(<span class="keyword">true</span>)</span><br><span class="line">        .withAttachStderr(<span class="keyword">true</span>)</span><br><span class="line">        .withCmd(<span class="string">"bash"</span>, <span class="string">"-c"</span>, <span class="string">"ls"</span>) <span class="comment">//当前目录下列出所有文件</span></span><br><span class="line">        .exec();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 执行命令</span></span><br><span class="line">dockerClient.execStartCmd(execCreateCmdResponse.getId()).exec(</span><br><span class="line">        <span class="keyword">new</span> ExecStartResultCallback(System.out, System.err));</span><br></pre></td></tr></table></figure></li><li><p>获取服务器上所有运行的容器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取所有运行的容器</span></span><br><span class="line">List&lt;Container&gt; containers = dockerClient.listContainersCmd().exec();</span><br><span class="line"><span class="keyword">for</span> (Container container: containers)&#123;</span><br><span class="line">    System.out.println(container.getId() + <span class="string">": "</span> + container.getNames()[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>获取服务器上所有运行结束的容器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取所有运行的容器</span></span><br><span class="line">List&lt;Container&gt; containers = dockerClient.listContainersCmd().withStatusFilter(<span class="string">"exited"</span>).exec();</span><br><span class="line"><span class="keyword">for</span> (Container container: containers)&#123;</span><br><span class="line">    System.out.println(container.getId() + <span class="string">": "</span> + container.getNames()[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>获取指定名字的容器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取指定名字的容器</span></span><br><span class="line">ListContainersCmd listContainersCmd = dockerClient.listContainersCmd();</span><br><span class="line">listContainersCmd.getFilters().put(<span class="string">"name"</span>, Arrays.asList(<span class="string">"jenkins"</span>));</span><br><span class="line">List&lt;Container&gt; containers = listContainersCmd.exec();</span><br><span class="line"><span class="keyword">for</span> (Container container: containers)&#123;</span><br><span class="line">    System.out.println(container.getId() + <span class="string">": "</span> + container.getNames()[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>停止、重启、暂停/恢复、删除容器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 停止容器</span></span><br><span class="line">dockerClient.stopContainerCmd(container1.getId()).exec();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 重启容器</span></span><br><span class="line">dockerClient.restartContainerCmd(container1.getId()).exec();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 暂停容器</span></span><br><span class="line">dockerClient.pauseContainerCmd(container1.getId()).exec();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 恢复容器</span></span><br><span class="line">dockerClient.unpauseContainerCmd(container1.getId()).exec();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 删除容器</span></span><br><span class="line">dockerClient.removeContainerCmd(container1.getId()).exec();</span><br></pre></td></tr></table></figure></li><li><p>创建一个名为 java-docker-mssql 的自定义网络：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CreateNetworkResponse networkResponse = dockerClient.createNetworkCmd()</span><br><span class="line">        .withName(<span class="string">"java-docker-mssql"</span>)</span><br><span class="line">        .withDriver(<span class="string">"bridge"</span>).exec();</span><br></pre></td></tr></table></figure></li><li><p>运行容器的时候使用 java-docker-mssql 这个自定义网络：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建容器</span></span><br><span class="line">CreateContainerResponse container1 = dockerClient.createContainerCmd(<span class="string">"busybox"</span>)</span><br><span class="line">        .withNetworkMode(<span class="string">"java-docker-mssql"</span>) <span class="comment">//设置网络</span></span><br><span class="line">        .exec();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//运行容器</span></span><br><span class="line">dockerClient.startContainerCmd(container1.getId()).exec();</span><br></pre></td></tr></table></figure></li></ol><h2 id="Mac开启Docker-Remote-API"><a href="#Mac开启Docker-Remote-API" class="headerlink" title="Mac开启Docker Remote API"></a>Mac开启Docker Remote API</h2><h3 id="socat"><a href="#socat" class="headerlink" title="socat"></a>socat</h3><ol><li><p>安装socat：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install socat</span><br></pre></td></tr></table></figure></li><li><p>启动socat：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat -d TCP-LISTEN:2375,range=127.0.0.1/32,reuseaddr,fork UNIX:/var/run/docker.sock</span><br></pre></td></tr></table></figure></li><li><p>开放全部端口：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat -d TCP-LISTEN:2375,reuseaddr,fork UNIX:/var/run/docker.sock</span><br></pre></td></tr></table></figure></li><li><p>测试：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:2375/version</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出</span></span><br><span class="line">&#123;"Platform":&#123;"Name":"Docker Engine - Community"&#125;,"Components":[&#123;"Name":"Engine","Version":"19.03.12","Details":&#123;"ApiVersion":"1.40","Arch":"amd64","BuildTime":"2020-06-22T15:49:27.000000000+00:00","Experimental":"false","GitCommit":"48a66213fe","GoVersion":"go1.13.10","KernelVersion":"4.19.76-linuxkit","MinAPIVersion":"1.12","Os":"linux"&#125;&#125;,&#123;"Name":"containerd","Version":"v1.2.13","Details":&#123;"GitCommit":"7ad184331fa3e55e52b890ea95e65ba581ae3429"&#125;&#125;,&#123;"Name":"runc","Version":"1.0.0-rc10","Details":&#123;"GitCommit":"dc9208a3303feef5b3839f4323d9beb36df0a9dd"&#125;&#125;,&#123;"Name":"docker-init","Version":"0.18.0","Details":&#123;"GitCommit":"fec3683"&#125;&#125;],"Version":"19.03.12","ApiVersion":"1.40","MinAPIVersion":"1.12","GitCommit":"48a66213fe","GoVersion":"go1.13.10","Os":"linux","Arch":"amd64","KernelVersion":"4.19.76-linuxkit","BuildTime":"2020-06-22T15:49:27.000000000+00:00"&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><ol><li><p>下载镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull bobrik/socat</span><br><span class="line">docker pull shipyard/docker-proxy</span><br></pre></td></tr></table></figure></li><li><p>创建镜像bobrik/socat实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -v /var/run/docker.sock:/var/run/docker.sock -p 2375:2375 \</span><br><span class="line"> bobrik/socat TCP4-LISTEN:2375,fork,reuseaddr UNIX-CONNECT:/var/run/docker.sock</span><br></pre></td></tr></table></figure></li><li><p>创建镜像shipyard/docker-proxy实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 2375:2375 -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line"> -d -e PORT=2375 shipyard/docker-proxy</span><br></pre></td></tr></table></figure></li><li><p>注意：上述两个镜像只要启动其中的一个即可，功能都是一样的！</p></li><li><p>测试：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:2375/version</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出</span></span><br><span class="line">&#123;"Platform":&#123;"Name":"Docker Engine - Community"&#125;,"Components":[&#123;"Name":"Engine","Version":"19.03.12","Details":&#123;"ApiVersion":"1.40","Arch":"amd64","BuildTime":"2020-06-22T15:49:27.000000000+00:00","Experimental":"false","GitCommit":"48a66213fe","GoVersion":"go1.13.10","KernelVersion":"4.19.76-linuxkit","MinAPIVersion":"1.12","Os":"linux"&#125;&#125;,&#123;"Name":"containerd","Version":"v1.2.13","Details":&#123;"GitCommit":"7ad184331fa3e55e52b890ea95e65ba581ae3429"&#125;&#125;,&#123;"Name":"runc","Version":"1.0.0-rc10","Details":&#123;"GitCommit":"dc9208a3303feef5b3839f4323d9beb36df0a9dd"&#125;&#125;,&#123;"Name":"docker-init","Version":"0.18.0","Details":&#123;"GitCommit":"fec3683"&#125;&#125;],"Version":"19.03.12","ApiVersion":"1.40","MinAPIVersion":"1.12","GitCommit":"48a66213fe","GoVersion":"go1.13.10","Os":"linux","Arch":"amd64","KernelVersion":"4.19.76-linuxkit","BuildTime":"2020-06-22T15:49:27.000000000+00:00"&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="动手实操"><a href="#动手实操" class="headerlink" title="动手实操"></a>动手实操</h2><ol><li><p>docker-java 是 Docker的 Java 版本 API；</p></li><li><p>创建一个SpringBoot项目，添加Docker开发相关的依赖（pom.xml）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--docker client begin--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.docker-java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.14<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.ws.rs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.ws.rs-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.glassfish.jersey.inject<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jersey-hk2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--docker client end--&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>创建控制器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 连接docker服务器</span></span><br><span class="line">        DockerClient dockerClient = DockerClientBuilder</span><br><span class="line">                .getInstance(<span class="string">"tcp://localhost:2375"</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取服务器信息</span></span><br><span class="line">        Info info = dockerClient.infoCmd().exec();</span><br><span class="line"></span><br><span class="line">        System.out.println(info.toString());</span><br><span class="line">        <span class="keyword">return</span> info.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/images"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">images</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DockerClient dockerClient = DockerClientBuilder</span><br><span class="line">                .getInstance(<span class="string">"tcp://localhost:2375"</span>).build();</span><br><span class="line">        List&lt;Image&gt; images = dockerClient.listImagesCmd().exec();</span><br><span class="line">        <span class="keyword">for</span>(Image image : images) &#123;</span><br><span class="line">            System.out.println(image.getRepoTags()[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/exist"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">imagesexist</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DockerClient dockerClient = DockerClientBuilder</span><br><span class="line">                .getInstance(<span class="string">"tcp://localhost:2375"</span>).build();</span><br><span class="line">        List&lt;Image&gt; images = dockerClient.listImagesCmd().withImageNameFilter(<span class="string">"jenkins"</span>).exec();</span><br><span class="line">        <span class="keyword">if</span> (images.isEmpty()) &#123;</span><br><span class="line">            System.out.println(<span class="string">"不存在 jenkins 镜像。"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"存在 jenkins 镜像。"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/search"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">imagesearch</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DockerClient dockerClient = DockerClientBuilder</span><br><span class="line">                .getInstance(<span class="string">"tcp://localhost:2375"</span>).build();</span><br><span class="line">        List&lt;SearchItem&gt; dockerSearch = dockerClient.searchImagesCmd(<span class="string">"busybox"</span>).exec();</span><br><span class="line">        <span class="keyword">for</span>(SearchItem item : dockerSearch) &#123;</span><br><span class="line">            System.out.println(item.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/download"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">imageload</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DockerClient dockerClient = DockerClientBuilder</span><br><span class="line">                .getInstance(<span class="string">"tcp://localhost:2375"</span>).build();</span><br><span class="line">        dockerClient.pullImageCmd(<span class="string">"busybox:latest"</span>).exec(<span class="keyword">new</span> ResultCallback&lt;PullResponseItem&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Closeable closeable)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"开始下载!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(PullResponseItem object)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 实时显示出下载信息</span></span><br><span class="line">                System.out.println(object.getStatus());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                throwable.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"下载完毕!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/delete"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">imagedelete</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DockerClient dockerClient = DockerClientBuilder</span><br><span class="line">                .getInstance(<span class="string">"tcp://localhost:2375"</span>).build();</span><br><span class="line">        <span class="comment">// 删除镜像</span></span><br><span class="line">        dockerClient.removeImageCmd(<span class="string">"busybox"</span>).exec();</span><br><span class="line">        System.out.println(<span class="string">"删除完毕"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/run"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">imagerun</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DockerClient dockerClient = DockerClientBuilder</span><br><span class="line">                .getInstance(<span class="string">"tcp://localhost:2375"</span>).build();</span><br><span class="line"><span class="comment">//创建容器</span></span><br><span class="line">        CreateContainerResponse container1 = dockerClient.createContainerCmd(<span class="string">"nginx:latest"</span>)</span><br><span class="line">                .withName(<span class="string">"nginx"</span>) <span class="comment">//给容器命名</span></span><br><span class="line">                .withPortBindings(PortBinding.parse(<span class="string">"8081:80"</span>)) <span class="comment">//Apache端口是80，映射到主机的8080端口</span></span><br><span class="line">              <span class="comment">//  .withBinds(Bind.parse("/home/user/htdocs:/usr/local/apache")) //目录挂载</span></span><br><span class="line">                .exec();</span><br><span class="line"></span><br><span class="line"><span class="comment">//运行容器</span></span><br><span class="line">        dockerClient.startContainerCmd(container1.getId()).exec();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/exec"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">imageexec</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DockerClient dockerClient = DockerClientBuilder</span><br><span class="line">                .getInstance(<span class="string">"tcp://localhost:2375"</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建容器</span></span><br><span class="line">        CreateContainerResponse container1 = dockerClient.createContainerCmd(<span class="string">"nginx:latest"</span>)</span><br><span class="line">                .withName(<span class="string">"nginx"</span>) <span class="comment">//给容器命名</span></span><br><span class="line">                .withPortBindings(PortBinding.parse(<span class="string">"8081:80"</span>)) <span class="comment">//Apache端口是80，映射到主机的8080端口</span></span><br><span class="line">                <span class="comment">//  .withBinds(Bind.parse("/home/user/htdocs:/usr/local/apache")) //目录挂载</span></span><br><span class="line">                .exec();</span><br><span class="line"></span><br><span class="line"><span class="comment">//运行容器</span></span><br><span class="line">        dockerClient.startContainerCmd(container1.getId()).exec();</span><br><span class="line"><span class="comment">// 创建命令</span></span><br><span class="line">        ExecCreateCmdResponse execCreateCmdResponse = dockerClient.execCreateCmd(container1.getId())</span><br><span class="line">                .withAttachStdout(<span class="keyword">true</span>)</span><br><span class="line">                .withAttachStderr(<span class="keyword">true</span>)</span><br><span class="line">                .withCmd(<span class="string">"bash"</span>, <span class="string">"-c"</span>, <span class="string">"ls"</span>) <span class="comment">//当前目录下列出所有文件</span></span><br><span class="line">                .exec();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行命令</span></span><br><span class="line">        dockerClient.execStartCmd(execCreateCmdResponse.getId()).exec(</span><br><span class="line">                <span class="keyword">new</span> ExecStartResultCallback(System.out, System.err));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">containerlist</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DockerClient dockerClient = DockerClientBuilder</span><br><span class="line">                .getInstance(<span class="string">"tcp://localhost:2375"</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取所有运行的容器</span></span><br><span class="line">        List&lt;Container&gt; containers = dockerClient.listContainersCmd().withStatusFilter(<span class="string">"exited"</span>).exec();</span><br><span class="line">        <span class="keyword">for</span> (Container container: containers)&#123;</span><br><span class="line">            System.out.println(container.getId() + <span class="string">": "</span> + container.getNames()[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/some"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">containerlistsome</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DockerClient dockerClient = DockerClientBuilder</span><br><span class="line">                .getInstance(<span class="string">"tcp://localhost:2375"</span>).build();</span><br><span class="line"></span><br><span class="line">        ListContainersCmd listContainersCmd = dockerClient.listContainersCmd();</span><br><span class="line">        listContainersCmd.getFilters().put(<span class="string">"name"</span>, Arrays.asList(<span class="string">"nginx"</span>));</span><br><span class="line">        List&lt;Container&gt; containers = listContainersCmd.exec();</span><br><span class="line">        <span class="keyword">for</span> (Container container: containers)&#123;</span><br><span class="line">            System.out.println(container.getId() + <span class="string">": "</span> + container.getNames()[<span class="number">0</span>]);</span><br><span class="line">            <span class="comment">// 停止容器</span></span><br><span class="line">            dockerClient.stopContainerCmd(container.getId()).exec();</span><br><span class="line">            dockerClient.removeContainerCmd(container.getId()).exec();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动项目即可测试！</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;Docker提供了Remote API，可以通过REST接口进行Docker服务的控制，包括pull/push等所有操作，结果与本机的操作完
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="https://wanderros.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBoot kafka Quick Start</title>
    <link href="https://wanderros.github.io/2020/08/25/SpringBoot-Kafka-Quick-Start/"/>
    <id>https://wanderros.github.io/2020/08/25/SpringBoot-Kafka-Quick-Start/</id>
    <published>2020-08-25T02:50:45.000Z</published>
    <updated>2020-10-01T08:52:15.904Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Apache Kafka是一个开源消息系统，由Scala写成。Kafka是一个分布式消息队列：生产者、消费者的功能，提供了类似于JMS的特性，但是在设计实现上完全不同。Kafka对消息保存时根据Topic进行归档，发送消息者统称为Producer，消息接收者统称为Consumer，而且Kafka支持分布式，可以由多个实例组成Kafka集群，每个实例称为broker。本文主要记录如何搭建Kafka环境以及通过SpringBoot构建Kafka消息Producer以及Consumer。</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="JMS"><a href="#JMS" class="headerlink" title="JMS"></a>JMS</h3><ol><li>JMS是Java提供的一套技术规范。JMS用来异构系统，缓解系统瓶颈，提高系统的伸缩性并且增强系统用户体验，使得系统模块化和组件化变得可行、灵活；</li><li>消息系统的核心：解耦、异步以及并行；</li><li>JMS消息传输模型：<ul><li>点对点模式（一对一，消费者主动拉取数据，消息收到后消息清除）</li><li>发布/订阅模式（一对多，数据生产后，推送给所有订阅者）</li></ul></li><li>消息队列（点对点模式）是当一个消费者消费了队列中的某条数据之后，该条数据则从消息队列中删除。生产者发送一条消息到队列中，只有一个消费者能收到；</li><li>发布-订阅消息系统中，消息被持久化到一个Topic中。消费者可以订阅一个或多个Topic，消费者可以消费该Topic中所有的数据，同一条数据可以被多个消费者消费，数据被消费后不会立马删除；</li><li>消息系统在处理过程中间插入了一个隐含的、基于数据的接口层，两边的处理过程都要实现这一接口。这样可以独立的扩展或修改两边的处理过程，只要确保它们遵守同样的接口约束！</li><li>使用消息队列能够使关键组件顶住突发的访问压力，而不会因为突发的超负荷请求而完全崩溃！</li></ol><h3 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h3><ol><li><p>Kafka最初由Linkedin公司开发，是一个分布式、分区的、多副本的、多订阅者，基于zookeeper协调的分布式消息平台；</p></li><li><p>主要应用场景：日志收集以及消息分发。在架构设计中起到解耦、削峰、异步处理的作用：</p><ul><li>构建在系统或应用程序之间可靠获取数据的实时数据流管道</li><li>构建转换或响应数据流的实时流应用程序</li></ul></li><li><p>Kafka核心组件：</p><ul><li>Topic ：消息根据Topic进行归类</li><li>Producer：发送消息者</li><li>Consumer：消息接受者</li><li>broker：每个kafka实例(server)</li><li>Zookeeper：依赖集群保存meta信息</li></ul></li><li><p>Kafka特性：</p><ul><li>以时间复杂度为O(1)的方式提供消息持久化能力，即使对TB级以上数据也能保证常数时间的访问性能</li><li>高吞吐率。即使在非常廉价的商用机器上也能做到单机支持每秒100K条消息的传输</li><li>支持Kafka Server间的消息分区，及分布式消费，同时<strong>保证每个partition内的消息顺序传输</strong></li><li>同时支持离线数据处理和实时数据处理</li><li>支持在线水平扩展</li></ul></li><li><p>分布式消息传递基于可靠的消息队列，在客户端应用和消息系统之间异步传递消息；</p></li><li><p>Kafka的优点：解耦、冗余（副本）、扩展性、灵活性&amp;峰值处理能力、可恢复性、顺序保证、缓冲、异步通信等！</p></li><li><p>Kafka的用法大致就是Producers往Brokers里面的指定Topic中写消息，Consumers从Brokers里面拉取指定Topic的消息，然后进行业务处理。如下图所示，有两个topic，topic 0有两个partition，topic 1有一个partition，三副本备份：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/4523a3e43cc57fc934535cc3db429a12-155422" alt="Kafka数据流"></p></li><li><p>当存在多副本的情况下，会尽量把多个副本，分配到不同的broker上。kafka会为partition选出一个leader，之后所有该partition的请求，实际操作的都是leader，然后再同步到其他的follower。当一个broker歇菜后，所有leader在该broker上的partition都会重新选举，选出一个leader；</p></li><li><p>kafka的成功不是技术有多厉害，而是它的业务厉害，能抽象很多的名词术语，已经说明了这款产品设计多么精妙；</p></li><li><p>Kafka官方中文网址：<a href="https://kafka.apachecn.org/" target="_blank" rel="noopener">https://kafka.apachecn.org/</a></p></li></ol><h3 id="常用消息队列工具对比"><a href="#常用消息队列工具对比" class="headerlink" title="常用消息队列工具对比"></a>常用消息队列工具对比</h3><ol><li><strong>RabbitMQ</strong>支持了很多的协议：AMQP，XMPP, SMTP, STOMP。实现了Broker架构，并且对路由、负载均衡以及数据持久化都有很好的支持；</li><li><strong>Redis</strong>是一个基于Key-Value对的NoSQL数据库，支持MQ功能，可以当成一个轻量级的队列服务来使用；</li><li><strong>ZeroMQ</strong>能够实现RabbitMQ不擅长的高级/复杂的队列，开发人员需要自己组合多种技术框架，技术上的复杂度是能够应用成功的挑战；</li><li><strong>ActiveMQ</strong>能够以代理人和点对点的技术实现队列，可以少量代码实现高级应用场景；</li><li><strong>Jafka</strong>在Kafka之上孵化而来的，能够快速持久化、高吞吐、完全分布式系统、自动实现负载均衡；</li><li><strong>MetaQ/RocketMQ</strong> 纯Java实现，发布/订阅消息系统，支持本地事务和XA分布式事务；</li></ol><h2 id="Docker构建Kafka环境"><a href="#Docker构建Kafka环境" class="headerlink" title="Docker构建Kafka环境"></a>Docker构建Kafka环境</h2><ol><li><p>在涉及到Apache Kafka的快速demo时，使用Docker Hub上提供的镜像免去了很多安装配置上的麻烦；</p></li><li><p>下载镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> zookeeper镜像</span></span><br><span class="line">docker pull zookeeper</span><br><span class="line"><span class="meta">#</span><span class="bash"> kafka镜像</span></span><br><span class="line">docker pull wurstmeister/kafka</span><br><span class="line"><span class="meta">#</span><span class="bash"> kafka管理者镜像</span></span><br><span class="line">docker pull kafkamanager/kafka-manager</span><br></pre></td></tr></table></figure></li><li><p>编写docker-compose启动文件docker-compose.yml：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zookeeper</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2181</span><span class="string">:2181</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wurstmeister/kafka</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KAFKA_ADVERTISED_HOST_NAME=192.168.3.108</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KAFKA_ADVERTISED_PORT=9092</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9092</span><span class="string">:9092</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zookeeper</span></span><br><span class="line">  <span class="attr">kafka2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wurstmeister/kafka</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KAFKA_ADVERTISED_HOST_NAME=192.168.3.108</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">KAFKA_ADVERTISED_PORT=9093</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9093</span><span class="string">:9092</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zookeeper</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kafkamanagement:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kafkamanager/kafka-manager</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ZK_HOSTS=zookeeper:2181</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">kafka</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zookeeper</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">kafka2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9000</span><span class="string">:9000</span></span><br></pre></td></tr></table></figure><ul><li>KAFKA_ADVERTISED_HOST_NAME以及KAFKA_ADVERTISED_PORT是Kafka对外暴露的地址以及端口</li><li>多zookeeper配置文件如下：</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="attr">zoo1:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">zookeeper</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">zoo1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"2181:2181"</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">ZOO_MY_ID:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zoo1:2888:3888;2181</span> <span class="string">server.2=zoo2:2888:3888;2181</span> <span class="string">server.3=zoo3:2888:3888;2181</span></span><br><span class="line">            </span><br><span class="line">    <span class="attr">zoo2:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">zookeeper</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">zoo2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"2182:2181"</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">ZOO_MY_ID:</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zoo1:2888:3888;2181</span> <span class="string">server.2=zoo2:2888:3888;2181</span> <span class="string">server.3=zoo3:2888:3888;2181</span></span><br><span class="line"> </span><br><span class="line">    <span class="attr">zoo3:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">zookeeper</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">zoo3</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"2183:2181"</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">ZOO_MY_ID:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">ZOO_SERVERS:</span> <span class="string">server.1=zoo1:2888:3888;2181</span> <span class="string">server.2=zoo2:2888:3888;2181</span> <span class="string">server.3=zoo3:2888:3888;2181</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">kafka:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">wurstmeister/kafka</span></span><br><span class="line">      <span class="attr">environment:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">KAFKA_ZOOKEEPER_CONNECT=zoo1:2181,zoo2:2181,zoo3:2181</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">KAFKA_ADVERTISED_HOST_NAME=192.168.3.108</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">KAFKA_ADVERTISED_PORT=9092</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">9092</span><span class="string">:9092</span></span><br><span class="line">      <span class="attr">depends_on:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">zoo1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">zoo2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">zoo3</span></span><br><span class="line">    <span class="attr">kafka2:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">wurstmeister/kafka</span></span><br><span class="line">      <span class="attr">environment:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">KAFKA_ZOOKEEPER_CONNECT=zoo1:2181,zoo2:2181,zoo3:2181</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">KAFKA_ADVERTISED_HOST_NAME=192.168.3.108</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">KAFKA_ADVERTISED_PORT=9093</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">9093</span><span class="string">:9092</span></span><br><span class="line">      <span class="attr">depends_on:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">zoo1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">zoo2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">zoo3</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">kafkamanagement:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">kafkamanager/kafka-manager</span></span><br><span class="line">      <span class="attr">environment:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ZK_HOSTS=zoo1:2181,zoo2:2181,zoo3:2181</span></span><br><span class="line">      <span class="attr">depends_on:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">kafka</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">zoo1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">zoo2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">zoo3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">kafka2</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">9000</span><span class="string">:9000</span></span><br></pre></td></tr></table></figure></li><li><p>使用的时候只要在docker-compose.yml目录下键入如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compse up -d</span><br></pre></td></tr></table></figure></li><li><p>Kafka管理器界面：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/9dc0086c6be668e992dc205683065b33-19922" alt="Kafka管理界面"></p></li><li><p>添加Kafka集群管理，按照下图配置即可，其他的保持默认即可：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/85458fa87843fbf70c87b603d3a78fa8-99994" alt="添加Kafka集群"></p></li><li><p>Brokers展示：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/f4b02377c8e40f08a10acb5d283d51ea-86405" alt="Brokers展示"></p></li></ol><h2 id="SpringBoot快速接入Kafka"><a href="#SpringBoot快速接入Kafka" class="headerlink" title="SpringBoot快速接入Kafka"></a>SpringBoot快速接入Kafka</h2><ol><li><p>在项目中添加Kafka依赖(pom.xml)：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-kafka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>配置文件添加：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#kafka默认消费者配置 </span></span><br><span class="line"><span class="meta">spring.kafka.consumer.bootstrap-servers</span>=<span class="string">127.0.0.1:9092,127.0.0.1:9093</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.enable-auto-commit</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.auto-offset-reset</span>=<span class="string">earliest</span></span><br><span class="line"><span class="comment">#kafka默认生产者配置</span></span><br><span class="line"><span class="meta">spring.kafka.producer.bootstrap-servers</span>=<span class="string">127.0.0.1:9092,127.0.0.1:9093</span></span><br><span class="line"><span class="meta">spring.kafka.producer.acks</span>=<span class="string">-1</span></span><br><span class="line"><span class="meta">spring.kafka.client-id</span>=<span class="string">kafka-producer</span></span><br><span class="line"><span class="meta">spring.kafka.producer.batch-size</span>=<span class="string">5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.kafka.producer.key-serializer</span>=<span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br><span class="line"><span class="meta">spring.kafka.producer.value-serializer</span>=<span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br></pre></td></tr></table></figure></li><li><p>添加Kafka配置代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaProducerConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.kafka.producer.bootstrap-servers&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String bootstrapServer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* --------------producer configuration-----------------**/</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">producerConfigs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServer);</span><br><span class="line">        props.put(ProducerConfig.RETRIES_CONFIG, <span class="number">0</span>);</span><br><span class="line">        props.put(ProducerConfig.BATCH_SIZE_CONFIG, <span class="number">16384</span>);</span><br><span class="line">        props.put(ProducerConfig.LINGER_MS_CONFIG, <span class="number">1</span>);</span><br><span class="line">        props.put(ProducerConfig.BUFFER_MEMORY_CONFIG, <span class="number">33554432</span>);</span><br><span class="line">        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> props;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProducerFactory&lt;String, Object&gt; <span class="title">producerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* --------------kafka template configuration-----------------**/</span></span><br><span class="line">    <span class="meta">@Bean</span>(value = <span class="string">"kafkaTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> KafkaTemplate&lt;String, Object&gt; <span class="title">kafkaTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KafkaTemplate&lt;String, Object&gt; kafkaTemplate = <span class="keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());</span><br><span class="line">        <span class="keyword">return</span> kafkaTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建TopicName为topic.wander.initial的Topic并设置分区数为10以及副本数为1</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NewTopic <span class="title">initialTopic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NewTopic(<span class="string">"topic.wander.initial"</span>,<span class="number">10</span>, (<span class="keyword">short</span>) <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.kafka.consumer.bootstrap-servers&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String kafkaServers;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AdminClient <span class="title">adminClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">//配置Kafka实例的连接地址</span></span><br><span class="line">        props.put(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaServers);</span><br><span class="line">        <span class="keyword">return</span> AdminClient.create(props);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>添加kafka监听器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaMessageReceiver2</span> </span>&#123;</span><br><span class="line">    <span class="comment">//指定监听的topic，当前消费者组id</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate kafkaTemplate;</span><br><span class="line">    <span class="meta">@KafkaListener</span>(id = <span class="string">"myListener1"</span>,topicPartitions =&#123;<span class="meta">@TopicPartition</span>(topic = <span class="string">"da"</span>, partitions = &#123; <span class="string">"0"</span>&#125;)&#125;,groupId = <span class="string">"group1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registryReceiver</span><span class="params">(ConsumerRecord&lt;Integer, String&gt; integerStringConsumerRecords)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"consume da "</span>+integerStringConsumerRecords.value());</span><br><span class="line">      <span class="comment">//  kafkaTemplate.send("TEST",integerStringConsumerRecords.value());</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//指定监听的topic，当前消费者组id</span></span><br><span class="line">    <span class="meta">@KafkaListener</span>(id = <span class="string">"myListener2"</span>,topicPartitions =&#123;<span class="meta">@TopicPartition</span>(topic = <span class="string">"db"</span>, partitions = &#123; <span class="string">"0"</span>&#125;)&#125;,groupId = <span class="string">"group1"</span>)</span><br><span class="line">  <span class="comment">//  @SendTo("DC2")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registryReceiver2</span><span class="params">(ConsumerRecord&lt;Integer, String&gt; integerStringConsumerRecords)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"consume db "</span>+integerStringConsumerRecords.value());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//指定监听的topic，当前消费者组id</span></span><br><span class="line">    <span class="meta">@KafkaListener</span>(topicPartitions =&#123;<span class="meta">@TopicPartition</span>(topic = <span class="string">"dc"</span>, partitions = &#123; <span class="string">"0"</span>&#125;)&#125;,groupId = <span class="string">"group1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registryReceiver3</span><span class="params">(ConsumerRecord&lt;Integer, String&gt; integerStringConsumerRecords)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"consume dc "</span>+integerStringConsumerRecords.value());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//指定监听的topic，当前消费者组id</span></span><br><span class="line">    <span class="meta">@KafkaListener</span>(topicPartitions =&#123;<span class="meta">@TopicPartition</span>(topic = <span class="string">"d9"</span>, partitions = &#123; <span class="string">"0"</span>&#125;)&#125;,groupId = <span class="string">"group1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registryReceiver4</span><span class="params">(ConsumerRecord&lt;Integer, String&gt; integerStringConsumerRecords)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"consume d9 "</span>+integerStringConsumerRecords.value());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在启动类上添加注解@EnableKafka：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableKafka</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafakaproviderApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(KafakaproviderApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建一个控制器添加消息发送：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, Object&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"监听器发送消息!"</span>);</span><br><span class="line">        kafkaTemplate.send(<span class="string">"da"</span>, <span class="string">"1条测试消息"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动项目即可。访问<a href="http://localhost:8080/test，然后监听器就能收到消息！" target="_blank" rel="noopener">http://localhost:8080/test，然后监听器就能收到消息！</a></p></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Kafka上手是有点难度的，这里只是简单的快速入门，还需要深入学习！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;Apache Kafka是一个开源消息系统，由Scala写成。Kafka是一个分布式消息队列：生产者、消费者的功能，提供了类似于JMS的特性
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="https://wanderros.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>Jenkins Quick Start</title>
    <link href="https://wanderros.github.io/2020/08/22/Jenkins-Quick-Start/"/>
    <id>https://wanderros.github.io/2020/08/22/Jenkins-Quick-Start/</id>
    <published>2020-08-22T04:15:48.000Z</published>
    <updated>2020-10-01T08:52:15.873Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Jenkins是一个开源的、提供友好操作界面的持续集成(CI)工具，主要用于持续、自动的构建/测试软件项目、监控外部任务的运行。Jenkins用Java语言编写，可在Tomcat等流行的servlet容器中运行，也可独立运行。通常与版本管理工具(SCM)、构建工具结合使用。开发工作流程一般划分为：编码 → 构建 → 集成 → 测试 → 交付 → 部署。整个流程中快速进行编码 → 构建 → 集成这个过程的时候如果使用了像Jenkins这种工具的话，开发的效率以及代码的质量相对来说会提高很多。这部分主要记录如何快速搭建Jenkins环境以及如何使用Jenkins构建SpringBoot项目！</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li><p>持续集成（Continuous Integration，CI）指的是将软件个人研发的部分向软件整体部分交付，频繁进行集成以便更快地发现其中的错误；</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/8b4508b66d3c33e06a1632072019daa5-54359" alt="CI"></p></li><li><p>CI的好处：</p><ul><li>快速发现错误，定位错误也比较容易</li><li>防止分支大幅偏离主干。如果不是经常集成，主干又在不断更新，会导致以后集成的难度变大，甚至难以集成</li></ul></li><li><p>CI的目的：CI并不能消除Bug，而是让Bug非常容易发现和改正。让产品可以快速迭代，同时还能保持高质量；</p></li><li><p>CI的核心措施：代码集成到主干之前，必须通过自动化测试。只要有一个测试用例失败，就不能集成；</p></li><li><p>持续交付（Continuous Delivery，CD）指的是频繁地将软件的新版本，交付给质量团队或者用户，以供评审。如果评审通过，代码就进入生产阶段。持续交付在持续集成的基础上，将集成后的代码部署到更贴近真实运行环境的类生产环境中，持续交付优先于整个产品生命周期的软件部署，建立在高水平自动化持续集成之上；</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/cc7372ca51780017d8a758454cd19389-97226" alt="CI/CD"></p></li><li><p>CD的目的：不管软件代码怎么更新，软件是随时随地可以交付的、可以进入生产阶段的；</p></li><li><p>CD的前提：能自动化完成测试、构建、部署等步骤；</p></li><li><p>常用的构建工具有：</p><ul><li>Jenkins</li><li>Travis</li><li>Codeship</li><li>Strider</li></ul></li><li><p>Jenkins是一个开源的、可扩展的持续集成、交付、部署（软件/代码的编译、打包、部署）的基于web界面的平台；</p></li><li><p>Jenkins特性：</p><ul><li>基于java语言开发的开源持续集成工具，支持CI，CD</li><li>易于安装部署配置</li><li>消息通知及测试报告</li><li>分布式构建</li><li>文件识别，能够跟踪哪次构建生成哪些jar，哪次构建使用哪个版本的jar等</li><li>丰富的插件支持</li></ul></li><li><p>Jenkins的中文官网：<a href="https://www.jenkins.io/zh/" target="_blank" rel="noopener">https://www.jenkins.io/zh/</a></p></li></ol><h2 id="Jenkins项目配置基础"><a href="#Jenkins项目配置基础" class="headerlink" title="Jenkins项目配置基础"></a>Jenkins项目配置基础</h2><h3 id="general"><a href="#general" class="headerlink" title="general"></a>general</h3><ol><li>项目名称：创建任务时设置的，用于区分任务；</li><li>描述: 对构建任务的描述；</li><li>丢弃旧的构建：服务器资源是有限的，有时候保存了太多的历史构建，会导致Jenkins速度变慢，并且服务器硬盘资源也会被占满。”保持构建天数” 和”保持构建的最大个数”是可以自定义的，需要根据实际情况确定一个合理的值；</li></ol><h3 id="源码管理"><a href="#源码管理" class="headerlink" title="源码管理"></a>源码管理</h3><ol><li>配置代码的存放位置；</li><li>Git: 支持主流的github 和gitlab代码仓库；</li><li>Repository URL：仓库地址；</li><li>Credentials：凭证，可以使用HTTP方式的用户名密码，也可以是RSA文件；</li><li>Branches to build：构建的分支。*/master表示master分支，也可以设置为其他分支；</li><li>源码浏览器：所使用的代码仓库管理工具，如github, gitlab；</li><li>URL：填入上方的仓库地址即可；</li><li>Version: gitlab服务器的版本；</li></ol><h3 id="构建触发器"><a href="#构建触发器" class="headerlink" title="构建触发器"></a>构建触发器</h3><ol><li>触发远程构建：该选项会提供一个接口，可以用来在代码层面触发构建；</li><li>Build after other projects are built：在其他projects构建后构建；</li><li>Build periodically： 周期性的构建。日程表类似linux crontab书写格式；</li><li>Build when a change is pushed to GitLab：当有更改push到gitlab代码仓库，即触发构建。GitLab的Web Hooks来触发构建；</li><li>Poll SCM：周期性的去检查代码仓库是否发生改动；</li></ol><h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><ol><li>Eexcute shell：执行shell命令，该工具是针对linux环境的，windows环境也有对应的工具”Execute Windows batch command”；</li><li>Invoke Ant：Ant是一款java项目构建工具；</li><li>Send files or execute commands over SSH：发送文件到远程主机或执行命令(脚本)！</li></ol><h3 id="构建状态"><a href="#构建状态" class="headerlink" title="构建状态"></a>构建状态</h3><ul><li>Successful蓝色：构建完成，并且被认为是稳定的</li><li>Unstable黄色：构建完成，但被认为是不稳定的</li><li>Failed红色：构建失败</li><li>Disable灰色：构建已禁用</li></ul><h3 id="构建稳定性"><a href="#构建稳定性" class="headerlink" title="构建稳定性"></a>构建稳定性</h3><ul><li>构建稳定性用天气表示</li><li>晴、晴转多云、多云、小雨、雷阵雨</li><li>天气越好表示构建越稳定，反之亦然</li></ul><h2 id="Docker搭建Jenkins环境（版本2-253）"><a href="#Docker搭建Jenkins环境（版本2-253）" class="headerlink" title="Docker搭建Jenkins环境（版本2.253）"></a>Docker搭建Jenkins环境（版本2.253）</h2><ol><li><p>查看DockerHub上有哪些版本的jenkins：<a href="https://hub.docker.com/r/jenkins/jenkins/tags" target="_blank" rel="noopener">https://hub.docker.com/r/jenkins/jenkins/tags</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/41fe5ab3e8f42706fc1aae2d46ed6338-224724" alt="Docker Jenkins Tags"></p><ul><li><p>官方支持很多Tag的Jenkins，默认的latest版本支持jdk-8</p></li><li><p>选择jdk11标签的版本以匹配自己的开发环境</p></li><li><p>下载镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins/jenkins:jdk11</span><br></pre></td></tr></table></figure></li></ul></li><li><p>创建一个工作目录，用于存放docker-compose.yml文件以及jenkins数据，这里创建的目录是/Users/wander/docker/jenkins，并且创建了docker-compose.yml以及jenkins_data目录；</p></li><li><p>编辑docker-compose.yml，内容如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">jenkins:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">jenkins/jenkins:jdk11</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"/Users/wander/docker/jenkins/jenkins_data:/var/jenkins_home"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"/Volumes/Data/Java_Env/apache-maven-3.6.3:/usr/apache-maven-3"</span></span><br></pre></td></tr></table></figure><ul><li>挂载了数据目录以及apache-maven-3.6.3目录，其中apache-maven-3.6.3目录是本地的管理工具Maven目录</li><li>jdk11的目录不需要挂载本地的，因为docker环境是jdk11的，可以直接使用</li></ul></li><li><p>启动docker-compose.yml，命令如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compse up -d</span><br></pre></td></tr></table></figure></li><li><p>等待容器启动完成，然后访问<a href="http://localhost:8080：">http://localhost:8080：</a></p><ul><li><p>正在初始化</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/d10d9814c067808d1ab4c71f446ba161-104509" alt="jenkins正在初始化"></p></li><li><p>解锁jenkins：在jenkins_data目录下的secrets目录下的initialAdminPassword文件中有管理员原始密码</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/0c6dd00343a8c0e0c0e065a7e0a86e40-228990" alt="解锁jenkins"></p></li><li><p>插件安装：（暂时不要点击，修改配置文件，不然下载速度太慢）</p></li></ul></li><li><p>停止容器，然后修改jenkins_data目录下的updates目录下default.json文件：</p><ul><li><p>使用vim编辑文件，替换所有插件的下载url：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:1,$s/https:\/\/updates.jenkins.io\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g</span><br></pre></td></tr></table></figure></li><li><p>使用vim编辑文件，替换所有插件的测试url：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:1,$s/http:\/\/www.google.com/https:\/\/www.baidu.com/g</span><br></pre></td></tr></table></figure></li><li><p>保存，然后重启容器，按照推荐的下载插件</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/744ef30a52f825964a282dc5f686fa8e-129604" alt="下载插件"></p></li></ul></li><li><p>下载完成推荐的插件之后就可以创建账户了：</p><ul><li><p>创建账户：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/1b8647a710930b2c9f6a3946c1258cf2-37993" alt="创建账户"></p></li><li><p>实例配置：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/906de5691549ee34b2282c54f8a8a6f5-56961" alt="实例配置"></p></li></ul></li><li><p>默认配置好的jenkins还不支持SpringBoot项目的构建，需要一些配置工作：</p><ul><li><p>在插件管理里搜索maven并安装：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/2be284e04d07dd346dc915f68166b8b9-116310" alt="搜索maven"></p></li><li><p>配置工具中的JDK配置：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/f26f84ecd210a2d8df41eb0691c26871-50648" alt="配置JDK"></p></li><li><p>配置工具中的Maven配置：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/6f091f656547425819b9f6ebd189a811-64430" alt="配置Maven"></p></li><li><p>应用并保存配置即可</p></li><li><p>注意：这些地址根据之前的配置进行填，不知道的话可以使用which java等命令确定位置</p></li></ul></li><li><p>Jenkins时区和时间设置，在【系统管理】-【脚本命令行】里运行如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty('org.apache.commons.jelly.tags.fmt.timeZone', 'Asia/Shanghai')</span><br></pre></td></tr></table></figure><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/119b110cc4382e00fc69b2057e7abaa7-97316" alt="时区设置"></p></li><li><p>安装插件Publish Over SSH：</p><ul><li>在插件安装中搜索Publish Over SSH，然后安装</li><li>该插件是可以通过SSH命令部署服务</li></ul></li></ol><h2 id="Jenkins配置GitHub"><a href="#Jenkins配置GitHub" class="headerlink" title="Jenkins配置GitHub"></a>Jenkins配置GitHub</h2><ol><li><p>在Jenkins的配置中心添加GitHub服务，直接连接测试效果如下：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/e5efc6df291facef4d1bf0cc718d5186-62962" alt="Jenkins连接github测试"></p></li><li><p>创建GitHub凭证，使用Secret text，需要填写Secret，这个要在GitHub中申请：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/34889c4e3f43c57205855568e719b107-50289" alt="jenkins凭证"></p></li><li><p>在GitHub中的【设置】-【开发者设置】-【个人权限令牌】中生成令牌：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/b10bfb98a189a17cc99f0c7acaf6770d-287790" alt="GitHub令牌"></p></li><li><p>配置凭证之后验证：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/6b76ac1235eafa984e77973fd4e1be05-53053" alt="验证github"></p></li><li><p>新建一个使用github仓库的maven项目：</p><ul><li><p>创建任务：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/507b34fb9942ad6dc91c8aeeae432748-184147" alt="创建任务"></p></li><li><p>通用配置：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/99eea970581cf25582e61ac7886a04c7-61426" alt="通用配置"></p></li><li><p>源码管理：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/8f378a9e476ba41087a4d9df31b9656f-63192" alt="源码管理"></p><ul><li>注意添加自己的账户和密码凭证</li></ul></li><li><p>其他配置后续再解释</p></li></ul></li><li><p>配置完成之后保存，然后点击立即构建，然后查看控制台的输出：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/6e1c9292c6b11797a062d1a2956d5ec2-238590" alt="控制台输出"></p></li><li><p>配置GitHub的Webhook自动触发Jenkins项目构建：</p><ul><li><p>全局配置Jenkins的HookURL：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/061c0600516e385088c95124c5adcc58-69411" alt="全局配置Jenkins的HookURL"></p></li><li><p>配置项目的Hook：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/654ba7746fece889a08f0e637fa7a141-74112" alt="配置项目的Hook"></p></li><li><p>在GitHub项目中的设置中配置Webhooks，添加对应的地址即可</p></li><li><p>修改源码之后进行push到master分支之后就会触发构建操作</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/c706b18f1f5962bad739aa09567fb566-57781" alt="WebHook构建成功"></p></li></ul></li></ol><h2 id="Publish-Over-SSH配置"><a href="#Publish-Over-SSH配置" class="headerlink" title="Publish Over SSH配置"></a>Publish Over SSH配置</h2><ol><li><p>在搭建环境的时候直接配置下载Publish Over SSH插件了，这里不再进行搜索啥的截图了；</p></li><li><p>进入Jenkins容器中生成ssh秘钥对：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it [容器ID] bash</span><br><span class="line"></span><br><span class="line">ssh-keygen  -t rsa  -C &quot;wangsp14@midea.com&quot;</span><br></pre></td></tr></table></figure></li><li><p>在Jenkins的【管理Jenkins】-【Configure System】-【Publish Over SSH】进行配置：</p><ul><li><p>添加私钥：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/506970b21d5e5e2887a2de720a3c58de-166694" alt="将生成的私钥添加到配置中"></p></li><li><p>添加SSH服务器：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/d44be829a2d05e68c41f395ab30e5ccd-80809" alt="添加SSH服务器"></p></li><li><p>注意要将jenkins的公钥拷贝到SSH服务器的authorized_keys文件中</p></li><li><p>可以测试连接状况</p></li></ul></li><li><p>在项目中添加远程部署：</p><ul><li><p>远程部署配置：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/c37c1916d9970e274db68cd9e9dddb48-180606" alt="ssh远程部署配置"></p></li><li><p>Exec Command如下（非通用）：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kill -9 `ps -ef | grep java | grep web | grep -v grep | awk '&#123;print $2&#125;'`</span><br><span class="line">sh /Users/wander/jenkins/start.sh</span><br></pre></td></tr></table></figure></li><li><p>start.sh脚本如下（非通用）：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">/usr/bin/nohup /usr/<span class="built_in">local</span>/Cellar/openjdk@11/11.0.8/bin/java -jar /Users/wander/jenkins/web-0.0.1-SNAPSHOT.jar 2&gt;file1 1&gt;file1 &amp;</span><br></pre></td></tr></table></figure></li><li><p>为了防止创建新目录，勾选Flatten files选项</p></li></ul></li><li><p>点击构建项目或者使用WebHooks修改源码之后自动构建之后就会将jar包拷贝到SSH服务器中，并且自动运行项目：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/e3d4a70cd820f8d2f0e82d289fb6e55a-15533" alt="SSH服务器文件"></p></li></ol><h2 id="Jenkins配置GitLab"><a href="#Jenkins配置GitLab" class="headerlink" title="Jenkins配置GitLab"></a>Jenkins配置GitLab</h2><ol><li><p>GitLab和Jenkins使用过程：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/219147e7ecd12aa47e99bf923b264f49-48796" alt="GitLab和Jenkins使用过程"></p></li><li><p>搜索并安装GitLab插件：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/eeb91ac5e412a1b3b65f52265ab41aac-255425" alt="GitLab插件"></p></li><li><p>在Jenkins的【管理Jenkins】-【Configure System】-【Gitlab】进行配置：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/7a144a4e5cbcb85b19645e2842097add-162382" alt="Gitlab配置"></p></li><li><p>GitLab生成令牌（API Token）：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/49d019c771a4b5df0edeeb235fcc4d6a-411279" alt="GitLab生成令牌"></p></li><li><p>Jenkin添加GitLab凭证：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/4774481ba42a00a11ac5281d83759937-139812" alt="添加GitLab凭证"></p></li><li><p>测试GitLab通信：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/422e2da24994892d28a7bb43d7555879-125410" alt="测试GitLab通信"></p></li><li><p>创建项目和GitHub的过程类似，然后就是源码管理需要添加账户认证：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/9aed4656f2c3194c8a7f26b416704900-123421" alt="GitLab账户认证"></p><ul><li>可以添加源码浏览器</li></ul></li><li><p>Webhooks的配置有一个选项，如下所示，过程和GitHub的配置类似，后续过程不再添加说明</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/3e8e72189da5cc3df689f6b56f6c10e5-202968" alt="GitLab WebHooks"></p></li><li><p>GitLab完整过程：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/c3436be72129e7e64281c9d29db5d963-575892" alt="GitLab完整过程"></p></li></ol><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul><li><p>默认的邮件通知只支持异常构建，可以添加插件Email Extension Plugin来通知，搜索插件：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/0d7d9848774acef0cecedee8bbd826a5-105431" alt="Email Extension Plugin"></p></li><li><p>破解管理员密码：如果忘记了管理员密码可以修改users目录下的用户子目录下的config.xml，修改其中的passwordHash字段，然后重启：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">passwordHash</span>&gt;</span>#jbcrypt:$2a$10$eJAMBW3qb/ijrFsSxkJnDOB747e0mFWSR03UmLCn96E4N7vL5BYzC<span class="tag">&lt;/<span class="name">passwordHash</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>重启之后的密码为123456，然后重新设置密码即可</li></ul></li><li><p>jenkins思维导图：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/3a7c3b3321b3aaed8f1b2397692f06b5-224591" alt="jenkins思维导图"></p></li></ul><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><strong>Jenkins中文社区：</strong><a href="http://jenkins-zh.cn/" target="_blank" rel="noopener">http://jenkins-zh.cn/</a></li><li><strong>Jenkins中文网：</strong><a href="http://www.jenkins.org.cn/" target="_blank" rel="noopener">http://www.jenkins.org.cn/</a></li></ul><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>随着软件开发复杂度的不断提高，团队开发成员间如何更好地协同工作以确保软件开发的质量已经慢慢成为开发过程中不可回避的问题。敏捷（Agile） 在软件工程领域越来越红火，如何能再不断变化的需求中快速适应和保证软件的质量也显得尤其的重要！CI倡导团队开发成员必须经常集成代码，甚至每天都可能发生多次集成，搭建Jenkins环境就显得尤为重要，这部分只能算是一个起步，还需要不断地阅读与探索！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;Jenkins是一个开源的、提供友好操作界面的持续集成(CI)工具，主要用于持续、自动的构建/测试软件项目、监控外部任务的运行。Jenkin
      
    
    </summary>
    
    
      <category term="Jenkins" scheme="https://wanderros.github.io/categories/Jenkins/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringCloud服务链路追踪</title>
    <link href="https://wanderros.github.io/2020/08/18/SpringCloud%E6%9C%8D%E5%8A%A1%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/"/>
    <id>https://wanderros.github.io/2020/08/18/SpringCloud%E6%9C%8D%E5%8A%A1%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/</id>
    <published>2020-08-18T07:25:04.000Z</published>
    <updated>2020-10-01T08:52:15.922Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>微服务架构是通过业务来划分服务的，应用之间通过REST调用，对外则暴露的一个接口，可能需要很多个服务协同才能完成这个接口功能。如果链路上任何一个服务出现问题或者网络超时，都会导致接口调用失败，随着业务的不断扩张，服务之间互相调用会越来越复杂，定位出现问题的服务就越来越复杂，因此在微服务架构中非常需要进行链路追踪。在SpringCloud中使用SpringCloud Sleuth来提供分布式系统的链路追踪，本文将进行这部分的内容的记录。</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><ol><li>SpringBoot版本：2.3.3</li><li>SpringCloud版本：Hoxton.SR7</li><li>IDEA版本：2019.02</li><li>Maven版本：3.6.3</li></ol><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li><p>微服务现状：</p><ul><li>随着业务的发展，单体架构变为微服务架构，并且系统规模也变得越来越大，各微服务间的调用关系也变得越来越复杂</li><li>在微服务的应用中，一个由客户端发起的请求在后端系统中会经过多个不同的微服务调用来协同产生最后的请求结果</li><li>在复杂的微服务架构系统中，几乎每一个前端请求都会形成一个复杂的分布式服务调用链路，在每条链路中任何一个依赖服务出现延迟超时或者错误都有可能引起整个请求最后的失败</li></ul></li><li><p>微服务跟踪(sleuth)在整个分布式系统中能跟踪一个用户请求的过程(包括数据采集，数据传输，数据存储，数据分析，数据可视化)，捕获这些跟踪数据，就能构建微服务的整个调用链的视图！</p></li><li><p>SpringCloud Sleuth特点：</p><table><thead><tr><th>特点</th><th>说明</th></tr></thead><tbody><tr><td>提供链路追踪</td><td>通过sleuth可以很清楚的看出一个请求经过了哪些服务， 可以方便的理清服务间的调用关系</td></tr><tr><td>性能分析</td><td>通过sleuth可以很方便的看出每个请求的耗时， 分析出哪些服务调用比较耗时，当服务调用的耗时随着请求量的增大而增大时，也可以对服务的扩容提供一定的提醒作用</td></tr><tr><td>数据分析优化链路</td><td>对于频繁地调用一个服务或者并行地调用等， 可以针对业务做一些优化措施</td></tr><tr><td>可视化</td><td>对于程序未捕获的异常，可以在zipkpin界面上看到</td></tr></tbody></table></li><li><p>SpringCloud Sleuth官网文档地址：<a href="https://docs.spring.io/spring-cloud-sleuth/docs/current-SNAPSHOT/reference/html/#overview" target="_blank" rel="noopener">https://docs.spring.io/spring-cloud-sleuth/docs/current-SNAPSHOT/reference/html/#overview</a></p></li><li><p>调用链路：一个请求过来，调用服务，一条链路通过Trace Id唯一标识，Span标识发起的请求，各Span通过parent id关联起来</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/aca290210457f33d8488424c5bcfc16d-84961" alt="调用链路"></p></li><li><p>zipkin的作用：</p><ul><li>zipkin为分布式链路调用监控系统，聚合各业务系统调用延迟数据，达到链路调用监控跟踪</li><li>zipkin通过采集跟踪数据可以帮助开发者深入了解在分布式系统中某一个特定的请求时如何执行的。假如现在有一个用户请求超时，就可以将这个超时的请求调用链展示在界面当中，可以很快度的定位到导致响应很慢的服务究竟是什么，如果对这个服务细节也很很清晰，那么还可以定位是服务中的哪个问题导致超时</li><li>zipkin系统让开发者可通过一个Web前端轻松的收集和分析数据，例如用户每次请求服务的处理时间等，可方便的监测系统中存在的瓶颈</li></ul></li><li><p>zipkin核心数据结构：</p><ul><li>Span——一次链路调用 (可以是RPC，DB等没有特定的限制) 创建一个span，通过一个64位ID标识</li><li>Trace——类似于树结构的Span集合，表示一条调用链路，存在唯一标识traceId</li><li>Annotation——用于定位一个request的开始和结束，cs/sr/ss/cr含有额外的信息<ul><li>cs（Client Start）表示客户端发起请求一个span的开始</li><li>sr（Server Receive）表示服务端收到请求</li><li>ss（Server Send）表示服务端完成处理，并将结果发送给客户端</li><li>cr（Client Received）表示客户端获取到服务端返回信息一个span的结束</li></ul></li><li>BinaryAnnotation——用于提供一些额外信息</li></ul></li></ol><h2 id="动手实操"><a href="#动手实操" class="headerlink" title="动手实操"></a>动手实操</h2><h3 id="ZipkinServer"><a href="#ZipkinServer" class="headerlink" title="ZipkinServer"></a>ZipkinServer</h3><ol><li><p>官方不推荐自己搭建ZipkinServer，推荐下载jar包或者Docker进行ZipkinServer的部署；</p></li><li><p>Jar包下载地址：<code>https://dl.bintray.com/openzipkin/maven/io/zipkin/zipkin-server/</code>，下载带有exec字段的jar包在本地运行。比如下载的zipkin-server-2.21.6-exec.jar；</p></li><li><p>直接运行jar包，默认端口9411：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar zipkin-server-2.21.6-exec.jar</span><br></pre></td></tr></table></figure><ul><li><p>输出信息：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">                  oo</span><br><span class="line">                 oooo</span><br><span class="line">                oooooo</span><br><span class="line">               oooooooo</span><br><span class="line">              oooooooooo</span><br><span class="line">             oooooooooooo</span><br><span class="line">           ooooooo  ooooooo</span><br><span class="line">          oooooo     ooooooo</span><br><span class="line">         oooooo       ooooooo</span><br><span class="line">        oooooo   o  o   oooooo</span><br><span class="line">       oooooo   oo  oo   oooooo</span><br><span class="line">     ooooooo  oooo  oooo  ooooooo</span><br><span class="line">    oooooo   ooooo  ooooo  ooooooo</span><br><span class="line">   oooooo   oooooo  oooooo  ooooooo</span><br><span class="line">  oooooooo      oo  oo      oooooooo</span><br><span class="line">  ooooooooooooo oo  oo ooooooooooooo</span><br><span class="line">      oooooooooooo  oooooooooooo</span><br><span class="line">          oooooooo  oooooooo</span><br><span class="line">              oooo  oooo</span><br><span class="line"></span><br><span class="line">     ________ ____  _  _____ _   _</span><br><span class="line">    |__  /_ _|  _ \| |/ /_ _| \ | |</span><br><span class="line">      / / | || |_) | ' / | ||  \| |</span><br><span class="line">     / /_ | ||  __/| . \ | || |\  |</span><br><span class="line">    |____|___|_|   |_|\_\___|_| \_|</span><br><span class="line"></span><br><span class="line">:: version 2.21.6 :: commit 263c266 ::</span><br><span class="line"></span><br><span class="line">2020-08-18 15:40:54.690  INFO 15507 --- [oss-http-*:9411] c.l.a.s.Server                           : Serving HTTP at /0:0:0:0:0:0:0:0:9411 - http://127.0.0.1:9411/</span><br></pre></td></tr></table></figure></li><li><p>界面如下：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/72da12603ce4232ac0671714a8f113b5-189879" alt="zipkin界面"></p></li></ul></li><li><p>Jar包运行参数设置：</p><ul><li><p>端口设置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar zipkin-server-2.21.6-exec.jar --server.port=8080</span><br></pre></td></tr></table></figure></li><li><p>RabbitMQ配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar zipkin-server-2.21.6-exec.jar --zipkin.collector.rabbitmq.addresses=192.168.3.108:5672 --zipkin.collector.rabbitmq.username=admin --zipkin.collector.rabbitmq.password=admin</span><br></pre></td></tr></table></figure></li></ul></li><li><p>Docker镜像下载：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull openzipkin/zipkin</span><br></pre></td></tr></table></figure></li><li><p>Docker运行zipkin Server镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name zipkin -d -p 9411:9411 openzipkin/zipkin</span><br></pre></td></tr></table></figure><ul><li><p>带有RabbitMQ参数的运行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name zipkin -d -p 9411:9411 -e RABBIT_ADDRESSES=192.168.3.108:5672 -e RABBIT_USER=admin -e RABBIT_PASSWORD=admin openzipkin/zipkin</span><br></pre></td></tr></table></figure></li><li><p>RabbitMQ服务器运行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5672:5672 -p 15672:15672 -e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=admin --name rabbit rabbitmq:management</span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="添加Sleuth以及zipkin支持"><a href="#添加Sleuth以及zipkin支持" class="headerlink" title="添加Sleuth以及zipkin支持"></a>添加Sleuth以及zipkin支持</h3><ol><li><p>在SpringCloud Eureka的基础上添加SpringCloud Sleuth支持，添加依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-sleuth-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>添加配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">percentage:</span> <span class="number">1.0</span> <span class="comment"># 默认0.1</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://127.0.0.1:9411</span></span><br><span class="line">    <span class="attr">sender:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">web</span></span><br></pre></td></tr></table></figure></li><li><p>配置完成重启项目之后日志输出类似下面：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2020-08-18 16:38:56.940 DEBUG [eureka,0907db10d1a6f2ae,0907db10d1a6f2ae,true] 24816 --- [io-8761-exec-10] c.n.e.r.r.AlwaysMatchInstanceStatusRule  : Returning the default instance status UP for instance 10.157.14.39:configserver</span><br><span class="line">2020-08-18 16:38:56.940 DEBUG [eureka,0907db10d1a6f2ae,0907db10d1a6f2ae,true] 24816 --- [io-8761-exec-10] c.n.eureka.resources.InstanceResource    : Found (Renew): CONFIGSERVER - 10.157.14.39:configserver; reply status=200</span><br><span class="line">2020-08-18 16:38:56.941 DEBUG [eureka,0907db10d1a6f2ae,0907db10d1a6f2ae,true] 24816 --- [io-8761-exec-10] o.s.s.w.header.writers.HstsHeaderWriter  : Not injecting HSTS header since it did not match the requestMatcher org.springframework.security.web.header.writers.HstsHeaderWriter$SecureRequestMatcher@4b54c259</span><br><span class="line">2020-08-18 16:38:56.941 DEBUG [eureka,0907db10d1a6f2ae,0907db10d1a6f2ae,true] 24816 --- [io-8761-exec-10] o.s.s.w.a.ExceptionTranslationFilter     : Chain processed normally</span><br><span class="line">2020-08-18 16:38:56.941 DEBUG [eureka,0907db10d1a6f2ae,0907db10d1a6f2ae,true] 24816 --- [io-8761-exec-10] s.s.w.c.SecurityContextPersistenceFilter : SecurityContextHolder now cleared, as request processing completed</span><br></pre></td></tr></table></figure></li><li><p>使用consumer接口调用服务，然后刷新zipkin Server接口获得效果如下：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/cd051ef43402ca06888e53d467fb16b5-132327" alt="Zipkin追踪"></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/18b8261fb3f04e5ac7557732a19c203e-249606" alt="链路详情"></p></li><li><p>配置RabbitMQ的话，需要做如下改动：</p><ul><li><p>添加RabbitMQ依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>修改配置文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sleuth:</span></span><br><span class="line">  <span class="attr">sampler:</span></span><br><span class="line">    <span class="attr">percentage:</span> <span class="number">1.0</span></span><br><span class="line"><span class="attr">zipkin:</span></span><br><span class="line">  <span class="attr">sender:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">rabbit</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">queue:</span> <span class="string">zipkin</span></span><br><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">  <span class="attr">listener:</span></span><br><span class="line">    <span class="attr">direct:</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">simple:</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li></ul></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>虽然实现了链路追踪，但是具体的使用还是以实际工程展现优势！仅仅在测试过程中使用并没有感觉到太大的用处，但是这部分的功能应该是非常重要的！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;微服务架构是通过业务来划分服务的，应用之间通过REST调用，对外则暴露的一个接口，可能需要很多个服务协同才能完成这个接口功能。如果链路上任何
      
    
    </summary>
    
    
      <category term="SpringCloud" scheme="https://wanderros.github.io/categories/SpringCloud/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringCloud Hystrix仪表盘</title>
    <link href="https://wanderros.github.io/2020/08/18/SpringCloud-Hystrix%E4%BB%AA%E8%A1%A8%E7%9B%98/"/>
    <id>https://wanderros.github.io/2020/08/18/SpringCloud-Hystrix%E4%BB%AA%E8%A1%A8%E7%9B%98/</id>
    <published>2020-08-18T01:28:45.000Z</published>
    <updated>2020-10-01T08:52:15.920Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>在微服务架构中，为了保证微服务的高可用性，防止服务出现故障导致线程阻塞，而出现了熔断器模型，熔断器的状况反应了某个程序的可用性和健壮性。在SpringCloud中经常用到的熔断器组件是Hystrix，Hystrix的基础使用在SpringCloud Eureka Quick Start中已有涉及。Hystrix仪表盘（Hystrix Dashboard）是监控Hystrix的熔断器状况的一个组件，提供了数据监控和友好的图形化展示界面，这部分主要记录如何使用Hystrix Dashboard。</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><ol><li>SpringBoot版本：2.3.3</li><li>SpringCloud版本：Hoxton.SR7</li><li>IDEA版本：2019.02</li><li>Maven版本：3.6.3</li></ol><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li>Hystrix提供了对于微服务调用状态的监控信息，Hystrix Dashboard提供了断路器的监控面板，可以更好的监控服务和集群的状态。</li><li>功能：Hystrix Dashboard主要用来实时监控Hystrix的各项指标信息。通过Hystrix Dashboard反馈的实时信息，可以快速发现系统中存在的问题！</li><li>访问被@HystrixCommand注解的接口时，都会记录是否成功以及最近10s错误百分比、超时数、熔断数、线程拒绝数、错误请求数、失败/异常数、服务请求频率等相关信息；</li><li>Hystrix DashBoard作为监控软件一般单独开启一个服务，这里注解了环境信息是因为版本会导致一些异常情况的出现，在使用过程中出现的问题都会一一记录下来；</li><li>Hystrix Dashboard共支持三种不同的监控方式：<ul><li>默认的集群监控：<code>http://turbine-hostname:port/turbine.stream</code></li><li>指定的集群监控：<code>http://turbine-hostname:port/turbine.stream?cluster=[clusterName]</code></li><li>单体应用的监控： <code>http://hystrix-app:port/actuator/hystrix.stream</code></li></ul></li></ol><h2 id="动手实操"><a href="#动手实操" class="headerlink" title="动手实操"></a>动手实操</h2><h3 id="DashBoard项目"><a href="#DashBoard项目" class="headerlink" title="DashBoard项目"></a>DashBoard项目</h3><ol><li><p>在SpringCloud Eureka Quick Start项目的基础上创建一个单独的DashBoard项目，添加主要依赖（pom.xml）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- hystrix以及hystrix-dashboard依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在配置文件application.yml中添加如下配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 端口号，默认的已经被占用了</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9600</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 微服务名称配置以及eureka 客户端配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dashboard</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># actuator暴露所有端口</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># dashboard允许访问的接口组，必须要添加</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">dashboard:</span></span><br><span class="line">    <span class="attr">proxyStreamAllowList:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.3</span><span class="number">.108</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">localhost</span></span><br></pre></td></tr></table></figure><ul><li>hystrix.dashboard.proxyStreamAllowList必须要添加，否则无法监控到对应服务的状态</li></ul></li><li><p>配置启动类，添加Hystrix DashBoard注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DashboardApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DashboardApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动项目之后访问<a href="http://localhost:9600/hystrix/，效果如下：" target="_blank" rel="noopener">http://localhost:9600/hystrix/，效果如下：</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/9cb80a912abc3d61266d834c65be8260-135211" alt="Hystrix DashBoard界面"></p></li></ol><h3 id="Consumer项目改造"><a href="#Consumer项目改造" class="headerlink" title="Consumer项目改造"></a>Consumer项目改造</h3><ol><li><p>这个项目是之前的SpringCloud项目中的子项目Consumer，之前已经加了熔断组件Hystrix，因此依赖不需要怎么修改(pom.xml)，主要依赖如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>修改启动类，添加重要的Bean：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">getServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HystrixMetricsStreamServlet streamServlet = <span class="keyword">new</span> HystrixMetricsStreamServlet();</span><br><span class="line">        ServletRegistrationBean registrationBean = <span class="keyword">new</span> ServletRegistrationBean(streamServlet);</span><br><span class="line">        registrationBean.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        registrationBean.addUrlMappings(<span class="string">"/actuator/hystrix.stream"</span>);</span><br><span class="line">        registrationBean.setName(<span class="string">"HystrixMetricsStreamServlet"</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>registrationBean.addUrlMappings(“/actuator/hystrix.stream”);是为了接口地址和DashBoard上的保持一致，可以修改为其他的，比如registrationBean.addUrlMappings(“/hystrix.stream”);</li><li>feign的配置中已经使能了hystrix，因此没有添加注解@EnableHystrix</li></ul></li><li><p>配置文件（application.yml）:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consumer</span>   <span class="comment">#指定了配置文件的应用名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8080/</span>  <span class="comment">#Config server的uri</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span>     <span class="comment">#指定的环境</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span>                      <span class="comment">#指定分支</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">percentage:</span> <span class="number">1.0</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://127.0.0.1:9411</span></span><br><span class="line">    <span class="attr">sender:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="comment"># feign熔断器开关</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">1000</span>  <span class="comment">#1秒</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment">#配置规则 随机</span></span><br><span class="line">    <span class="comment">#NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RoundRobinRule #配置规则 轮询</span></span><br><span class="line">    <span class="comment"># NFLoadBalancerRuleClassName: com.netflix.loadbalancer.BestAvailableRule #配置规则 最空闲连接策略</span></span><br><span class="line">    <span class="attr">ConnectTimeout:</span> <span class="number">500</span> <span class="comment">#请求连接超时时间</span></span><br><span class="line">    <span class="attr">ReadTimeout:</span> <span class="number">1000</span> <span class="comment">#请求处理的超时时间</span></span><br><span class="line">    <span class="attr">OkToRetryOnAllOperations:</span> <span class="literal">true</span> <span class="comment">#对所有请求都进行重试</span></span><br><span class="line">    <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">2</span> <span class="comment">#切换实例的重试次数</span></span><br><span class="line">    <span class="attr">MaxAutoRetries:</span> <span class="number">1</span> <span class="comment">#对当前实例的重试次数</span></span><br></pre></td></tr></table></figure></li><li><p>java文件如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyFeignClient.java</span></span><br><span class="line"><span class="meta">@Component</span>(value = <span class="string">"myFeignClient"</span>)</span><br><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"service"</span>,fallback=ServiceFallback<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">MyFeignClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/"</span>)</span><br><span class="line">    <span class="function">Map&lt;String,Object&gt; <span class="title">hello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ServiceFallback.java</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceFallback</span> <span class="keyword">implements</span> <span class="title">MyFeignClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"err"</span>,<span class="string">"服务崩溃"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HelloController.java</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyFeignClient myFeignClient;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  @HystrixCommand(fallbackMethod = "getHello")</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; ret=myFeignClient.hello();</span><br><span class="line">        Map&lt;String,Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"res"</span>,ret);</span><br><span class="line">        res.put(<span class="string">"msg"</span>,<span class="string">"success"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">getHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"msg"</span>,<span class="string">"启动熔断"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>监控效果如下：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/f24031e83ae023a0029aac5f927079b7-81636" alt="Hystrix DashBoard监控consumer"></p></li></ol><h3 id="restconsumer项目改造"><a href="#restconsumer项目改造" class="headerlink" title="restconsumer项目改造"></a>restconsumer项目改造</h3><ol><li><p>这个项目是之前的SpringCloud项目中的子项目restconsumer，之前已经加了熔断组件Hystrix，因此依赖不需要怎么修改(pom.xml)，主要依赖如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>修改启动类，添加重要的Bean：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableHystrix</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestconsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RestconsumerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function">RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">getServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HystrixMetricsStreamServlet streamServlet = <span class="keyword">new</span> HystrixMetricsStreamServlet();</span><br><span class="line">        ServletRegistrationBean registrationBean = <span class="keyword">new</span> ServletRegistrationBean(streamServlet);</span><br><span class="line">        registrationBean.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        registrationBean.addUrlMappings(<span class="string">"/actuator/hystrix.stream"</span>);</span><br><span class="line">        registrationBean.setName(<span class="string">"HystrixMetricsStreamServlet"</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9500</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">restconsumer</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">percentage:</span> <span class="number">1.0</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure></li><li><p>控制器（修改）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"consumerServiceRibbonFallback"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"user is registering"</span>);</span><br><span class="line">        String ret = restTemplate.getForObject(<span class="string">"http://service/"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Map&lt;String, Object&gt; res = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"res"</span>, ret);</span><br><span class="line">        res.put(<span class="string">"msg"</span>, <span class="string">"success"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/rest2"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"consumerServiceRibbonFallback"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">hello2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"user is registering2"</span>);</span><br><span class="line">        String ret = restTemplate.getForObject(<span class="string">"http://service/"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Map&lt;String, Object&gt; res = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"res"</span>, ret);</span><br><span class="line">        res.put(<span class="string">"msg"</span>, <span class="string">"success"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/rest3"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">hello3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"user is registering2"</span>);</span><br><span class="line">        String ret = restTemplate.getForObject(<span class="string">"http://service/"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Map&lt;String, Object&gt; res = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"res"</span>, ret);</span><br><span class="line">        res.put(<span class="string">"msg"</span>, <span class="string">"success"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">consumerServiceRibbonFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; res = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"res"</span>, <span class="string">"error"</span>);</span><br><span class="line">        res.put(<span class="string">"msg"</span>, <span class="string">"err"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动x项目，然后访问接口<code>http://localhost:9500/rest</code>，<code>http://localhost:9500/rest2</code>，<code>http://localhost:9500/rest3</code>，多次刷新，然后在dashboard项目的界面添加监控<code>http://localhost:9500/actuator/hystrix.stream</code>，效果如下：</p><ul><li><p>注意要启动service等多个服务</p></li><li><p>启动service服务情况：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/259b1e96b606dd83481137bce2ddee83-83349" alt="Hystrix DashBoard监控restconsumer"></p></li><li><p>关闭service服务情况：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/3b77d5450d7e534bab78d4f3f9b6ca14-52511" alt="Hystrix DashBoard监控restconsumer关闭Service"></p></li></ul></li><li><p>页面各部分代表的含义：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/c779814896174c8c085b41e8fe4e7ffd-108497" alt="各部分含义"></p></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Hystrix DashBoard能够更方便地观看断路器状态，也能看应用的负载以及健康程度等各种有用信息，几乎实时，虽然只是记录了单体应用的监控，后续如果有需要再学习集群的！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;在微服务架构中，为了保证微服务的高可用性，防止服务出现故障导致线程阻塞，而出现了熔断器模型，熔断器的状况反应了某个程序的可用性和健壮性。在S
      
    
    </summary>
    
    
      <category term="SpringCloud" scheme="https://wanderros.github.io/categories/SpringCloud/"/>
    
    
  </entry>
  
  <entry>
    <title>OpenResty Quick Start</title>
    <link href="https://wanderros.github.io/2020/08/12/OpenResty-Quick-Start/"/>
    <id>https://wanderros.github.io/2020/08/12/OpenResty-Quick-Start/</id>
    <published>2020-08-12T02:35:19.000Z</published>
    <updated>2020-10-01T08:52:15.886Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Nginx和Lua能够结合使用，才深有体会Nginx的强大。以前只知道Nginx是一个开源的轻量级的Web服务软件，真的是井底之蛙！搜索之后才知道还有OpenResty，这部分主要记录在Mac上的环境配置以及简单测试，项目中怎么用慢慢探索吧！</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li>OpenResty® 是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项；</li><li>功能：用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关；</li><li>效果：Web 开发人员和系统工程师可以使用 Lua 脚本语言调动 Nginx 支持的各种 C 以及 Lua 模块，快速构造出足以胜任 10K 乃至 1000K 以上单机并发连接的高性能 Web 应用系统；</li><li>官方教程：<a href="http://openresty.org/cn/" target="_blank" rel="noopener">http://openresty.org/cn/</a></li><li>Nginx解决的是<strong>高并发</strong>的痛点，处理几万的请求很轻松，内存占用也不高。OpenResty的出现解决了享受Nginx高并发优势的拦路虎，可以用传统的同步编程思想上，在Nginx请求接进来后使用Lua处理稍复杂的逻辑；</li><li>Nginx 是俄罗斯人发明的， Lua 是巴西几个教授发明的，中国人章亦春把 LuaJIT VM 嵌入到 Nginx 中，实现了 OpenResty 这个高性能服务端解决方案；</li><li>在请求真正到达上游服务之前：<ul><li>Lua 可以随心所欲的做复杂的访问控制和安全检测</li><li>Lua 可以随心所欲的操控响应头里面的信息</li><li>Lua 可以从外部存储服务（比如 Redis，Memcached，MySQL，Postgres）中获取后端信息，并用这些信息来实时选择哪一个后端来完成业务访问</li></ul></li><li>nginScript是Nginx 官方推出的一个新的配置语言，把 JavaScript VM 嵌入到 nginx 中，提供简单的 nginx 配置功能。技术是不断迭代的，nginScript 只是想提供一种更方便配置 nginx 的方法，并不想取代 ngx_lua；</li><li>OpenResty®解决了高并发问题，但是并不是特效药，还是需要结合整体去分析，去取舍！</li></ol><h2 id="Mac安装并测试（brew）"><a href="#Mac安装并测试（brew）" class="headerlink" title="Mac安装并测试（brew）"></a>Mac安装并测试（brew）</h2><ol><li><p>使用命令安装OpenResty®：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install openresty/brew/openresty</span><br></pre></td></tr></table></figure></li><li><p>添加zsh路径(~/.zshrc)：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PATH=/usr/local/Cellar/openresty/1.17.8.2_1/nginx/sbin:$PATH</span><br><span class="line">export PATH</span><br></pre></td></tr></table></figure></li><li><p>查看版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openresty -v</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> nginx version: openresty/1.17.8.2</span></span><br></pre></td></tr></table></figure></li><li><p>安装Lua5.1（如果版本一致则安装这个Lua版本）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install lua@5.1</span><br></pre></td></tr></table></figure></li><li><p>下载luarocks源码，网址：<a href="http://luarocks.org/releases/luarocks-3.3.1.tar.gz，然后带OpenResty®的Lua环境地址编译，安装：" target="_blank" rel="noopener">http://luarocks.org/releases/luarocks-3.3.1.tar.gz，然后带OpenResty®的Lua环境地址编译，安装：</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar -zvxf luarocks-3.3.1.tar.gz</span><br><span class="line">cd luarocks-3.3.1</span><br><span class="line">./configure --with-lua-include=/usr/local/Cellar/openresty/1.17.8.2_1/luajit/include/luajit-2.1/</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></li><li><p>安装完成luarocks就可使用luarocks安装模块，然后在OpenResty®上使用，新建一个工作目录work，在工作目录下创建logs、conf目录，并添加如下配置文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">worker_processes</span>  <span class="number">1</span><span class="string">;</span></span><br><span class="line"><span class="string">error_log</span> <span class="string">logs/error.log;</span></span><br><span class="line"></span><br><span class="line"><span class="string">events</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">worker_connections</span> <span class="number">1024</span><span class="string">;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">http</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">lua_code_cache</span> <span class="string">off;</span></span><br><span class="line">  <span class="comment">#  lua_package_path 'conf/?.lua;;';</span></span><br><span class="line">    <span class="string">access_log</span> <span class="string">logs/access.log;</span></span><br><span class="line">    <span class="string">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">listen</span> <span class="number">8080</span><span class="string">;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">default_type</span> <span class="string">text/html;</span></span><br><span class="line">            <span class="string">content_by_lua_block</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">ngx.say("&lt;p&gt;hello,</span> <span class="string">world&lt;/p&gt;")</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">/luarocks</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">default_type</span> <span class="string">"text/html"</span><span class="string">;</span></span><br><span class="line">            <span class="string">content_by_lua_file</span> <span class="string">conf/staticitem.lua;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>lua_code_cache off;是关闭lua缓存，这样修改lua文件就能实时刷新了，但是会影响性能，正式环境需要关闭</li></ul></li><li><p>在conf目录下创建staticitem.lua，内容如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ngx.say(<span class="string">"&lt;h1&gt;staticitem.lua.loaded&lt;/h1&gt;"</span>)</span><br><span class="line"><span class="keyword">local</span> bar= <span class="built_in">require</span> <span class="string">"conf/bar"</span></span><br><span class="line">bar.say(<span class="string">"hello"</span>)</span><br><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span> <span class="string">"cjson"</span></span><br><span class="line"><span class="keyword">local</span> json = cjson.encode(&#123;</span><br><span class="line">    foo = <span class="string">"bar"</span>,</span><br><span class="line">    some_object = &#123;&#125;,</span><br><span class="line">    some_array = cjson.empty_array</span><br><span class="line">&#125;)</span><br><span class="line">ngx.say(json)</span><br></pre></td></tr></table></figure></li><li><p>在conf目录下创建bar.lua：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- conf/bar.lua</span></span><br><span class="line">_M=&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> rocks = <span class="built_in">require</span> <span class="string">"luarocks.loader"</span></span><br><span class="line"><span class="keyword">local</span> md5 = <span class="built_in">require</span> <span class="string">"md5"</span></span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">"rocks and md5 loaded"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.say</span> <span class="params">(a)</span></span></span><br><span class="line">    ngx.say(md5.sumhexa(a))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> _M</span><br></pre></td></tr></table></figure><ul><li><p>这里加载了md5模块，需要使用命令安装md5模块：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo luarocks install md5</span><br></pre></td></tr></table></figure></li><li><p>推荐使用bar.lua这种方式书写自定义模块</p></li></ul></li><li><p>在work目录下启动服务，命令如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -p `pwd`/ -c conf/nginx.conf</span><br></pre></td></tr></table></figure><ul><li><p>修改了配置可以使用如下命令进行重启：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure></li></ul></li><li><p>访问网址：<a href="http://localhost:8080/luarocks，进行测试" target="_blank" rel="noopener">http://localhost:8080/luarocks，进行测试</a></p></li><li><p>可以使用下面的命令进行性能测试：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab -c10 -n10000 http://127.0.0.1:8080/luarocks</span><br></pre></td></tr></table></figure></li></ol><h2 id="适用的场景"><a href="#适用的场景" class="headerlink" title="适用的场景"></a>适用的场景</h2><ol><li>高访问下的应用及官网的主页</li><li>商城类的秒杀功能</li><li>ip限流</li><li>APP灰度升级发布</li><li>… …</li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>OpenResty®的环境还是很好搭建的，主要还是应用场景以及设计方案，这个需要好好去研究了！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;Nginx和Lua能够结合使用，才深有体会Nginx的强大。以前只知道Nginx是一个开源的轻量级的Web服务软件，真的是井底之蛙！搜索之后
      
    
    </summary>
    
    
      <category term="Nginx" scheme="https://wanderros.github.io/categories/Nginx/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBoot遗忘点速记</title>
    <link href="https://wanderros.github.io/2020/08/10/SpringBoot%E9%81%97%E5%BF%98%E7%82%B9%E9%80%9F%E8%AE%B0/"/>
    <id>https://wanderros.github.io/2020/08/10/SpringBoot%E9%81%97%E5%BF%98%E7%82%B9%E9%80%9F%E8%AE%B0/</id>
    <published>2020-08-10T01:40:04.000Z</published>
    <updated>2020-10-01T08:52:15.917Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>SpringBoot虽然简化了配置，但是还是有很多速配的地方容易被忘记，导致项目编译不过去，这里记录一下SpringBoot中的一些容易忘记的点，方便出问题速查！</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><ol><li><p>SpringBoot默认扫描包的机制是：从启动类开始，扫描启动类所在包和子包中的所有类。如果想要扫描其他包下的类，可以修改@SpringBootApplication(scanBasePackages = {“demo.test”, “demo.spring”})；</p></li><li><p>通过修改application.yml设置输出的级别，默认情况下，Spring Boot仅记录到控制台，不会写入日志文件。如果需要输出到文件，则需要设置 logging.file或logging.path属性：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span> </span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="comment">#root日志以error级别输出</span></span><br><span class="line">    <span class="attr">root:</span> <span class="string">error</span></span><br><span class="line">    <span class="comment">#demo.springboot包下的日志以debug级别输出</span></span><br><span class="line">    <span class="attr">demo.springboot:</span> <span class="string">debug</span></span><br><span class="line">  <span class="attr">file:</span> <span class="string">xxx-log.log</span></span><br></pre></td></tr></table></figure><ul><li>logging.file：会在项目的当前路径下生成一个 xxx.log 日志文件</li><li>logging.path：在指定文件夹生成一个日志文件为spring.log</li><li>二者不能同时使用，如若同时使用，则只有logging.file生效</li></ul></li><li><p>根据不同的日志系统，如果有以下文件，将默认加载：</p><ul><li><p>Logback：logback-spring.xml, logback-spring.groovy, logback.xml, logback.groovy</p></li><li><p>Log4j2：log4j2-spring.xml, log4j2.xml</p></li><li><p>JDK (Java Util Logging)：logging.properties</p></li><li><p>SpringBoot建议使用-spring变量进行日志记录配置</p></li><li><p>如果不使用以上文件名，则需要在application.yml配置加载</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span> </span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:log-config.xml</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>SpringBoot不会自动注册RestTemplate，需要自己注册bean：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">(RestTemplateBuilder builder)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>SpringBoot内置支持的Web容器有Tomcat、Undertow、Jetty和Netty，默认情况下，这些Web服务的Access日志是不开启的，如果需要开启日志的话就需要进行相应的配置：</p><ol><li><p><strong>Tomcat容器日志配置</strong>：默认支持的是Tomcat Web容器，配置如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">tomcat:</span></span><br><span class="line">    <span class="attr">basedir:</span> <span class="string">/home/wanderros/tomcat</span></span><br><span class="line">    <span class="attr">background-processor-delay:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">port-header:</span> <span class="string">X-Forwarded-Port</span></span><br><span class="line">    <span class="attr">protocol-header:</span> <span class="string">X-Forwarded-Proto</span></span><br><span class="line">    <span class="attr">protocol-header-https-value:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">redirect-context-root:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">remote-ip-header:</span> <span class="string">X-Forwarded-For</span></span><br><span class="line">    <span class="attr">uri-encoding:</span> <span class="string">UTF-8</span></span><br><span class="line">    <span class="attr">accesslog:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">buffered:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">directory:</span> <span class="string">./log</span></span><br><span class="line">      <span class="attr">file-date-format:</span> <span class="string">.yyyy-MM-dd</span></span><br><span class="line">      <span class="attr">pattern:</span> <span class="string">'%h %l %u %t "%r" %s %b "<span class="template-variable">%&#123;Referer&#125;</span>i" "<span class="template-variable">%&#123;User-Agent&#125;</span>i" %D ms'</span></span><br><span class="line">      <span class="attr">prefix:</span> <span class="string">access_log</span></span><br><span class="line">      <span class="attr">rename-on-rotate:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">request-attributes-enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">rotate:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">suffix:</span> <span class="string">.log</span></span><br></pre></td></tr></table></figure><ul><li>server.tomcat.basedir属性是必须要配置的，如果不配置该属性，日志是不会输出的</li></ul></li><li><p><strong>Undertow容器日志配置</strong>：引入Undertow依赖包后，在配置文件添加如下配置（注意需要排除tomcat依赖包）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span> </span><br><span class="line">  <span class="attr">undertow:</span> </span><br><span class="line">    <span class="attr">max-http-post-size:</span> <span class="string">10MB</span></span><br><span class="line">    <span class="attr">buffer-size:</span> <span class="string">1024KB</span></span><br><span class="line">    <span class="attr">io-threads:</span> <span class="number">8</span></span><br><span class="line">    <span class="attr">worker-threads:</span> <span class="number">64</span></span><br><span class="line">    <span class="attr">direct-buffers:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">eager-filter-init:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">accesslog:</span> </span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">pattern:</span> <span class="string">common</span></span><br><span class="line">      <span class="attr">prefix:</span> <span class="string">access_log.</span></span><br><span class="line">      <span class="attr">suffix:</span> <span class="string">log</span></span><br><span class="line">      <span class="attr">dir:</span> <span class="string">/var/undertow/logs</span></span><br><span class="line">      <span class="attr">rotate:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li><li><p><strong>Jetty容器日志配置</strong>：引入Jetty依赖包后，在配置文件添加如下配置（注意需要排除tomcat依赖包）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span> </span><br><span class="line">  <span class="attr">jetty:</span> </span><br><span class="line">    <span class="attr">max-http-post-size:</span> <span class="string">4MB</span></span><br><span class="line">    <span class="attr">acceptors:</span> <span class="number">32</span></span><br><span class="line">    <span class="attr">selectors:</span> <span class="number">32</span></span><br><span class="line">    <span class="attr">accesslog:</span> </span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">filename:</span> <span class="string">/var/jetty/logs/access_log.yyyy_MM_dd.log</span></span><br><span class="line">      <span class="attr">file-date-format:</span> <span class="string">yyyy-MM-dd</span></span><br><span class="line">      <span class="attr">retention-period:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">append:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">extended-format:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">date-format:</span> <span class="string">'dd/MMM/yyyy:HH:mm:ss Z'</span></span><br><span class="line">      <span class="attr">locale:</span> <span class="string">zh</span></span><br><span class="line">      <span class="attr">timeZone:</span> <span class="string">GMT+8</span></span><br><span class="line">      <span class="attr">log-cookies:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">log-server:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">log-latency:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li></ol></li><li></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;SpringBoot虽然简化了配置，但是还是有很多速配的地方容易被忘记，导致项目编译不过去，这里记录一下SpringBoot中的一些容易忘记
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>SpringCloud之负载均衡</title>
    <link href="https://wanderros.github.io/2020/08/08/SpringCloud%E4%B9%8B%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    <id>https://wanderros.github.io/2020/08/08/SpringCloud%E4%B9%8B%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</id>
    <published>2020-08-08T11:50:31.000Z</published>
    <updated>2020-10-01T08:52:15.922Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>负载均衡是高可用网络基础架构的关键组件，通常用于将工作负载分布到多个服务器来提高网站、应用、数据库或其他服务的性能和可靠性。一个没有负载均衡的 web 架构类似下面这样：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/72d53920aa8e46ab55dbd28ff29c6158-14613" alt="没有负载均衡的架构"></p><p>带有负载均衡功能的架构可能如下所示：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/35ff5e196b0940021676361bbb294b51-24012" alt="有负载均衡的架构"></p><p>这部分主要介绍常见的负载均衡，以及如何使用负载均衡提供高可用服务。</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li><p>负载均衡（Load balancing）是一种计算机技术，用来在多个计算机（计算机集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，以达到最优化资源使用、最大化吞吐率、最小化响应时间、同时避免过载的目的；</p></li><li><p>任何的负载均衡技术都要想办法建立某种一对多的映射机制：一个请求的入口映射到多个处理请求的节点，从而实现分而治之（Divide and Conquer）；</p></li><li><p>日常场景：在日常生活中经常免不了要去一些比较拥挤的地方，比如地铁站、火车站、电影院、银行等。无论是买票，还是排队入场，这些场所一般都会设置多个服务点或者入口的，如果没有人引导的话，大多数情况下，最近的入口会挤满人就会大大浪费资源；如果可以把这些排队的人很好的分散到各个入口的话会大大缩短排队时间；</p></li><li><p>网络场景：为了提升服务能力，很多服务采用集群部署，就像话剧院有多个入口一样。这时候，就需要一个协调者，来均衡的分配这些用户的请求，可以让用户的可以均匀的分派到不同的服务器上；</p></li><li><p>定义：<strong>将负载（工作任务、访问请求）进行平衡、分摊到多个操作单元（服务器、组件）上进行执行，解决高性能，单点故障（高可用），扩展性（水平伸缩）的一种解决方案；</strong></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/a7b7c780f6b2a4d9d8e87cb2dc4ab99a-37718" alt="负载均衡原理"></p></li><li><p><strong>负载均衡是要在网络传输中做文章的</strong>，这样必须对网络的七层模型有所了解；</p></li><li><p>OSI是一个开放性的通信系统互连参考模型，是一个定义得非常好的协议规范，当然协议的实现不会完全按照OSI规范来实施。OSI模型有7层结构，每层都可以有几个子层，7层从上到下分别是 应用层、表示层、会话层、传输层、网络层、数据链路层、物理层；</p></li><li><p>在OSI七层模型中，高层次都是依赖于低层次的，层次越高，使用起来越方便，各个层的功能如下：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/3c2ea551a8fa53076e7d2cbbd08fbc58-93389" alt="OSI七层功能"></p></li><li><p>计算机网络有关的概念：</p><ul><li>TELNET、HTTP、FTP、NFS、SMTP、DNS等属于应用层的协议</li><li>TCP、UDP、SPX等属于传输层的协议</li><li>IP、IPX等属于网络层的协议</li><li>ATM、FDDI等属于数据链路层的协议</li></ul></li><li><p>根据OSI分层模型对负载均衡进行分类：</p><ul><li>工作在应用层的负载均衡，通常称之为七层负载均衡</li><li>工作在传输层的负载均衡，通常称之为四层负载均衡</li><li>工作在数据链路的负载均衡，通常称之为二层负载均衡</li></ul></li><li><p><strong>二层负载均衡</strong>对外依然提供一个VIP（虚拟IP），但是集群中不同的机器采用不同的IP地址。当负载均衡器接受到请求之后，根据不同的负载均衡算法，通过IP将请求转发至不同的真实服务器；</p></li><li><p><strong>四层负载均衡</strong>工作在传输层（TCP/UDP协议），TCP/UDP协议除了包含源IP、目标IP以外，还包含源端口号及目的端口号。四层负载均衡器在接受到客户端请求后，以后通过修改数据包的地址信息（IP+端口号）将流量转发到应用服务器；</p></li><li><p><strong>七层负载均衡</strong>工作在应用层，应用层协议较多，常用的有http、radius、dns等。七层负载均衡能够基于这些协议来负载，这些应用层协议中会包含很多有意义的内容，比如同一个Web服务器的负载均衡，除了根据IP和端口进行负载外，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡；</p></li><li><p>负载均衡根据实现方式来分有硬件负载均衡和软件负载均衡；硬件负载均衡器有F5和A10，非常贵。市面上有很多开源的负载均衡的工具或软件，Nginx、LVS、HAProxy是目前使用最广泛的三种负载均衡软件；</p></li><li><p>LVS（Linux Virtual Server）主要用来做四层负载均衡，通过LVS提供的负载均衡技术和Linux操作系统实现一个高性能、高可用的服务器群集，具有良好可靠性、可扩展性和可操作性；</p></li><li><p>Nginx主要用来做七层负载均衡，能反向代理HTTP, HTTPS, SMTP, POP3, IMAP的协议链接，还能进行负载均衡以及HTTP缓存；</p></li><li><p>HAProxy主要用来做七层负载均衡，能提供高可用性、负载均衡，以及基于TCP和HTTP的应用程序代理；</p></li><li><p>单点负载均衡器如果宕机了，则整个系统无法提供服务，常用的方案是使用多个负载均衡器实现负载均衡器，将第二个以上的负载均衡器连接到第一个上，从而形成一个集群。一个使用浮动 IP 的负载均衡架构示意图：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/802345231a8459cb0834a83df042da40-618422" alt="浮动IP负载均衡器"></p></li></ol><h2 id="负载均衡算法"><a href="#负载均衡算法" class="headerlink" title="负载均衡算法"></a>负载均衡算法</h2><ol><li>负载均衡算法是负载均衡的核心，负载均衡服务器在决定将请求转发到具体哪台真实服务器的时候是通过负载均衡算法来实现的；</li><li>负载均衡算法可以分为两类：静态负载均衡算法和动态负载均衡算法；</li><li>静态负载均衡算法包括：轮询、比率、优先权<ul><li>轮询（Round Robin）——将请求按照顺序循环地分发给每个服务器</li><li>比率（Ratio）——给每个服务器分配一个加权值，根椐这个权值把用户的请求分配到每个服务器</li><li>优先权（Priority）——将所有服务器分组，给每个组定义优先权。BIG-IP 用户的请求，分配给优先级最高的服务器组（在同一组内，采用轮询或比率算法，分配用户的请求）；当最高优先级中所有服务器出现故障，BIG-IP 才将请求送给次优先级的服务器组</li></ul></li><li>动态负载均衡算法包括: 最少连接数、最快响应速度、观察方法、预测法、动态性能分配、动态服务器补充、服务质量、服务类型、规则模式<ul><li>最少连接数（Least Connection）——传递新的连接给那些进行最少连接处理的服务器</li><li>最快模式（Fastest）——传递连接给那些响应最快的服务器</li><li>观察模式（Observed）——连接数目和响应时间以这两项的最佳平衡为依据为新的请求选择服务器</li><li>预测模式（Predictive）——BIG-IP利用收集到的服务器当前的性能指标，进行预测分析，选择一台服务器在下一个时间片内，其性能将达到最佳的服务器响应用户的请求</li><li>动态性能分配(Dynamic Ratio-APM)——BIG-IP 收集应用程序和应用服务器的各项性能参数，动态调整流量分配</li><li>动态服务器补充(Dynamic Server Act.)——当主服务器群中因故障导致数量减少时，动态地将备份服务器补充至主服务器群</li><li>服务质量(QoS）——按不同的优先级对数据流进行分配</li><li>服务类型(ToS)——按不同的服务类型（在Type of Field中标识）负载均衡对数据流进行分配</li><li>规则模式——用户可以针对不同的数据流设置导向规则</li></ul></li><li>不同的负载均衡服务器会选择不同的算法，不同的负载均衡器也支持不同的算法，根据业务需求进行配置即可！</li></ol><h2 id="Nginx负载均衡"><a href="#Nginx负载均衡" class="headerlink" title="Nginx负载均衡"></a>Nginx负载均衡</h2><h3 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h3><ol><li><p>nginx通过从upstream模板定义的后端服务器列表中选取一台服务器接收用户的请求从而达到负载均衡；</p></li><li><p>一个基本的upstream模块如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream [服务器组名称]&#123;</span><br><span class="line">　　server [IP地址]:[端口号];</span><br><span class="line">　　server [IP地址]:[端口号];</span><br><span class="line">　　....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在upstream模块配置完成后，要让指定的访问反向代理到服务器列表，格式如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location ~ .*$ &#123;</span><br><span class="line">　　index index.jsp index.html;</span><br><span class="line">　　proxy_pass http://[服务器组名称];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>上述配置就完成了最基础的负载均衡，但是并不满足实际的需求。目前Nginx的upstream模块支持6种负载均衡策略（算法）：轮询（默认方式）、weight（权重方式）、ip_hash（依据ip分配方式）、least_conn（最少连接方式）、fair（第三方提供的响应时间方式）、url_hash（第三方通过的依据URL分配方式）</p></li></ol><h3 id="轮询-默认"><a href="#轮询-默认" class="headerlink" title="轮询(默认)"></a>轮询(默认)</h3><ol><li><p>upstream模块默认的负载均衡策略，每个请求会按时间顺序平均分配到不同的后端服务器；</p></li><li><p>参数：</p><table><thead><tr><th align="center">名称</th><th align="center">功能</th></tr></thead><tbody><tr><td align="center">max_fails</td><td align="center">在fail_timeout参数设置的时间内最大失败次数。如果在这个时间内，所有该服务器的请求都失败了，那么认为该服务器停机</td></tr><tr><td align="center">fail_time</td><td align="center">服务器被认为停机的时长，默认10s</td></tr><tr><td align="center">backup</td><td align="center">标记该服务器为备用服务器。当主服务器停止时，请求会被发送到它这里</td></tr><tr><td align="center">down</td><td align="center">标记服务器永久停机</td></tr><tr><td align="center">fail_timeout</td><td align="center">与max_fails结合使用</td></tr></tbody></table></li><li><p>注意：</p><ul><li>down标记的服务器会自动剔除</li><li>缺省就是轮询</li><li>此策略适合服务器配置无状态且短平块的服务使用</li></ul></li></ol><h3 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h3><ol><li><p>在轮询策略的基础上指定轮询的几率，在轮询的基础上新增了一个weight的参数，此参数指定轮询的几率，值为number；</p></li><li><p>upstream模块配置模板如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream [服务器组名称]&#123;</span><br><span class="line">　　server [IP地址]:[端口号] weight=2;</span><br><span class="line">　　server [IP地址]:[端口号];</span><br><span class="line">　　....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>没有weight参数的服务器默认为1，weight的数值与访问比例成正比，所有weight值的总和为一个循环单位，服务器自身的weight值为循环单位内的轮询次数；</p></li><li><p>注意：</p><ul><li>权重越高分配到的请求越多</li><li>此策略可以和least_conn策略、iphash策略结合使用</li><li><strong>此策略比较适合服务器硬件配置差距较大的情况</strong></li></ul></li></ol><h3 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h3><ol><li><p>依据ip分配方式，指定负载均衡器按照基于客户端IP的分配方式，这个方法确保了相同的客户端请求一致发送到相同的服务器，以保证session会话。每个访客都固定访问一个后端服务器，可以解决session不能跨服务器的问题；</p></li><li><p>upstream模块配置模板如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream [服务器组名称]&#123;</span><br><span class="line">　　ip_hash;</span><br><span class="line">　　server [IP地址]:[端口号] weight=2;</span><br><span class="line">　　server [IP地址]:[端口号];</span><br><span class="line">　　....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>注意：</p><ul><li>nginx1.3.1之前的版本不能在ip_hash中使用权重（weight）</li><li>ip_hash不能与backup同时使用</li><li><strong>此策略适合有状态服务的程序，比如session</strong></li><li>当有服务器需要剔除，必须手动down掉</li></ul></li></ol><h3 id="least-conn"><a href="#least-conn" class="headerlink" title="least_conn"></a>least_conn</h3><ol><li><p>把请求发给链接数最少的后端服务器。有些请求占用的时间很长，会导致其所在的后端负载较高，在这种情况下使用这种方式可以达到更好的负载均衡效果；</p></li><li><p>upstream模块配置模板如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream [服务器组名称]&#123;</span><br><span class="line">　　least_conn;</span><br><span class="line">　　server [IP地址]:[端口号] weight=2;</span><br><span class="line">　　server [IP地址]:[端口号];</span><br><span class="line">　　....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>注意：</p><ul><li>此策略适合请求处理时间长短不一造成的服务器过载情况</li></ul></li></ol><h3 id="fair"><a href="#fair" class="headerlink" title="fair"></a>fair</h3><ol><li><p>响应时间方式，按照服务器端的响应时间来分配请求，响应时间短的优先分配；</p></li><li><p>upstream模块配置模板如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream [服务器组名称]&#123;</span><br><span class="line">　　server [IP地址]:[端口号] weight=2;</span><br><span class="line">　　server [IP地址]:[端口号];</span><br><span class="line">　　....</span><br><span class="line">　　fair;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>注意：</p><ul><li>需要安装第三方插件</li></ul></li></ol><h3 id="url-hash"><a href="#url-hash" class="headerlink" title="url_hash"></a>url_hash</h3><ol><li><p>url分配方式，按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，要配合缓存命中来使用；</p></li><li><p>同一个资源多次请求可能会到达不同的服务器上，导致不必要的多次下载，缓存命中率不高，以及一些资源时间的浪费。而使用url_hash，可以使得同一个url（也就是同一个资源请求）会到达同一台服务器，一旦缓存住了资源，再次收到请求，就可以在缓存中读取；</p></li><li><p>upstream模块配置模板如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream [服务器组名称]&#123;</span><br><span class="line">　　hash $request_uri;</span><br><span class="line">　　server [IP地址]:[端口号] weight=2;</span><br><span class="line">　　server [IP地址]:[端口号];</span><br><span class="line">　　....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>注意：</p><ul><li>需要安装第三方插件</li></ul></li></ol><h3 id="样例配置（实体机）"><a href="#样例配置（实体机）" class="headerlink" title="样例配置（实体机）"></a>样例配置（实体机）</h3><ol><li><p>nginx.conf（部分）：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"># Basic Settings</span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">sendfile on;</span><br><span class="line">tcp_nopush on;</span><br><span class="line">tcp_nodelay on;</span><br><span class="line">keepalive_timeout 65;</span><br><span class="line">types_hash_max_size 2048;</span><br><span class="line"># server_tokens off;</span><br><span class="line"></span><br><span class="line"># server_names_hash_bucket_size 64;</span><br><span class="line"># server_name_in_redirect off;</span><br><span class="line"></span><br><span class="line">include /etc/nginx/mime.types;</span><br><span class="line">default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"># SSL Settings</span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE</span><br><span class="line">ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"># Logging Settings</span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">upstream org.tonny.balance &#123;</span><br><span class="line">        server 192.168.31.171:8081 weight=1;</span><br><span class="line">        server 192.168.31.171:8089 weight=1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">       log_format main '&#123;"@timestamp":"$time_iso8601",'</span><br><span class="line">       '"host": "$server_addr",'</span><br><span class="line">       '"client": "$remote_addr",'</span><br><span class="line">       '"size": $body_bytes_sent,'</span><br><span class="line">       '"responsetime": $request_time,'</span><br><span class="line">       '"domain": "$host",'</span><br><span class="line">       '"url":"$request_uri",'</span><br><span class="line">       '"referer": "$http_referer",'</span><br><span class="line">       '"agent": "$http_user_agent",'</span><br><span class="line">       '"status":"$status",'</span><br><span class="line">       '"x_forwarded_for":"$http_x_forwarded_for"&#125;';</span><br><span class="line"></span><br><span class="line">access_log /var/log/nginx/access.log main;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"># Gzip Settings</span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">gzip on;</span><br><span class="line"></span><br><span class="line"># gzip_vary on;</span><br><span class="line"># gzip_proxied any;</span><br><span class="line"># gzip_comp_level 6;</span><br><span class="line"># gzip_buffers 16 8k;</span><br><span class="line"># gzip_http_version 1.1;</span><br><span class="line"># gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"># Virtual Host Configs</span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">include /etc/nginx/conf.d/*.conf;</span><br><span class="line">include /etc/nginx/sites-enabled/*;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>site-available/default（重要部分）：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 80 default_server;</span><br><span class="line">listen [::]:80 default_server;</span><br><span class="line"></span><br><span class="line"># SSL configuration</span><br><span class="line">#</span><br><span class="line"># listen 443 ssl default_server;</span><br><span class="line"># listen [::]:443 ssl default_server;</span><br><span class="line">#</span><br><span class="line"># Note: You should disable gzip for SSL traffic.</span><br><span class="line"># See: https://bugs.debian.org/773332</span><br><span class="line">#</span><br><span class="line"># Read up on ssl_ciphers to ensure a secure configuration.</span><br><span class="line"># See: https://bugs.debian.org/765782</span><br><span class="line">#</span><br><span class="line"># Self signed certs generated by the ssl-cert package</span><br><span class="line"># Don't use them in a production server!</span><br><span class="line">#</span><br><span class="line"># include snippets/snakeoil.conf;</span><br><span class="line"></span><br><span class="line">root /var/www/html;</span><br><span class="line"></span><br><span class="line"># Add index.php to the list if you are using PHP</span><br><span class="line">index index.html index.htm index.nginx-debian.html;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server_name _;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line"># First attempt to serve request as file, then</span><br><span class="line"># as directory, then fall back to displaying a 404.</span><br><span class="line">try_files $uri $uri/ =404;</span><br><span class="line">#  visit mapping</span><br><span class="line">proxy_pass   http://org.tonny.balance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># pass PHP scripts to FastCGI server</span><br><span class="line">#</span><br><span class="line">#location ~ \.php$ &#123;</span><br><span class="line">#include snippets/fastcgi-php.conf;</span><br><span class="line">#</span><br><span class="line">## With php-fpm (or other unix sockets):</span><br><span class="line">#fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;</span><br><span class="line">## With php-cgi (or other tcp sockets):</span><br><span class="line">#fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">#&#125;</span><br><span class="line"></span><br><span class="line"># deny access to .htaccess files, if Apache's document root</span><br><span class="line"># concurs with nginx's one</span><br><span class="line">#</span><br><span class="line">#location ~ /\.ht &#123;</span><br><span class="line">#deny all;</span><br><span class="line">#&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>注意：</p><ul><li>upstream模板是配置在http中的</li><li>log_format模板也是配置在http中的</li><li>niginx版本为nginx/1.18.0 (Ubuntu)</li></ul></li></ol><h3 id="Docker上负载均衡"><a href="#Docker上负载均衡" class="headerlink" title="Docker上负载均衡"></a>Docker上负载均衡</h3><ol><li><p>下载nginx官方镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx</span><br></pre></td></tr></table></figure></li><li><p>运行nginx镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8080:80 -d nginx</span><br></pre></td></tr></table></figure></li><li><p>进入镜像中进行配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker ps </span></span><br><span class="line"></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                  NAMES</span><br><span class="line">deb661196722        nginx               "/docker-entrypoint.…"   19 hours ago        Up 18 hours         0.0.0.0:8089-&gt;80/tcp   cool_torvalds</span><br><span class="line">d68d1fd15626        nginx               "/docker-entrypoint.…"   19 hours ago        Up 18 hours         0.0.0.0:8080-&gt;80/tcp   trusting_lovelace</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it d68d1fd15626 bash</span></span><br></pre></td></tr></table></figure></li><li><p>配置nginx实例的配置，然后重启(真机类似)：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart d68d1fd15626</span><br></pre></td></tr></table></figure></li><li><p>测试输入地址<a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a></p></li></ol><h2 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h2><ol><li>Ribbon 是Netflix 公司开源的一款基于客户端的负载均衡组件，是Spring Cloud大家庭中非常重要的一个模块。Ribbon应该也是整个Spring Cloud大家庭中相对而言比较复杂的模块，直接影响到服务调度的质量和性能；</li><li>掌握Ribbon有助于了解在分布式微服务集群工作模式下，服务调度应该考虑的各个环节；</li><li></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;负载均衡是高可用网络基础架构的关键组件，通常用于将工作负载分布到多个服务器来提高网站、应用、数据库或其他服务的性能和可靠性。一个没有负载均衡
      
    
    </summary>
    
    
      <category term="SpringCloud" scheme="https://wanderros.github.io/categories/SpringCloud/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringBoot远程访问http服务方法汇总</title>
    <link href="https://wanderros.github.io/2020/08/07/SpringBoot%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AEhttp%E6%9C%8D%E5%8A%A1%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB/"/>
    <id>https://wanderros.github.io/2020/08/07/SpringBoot%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AEhttp%E6%9C%8D%E5%8A%A1%E6%96%B9%E6%B3%95%E6%B1%87%E6%80%BB/</id>
    <published>2020-08-06T23:13:49.000Z</published>
    <updated>2020-10-01T08:52:15.917Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>进行微服务开发时，可以使用@Controller以及@RestController注解来对外提供服务，但是也避免不了要使用HTTP客户端访问其他服务提供者获取一些内容。在Spring中有很多封装好的工具来进行HTTP内容获取，本文将记录这些访问方法，并对各种方法的优劣进行分析。</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h2><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li><p>RestTemplate是Spring提供的用于访问Rest服务的客户端，RestTemplate提供了多种便捷访问远程HTTP服务的方法，简化了开发人员与HTTP服务的通信方式，统一了RESTful得到标准，封装了HTTP链接；</p></li><li><p>相较于之前常用的 HttpClient，RestTemplate 是一种更优雅的调用 RESTful 服务的方式；</p></li><li><p>RestTemplate 默认依赖JDK的HTTP连接工具(HttpURLConnection)，如果有需要的话也可以通过setRequestFactory方法替换为例如 Apache HttpComponents、Netty或OkHttp等其它HTTP库；</p></li><li><p>RestTemplate默认使用HttpMessageConverter实例将HTTP消息转换成POJO或者从POJO转换成HTTP消息；</p></li><li><p>RestTemplate是Spring的一个RESTful客户端，只要包含了spring-web就可以在项目中使用了；</p></li><li><p>RestTemplate使用流程：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/873f83a509d8f64d97aae2480b87008b-155759" alt="RestTemplate使用流程"></p></li><li><p>主要方法：</p><table><thead><tr><th>HTTPMethod</th><th>RestTemplate Method</th><th>说明</th></tr></thead><tbody><tr><td>Post</td><td><strong>postForLocation</strong></td><td>POST 数据到一个URL，返回新创建资源的URL</td></tr><tr><td>Post</td><td><strong>postForEntity</strong></td><td>POST 数据到一个URL，返回包含一个对象的ResponseEntity</td></tr><tr><td>Post</td><td><strong>postForObject</strong></td><td>POST 数据到一个URL，返回根据响应体匹配形成的对象</td></tr><tr><td>Get</td><td><strong>getForObject</strong></td><td>发送一个HTTP GET请求，返回的请求体将映射为一个对象</td></tr><tr><td>Get</td><td><strong>getForEntity</strong></td><td>发送一个HTTP GET请求，返回的ResponseEntity包含了响应体所映射成的对象</td></tr><tr><td>Delete</td><td><strong>delete</strong></td><td></td></tr><tr><td>head</td><td><strong>headForHeaders</strong></td><td></td></tr><tr><td>put</td><td><strong>put</strong></td><td></td></tr><tr><td>any</td><td><strong>exchange</strong></td><td></td></tr><tr><td>any</td><td><strong>execute</strong></td><td>所有的get、post、delete、put、options、head、exchange方法最终调用的都是excute方法</td></tr></tbody></table></li><li><p>需要注意的是<strong>RestTemplate只是对其它Rest客户端的一个封装，本身并没有自己的实现</strong>，最常用的几种客户端有：</p><ul><li>SimpleClientHttpRequestFactory（封装URLConnection）</li><li>HttpComponentsClientHttpRequestFactory（封装HttpClient）</li><li>OkHttp3ClientHttpRequestFactory(封装OKHttp)</li></ul></li><li><p>常用HTTP客户端的依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>httpclient——HttpComponentsClientHttpRequestFactory</li><li>okhttp——OkHttp3ClientHttpRequestFactory</li><li>使用某个工厂方法初始化RestTemplate时必须对应添加底层依赖</li><li>使用的时候一般都会只选择其中的一种方式</li></ul></li><li><p>RestTemplate在使用前可以做一些初始化操作，比如设置超时时间、响应参数转换器等！</p></li></ol><h3 id="基础请求"><a href="#基础请求" class="headerlink" title="基础请求"></a>基础请求</h3><ol><li><p>创建一个SpringBoot项目，添加依赖（pom.xml）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>创建RestTemplate配置类（默认配置）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestTemplateConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        <span class="keyword">return</span> restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"urlConnection"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">urlConnectionRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(<span class="keyword">new</span> SimpleClientHttpRequestFactory());</span><br><span class="line">        <span class="keyword">return</span> restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"httpClient"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">httpClientRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(<span class="keyword">new</span> HttpComponentsClientHttpRequestFactory());</span><br><span class="line">        <span class="keyword">return</span> restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="meta">@Bean</span>(<span class="string">"OKHttp3"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">OKHttp3RestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(<span class="keyword">new</span> OkHttp3ClientHttpRequestFactory());</span><br><span class="line">        <span class="keyword">return</span> restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>带有配置的RestTemplate配置类（自定义配置）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.Header;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.config.Registry;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.config.RegistryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.conn.socket.ConnectionSocketFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.conn.socket.PlainConnectionSocketFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.conn.ssl.NoopHostnameVerifier;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.conn.ssl.SSLConnectionSocketFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.conn.PoolingHttpClientConnectionManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.message.BasicHeader;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.ssl.SSLContextBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.ssl.TrustStrategy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.ClientHttpRequestFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.HttpComponentsClientHttpRequestFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.DefaultResponseErrorHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.KeyManagementException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wander</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestTemplateConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 建立连接的超时时间 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>connectTimeout= <span class="number">20000</span>;</span><br><span class="line">    <span class="comment">/** 连接不够用的等待时间 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>requestTimeout= <span class="number">20000</span>;</span><br><span class="line">    <span class="comment">/** 每次请求等待返回的超时时间 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>socketTimeout= <span class="number">3000</span>;</span><br><span class="line">    <span class="comment">/** 每个主机最大连接数 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>defaultMaxPerRoute= <span class="number">100</span>;</span><br><span class="line">    <span class="comment">/** 最大连接数 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>maxTotalConnections= <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">buildRestTemplate</span><span class="params">(ClientHttpRequestFactory factory)</span> </span>&#123;</span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(factory);</span><br><span class="line">        restTemplate.setErrorHandler(<span class="keyword">new</span> DefaultResponseErrorHandler());</span><br><span class="line">        <span class="keyword">return</span> restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpComponentsClientHttpRequestFactory <span class="title">createFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// httpClient连接配置</span></span><br><span class="line">        SSLContextBuilder builder = <span class="keyword">new</span> SSLContextBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TrustStrategy acceptingTrustStrategy = <span class="keyword">new</span> TrustStrategy() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTrusted</span><span class="params">(X509Certificate[] chain, String authType)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            builder.loadTrustMaterial(<span class="keyword">null</span>, acceptingTrustStrategy);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"Pooling Connection Manager Initialisation failure because of "</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SSLConnectionSocketFactory socketFactory = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socketFactory = <span class="keyword">new</span> SSLConnectionSocketFactory(builder.build(), NoopHostnameVerifier.INSTANCE);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeyManagementException | NoSuchAlgorithmException e) &#123;</span><br><span class="line">            log.error(<span class="string">"Pooling Connection Manager Initialisation failure because of "</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册http和https请求</span></span><br><span class="line">        Registry&lt;ConnectionSocketFactory&gt; registry = RegistryBuilder.&lt;ConnectionSocketFactory&gt; create()</span><br><span class="line">                .register(<span class="string">"http"</span>, PlainConnectionSocketFactory.getSocketFactory())</span><br><span class="line">                .register(<span class="string">"https"</span>, socketFactory).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始设置连接池</span></span><br><span class="line">        PoolingHttpClientConnectionManager phccm = <span class="keyword">new</span> PoolingHttpClientConnectionManager(registry);</span><br><span class="line">        <span class="comment">// 最大连接数</span></span><br><span class="line">        phccm.setMaxTotal(maxTotalConnections);</span><br><span class="line">        <span class="comment">// 同路由并发数</span></span><br><span class="line">        phccm.setDefaultMaxPerRoute(defaultMaxPerRoute);</span><br><span class="line"></span><br><span class="line">        HttpClientBuilder httpClientBuilder = HttpClients.custom();</span><br><span class="line">        httpClientBuilder.setSSLSocketFactory(socketFactory);</span><br><span class="line">        httpClientBuilder.setConnectionManager(phccm);</span><br><span class="line">        httpClientBuilder.setConnectionManagerShared(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 重试次数，默认是3次，没有开启</span></span><br><span class="line">        httpClientBuilder.setRetryHandler(<span class="keyword">new</span> DefaultHttpRequestRetryHandler(<span class="number">3</span>, <span class="keyword">true</span>));</span><br><span class="line">        <span class="comment">// 保持长连接配置，需要在头添加Keep-Alive</span></span><br><span class="line">        httpClientBuilder.setKeepAliveStrategy(DefaultConnectionKeepAliveStrategy.INSTANCE);</span><br><span class="line"></span><br><span class="line">        List&lt;Header&gt; headers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        headers.add(<span class="keyword">new</span> BasicHeader(<span class="string">"User-Agent"</span>,</span><br><span class="line">                <span class="string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.59 Safari/537.36"</span>));</span><br><span class="line">        headers.add(<span class="keyword">new</span> BasicHeader(<span class="string">"Connection"</span>, <span class="string">"keep-alive"</span>));</span><br><span class="line"></span><br><span class="line">        httpClientBuilder.setDefaultHeaders(headers);</span><br><span class="line"></span><br><span class="line">        CloseableHttpClient httpClient = httpClientBuilder.build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// httpClient连接配置，底层是配置RequestConfig</span></span><br><span class="line">        HttpComponentsClientHttpRequestFactory factory = <span class="keyword">new</span> HttpComponentsClientHttpRequestFactory();</span><br><span class="line"></span><br><span class="line">        factory.setHttpClient(httpClient);</span><br><span class="line">        <span class="comment">// 连接超时</span></span><br><span class="line">        factory.setConnectTimeout(connectTimeout);</span><br><span class="line">        <span class="comment">// 数据读取超时时间，即SocketTimeout</span></span><br><span class="line">        factory.setReadTimeout(socketTimeout);</span><br><span class="line">        <span class="comment">// 连接不够用的等待时间，不宜过长，必须设置，比如连接不够用时，时间过长将是灾难性的</span></span><br><span class="line">        factory.setConnectionRequestTimeout(requestTimeout);</span><br><span class="line">        <span class="comment">// 缓冲请求数据，默认值是true。通过POST或者PUT大量发送数据时，建议将此属性更改为false，以免耗尽内存。</span></span><br><span class="line">        factory.setBufferRequestBody(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置RestController：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,String&gt; <span class="title">mainRequest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Map&lt;String,String&gt; ret=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        ret.put(<span class="string">"hello"</span>,<span class="string">"world"</span>);</span><br><span class="line">        ret.put(<span class="string">"msg"</span>,<span class="string">"OK"</span>);</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>); <span class="comment">// 故意睡眠5秒返回，测试配置类</span></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>编译项目并运行，使用浏览器测试接口（<a href="http://localhost:8080）：">http://localhost:8080）：</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/643ddaac77abcec75dd1c84fab99332c-45541" alt="浏览器请求"></p></li><li><p>编写测试请求：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResttemplateApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     String res=restTemplate.getForObject(<span class="string">"http://localhost:8080"</span>,String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">     log.info(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/06d894f2d6c803746aa66f84d34f9c25-380316" alt="restTemplate访问"></p></li><li><p>屏蔽mainRequest中的 Thread.sleep(5000); 再次测试访问接口：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/1822cb00c40e9aa20b1798d96a9f7f21-41651" alt="屏蔽睡眠效果"></p></li></ol><h3 id="Get请求"><a href="#Get请求" class="headerlink" title="Get请求"></a>Get请求</h3><h4 id="getForObject"><a href="#getForObject" class="headerlink" title="getForObject"></a>getForObject</h4><ol><li><p>getForObject是对getForEntity函数的进一步封装，返回值返回的是请求的响应体，省去了再去调用getBody；</p></li><li><p>实操：</p><ol><li><p>创建一个Info类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Info</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String hello;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Info</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hello;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHello</span><span class="params">(String hello)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.hello = hello;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>RestTemplate配置类使用基础请求的配置类；</p></li><li><p>创建测试用例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResttemplateApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Info res=restTemplate.getForObject(<span class="string">"http://localhost:8080"</span>,Info<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        log.info(res.getHello());</span><br><span class="line">        log.info(res.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>请求结果：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-08</span><span class="number">-07</span> <span class="number">10</span><span class="string">:02:14.615</span>  <span class="string">INFO</span> <span class="number">52858</span> <span class="string">---</span> <span class="string">[</span>           <span class="string">main]</span> <span class="attr">c.w.t.r.ResttemplateApplicationTests     :</span> <span class="string">world</span></span><br><span class="line"><span class="number">2020</span><span class="number">-08</span><span class="number">-07</span> <span class="number">10</span><span class="string">:02:14.615</span>  <span class="string">INFO</span> <span class="number">52858</span> <span class="string">---</span> <span class="string">[</span>           <span class="string">main]</span> <span class="attr">c.w.t.r.ResttemplateApplicationTests     :</span> <span class="string">OK</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="getForEntity"><a href="#getForEntity" class="headerlink" title="getForEntity"></a>getForEntity</h4><ol><li><p>返回值类型 ResponseEntity，继承自HttpEntity，封装了返回的响应信息，包括响应状态、响应头、响应体等；</p></li><li><p>实操：</p><ol><li><p>Info类上面的getForObject已经创建了；</p></li><li><p>配置类沿用；</p></li><li><p>创建测试用例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResttemplateApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ResponseEntity response=restTemplate.getForEntity(<span class="string">"http://localhost:8080"</span>,Info<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        HttpHeaders resheader=response.getHeaders(); <span class="comment">// 响应头</span></span><br><span class="line">        HttpStatus httpStatus=response.getStatusCode(); <span class="comment">// 响应码</span></span><br><span class="line">        Info info=(Info)response.getBody(); <span class="comment">// 响应体</span></span><br><span class="line">        System.out.println(resheader);</span><br><span class="line">        System.out.println(httpStatus);</span><br><span class="line">        System.out.println(info.getHello());</span><br><span class="line">        System.out.println(info.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>请求结果：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[Content-Type:"application/json",</span> <span class="string">Transfer-Encoding:"chunked",</span> <span class="string">Date:"Fri,</span> <span class="number">07</span> <span class="string">Aug</span> <span class="number">2020</span> <span class="number">02</span><span class="string">:22:45</span> <span class="string">GMT",</span> <span class="string">Keep-Alive:"timeout=60",</span> <span class="string">Connection:"keep-alive"]</span></span><br><span class="line"><span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="string">world</span></span><br><span class="line"><span class="string">OK</span></span><br></pre></td></tr></table></figure></li></ol></li></ol></li></ol><h3 id="POST请求"><a href="#POST请求" class="headerlink" title="POST请求"></a>POST请求</h3><ol><li><p>postForObject发送一个POST请求，并返回一个Object对象；</p></li><li><p>postForEntity发送一个POST请求，并返回一个ResponseEntity对象；</p></li><li><p>postForLocation提交新资源，提交成功之后，返回新资源的URI。参数和前面两种的参数基本一致，只不过该方法的返回值为URI。服务提供者需要在Headers中添加Location字段才能输出URI；</p></li><li><p>实操：</p><ol><li><p>创建一个POST路由：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">mainPost</span><span class="params">( @RequestBody String body,String hello)</span></span>&#123;</span><br><span class="line">    Map&lt;String,Object&gt;ret=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    ret.put(<span class="string">"put"</span>,hello);</span><br><span class="line">    ret.put(<span class="string">"msg"</span>,<span class="string">"OK"</span>);</span><br><span class="line">    ret.put(<span class="string">"body"</span>,body);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置类沿用Get请求的配置类；</p></li><li><p>创建测试postForObject的样例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResttemplateApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String ret=restTemplate.postForObject("http://localhost:8080?hello=&#123;1&#125;","null",String.class,"test");</span><br><span class="line">        System.out.println(ret);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>postForObject测试输出：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;"msg":"OK","body":"null","put":"test"&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>创建测试postForEntity的样例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResttemplateApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ResponseEntity responseEntity=restTemplate.postForEntity("http://localhost:8080?hello=&#123;1&#125;","null",String.class,"test");</span><br><span class="line">        System.out.println(responseEntity.getStatusCode());</span><br><span class="line">        System.out.println(responseEntity.getHeaders());</span><br><span class="line">        System.out.println(responseEntity.getBody());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>postForEntity测试输出：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="string">[Content-Type:"application/json",</span> <span class="string">Transfer-Encoding:"chunked",</span> <span class="string">Date:"Fri,</span> <span class="number">07</span> <span class="string">Aug</span> <span class="number">2020</span> <span class="number">02</span><span class="string">:50:57</span> <span class="string">GMT",</span> <span class="string">Keep-Alive:"timeout=60",</span> <span class="string">Connection:"keep-alive"]</span></span><br><span class="line"><span class="string">&#123;"msg":"OK","body":"null","put":"test"&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>创建一个新的POST服务：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/uri"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> URI <span class="title">mainPostUri</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> URISyntaxException </span>&#123;</span><br><span class="line">    response.setHeader(<span class="string">"Location"</span>,<span class="string">"test"</span>);</span><br><span class="line">    URI uri=<span class="keyword">new</span> URI(<span class="string">"https://www.hao123.com"</span>);</span><br><span class="line">    <span class="keyword">return</span> uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建测试postForLocation的样例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResttemplateApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        URI uri=restTemplate.postForLocation(<span class="string">"http://localhost:8080/uri"</span>,<span class="string">"null"</span>,String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(uri);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>postForLocation测试输出：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">test</span></span><br></pre></td></tr></table></figure><ul><li>从测试输出可以看到响应体的Location得到输出</li></ul></li></ol></li></ol><h3 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h3><ol><li><p>delete方法测试：</p><ol><li><p>创建一个delete路由：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping</span>(<span class="string">"/"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mainDelete</span><span class="params">(String hello)</span></span>&#123;</span><br><span class="line">    Map&lt;String,Object&gt;ret=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    ret.put(<span class="string">"put"</span>,hello);</span><br><span class="line">    ret.put(<span class="string">"msg"</span>,<span class="string">"OK"</span>);</span><br><span class="line">    System.out.println(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置类沿用Get请求的配置类；</p></li><li><p>创建delete测试样例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResttemplateApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        restTemplate.delete(<span class="string">"http://localhost:8080?hello=hello"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>运行测试样例时，应用输出：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;msg=OK,</span> <span class="string">put=hello&#125;</span></span><br></pre></td></tr></table></figure></li></ol></li><li><p>put方法测试：</p><ol><li><p>创建一个put路由：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping</span>(<span class="string">"/"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mainPut</span><span class="params">(String hello)</span></span>&#123;</span><br><span class="line">    Map&lt;String,Object&gt;ret=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    ret.put(<span class="string">"put"</span>,hello);</span><br><span class="line">    ret.put(<span class="string">"msg"</span>,<span class="string">"OK"</span>);</span><br><span class="line">    System.out.println(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置类沿用Get请求的配置类；</p></li><li><p>创建put测试样例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResttemplateApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        restTemplate.put(<span class="string">"http://localhost:8080?hello=hello"</span>,<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>运行测试样例时，应用输出：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;msg=OK,</span> <span class="string">put=hello&#125;</span></span><br></pre></td></tr></table></figure></li></ol></li><li><p>exchange方法测试：</p><ol><li><p>exchange方法跟getForObject、getForEntity、postForObject、postForEntity等方法不同之处在于它可以指定请求的HTTP类型；</p></li><li><p>创建exchange测试样例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResttemplateApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ResponseEntity responseEntity=restTemplate.exchange(<span class="string">"http://localhost:8080"</span>, HttpMethod.GET,<span class="keyword">null</span>,String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(responseEntity.getBody());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>运行测试样例时输出：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"msg"</span>:<span class="string">"OK"</span>,<span class="attr">"hello"</span>:<span class="string">"world"</span>&#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><p>excute的用法与 exchange大同小异了，它同样可以指定不同的 HttpMethod，不同的是它返回的对象是响应体所映射成的对象 ，而不是 ResponseEntity!</p></li><li><p>可以通过下面的方法设置Headers：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPostHeaders</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="comment">//设置请求头</span></span><br><span class="line">       HttpHeaders httpHeaders = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">       httpHeaders.add(<span class="string">"Content-Type"</span>, <span class="string">"application/json;charset=utf-8"</span>);</span><br><span class="line">   </span><br><span class="line">       <span class="comment">//设置请求参数</span></span><br><span class="line">       Map&lt;String, Object&gt; postData = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">       postData.put(<span class="string">"id"</span>, <span class="number">1L</span>);</span><br><span class="line">       postData.put(<span class="string">"name"</span>, <span class="string">"测试"</span>);</span><br><span class="line">       postData.put(<span class="string">"age"</span>, <span class="number">18</span>);</span><br><span class="line">   </span><br><span class="line">       <span class="comment">//将请求头和请求参数设置到HttpEntity中</span></span><br><span class="line">       HttpEntity&lt;Map&lt;String, Object&gt;&gt; httpEntity = <span class="keyword">new</span> HttpEntity&lt;&gt;(postData, httpHeaders);</span><br><span class="line">   </span><br><span class="line">       User user = restTemplate.postForObject(<span class="string">"http://localhost:8080/getUser"</span>, httpEntity, User<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">       System.out.println(user);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="FeignClient"><a href="#FeignClient" class="headerlink" title="FeignClient"></a>FeignClient</h2><h3 id="基础知识-1"><a href="#基础知识-1" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li><p>微服务场景：项目中经常调用基于Http协议的服务，常使用的框架可能有HttpURLConnection、Apache HttpComponnets、OkHttp3 、Netty等！</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/c9c774b00744eba08980fdcd8e6e779b-37844" alt="HTTP客户端流程"></p></li><li><p>Feign 是Netflix提供的一个实现了REST API 客户端的声明式开发框架，Feign允许使用标签注解接口达到声明式的创建REST客户端，具体的实现在运行时提供。Feign将请求模板化，当实际调用的时候，传入参数，根据参数再应用到请求上，进而转化成真正的请求；</p></li><li><p>目的：让REST调用更加简单，可以和SpringCloud进行无缝集成，非常方便地进行服务熔断等操作；</p></li><li><p>Feign提供了HTTP请求的模板，通过编写简单的接口和插入注解，就可以定义好HTTP请求的参数、格式、地址等信息；</p></li><li><p>Feign会完全代理HTTP请求，只需要像调用方法一样调用它就可以完成服务请求及相关处理；</p></li><li><p>SpringCloud对Feign进行了封装，支持了SpringMVC标准注解和HttpMessageConverters，Feign可以与Eureka和Ribbon组合使用从而能支持负载均衡。Feign被广泛应用在Spring Cloud 的解决方案中，是学习基于Spring Cloud 微服务架构不可或缺的重要组件；</p></li><li><p>Feign处理HTTP请求流程如下：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/ac828770011b727ac1cc6cc15a073da2-92628" alt="Feign结构"></p></li><li><p>在Feign 底层，通过基于面向接口的动态代理方式生成实现类，将请求调用委托到动态代理实现类，基本原理如下：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/93d962fc3be45e9eec3f8373e26abecf-21999" alt="Feign底层原理"></p></li><li><p><strong>用了Feign之后调用接口只需要定义相同的接口即可实现调用！</strong></p></li><li><p>使用Feign需要引入依赖，然后还要在启动类上加上<code>@EnableFeignClients</code>注解，如果定义的Feign接口跟启动类不在一个包名下，还需要指定扫描的包名@EnableFeignClients(basePackages = “xx.xx.xx.xx”)。@EnableFeignClients注解的主要功能是初始化FeignClient的配置和动态执行client的请求；</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>建议将接口定义单独抽出来，单独成为一个接口项目，这样无论是哪个项目需要调用接口时，引入公共的接口Jar包即可，而无需再重新定义一次！</p></li><li><p>Feign的使用非常简单，和普通的Service的类一样使用，注入进来，然后直接调用方法就相当于调用远程接口了；</p></li><li><p>Feign的GitHub源码地址：<a href="https://github.com/OpenFeign/feign" target="_blank" rel="noopener">https://github.com/OpenFeign/feign</a></p></li></ol><h3 id="SpringBoot基础使用"><a href="#SpringBoot基础使用" class="headerlink" title="SpringBoot基础使用"></a>SpringBoot基础使用</h3><ol><li><p>创建一个SpringBoot项目，添加依赖(pom.xml)：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>创建RESTful服务：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">Hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; res = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"hello"</span>, <span class="string">"world"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"getString"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(String src)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> src;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"getUser"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(@RequestBody User user)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/upload"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(@RequestParam(<span class="string">"file_upload"</span>)</span> MultipartFile file) </span>&#123;</span><br><span class="line">        System.out.println(file.getOriginalFilename());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String uploadDir=<span class="string">"/home/wanderros/vue_learn/"</span>;</span><br><span class="line">            File dir=<span class="keyword">new</span> File(uploadDir);</span><br><span class="line">            <span class="keyword">if</span>(!dir.exists())&#123;</span><br><span class="line">                dir.mkdir();</span><br><span class="line">            &#125;</span><br><span class="line">            String filename=file.getOriginalFilename();</span><br><span class="line">            File serverFile=<span class="keyword">new</span> File(uploadDir+File.separator+filename);</span><br><span class="line">            file.transferTo(serverFile);</span><br><span class="line">            <span class="comment">// FileUtils.writeByteArrayToFile(new File("/Users/wander/test/files"+file.getOriginalFilename()),file.getBytes());</span></span><br><span class="line">            System.out.println(<span class="string">"成功"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"上传成功"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"上传失败"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在启动类上添加注解@EnableFeignClients：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span>(exclude = &#123;MultipartAutoConfiguration<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">WebApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(WebApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建Feign接口类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"myFeignClient"</span>, url = <span class="string">"http://127.0.0.1:8080"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyFeignClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/getString"</span>)</span><br><span class="line">    <span class="function">String <span class="title">getCategorys</span><span class="params">(@RequestParam String src)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建测试类，自动注入接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyFeignClient myFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String str = myFeignClient.getCategorys(<span class="string">"hello-world"</span>);</span><br><span class="line">        System.out.println(str);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>测试输出：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">hello-world</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="Feign单文件上传（基础使用外拓）"><a href="#Feign单文件上传（基础使用外拓）" class="headerlink" title="Feign单文件上传（基础使用外拓）"></a>Feign单文件上传（基础使用外拓）</h3><ol><li><p>这部分需要理解之前的记录（SpringBoot之Web文件上传），创建项目时添加这部分的支持；</p></li><li><p>在新项目中添加Feign文件上传的依赖（pom.xml）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 文件上传  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>注意：前面基础的依赖也需要添加，如果创建一个新项目的话</li></ul></li><li><p>由于在之前的项目上创建的，因此只需修改接口等：</p><ol><li><p>Feign接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"myFeignClient"</span>, url = <span class="string">"http://127.0.0.1:8080"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyFeignClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/"</span>)</span><br><span class="line">    <span class="function">Map&lt;String,String&gt; <span class="title">getCategorys</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.POST,value = <span class="string">"upload"</span>, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span><br><span class="line">    <span class="function">String <span class="title">upload</span><span class="params">(@RequestPart(<span class="string">"file_upload"</span>)</span> MultipartFile file)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>控制器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/upload"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(@RequestParam(<span class="string">"file_upload"</span>)</span> MultipartFile file) </span>&#123;</span><br><span class="line">    System.out.println(file.getOriginalFilename());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String uploadDir=<span class="string">"/Users/wander/test/file"</span>;</span><br><span class="line">        File dir=<span class="keyword">new</span> File(uploadDir);</span><br><span class="line">        <span class="keyword">if</span>(!dir.exists())&#123;</span><br><span class="line">            dir.mkdir();</span><br><span class="line">        &#125;</span><br><span class="line">        String filename=file.getOriginalFilename();</span><br><span class="line">        File serverFile=<span class="keyword">new</span> File(uploadDir+ File.separator+filename);</span><br><span class="line">        file.transferTo(serverFile);</span><br><span class="line">       <span class="comment">//  FileUtils.writeByteArrayToFile(new File("/Users/wander/test/files"+file.getOriginalFilename()),file.getBytes());</span></span><br><span class="line">        System.out.println(<span class="string">"成功"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"上传成功"</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"上传失败"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MyFeignClient myFeignClient;</span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/upload2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">upload2</span><span class="params">(@RequestPart(<span class="string">"file_upload"</span>)</span> MultipartFile file) </span>&#123;</span><br><span class="line"> <span class="keyword">return</span>   myFeignClient.upload(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>注意：接口的参数注解是@RequestPart。@RequestParam是不可以的</p></li><li><p>添加控制器upload2是为了测试Feign客户端的单文件上传，真的是踩了不少坑之后才解决</p></li></ol></li><li><p>测试文件编写：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResttemplateApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyFeignClient myFeignClient;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        </span><br><span class="line">        File file=<span class="keyword">new</span> File(<span class="string">"/Volumes/Daily/Project/MideaLua/midea/src/D9/T_0000_D9_14.lua"</span>);</span><br><span class="line">        MultipartFile multipartFile = <span class="keyword">new</span> MockMultipartFile(<span class="string">"file_upload"</span>,file.getName(),toString(),<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">        System.out.println(myFeignClient.upload(multipartFile));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>需要注意MockMultipartFile的函数的参数，第一个”file_upload”必须和接口的参数名称一致</li></ul></li><li><p>测试效果如下：</p><ol><li><p>未运行之前：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/7957b5ba0ba864dcf6684f0b909485ac-108323" alt="未运行之前"></p></li><li><p>运行测试之后：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/fabbe96d7b96d718a09a0e2ff389e93f-120781" alt="运行测试之后"></p></li><li><p>浏览器上传：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/314fce51363618078c0c394962141f87-28690" alt="浏览器上传"></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/04404220141069a623f894344ece1467-135941" alt="上传结果"></p></li></ol></li></ol><ol start="8"><li></li></ol><p>使用Apache的httpclient的连接池–启用Apache的httpclient替换其内嵌httpclient，启用Httpclient的连接池方式可能会比Ribbon的客户端loadbalance方式更好。</p><p>依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpcore<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpmime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>添加属性配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span> </span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">httpclient:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">maxConnections:</span> <span class="number">20480</span></span><br><span class="line">    <span class="attr">maxConnectionsPerRoute:</span> <span class="number">512</span></span><br><span class="line">    <span class="attr">timeToLive:</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">connectionTimeout:</span> <span class="number">10000</span></span><br><span class="line">    <span class="attr">userAgent:</span> <span class="string">'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:37.0) Gecko/20100101 Firefox/37.0'</span></span><br></pre></td></tr></table></figure><p>引入FeignAutoConfiguration配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import</span>(FeignAutoConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Configuration</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">FeignConfig</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启用hystrix熔断降级</p><p>添加依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>属性配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span> </span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">15000</span></span><br><span class="line">  <span class="attr">threadpool:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">coreSize:</span> <span class="number">40</span></span><br><span class="line">      <span class="attr">maximumSize:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">maxQueueSize:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure><p>降级策略</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFeignClientFallback</span> <span class="keyword">implements</span> <span class="title">MyFeignClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnResult&lt;ImageVO&gt; <span class="title">uploadFile</span><span class="params">(MultipartFile file, String bucketName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReturnResult&lt;&gt;(<span class="number">5001</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Bean配置</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line"><span class="keyword">public</span> Feign.<span class="function">Builder <span class="title">feignBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> HystrixFeign.builder();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MyFeignClientFallback <span class="title">fb</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyFeignClientFallback();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"><span class="doctag">@FeignClient</span>(</span></span><br><span class="line"><span class="comment">    name = "myFeignClient", </span></span><br><span class="line"><span class="comment">    url = "http://127.0.0.1:8001",</span></span><br><span class="line"><span class="comment">    fallback = MyFeignClientFallback.class,</span></span><br><span class="line"><span class="comment">    configuration = &#123;FeignConfig.class&#125;)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>想处理熔断的具体原因,更新熔断策略代码实现FallbackFactory接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFeignClientFallback</span> <span class="keyword">implements</span> <span class="title">FallbackFactory</span>&lt;<span class="title">MyFeignClient</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyFeignClient <span class="title">create</span><span class="params">(<span class="keyword">final</span> Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyFeignClient() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ReturnResult&lt;ImageVO&gt; <span class="title">uploadFile</span><span class="params">(MultipartFile file, String bucketName)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 处理cause</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ReturnResult&lt;&gt;(<span class="number">5001</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MyFeignClientFallback <span class="title">fbf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyFeignClientFallback();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"><span class="doctag">@FeignClient</span>(</span></span><br><span class="line"><span class="comment">    name = "myFeignClient", </span></span><br><span class="line"><span class="comment">    url = "http://127.0.0.1:8001",</span></span><br><span class="line"><span class="comment">    fallbackFactory = MyFeignClientFallback.class,</span></span><br><span class="line"><span class="comment">    configuration = &#123;FeignConfig.class&#125;)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;进行微服务开发时，可以使用@Controller以及@RestController注解来对外提供服务，但是也避免不了要使用HTTP客户端访问
      
    
    </summary>
    
    
      <category term="SpringBoot" scheme="https://wanderros.github.io/categories/SpringBoot/"/>
    
    
  </entry>
  
  <entry>
    <title>SpringCloud Eureka Quick Start</title>
    <link href="https://wanderros.github.io/2020/08/05/SpringCloud-Eureka-Quick-Start/"/>
    <id>https://wanderros.github.io/2020/08/05/SpringCloud-Eureka-Quick-Start/</id>
    <published>2020-08-05T01:29:36.000Z</published>
    <updated>2020-10-01T08:52:15.920Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>服务发现是基于微服务体系结构的关键原则之一。尝试手工配置每个客户端或某种形式的约定可能很困难，而且很脆弱。Eureka是Netflix的服务发现服务器和客户端，可以将服务器配置和部署为高可用性，每个服务器将注册服务的状态复制到其他服务器。本文主要记录SpringCloud Eureka相关技术的操作，真实的使用还需要进行实战才能强化！</p><hr><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol><li><p>服务发现的两种方式：</p><ul><li><p>客户端发现</p><ul><li>Eureka</li></ul></li><li><p>服务端发现</p><ul><li>Nginx</li><li>Zookeeper</li><li>Kubernetes</li></ul></li></ul></li><li><p>康威定律：任何组织在设计一套系统时，所交付的设计方案在结构上都与该组织的沟通结构保持一致！——沟通的问题会影响架构结构。</p></li><li><p>微服务特点之一是异构，主要表现在：</p><ul><li>不同语言</li><li>不同类型的数据库</li></ul></li><li><p>应用间通信方式有HTTP和RPC，典型代表有：</p><ul><li>HTTP——SpringCloud</li><li>RPC——Dubbo</li></ul></li><li><p>SpringCloud中服务间有两种RESTful调用方式：</p><ul><li>RestTemplate</li><li>Feign</li></ul></li><li><p>SpringCloud中各种组件的功能描述：</p><ul><li>Eureka Client——负责将服务的信息注册到Eureka Server中</li><li>Eureka Server——注册中心，里面有一个注册表，保存了各个服务所在的机器和端口号</li><li>Feign——使用动态代理技术，来动态构造出请求的服务的地址</li><li>Ribbon——和Feign以及Eureka紧密协作完成负载均衡的功能</li><li>Hystrix——隔离、熔断以及降级的一个框架</li><li>Zuul——（微服务网关组件）负责网络路由，一般微服务架构中都必然会设计一个网关在里面</li></ul></li></ol><h2 id="网关Zuul"><a href="#网关Zuul" class="headerlink" title="网关Zuul"></a>网关Zuul</h2><ol><li><p>Zuul是Netflix开源的微服务网关，可以和Eureka、Ribbon、Hystrix等组件配合使用，Spring Cloud对Zuul进行了整合与增强，Zuul默认使用的HTTP客户端是Apache HTTPClient，也可以使用RestClient或okhttp3.OkHttpClient；</p></li><li><p>主要功能：路由转发和过滤器</p></li><li><p>工作原理：在把请求路由到网关之后的服务过程中，通过一系列的过滤器进行处理，达到预期的效果，和Servlet框架的Filter以及AOP类似；</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/06b983e45d45493ba85a05ad9a34476b-109561" alt="Zuul原理"></p></li><li><p>过滤器的主要应用：</p><ul><li>身份验证和安全性 - 确定每个资源的身份验证要求并拒绝不满足这些要求的请求</li><li>洞察和监控 - 在边缘跟踪有意义的数据和统计数据，以便为我们提供准确的生产视图</li><li>动态路由 - 根据需要动态地将请求路由到不同的后端集群</li><li>压力测试 - 逐渐增加集群的流量以衡量性能</li><li>Load Shedding - 为每种类型的请求分配容量并删除超过限制的请求</li><li>静态响应处理 - 直接在边缘构建一些响应，而不是将它们转发到内部集群</li></ul></li><li><p>过滤器的生命周期：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/c1ecae7ac44b251fbda1c7d696fe5da5-38780" alt="过滤器的生命周期"></p></li><li><p>Zuul的组件：</p><ul><li>zuul-core——zuul核心库，包含编译和执行过滤器的核心功能</li><li>zuul-simple-webapp——zuul Web应用程序示例，展示了如何使用zuul-core构建应用程序</li><li>zuul-netflix——lib包，将其他NetflixOSS组件添加到Zuul中，例如使用功能区进去路由请求处理</li><li>zuul-netflix-webapp——webapp，它将zuul-core和zuul-netflix封装成一个简易的webapp工程包</li></ul></li><li><p>在zuul中，路由匹配的路径表达式采用ant风格定义</p><table><thead><tr><th>通配符</th><th>说明</th></tr></thead><tbody><tr><td>？</td><td>匹配任意单个字符</td></tr><tr><td>*</td><td>匹配任意数量的字符</td></tr><tr><td>**</td><td>匹配任意数量的字符，支持多级目录</td></tr></tbody></table><ul><li><p>默认情况下，Zuul在请求路由时，会过滤掉http请求头信息中一些敏感信息，防止它们被传递到下游的外部服务器，通过zuul.sensitive-headers来进行配置，不过滤掉直接填空值即可</p></li><li><p>参考配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建路由地址</span></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="comment"># 这里可以自定义</span></span><br><span class="line">    <span class="attr">demo2:</span></span><br><span class="line">      <span class="comment"># 匹配的路由规则</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/demo/**</span></span><br><span class="line">      <span class="comment"># 路由的目标服务名</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">demo</span></span><br><span class="line"><span class="comment"># 关闭使用eureka负载路由</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eureka:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 如果不使用eureka的话，需要自己定义路由的那个服务的其他负载服务</span></span><br></pre></td></tr></table></figure></li></ul></li></ol><h2 id="限流、熔断和降级Hystrix-hɪst’rɪks"><a href="#限流、熔断和降级Hystrix-hɪst’rɪks" class="headerlink" title="限流、熔断和降级Hystrix [hɪst’rɪks]"></a>限流、熔断和降级Hystrix [hɪst’rɪks]</h2><ol><li><p>Hystrix是由Netflix开源的一个延迟和容错库，用于隔离访问远程系统、服务或者第三方库，防止级联失败，从而提升系统的可用性、容错性与局部应用的弹性，是一个实现了超时机制和断路器模式的工具类库！</p></li><li><p>在理想状态下，一个应用依赖的服务都是健康可用的，可以正常的处理所有的请求。但是当某一个服务出现延迟时，所有的请求都阻塞在依赖的服务上，会导致服务阻塞，可能引起服务雪崩；</p></li><li><p>使用了Hystrix时，Hystrix将所有的外部调用都封装成一个HystrixCommand或者HystrixObservableCommand对象，这些外部调用将会在一个独立的线程中运行。可以将出现问题的服务通过熔断、降级等手段隔离开来，这样不影响整个系统的主业务；</p></li><li><p>Hystrix工作原理：</p><ul><li>使用命令模式将所有对外部服务（或依赖关系）的调用包装在HystrixCommand或HystrixObservableCommand对象中，并将该对象放在单独的线程中执行</li><li>每个依赖都维护着一个线程池（或信号量），线程池被耗尽则拒绝请求（而不是让请求排队）</li><li>记录请求成功，失败，超时和线程拒绝</li><li>服务错误百分比超过了阈值，熔断器开关自动打开，一段时间内停止对该服务的所有请求</li><li>请求失败，被拒绝，超时或熔断时执行降级逻辑</li><li>近实时地监控指标和配置的修改</li></ul></li><li><p>Hystrix配置示例：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 线程池大小</span></span><br><span class="line"><span class="meta">hystrix.threadpool.default.coreSize</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"># 缓冲区大小， 如果为-1，则不缓冲，直接进行降级 fallback</span></span><br><span class="line"><span class="meta">hystrix.threadpool.default.maxQueueSize</span>=<span class="string">200</span></span><br><span class="line"><span class="comment"># 缓冲区大小超限的阈值，超限就直接降级</span></span><br><span class="line"><span class="meta">hystrix.threadpool.default.queueSizeRejectionThreshold</span>=<span class="string">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行策略</span></span><br><span class="line"><span class="comment"># 资源隔离模式，默认thread。 还有一种叫信号量</span></span><br><span class="line"><span class="meta">hystrix.command.default.execution.isolation.strategy</span>=<span class="string">THREAD</span></span><br><span class="line"><span class="comment"># 是否打开超时</span></span><br><span class="line"><span class="meta">hystrix.command.default.execution.timeout.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 超时时间，默认1000毫秒</span></span><br><span class="line"><span class="meta">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</span>=<span class="string">15000</span></span><br><span class="line"><span class="comment"># 超时时中断线程</span></span><br><span class="line"><span class="meta">hystrix.command.default.execution.isolation.thread.interruptOnTimeout</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 取消时候中断线程</span></span><br><span class="line"><span class="meta">hystrix.command.default.execution.isolation.thread.interruptOnFutureCancel</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 信号量模式下，最大并发量</span></span><br><span class="line"><span class="meta">hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests</span>=<span class="string">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 降级策略</span></span><br><span class="line"><span class="comment"># 是否开启服务降级</span></span><br><span class="line"><span class="meta">hystrix.command.default.fallback.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># fallback执行并发量</span></span><br><span class="line"><span class="meta">hystrix.command.default.fallback.isolation.semaphore.maxConcurrentRequests</span>=<span class="string">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 熔断策略</span></span><br><span class="line"><span class="comment"># 启用/禁用熔断机制</span></span><br><span class="line"><span class="meta">hystrix.command.default.circuitBreaker.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 强制开启熔断</span></span><br><span class="line"><span class="meta">hystrix.command.default.circuitBreaker.forceOpen</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 强制关闭熔断</span></span><br><span class="line"><span class="meta">hystrix.command.default.circuitBreaker.forceClosed</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 前提条件，一定时间内发起一定数量的请求。  也就是5秒钟内(这个5秒对应下面的滚动窗口长度)至少请求4次，熔断器才发挥起作用。  默认20</span></span><br><span class="line"><span class="meta">hystrix.command.default.circuitBreaker.requestVolumeThreshold</span>=<span class="string">4</span></span><br><span class="line"><span class="comment"># 错误百分比。达到或超过这个百分比，熔断器打开。  比如：5秒内有4个请求，2个请求超时或者失败，就会自动开启熔断</span></span><br><span class="line"><span class="meta">hystrix.command.default.circuitBreaker.errorThresholdPercentage</span>=<span class="string">50</span></span><br><span class="line"><span class="comment"># 10秒后，进入半打开状态（熔断开启，间隔一段时间后，会让一部分的命令去请求服务提供者，如果结果依旧是失败，则又会进入熔断状态，如果成功，就关闭熔断）。 默认5秒</span></span><br><span class="line"><span class="meta">hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds</span>=<span class="string">10000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 度量策略</span></span><br><span class="line"><span class="comment"># 5秒为一次统计周期，术语描述：滚动窗口的长度为5秒</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.rollingStats.timeInMilliseconds</span>=<span class="string">5000</span></span><br><span class="line"><span class="comment"># 统计周期内 度量桶的数量，必须被timeInMilliseconds整除。作用：</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.rollingStats.numBuckets</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># 是否收集执行时间，并计算各个时间段的百分比</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.rollingPercentile.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 设置执行时间统计周期为多久，用来计算百分比</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.rollingPercentile.timeInMilliseconds</span>=<span class="string">60000</span></span><br><span class="line"><span class="comment"># 执行时间统计周期内，度量桶的数量</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.rollingPercentile.numBuckets</span>=<span class="string">6</span></span><br><span class="line"><span class="comment"># 执行时间统计周期内，每个度量桶最多统计多少条记录。设置为50，有100次请求，则只会统计最近的10次</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.rollingPercentile.bucketSize</span>=<span class="string">100</span></span><br><span class="line"><span class="comment"># 数据取样时间间隔</span></span><br><span class="line"><span class="meta">hystrix.command.default.metrics.healthSnapshot.intervalInMilliseconds</span>=<span class="string">500</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置是否缓存请求，request-scope内缓存</span></span><br><span class="line"><span class="meta">hystrix.command.default.requestCache.enabled</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 设置HystrixCommand执行和事件是否打印到HystrixRequestLog中</span></span><br><span class="line"><span class="meta">hystrix.command.default.requestLog.enabled</span>=<span class="string">false</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 限流策略</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果没有定义HystrixThreadPoolKey，HystrixThreadPoolKey会默认定义为HystrixCommandGroupKey的值</span></span><br><span class="line"><span class="meta">hystrix.threadpool.userGroup.coreSize</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">hystrix.threadpool.userGroup.maxQueueSize</span>=<span class="string">-1</span></span><br><span class="line"><span class="meta">hystrix.threadpool.userGroup.queueSizeRejectionThreshold</span>=<span class="string">800</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">hystrix.threadpool.userThreadPool.coreSize</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">hystrix.threadpool.userThreadPool.maxQueueSize</span>=<span class="string">-1</span></span><br><span class="line"><span class="meta">hystrix.threadpool.userThreadPool.queueSizeRejectionThreshold</span>=<span class="string">800</span></span><br><span class="line"><span class="meta">hystrix.command.userCommandKey.execution.isolation.thread.timeoutInMilliseconds</span>=<span class="string">5000</span></span><br></pre></td></tr></table></figure></li><li><p>Hystrix支持以注解的形式配置，通过@HystrixCommand注解的fallbackMethod属性指定降级方法；通过@HystrixProperty的name value键值对进行配置commandProperties<code>和</code>threadPoolProperties；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"timeoutFallback"</span>, threadPoolProperties = &#123;</span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"coreSize"</span>, value = <span class="string">"20"</span>),</span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"queueSizeRejectionThreshold"</span>, value = <span class="string">"20"</span>)</span><br><span class="line">    &#125;, commandProperties = &#123;</span><br><span class="line">            <span class="meta">@HystrixProperty</span>(name = <span class="string">"execution.isolation.thread.timeoutInMilliseconds"</span>, value = <span class="string">"8000"</span>)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></li><li><p>在客户端需要使用@EnableCircuitBreaker启用熔断机制；</p></li><li><p>Hystrix配置属性说明：<a href="https://github.com/Netflix/Hystrix/wiki/Configuration" target="_blank" rel="noopener">https://github.com/Netflix/Hystrix/wiki/Configuration</a></p></li></ol><h2 id="配置ConfigServer"><a href="#配置ConfigServer" class="headerlink" title="配置ConfigServer"></a>配置ConfigServer</h2><ol><li><p>在分布式系统中，Spring Cloud提供一个Config子项目，该项目核心就是配置中心，通过一个服务端和多个客户端实现配置服务！</p></li><li><p>功能：使用配置服务器集中的管理所有服务的各种环境配置文件；</p></li><li><p>需要使用@EnableConfigServer来启动配置服务；配合Eureke可实现服务发现，配合Cloud Bus可实现配置推送更新；</p></li><li><p>需要添加bootstrap.yml配置文件，文件内容类似下面的：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/hellxz/SpringCloudlearn</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">config-repo</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">username</span> </span><br><span class="line">          <span class="attr">password:</span> <span class="string">password</span></span><br></pre></td></tr></table></figure><ul><li>search-paths指定的是匹配查询的路径名</li><li>username和password是访问仓库的用户名和密码</li></ul></li><li><p>Config支持使用的请求的参数规则有：</p><ul><li>/ { 应用名 } / { 环境名 } [ / { 分支名 } ]</li><li>/ { 应用名 } - { 环境名 }.yml</li><li>/ { 应用名 } - { 环境名 }.properties</li><li>/ { 分支名 } / { 应用名 } - { 环境名 }.yml</li><li>/ { 分支名 } / { 应用名 } - { 环境名 }.properties</li></ul></li><li><p>Config Server工作原理：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/a4de5d67c6fdab86808d2cd3ba8ce204-26808" alt="Config Server工作原理"></p><ul><li>远程git仓库——用来存储配置文件的地方</li><li>Config Server——分布式配置中心</li><li>微服务应用——配置了ConfigClient的微服务</li></ul></li><li><p>Config Server启动流程：</p><ol><li>微服务应用启动，根据bootstrap.yml（properties）中配置的应用名（application）、环境名（profile）、分支名（label），向Config Server请求配置信息</li><li>Config Server 根据自己bootstrap.yml（properties）中的Git（或SVN）仓库信息加上客户端传来的配置定位信息去查配置信息的路径</li><li>Config Server 执行git clone命令，将配置信息下载到本地Git仓库中，将配置信息加载到Spring的ApplicationContext读取内容返回给客户端（微服务应用）</li><li>客户端将内容加载到ApplicationContext，配置内容的优先级大于客户端内部的配置内容，进行忽略</li></ol><ul><li>当Config Server因为网络原因无法连接到Git或SVN时，客户端的请求过来后，会先连接Git或SVN，如果没连上，就使用本地仓库的配置文件内容进行返回给客户端</li></ul></li><li><p>Config Server可以配置多个仓库，配置示例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/spring-cloud-samples/config-repo</span>   <span class="comment">#默认的仓库</span></span><br><span class="line">          <span class="attr">repos:</span></span><br><span class="line">            <span class="attr">simple:</span> <span class="string">https://github.com/simple/config-repo</span></span><br><span class="line">            <span class="attr">special:</span></span><br><span class="line">              <span class="attr">pattern:</span> <span class="string">special*/dev*,*special*/dev*</span></span><br><span class="line">              <span class="attr">uri:</span> <span class="string">https://github.com/special/config-repo</span></span><br><span class="line">            <span class="attr">local:</span></span><br><span class="line">              <span class="attr">pattern:</span> <span class="string">local*</span></span><br><span class="line">              <span class="attr">uri:</span> <span class="string">file:/home/configsvc/config-repo</span></span><br><span class="line">            <span class="attr">test:</span> </span><br><span class="line">              <span class="attr">pattern:</span> </span><br><span class="line">                <span class="bullet">-</span> <span class="string">'*/development'</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">'*/staging'</span></span><br><span class="line">              <span class="attr">uri:</span> <span class="string">https://github.com/development/config-repo</span></span><br></pre></td></tr></table></figure><ul><li>simple 仓库自动匹配到 simple/*</li><li>special 仓库的pattern，第一个是应用名以special开头，环境名以dev开头；第二个是应用名包含special，环境名以dev开头；多个匹配到同一uri的pattern用逗号分割</li><li>local 仓库的的pattern也会自动补全为local<em>/</em></li><li>test仓库中的 pattern 是以通配符开始的，需要使用单引号</li><li><strong>配置多个仓库时，Config Server 在启动时会直接克隆第一个仓库的配置库，其他配置库只有请求时才会clone到本地</strong></li></ul></li></ol><h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><ol><li><p><strong>SpringCloud Config的手动刷新：</strong>在Config Server以及Config Client都在运行的情况下，修改GitHub中的配置文件中的内容，然后再手动刷新Config Client就可以不重启任何服务的情况达到效果，但是需要注意以下点：</p><ul><li><p>Config Client需要添加actuator依赖，并且暴露refresh端点的配置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">endpoint:</span></span><br><span class="line"><span class="attr">web:</span></span><br><span class="line"><span class="attr">exposure:</span></span><br><span class="line"><span class="attr">include:</span> <span class="string">refresh</span></span><br></pre></td></tr></table></figure></li><li><p>对于引用了GitHub配置文件的类上加上注解@RefreshScope</p></li><li><p>手动POST Config Client的/actuator/refresh接口</p></li></ul></li><li><p>在配置使用Feign时，添加了之前可以使用的一些依赖但是导致在项目中一直出现如下错误：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nested exception is java.lang.NoClassDefFoundError</span><br></pre></td></tr></table></figure><ul><li>只添加spring-cloud-starter-openfeign即可，其他的依赖项添加不对的话，会导致依赖出现问题</li></ul></li><li><p>Ribbon的负载均衡策略主要有以下几种：</p><ul><li>com.netflix.loadbalancer.RandomRule #配置规则 随机</li><li>com.netflix.loadbalancer.RoundRobinRule #配置规则 轮询</li><li>com.netflix.loadbalancer.RetryRule #配置规则 重试</li><li>com.netflix.loadbalancer.WeightedResponseTimeRule #配置规则 响应时间权重</li><li>com.netflix.loadbalancer.BestAvailableRule #配置规则 最空闲连接策略</li></ul></li><li><p>@FeignClient注解参数说明：</p><ul><li>name——指定FeignClient的名称，如果项目使用了Ribbon，name属性会作为微服务的名称，用于服务发现</li><li>fallback——定义容错的处理类，当调用远程接口失败或超时时，会调用对应接口的容错逻辑，fallback指定的类必须实现@FeignClient标记的接口</li><li>fallbackFactory——工厂类，用于生成fallback类示例，通过这个属性我们可以实现每个接口通用的容错逻辑，减少重复的代码</li><li>path——定义当前FeignClient的统一前缀，类似于注解到类上的@RequestMapping的功能</li><li><strong>注意：</strong>出现fallback method wasn’t found异常时，是因为指定的备用方法和原方法的参数个数或类型不同造成的，需要统一参数的类型和个数</li></ul></li><li><p>在注册完服务之后，服务提供者会维护一个心跳用来持续告诉 Eureka Server“我还活着”，以防止 Eureka Server 的“剔除任务”将该服务实例从服务列表中排除出去，我们称该操作为服务续约（Renew），关于服务续约有如下两个重要属性，可以根据需求来调整：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义服务续约任务的调用时间间隔（即发送心跳给server端的频率），默认为30秒</span></span><br><span class="line"><span class="meta">eureka.instance.lease-renewal-interval-in-seconds</span>=<span class="string">30</span></span><br><span class="line"><span class="comment"># 定于服务失效的时间（即server端多长时间没收到心跳后就将此实例剔除)，默认为90秒</span></span><br><span class="line"><span class="meta">eureka.instance.lease-expiration-duration-in-seconds</span>=<span class="string">90</span></span><br></pre></td></tr></table></figure></li></ol><h1 id="动手实操"><a href="#动手实操" class="headerlink" title="动手实操"></a>动手实操</h1><h2 id="Eureka服务端"><a href="#Eureka服务端" class="headerlink" title="Eureka服务端"></a>Eureka服务端</h2><ol><li><p>创建一个SpringCloud Eureka的注册中心服务端项目，选中Spring Cloud Discovery下的Eureka Server即可；</p></li><li><p>开启注解@EnableEurekaServer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>直接启动能够打开<a href="http://localhost:8080，但是终端会报错误，效果如下：">http://localhost:8080，但是终端会报错误，效果如下：</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/2822219a5796fa99ab43b0ff472d5dc7-121093" alt="Eureka网页"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">com.netflix.discovery.shared.transport.TransportException: Cannot execute request on any known server</span><br><span class="line">at com.netflix.discovery.shared.transport.decorator.RetryableEurekaHttpClient.execute(RetryableEurekaHttpClient.java:<span class="number">112</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">at com.netflix.discovery.shared.transport.decorator.EurekaHttpClientDecorator.register(EurekaHttpClientDecorator.java:<span class="number">56</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">at com.netflix.discovery.shared.transport.decorator.EurekaHttpClientDecorator$<span class="number">1</span>.execute(EurekaHttpClientDecorator.java:<span class="number">59</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">at com.netflix.discovery.shared.transport.decorator.SessionedEurekaHttpClient.execute(SessionedEurekaHttpClient.java:<span class="number">77</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">at com.netflix.discovery.shared.transport.decorator.EurekaHttpClientDecorator.register(EurekaHttpClientDecorator.java:<span class="number">56</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">at com.netflix.discovery.DiscoveryClient.register(DiscoveryClient.java:<span class="number">857</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">at com.netflix.discovery.InstanceInfoReplicator.run(InstanceInfoReplicator.java:<span class="number">121</span>) ~[eureka-client-<span class="number">1.9</span><span class="number">.21</span>.jar:<span class="number">1.9</span><span class="number">.21</span>]</span><br><span class="line">at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:<span class="number">515</span>) ~[na:na]</span><br><span class="line">at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">264</span>) ~[na:na]</span><br><span class="line">at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:<span class="number">304</span>) ~[na:na]</span><br><span class="line">at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1128</span>) ~[na:na]</span><br><span class="line">at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">628</span>) ~[na:na]</span><br><span class="line">at java.base/java.lang.Thread.run(Thread.java:<span class="number">834</span>) ~[na:na]</span><br></pre></td></tr></table></figure></li><li><p>添加配置如下（application.yml）：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span> <span class="comment"># 本身也是客户端，注册到自己的服务中心</span></span><br><span class="line">   <span class="comment"># register-with-eureka: false # 关闭在注册中心的显示</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka</span> <span class="comment"># 修改应用名</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span> <span class="comment"># 修改端口号</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EurekaClientConfigBean.class    </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">EurekaClientConfigBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serviceUrl.put(<span class="string">"defaultZone"</span>, <span class="string">"http://localhost:8761/eureka/"</span>);</span><br><span class="line">        <span class="keyword">this</span>.gZipContent = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.useDnsForFetchingServiceUrls = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.registerWithEureka = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.preferSameZoneEureka = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.availabilityZones = <span class="keyword">new</span> HashMap();</span><br><span class="line">        <span class="keyword">this</span>.filterOnlyUpInstances = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.fetchRegistry = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.dollarReplacement = <span class="string">"_-"</span>;</span><br><span class="line">        <span class="keyword">this</span>.escapeCharReplacement = <span class="string">"__"</span>;</span><br><span class="line">        <span class="keyword">this</span>.allowRedirects = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.onDemandUpdateStatusChange = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.clientDataAccept = EurekaAccept.full.name();</span><br><span class="line">        <span class="keyword">this</span>.shouldUnregisterOnShutdown = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.shouldEnforceRegistrationAtInit = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.order = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>重新启动服务之后，等待一段时间就可以查看<a href="http://localhost:8761，效果如下：">http://localhost:8761，效果如下：</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/79d1fd2acf5008e79aaa18086e7bf20d-122728" alt="Eureka自注册"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">08</span>-<span class="number">05</span> <span class="number">09</span>:<span class="number">44</span>:<span class="number">00.893</span>  INFO <span class="number">25750</span> --- [freshExecutor-<span class="number">0</span>] com.netflix.discovery.DiscoveryClient    : Getting all instance registry info from the eureka server</span><br><span class="line"><span class="number">2020</span>-<span class="number">08</span>-<span class="number">05</span> <span class="number">09</span>:<span class="number">44</span>:<span class="number">00.897</span>  INFO <span class="number">25750</span> --- [freshExecutor-<span class="number">0</span>] com.netflix.discovery.DiscoveryClient    : The response status is <span class="number">200</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">08</span>-<span class="number">05</span> <span class="number">09</span>:<span class="number">44</span>:<span class="number">01.041</span>  INFO <span class="number">25750</span> --- [      Thread-<span class="number">16</span>] c.n.e.registry.AbstractInstanceRegistry  : Registered instance EUREKA/<span class="number">192.168</span><span class="number">.3</span><span class="number">.108</span>:eureka:<span class="number">8761</span> <span class="function">with status <span class="title">UP</span> <span class="params">(replication=<span class="keyword">true</span>)</span></span></span><br><span class="line"><span class="function">2020-08-05 09:44:01.041  INFO 25750 --- [      Thread-16] c.n.e.r.PeerAwareInstanceRegistryImpl    : Got 1 instances from neighboring DS node</span></span><br><span class="line"><span class="function">2020-08-05 09:44:01.041  INFO 25750 --- [      Thread-16] c.n.e.r.PeerAwareInstanceRegistryImpl    : Renew threshold is: 1</span></span><br><span class="line"><span class="function">2020-08-05 09:44:01.041  INFO 25750 --- [      Thread-16] c.n.e.r.PeerAwareInstanceRegistryImpl    : Changing status to UP</span></span><br><span class="line"><span class="function">2020-08-05 09:44:01.047  INFO 25750 --- [      Thread-16] e.s.EurekaServerInitializerConfiguration : Started Eureka Server</span></span><br><span class="line"><span class="function">2020-08-05 09:45:01.044  INFO 25750 --- [a-EvictionTimer] c.n.e.registry.AbstractInstanceRegistry  : Running the evict task with compensationTime 0ms</span></span><br></pre></td></tr></table></figure><ul><li>通过终端可以看到自己注册到了服务中</li><li>使用register-with-eureka: false 可以关闭自注册，取消配置文件中的注释就看不到自注册了</li></ul></li><li><p><strong>修改配置，支持密码保护：</strong></p><ul><li><p>添加安全依赖（pom.xml）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>修改配置文件（application.yml）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@127.0.0.1:8761/eureka/</span> <span class="comment"># 本身也是客户端，注册到自己的服务中心 username : password@</span></span><br><span class="line">    <span class="comment"># register-with-eureka: false # 关闭在注册中心的显示</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka</span> <span class="comment"># 修改应用名</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">basic:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span> <span class="comment"># 修改端口号</span></span><br></pre></td></tr></table></figure></li><li><p>安全配置（跨域问题，账户登录问题）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.csrf().disable();</span><br><span class="line">        <span class="keyword">super</span>.configure(http);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>如果不将csrf检验关闭，会出现其他服务无法注册进 eureka注册中心的情况</li><li>如果不添加父类的配置，则无法进行安全认证的情况</li></ul></li><li><p>客户端的注册地址要修改成<a href="http://admin:admin@127.0.0.1:8761/eureka/类似的地址" target="_blank" rel="noopener">http://admin:admin@127.0.0.1:8761/eureka/类似的地址</a></p></li></ul></li></ol><h2 id="Eureka客户端"><a href="#Eureka客户端" class="headerlink" title="Eureka客户端"></a>Eureka客户端</h2><ol><li><p>创建一个SpringCloud项目，选择Web下的Spring Web以及Spring Cloud Discovery下的Eureka Discovery Client；</p></li><li><p>开启注解@EnableDiscoveryClient：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaclientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaclientApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>添加配置文件（application.yml）:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line"><span class="comment">#  instance:</span></span><br><span class="line"><span class="comment">#    hostname: test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eurekaclient</span></span><br></pre></td></tr></table></figure></li><li><p>启动服务，查看Eureka服务端网址<a href="http://localhost:8761" target="_blank" rel="noopener">http://localhost:8761</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/1968f2b0984809bf464876564eef9f14-116933" alt="Eureka客户端注册"></p></li><li><p>开发过程中可以关闭Eureka服务的自我保护模式，在注册中心配置application.yml：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span> <span class="comment"># 本身也是客户端，注册到自己的服务中心</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment"># 关闭在注册中心的显示</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span> <span class="comment"># 关闭自我保护</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka</span> <span class="comment"># 修改应用名</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span> <span class="comment"># 修改端口号</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="Eureka高可用注册"><a href="#Eureka高可用注册" class="headerlink" title="Eureka高可用注册"></a>Eureka高可用注册</h2><ol><li><p>多个注册中心相互注册自己的客户端，修改application.yml即可：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 两个注册中心,注册中心配置文件</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br></pre></td></tr></table></figure></li><li><p>客户端注册的时候要注册到<strong>每个注册中心</strong>，防止其中任何一个注册中心宕机都还是可用的</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端配置文件</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/,http://localhost:8762/eureka/</span></span><br><span class="line"><span class="comment">#  instance:</span></span><br><span class="line"><span class="comment">#    hostname: test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eurekaclient</span></span><br></pre></td></tr></table></figure></li><li><p>效果：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/732ec4bbbf754ffaedb2cdc4f9bc93cf-137465" alt="Eureka1号注册中心"></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/a12149d58adf941cebceaca9406b2bf0-140073" alt="Eureka2号注册中心"></p></li><li><p>在开发的项目的正式发布环境中一般至少保证有两个注册中心。</p></li></ol><h2 id="ConfigServer服务"><a href="#ConfigServer服务" class="headerlink" title="ConfigServer服务"></a>ConfigServer服务</h2><ol><li><p>创建一个SpringCloud ConfigServer服务的项目，主要依赖如下（pom.xml）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringCloud 整合 config-server --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- SpringCloud 整合 eureka客户端 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在启动类上添加Eureka客户端以及ConfigServer注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigserverApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigserverApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在GitHub上创建一个github配置文件项目，可以公开或者私有，私有的话，SpringCloud的ConfigServer项目配置文件中就要输入密码；</p></li><li><p>修改应用配置文件（application.yml）:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># 使用ip</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span>  <span class="comment"># 修改了安全，这个会单独说明</span></span><br><span class="line">    <span class="attr">instance:</span></span><br><span class="line">      <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># 使用ip</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">configserver</span>  <span class="comment"># 项目名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/WanderROS/cloudconfig</span> <span class="comment"># 配置git仓库的地址（最后不需要带/，否则会出现：No custom http config found for URL: XXX）</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">/</span> <span class="comment"># git仓库地址下的相对搜索地址（可用使用通配符），可以配置多个，用,分割。可以&#123;application&#125;实现按应用查配置</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">wanderros</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">******</span></span><br><span class="line">          <span class="attr">default-label:</span> <span class="string">master</span> <span class="comment">#选择分支</span></span><br></pre></td></tr></table></figure></li><li><p>配置好了就可以直接启动配置服务器了，然后访问配置服务器的地址：<a href="http://localhost:8080/service-dev.json，注意这个是要在github配置中有，不然是访问不到的：" target="_blank" rel="noopener">http://localhost:8080/service-dev.json，注意这个是要在github配置中有，不然是访问不到的：</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/67ff71ae722b14068bf54ec71013db35-35448" alt="github内容"></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/d3cd3bf9c1169c1c7a60a3a7c6d06cc9-21040" alt="config网址内容"></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/90d1ce032ea695483d0bc7ae1a41c05e-120477" alt="config添加到注册中心"></p></li></ol><h2 id="ConfigClient"><a href="#ConfigClient" class="headerlink" title="ConfigClient"></a>ConfigClient</h2><ol><li><p>创建一个服务，使用ConfigServer的配置，项目主要依赖如下（pom.xml）:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在启动类上添加Eureka客户端注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientserviceApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ClientserviceApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>创建配置文件bootstrap.yml，并添加内容：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service</span>   <span class="comment">#指定了配置文件的应用名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8080/</span>  <span class="comment">#Config server的uri </span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span>     <span class="comment">#指定的环境</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span>                      <span class="comment">#指定分支</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span></span><br><span class="line">    <span class="attr">instance:</span></span><br><span class="line">      <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure></li><li><p>创建一个RESTful控制器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RestController</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;hello&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">serviceHello</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; ret = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        ret.put(<span class="string">"test"</span>, <span class="string">"hello"</span>);</span><br><span class="line">        ret.put(<span class="string">"age"</span>, <span class="number">18</span>);</span><br><span class="line">        ret.put(<span class="string">"status"</span>, <span class="string">"success"</span>);</span><br><span class="line">        ret.put(<span class="string">"hello"</span>, name);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>注意注入了配置服务器中的hello字段的内容，如果配置服务器没启动会报错的</li><li>还添加了@RefreshScope注解，这个是github配置文件修改后进行手动刷新之后必须要配置的（坑点之一），有用到配置服务器的内容的类都要添加</li><li>将所有的actuator接口都暴露出来，是为了POST actuator/refresh接口，这样就能够手动刷新服务，而无需重新启动服务就更新配置了</li></ul></li><li><p>启动服务，需要注意的是前面的EurekaServer服务以及ConfigServer服务都要是启动的，然后访问<a href="http://localhost:8081：">http://localhost:8081：</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/771cc7a70145406b92427b148d684592-18014" alt="访问Service服务"></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/5393c5d00ad35c6d857235785be3cc7c-42683" alt="修改github配置文件"></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/f519dacdf40981351c0a16f9e3a7b881-110812" alt="POST刷新配置"></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/dca44713c7e8eba2be6f80be99ea50a6-20091" alt="刷新后访问Service服务"></p></li></ol><h2 id="Feign服务"><a href="#Feign服务" class="headerlink" title="Feign服务"></a>Feign服务</h2><ol><li><p>创建这个项目主要为了使用Feign进行服务的访问，主要依赖配置如下（pom.xml）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>需要注意的是要添加的是spring-cloud-starter-openfeign，其他的会默认添加上，不要乱添加，否则会出现问题</li></ul></li><li><p>在启动类上添加注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>添加配置（使用配置服务，因此文件要为bootstrap.yml）：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consumer</span>   <span class="comment">#指定了配置文件的应用名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8080/</span>  <span class="comment">#Config server的uri</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span>     <span class="comment">#指定的环境</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span>                      <span class="comment">#指定分支</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="comment"># feign熔断器开关</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">1000</span>  <span class="comment">#1秒</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment">#配置规则 随机</span></span><br><span class="line">    <span class="comment">#NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RoundRobinRule #配置规则 轮询</span></span><br><span class="line">    <span class="comment"># NFLoadBalancerRuleClassName: com.netflix.loadbalancer.BestAvailableRule #配置规则 最空闲连接策略</span></span><br><span class="line">    <span class="attr">ConnectTimeout:</span> <span class="number">500</span> <span class="comment">#请求连接超时时间</span></span><br><span class="line">    <span class="attr">ReadTimeout:</span> <span class="number">1000</span> <span class="comment">#请求处理的超时时间</span></span><br><span class="line">    <span class="attr">OkToRetryOnAllOperations:</span> <span class="literal">true</span> <span class="comment">#对所有请求都进行重试</span></span><br><span class="line">    <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">2</span> <span class="comment">#切换实例的重试次数</span></span><br><span class="line">    <span class="attr">MaxAutoRetries:</span> <span class="number">1</span> <span class="comment">#对当前实例的重试次数</span></span><br></pre></td></tr></table></figure><ul><li>注意fegin和hystrix结合的比较好，要配置服务降级的话，添加feign.hystrix.enabled=true即可</li><li>默认负载均衡是轮询，也是可以修改的</li></ul></li><li><p>配置Feign接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(value = <span class="string">"myFeignClient"</span>)</span><br><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"service"</span>,fallback=ServiceFallback<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">MyFeignClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/"</span>)</span><br><span class="line">    <span class="function">Map&lt;String,Object&gt; <span class="title">hello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>添加降级类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceFallback</span> <span class="keyword">implements</span> <span class="title">MyFeignClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"err"</span>,<span class="string">"服务崩溃"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置RESTful控制器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyFeignClient myFeignClient;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// @HystrixCommand(fallbackMethod = "getHello")</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; ret=myFeignClient.hello();</span><br><span class="line">        Map&lt;String,Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"res"</span>,ret);</span><br><span class="line">        res.put(<span class="string">"msg"</span>,<span class="string">"success"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">getHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"msg"</span>,<span class="string">"启动熔断"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动项目，前面的EurekaServer服务、Service服务以及ConfigServer服务都要是启动的，访问<a href="http://localhost:9000即可：">http://localhost:9000即可：</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/ff198fc22593c8807723ca380df04410-21126" alt="Feign服务"></p><ul><li><p>关闭Service服务，访问服务：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/ff0e8a419bf054dbc4b6c5a06ef84d94-15952" alt="Feign服务降级"></p></li><li><p>EurekaServer展示页面：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/bbb3d2ee423a1060a64b7cb96428814c-112832" alt="EurekaServer展示页面"></p></li></ul></li></ol><h2 id="RestTemplate服务"><a href="#RestTemplate服务" class="headerlink" title="RestTemplate服务"></a>RestTemplate服务</h2><ol><li><p>创建这个项目主要为了使用RestTemplate进行服务的访问，主要依赖配置如下（pom.xml）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在启动类上注解并添加RestTemplate的Bean：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableHystrix</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestconsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RestconsumerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function">RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>@LoadBalanced是Ribbon的注解，用于负载均衡</li><li>@EnableHystrix是开启Hystrix的注解，用于服务熔断</li></ul></li><li><p>添加配置（application.yml）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9500</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">restconsumer</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure></li><li><p>创建控制器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod=<span class="string">"consumerServiceRibbonFallback"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String ret=restTemplate.getForObject(<span class="string">"http://service/"</span>,String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Map&lt;String,Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"res"</span>,ret);</span><br><span class="line">        res.put(<span class="string">"msg"</span>,<span class="string">"success"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">consumerServiceRibbonFallback</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; res=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        res.put(<span class="string">"res"</span>,<span class="string">"error"</span>);</span><br><span class="line">        res.put(<span class="string">"msg"</span>,<span class="string">"err"</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动项目，前面的EurekaServer服务、Service服务以及ConfigServer服务都要是启动的，访问<a href="http://localhost:9500即可：">http://localhost:9500即可：</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/3d4b9eb96de8e029a50c38f583ccb396-23085" alt="restTemplate客户端"></p></li></ol><h2 id="zuul网关"><a href="#zuul网关" class="headerlink" title="zuul网关"></a>zuul网关</h2><ol><li><p>创建项目，添加主要依赖如下(不添加配置客户端)：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在启动类上开启zuul服务以及Eureka客户端注解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulgatewayApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ZuulgatewayApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>修改配置文件(application.yml)：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">zuul</span>   <span class="comment">#指定了配置文件的应用名</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:admin@localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">host:</span></span><br><span class="line">    <span class="attr">connect-timeout-millis:</span> <span class="number">15000</span> <span class="comment">#HTTP连接超时要比Hystrix的大</span></span><br><span class="line">    <span class="attr">socket-timeout-millis:</span> <span class="number">60000</span>   <span class="comment">#socket超时</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">120000</span>  <span class="comment">#请求处理的超时时间</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">30000</span>  <span class="comment">#请求连接的超时时间</span></span><br></pre></td></tr></table></figure></li><li><p>启动zuul服务，然后就可以通过Eureka中注册的服务名称添加接口地址访问服务了，比如：<a href="http://localhost:9001/consumer/" target="_blank" rel="noopener">http://localhost:9001/consumer/</a></p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/99d9a830b1de9837c1e1b15756ffbd43-25199" alt="zuul访问服务"></p><ul><li><p>访问超时的服务时会崩溃，比如：<a href="http://localhost:9001/configserver/service-dev.json，因此添加了配置" target="_blank" rel="noopener">http://localhost:9001/configserver/service-dev.json，因此添加了配置</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">host:</span></span><br><span class="line">    <span class="attr">connect-timeout-millis:</span> <span class="number">15000</span> <span class="comment">#HTTP连接超时要比Hystrix的大</span></span><br><span class="line">    <span class="attr">socket-timeout-millis:</span> <span class="number">60000</span>   <span class="comment">#socket超时</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">120000</span>  <span class="comment">#请求处理的超时时间</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">30000</span>  <span class="comment">#请求连接的超时时间</span></span><br></pre></td></tr></table></figure><ul><li><p>超时错误：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/9c0f83fb94488c19d9ee0594b84272d4-195280" alt="未配置超时效果"></p></li><li><p>修改配置后：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/ad92ee11c226e8ca816f947e2182660a-28278" alt="配置之后"></p></li><li><p>网关默认的等待时间为1秒，时间到了还没有响应就会报错</p></li></ul></li></ul></li><li><p>创建一个服务过滤器serviceFilter继承自ZuulFilter：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">serviceFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"pre"</span>;<span class="comment">// 定义filter的类型，有pre、route、post、error四种</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">// 定义filter的顺序，数字越小表示顺序越高，越先执行</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// 表示是否需要执行该filter，true表示执行，false表示不执行</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException </span>&#123; <span class="comment">// filter需要执行的具体操作</span></span><br><span class="line">        <span class="comment">// filter需要执行的具体操作</span></span><br><span class="line">        RequestContext ctx = RequestContext.getCurrentContext();</span><br><span class="line">        HttpServletRequest request = ctx.getRequest();</span><br><span class="line">        String token = request.getParameter(<span class="string">"token"</span>);</span><br><span class="line">        System.out.println(token);</span><br><span class="line">        <span class="keyword">if</span>(token==<span class="keyword">null</span>)&#123;</span><br><span class="line">            log.warn(<span class="string">"there is no request token"</span>);</span><br><span class="line">            ctx.setSendZuulResponse(<span class="keyword">false</span>);</span><br><span class="line">            ctx.setResponseStatusCode(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ctx.getResponse().getWriter().write(<span class="string">"there is no request token"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"ok"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>添加玩上述过滤器之后，重启网关服务</li><li>现在所有经过网关的服务中必须添加参数token，否则不允许访问任何服务</li></ul></li><li><p>测试过滤器：</p><ul><li><p>不带token参数：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/273facdf1cf67f2e34655f7fe6c24ed7-16109" alt="不带token参数"></p></li><li><p>带token参数：</p><p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/fa9f6138ca8d8607fb92a57f44d4596c-26046" alt="带token参数"></p></li></ul></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>SpringCloud相关的技术真的很繁琐，内容比较多，这里还有和SpringCloud相关的组件没有使用过，而且这些使用都是非常简单的实现，复杂的配置选项以及源码都没有阅读理解。在后续的学习过程中还需要不断扩充这部分的内容，感觉理解还是不够深入，无法比较好地去叙述这部分内容！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;服务发现是基于微服务体系结构的关键原则之一。尝试手工配置每个客户端或某种形式的约定可能很困难，而且很脆弱。Eureka是Netflix的服务
      
    
    </summary>
    
    
      <category term="SpringCloud" scheme="https://wanderros.github.io/categories/SpringCloud/"/>
    
    
  </entry>
  
</feed>
